
```{r "packages", include = FALSE, warning = FALSE, message = FALSE}
# Default chunk options
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,
  dpi     = 300
)

# Load packages
R_packages <- c(
  "tidyverse",
  "ggbeeswarm",
  "ggforce",
  "Seurat",
  "gprofiler2", "knitr",
  "cowplot",
  "ggrepel",    "RColorBrewer",
  "xlsx",
  "colorblindr",
  "broom",
  "mixtools",
  "clustifyr",
  "boot",       "scales",
  "patchwork",  "ComplexHeatmap",
  "devtools",
  "presto",     "here",
  "tools",
  "clustifyrdata",
  "gtools",
  "djvdj",
  "M3Drop",     "vroom",
  "qs",         "ggtrace",
  "ggtext",     "rdrop2",
  "lubridate",
  "MetBrewer",
  "openxlsx",   "biomaRt",
  "harmony",
  "rsample",    "ranger",
  "furrr",
  "caret",
  "clusterProfiler",
  "enrichplot",
  "msigdbr",
  "org.Mm.eg.db",
  "GOSemSim",
  "biomaRt",
  "ggtree"
)

purrr::walk(R_packages, library, character.only = TRUE)

source(here(params$template_dir, "funs.R"))

# Load sample info
xlsx_path <- here(params$ref_dir, params$sample_info)
sam_info  <- xlsx::read.xlsx(xlsx_path, sheetName = "samples")
ag_key    <- xlsx::read.xlsx(xlsx_path, sheetName = "tags")

ags <- unique(ag_key$tag)

ag_key <- ag_key %>%
  split(.$experiment) %>%
  map(~ set_names(.x$tag, .x$identity))

# Check for save objects
create_sobjs <- !file.exists(here(params$so_dir, "lec_so.qs"))
```

```{r "functions"}
#' Integrate Seurat objects using harmony
#' 
#' @param obj Input object
#' @param group_vars Variable(s) to using for grouping cells
#' @noRd
integrate_sobjs <- function(so_in, group_vars = "mouse", dims = 1:40,
                            resolution = c(1, 3, 5, 10)) {
  rm_clmns <- c(str_c("UMAP_", 1:2), str_c("hUMAP_", 1:2))
  
  res <- so_in %>%
    mutate_meta(dplyr::select, -any_of(rm_clmns)) %>%
    FindVariableFeatures(nfeatures = 2000) %>%
    ScaleData() %>%
    RunPCA() %>%
    RunUMAP(dims = dims) %>%
    AddMetaData(FetchData(., c("UMAP_1", "UMAP_2")))
  
  res <- res %>%
    RunHarmony(
      group.by.vars = group_vars,
      dims = dims,
      plot_convergence = TRUE
    ) %>%
    RunUMAP(
      dims = dims,
      reduction      = "harmony",
      reduction.name = "humap",
      reduction.key  = "hUMAP_"
    ) %>%
    FindNeighbors(reduction = "harmony", dims = dims) %>%
    FindClusters(resolution = resolution) %>%
    AddMetaData(FetchData(., c("hUMAP_1", "hUMAP_2")))
  
  res
}

#' Calculate antigen score by subtracting B/T cell signal
#' 
#' @param obj Input object
#' @param clmns Columns containing antigen counts
#' @param control_types Cell types to use for calculating control signal
#' @param type_clmn Column containing cell types, this should contain the types
#' provided to control_types
#' @param sample_clmn Column containing sample names that match those provided
#' by `norm_factors`
#' @param norm_factors Named vector where names are sample names found in
#' `sample_clmn` and values are normalization factors for each sample,
#' e.g. total counts expressed in millions
#' @param q Quantile to use as cutoff for control signal
#' @noRd
calc_ag_score <- function(obj, clmns, control_types = c("B cells", "T cells"),
                          type_clmn = "cell_type", sample_clmn = "directory",
                          norm_factors, q = 0.75) {

  # Column containing cell types
  type_clmn <- names(control_types) %||% "cell_type"
  typs      <- unlist(control_types, use.names = FALSE)
  
  # Names for new columns
  cpm_clmns <- str_c(clmns, "_cpm")
  
  final_clmns <- set_names(
    str_c(cpm_clmns, "_score"),
    names(clmns) %||% str_c(clmns, "_score")
  )
  
  # Fetch clmns
  if (any(!clmns %in% colnames(obj@meta.data))) {
    DefaultAssay(obj) <- "ADT"
    
    obj <- obj %>%
      AddMetaData(FetchData(., clmns))
    
    DefaultAssay(obj) <- "RNA"
  }
  
  # Calculate Ag scores
  res <- obj %>%  
    mutate_meta(~ {
      .x %>%
        group_by(!!sym(sample_clmn)) %>%
        
        mutate(across(
          all_of(unname(clmns)),
          ~ .x / norm_factors[!!sym(sample_clmn)],
          .names = "{.col}_cpm")
        ) %>%
        
        mutate(across(
          all_of(cpm_clmns),
          ~ {
            idx   <- !!sym(type_clmn) %in% typs   # rows to use
            t_cut <- quantile(.x[idx], q)         # set cutoff
            res   <- .x - t_cut                   # subtract background
            
            # replace negative values and log-transform
            res[res < 0] <- 0
            
            res <- log1p(res)
            
            res
          },
          .names = "{.col}_score")
        ) %>%
        ungroup() %>%
        rename(!!!final_clmns)
    })
  
  res
}
#' Format and normalize Ag meta.data columns
#' 
#' @param so_in Input object
#' @param norm_factors Named vector containing normalization factors for
#' `calc_ag_score()`
#' @param ag_key List of named vectors containing labels for each Ag tag for
#' each experiment. List names should be experiment name, vector names should
#' be new label for the Ag tag.
#' @noRd
format_ag_data <- function(so_in, norm_factors, ag_key) {
  
  # Assign labels for Ag tags (ABPS2, ABPS4)
  res <- so_in %>%
    mutate_meta(~ {
      dat <- .x
      
      c("3wk", "6wk") %>%
        walk(~ {
          clmn <- str_c("Ag_", .x)
          
          dat <<- dat %>%
            group_by(exp) %>%
            mutate(
              !!sym(clmn) := ag_key[[as.character(cur_group())]][.x],
              
              !!sym(clmn) := case_when(
                !!sym(clmn) == "ABPS2" ~ ABPS2,
                !!sym(clmn) == "ABPS4" ~ ABPS4
              )
            ) %>%
            ungroup()
        })
      
      dat
    })
  
  # Calculate Ag scores
  ag_clmns <- c("ovalbumin", "Ag_3wk", "Ag_6wk")
  
  res <- res %>%
    mutate_meta(mutate, across(all_of(ag_clmns), ~ replace_na(.x, 0))) %>%
    calc_ag_score(
      clmns        = ag_clmns,
      type_clmn    = "cell_type",
      sample_clmn  = "directory",
      norm_factors = norm_factors
    )
  
  # Format Ag score columns
  res <- res %>%
    mutate_meta(
      mutate,
      Ag_score = case_when(
        exp == "exp-0" ~ ovalbumin_score,
        mouse == "3wk" ~ Ag_3wk_score,
        mouse == "6wk" ~ Ag_6wk_score,
        
        # for 6wk-3wk use highest score
        mouse == "6wk-3wk" & Ag_3wk_score >= Ag_6wk_score ~ Ag_3wk_score,
        mouse == "6wk-3wk" & Ag_6wk_score >= Ag_3wk_score ~ Ag_6wk_score
      ),
      
      # these columns are used for antigen-exchange plots
      Ag_score_3 = ifelse(vaccination == "dual", Ag_3wk_score, Ag_score),
      Ag_score_6 = ifelse(vaccination == "dual", Ag_6wk_score, Ag_score),
      
      tm_3 = ifelse(vaccination == "dual", 21, tm),
      tm_6 = ifelse(vaccination == "dual", 42, tm)
    )
}

create_exchange_boxes <- function(dat, tm_clmn, ag_clmn, typs = NULL,
                                  clrs, fill_clrs) {
  
  # Format plot data
  dat <- dat %>%
    mutate(
      subtype = fct_reorder(subtype, !!sym(ag_clmn), mean, .desc = TRUE),
      vaccination = fct_relevel(vaccination, vacs)
    )
  
  if (!is.null(typs)) {
    dat <- dat %>%
      filter(subtype %in% typs)
  }
  
  # Data to draw line connecting timepoints
  ln_dat <- dat %>%
    filter(mouse != "6wk-3wk") %>%
    group_by(!!sym(tm_clmn), subtype) %>%
    summarize(!!sym(ag_clmn) := median(!!sym(ag_clmn)), .groups = "drop")
  
  # p-values for vaccination
  p_dat <- dat %>%
    group_by(!!sym(tm_clmn), subtype) %>%
    filter(all(vacs %in% vaccination)) %>%
    summarize(
      pval = t.test(
        (!!sym(ag_clmn))[vaccination == vacs[1]],
        (!!sym(ag_clmn))[vaccination == vacs[2]],
        alternative = "less"
      )$p.value,
      y = max(!!sym(ag_clmn)),
      y = y + (y * 0.1),
      .groups = "drop"
    ) %>%
    mutate(padj = p.adjust(pval, method = "bonferroni")) %>%
    rowwise() %>%
    mutate(
      plab = .format_pvalue(padj),
      plab = str_c("italic(p) == ", plab)
    ) %>%
    filter(padj < 0.05)
  
  # Create boxplots
  res <- dat %>%
    ggplot(aes(!!sym(tm_clmn), !!sym(ag_clmn))) +
    
    geom_line(
      data = ln_dat,
      color = "grey85", linewidth = 0.5, linetype = 2
    ) +
    geom_boxplot(
      aes(fill = as.character(!!sym(tm_clmn)), color = as.character(!!sym(tm_clmn)), alpha = vaccination),
      outlier.size = 0.2, width = 5, key_glyph = draw_key_point,
      position = position_dodge2(preserve = "single")
    ) +
    geom_text(
      aes(y = y, label = plab, alpha = NULL),
      data = p_dat,
      parse = TRUE,
      show.legend = FALSE,
      # size = txt_pt1 / .pt
      size = 8 / .pt
    ) +
    facet_grid(~ subtype) +
    scale_alpha_manual(values = c(single = 0.35, dual = 1)) +
    scale_fill_manual(values = fill_clrs) +
    scale_color_manual(values = clrs) +
    guides(
      fill = "none", color = "none",
      alpha = guide_legend(override.aes = list(shape = 15, size = 4))
    ) +
    labs(x = "days post vaccination", y = "Ag-score") +
    base_theme +
    theme(
      aspect.ratio = 0.7
    )
  
  res
}
```

```{r "references"}
# LEC reference
ref_lec <- ref_immgen[, grepl("^Endothelial cells", colnames(ref_immgen))]
ref_lec <- ref_lec[rownames(ref_lec) %in% rownames(ref_LEC_xiang), ]

colnames(ref_lec) <- colnames(ref_lec) %>%
  str_replace("Endothelial cells \\(BEC\\)", "BEC")

ref_LEC_xiang <- ref_LEC_xiang[rownames(ref_lec), ]

stopifnot(identical(rownames(ref_LEC_xiang), rownames(ref_lec)))

ref_lec <- cbind(ref_LEC_xiang, ref_lec)
ref_lec <- ref_lec[, !grepl("^Endothelial cells", colnames(ref_lec))]

# Fibroblast/stromal cell reference
ref_frc <- ref_immgen[, grepl("^Fibroblast", colnames(ref_immgen))]
ref_frc <- ref_frc[rownames(ref_frc) %in% rownames(ref_lymphnodestromal), ]

ref_lymphnodestromal <- ref_lymphnodestromal[rownames(ref_frc), ]

stopifnot(identical(rownames(ref_lymphnodestromal), rownames(ref_frc)))

ref_frc <- cbind(ref_lymphnodestromal, ref_frc)

# Combined Immgen/DC reference
rownames(ref_mousespleenDC) <- str_to_title(rownames(ref_mousespleenDC))

shared_gns    <- intersect(rownames(ref_immgen), rownames(ref_mousespleenDC))
ref_immgen_dc <- cbind(ref_immgen[shared_gns, ], ref_mousespleenDC[shared_gns, ])
```

```{r "Ag normalization factors", eval = create_sobjs}
# Calculate total UMI counts for each library using raw matrix
# do not use filtered matrix since a poor quality library would have a high
# fraction of counts in empty drops that would not be taken into account when
# normalizing data
plan(strategy = multisession, workers = 6)

norm_factors <- sam_info %>%
  mutate(
    lib_size = future_pmap_dbl(., ~ {
      args <- list(...)
      
      mat <- here(params$res_dir[[args$experiment]], args$directory)
      mat <- here(mat, "outs/raw_feature_bc_matrix")
      res <- Read10X(mat)
      sum(res$`Antibody Capture`) / 1e6
    })
  )

norm_factors %>%
  write_tsv(here(params$ref_dir, "norm_factors.tsv"))

norm_factors <- set_names(
  norm_factors$lib_size,
  norm_factors$directory
)
```

```{r "create seurat objects", eval = create_sobjs}
# Create objects
sobjs <- sam_info %>%
  pmap(~ {
    args <- list(...)
    
    mat <- args$directory %>%
      here(params$res_dir[args$experiment], .) %>%
      here("outs/filtered_feature_bc_matrix")
    
    mat %>%
      create_sobj(
        proj_name = args$sample,
        gene_min  = 250,
        gene_max  = 5000,
        mito_max  = 20
      ) %>%
      mutate_meta(
        mutate,
        exp         = args$experiment,
        directory   = args$directory,
        sample      = args$sample,
        tm          = args$tm,
        mouse       = args$mouse,
        vaccination = args$vaccination,
        cell_sort   = args$cell_sort
      ) %>%
      norm_sobj()
  })

sobjs %>%
  qsave(here(params$so_dir, "raw_sobjs.qs"))

# Save sample stats
stat_clmns <- c(
  "nCount_RNA", "nFeature_RNA",
  "nCount_ADT", "nFeature_ADT",
  "pct_mito"
)

plan(multisession, workers = 4)

sam_stats <- sam_info %>%
  future_pmap_dfr(~ {
    args <- list(...)
    
    mat_dir <- args$directory %>%
      here(params$res_dir[args$experiment], ., "outs")
    
    c("raw", "filtered") %>%
      map_dfr(~ {
        mat <- Read10X(here(mat_dir, str_c(.x, "_feature_bc_matrix")))
        mat <- mat$`Antibody Capture`
        
        tibble(
          matrix    = str_c("Ag_counts_", .x),
          directory = args$directory,
          ag_counts = sum(mat)
        )
      })
  }) %>%
  pivot_wider(names_from = matrix, values_from = ag_counts) %>%
  mutate(Ag_counts_frac = Ag_counts_filtered / Ag_counts_raw)

sobjs %>%
  map_dfr(~ {
    .x@meta.data %>%
      as_tibble(rownames = "cell_id") %>%
      group_by(exp, sample, tm, mouse, vaccination, cell_sort) %>%
      mutate(across(all_of(stat_clmns), median, .names = "med_{.col}")) %>%
      group_by(qc_class, !!!syms(str_c("med_", stat_clmns)), .add = TRUE) %>%
      summarize(n = n(), .groups = "drop")
  }) %>%
  left_join(sam_stats, by = "directory") %>%
  write_tsv(here(params$so_dir, "sample_stats.tsv"))

# Save raw objects
sobjs <- sobjs %>%
  map(subset, qc_class == "pass")

sobjs %>%
  qsave(here(params$so_dir, "sobjs.qs"))
```

```{r "CD45- samples", eval = create_sobjs}
# NEED TO:
# 1. Check epithelial cells, some may be PvCs based on Pdpn, Pecam1, Acta2,
#    Itga7. They do express expected markers, Cdh1, Krt8, Muc1, Ocln
# 2. Check unassigned cells, some may be epithelial cells
# 3. Check stem cells, are these accurate? They express Cd19 and Cd79a, these
#    should be reclassified as B cells

# Merge objects
neg_idx    <- sam_info$cell_sort == "CD45neg"
cd45neg_so <- merge(sobjs[neg_idx][[1]], sobjs[neg_idx][-1])

rm(sobjs)

cd45neg_so <- cd45neg_so %>%
  integrate_sobjs(group_vars = "mouse")

# Broad cell type annotations
clst_clmn <- "RNA_snn_res.5"

cd45neg_so <- cd45neg_so %>%
  mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
  clustify(
    ref_mat     = ref_immgen,
    cluster_col = clst_clmn,
    n_genes     = 2000,
    threshold   = 0.55
  ) %>%
  mutate_meta(mutate, rough_type = type)

# Adjust B and T cells
# adjust stem cells based on Cd79a, these appear to be B cells
cd45neg_so <- cd45neg_so %>%
  classify_markers(
    feats    = c("Ptprc", "Cd79a", "Cd19"),
    filt     = Ptprc > 1 & Cd79a > 1.5 & Cd19 > 0.5,
    type     = "B cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  ) %>%
  classify_markers(
    feats    = c("Ptprc", "Cd3e"),
    filt     = Ptprc > 1.25 & Cd3e > 0.75,
    type     = "T cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# Adjust BECs
cd45neg_so <- cd45neg_so %>%
  classify_markers(
    feats    = c("Ptprc", "Pdpn", "Pecam1"),
    filt     = Ptprc < 0.5 & Pdpn < 0.5 & Pecam1 > 2,
    type     = "Endothelial cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# Adjust epithelial cells based on E-cadherin and cytokeratin-8
# some unassigned cells appear to be epithelial cells
cd45neg_so <- cd45neg_so %>%
  classify_markers(
    feats    = c("Cdh1", "Krt8"),
    filt     = Cdh1 > 0.75 & Krt8 > 0.75,
    type     = "Epithelial cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# Adjust cell type labels
# fibroblasts also include DN stromal cells
cd45neg_so <- cd45neg_so %>%
  mutate_meta(
    mutate,
    cell_type = str_remove(rough_type, " \\(.+$"),
    cell_type = recode(cell_type, `Stromal cells` = "Fibroblasts"),
    subtype   = cell_type
  )
```

```{r "CD45+ samples", eval = create_sobjs}
# NEED TO:
# 1. check neutrophils, they show expression of Cd14, which is not expected

# Load objects
sobjs <- qread(here(params$so_dir, "sobjs.qs"))

# Merge objects
pos_idx    <- sam_info$cell_sort == "CD45pos"
cd45pos_so <- merge(sobjs[pos_idx][[1]], sobjs[pos_idx][-1])

rm(sobjs)

cd45pos_so <- cd45pos_so %>%
  integrate_sobjs(group_vars = "mouse")

# Cell type annotations
# assign broad cell types and DC subset using a combined reference
clst_clmn <- "RNA_snn_res.5"

cd45pos_so <- cd45pos_so %>%
  mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
  clustify(
    ref_mat     = ref_immgen_dc,
    cluster_col = clst_clmn,
    n_genes     = 2000
  ) %>%
  mutate_meta(mutate, rough_type = type)

# NK cells
# ILCs show high expression of Nkg7, label these are NK cells
cd45pos_so <- cd45pos_so %>%
  classify_markers(
    feats    = c("Ptprc", "Nkg7"),
    filt     = Ptprc > 1.25 & Nkg7 > 2,
    type     = "NK cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# T cells
cd45pos_so <- cd45pos_so %>%
  classify_markers(
    feats    = c("Ptprc", "Cd3e", "Cd19"),
    filt     = Ptprc > 1.25 & Cd3e > 1 & Cd19 < 0.3,
    type     = "T cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# CD45- cells
# a cluster of B cells show poor expression of Ptprc, label as unassigned
cd45pos_so <- cd45pos_so %>%
  classify_markers(
    feats    = "Ptprc",
    filt     = Ptprc < 0.75,
    type     = "unassigned",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# cDC2 Tbet+
# evidence is lacking that these are actually Tbet+ cells, label as cDC2s
cd45pos_so <- cd45pos_so %>%
  mutate_meta(
    mutate,
    rough_type = ifelse(
      rough_type %in% c("cDC2 Mixed", "cDC2 Tbet+"),
      "cDC2", rough_type
    ),
    cell_type = str_remove(rough_type, " \\(.+$"),
    subtype   = cell_type,
    cell_type = ifelse(grepl("DC", cell_type), "DC", cell_type)
  )
```

```{r "Ag scores", eval = create_sobjs}
# CD45-
cd45neg_so <- cd45neg_so %>%
  AddMetaData(FetchData(., ags, slot = "counts"), col.name = ags)

cd45neg_so <- cd45neg_so %>%
  format_ag_data(
    norm_factors = norm_factors,
    ag_key = ag_key
  )

# CD45+
cd45pos_so <- cd45pos_so %>%
  AddMetaData(FetchData(., ags, slot = "counts"), col.name = ags)

cd45pos_so <- cd45pos_so %>%
  format_ag_data(
    norm_factors = norm_factors,
    ag_key = ag_key
  )
```

```{r "Ag class", eval = create_sobjs}
# Format data for clustering based on Ag scores
# The strategy is to identify Ag-high/low cells for all datasets together
# One might expect that changes in gene expression will depend on absolute
# levels of Ag taken up by the cell, and so it would make the most sense to
# use a consistent cutoff for Ag-high cells across all cell types and datasets.
# This should work since Ag scores are corrected based on background T/B signal.
all_meta <- list(cd45neg_so, cd45pos_so) %>%
  map_dfr(~ .x@meta.data) %>%
  as_tibble(rownames = ".cell_id")

clust_dat <- all_meta %>%
  filter(Ag_score > 0)

# Downsample samples
# This ensures that larger samples do not skew the clustering
sam_size <- min(table(clust_dat$mouse))

set.seed(42)
  
clust_dat <- clust_dat %>%
  group_by(mouse) %>%
  slice_sample(n = sam_size) %>%
  ungroup()

# Identify threshold for Ag-high/low cells
ag_threshold <- clust_dat %>%
  mutate(km_class = kmeans(Ag_score, centers = 2)$cluster) %>%
  group_by(km_class) %>%
  summarize(Ag_score = max(Ag_score)) %>%
  pull(Ag_score) %>%
  min()

# Set Ag-high/low classifications
cd45neg_so <- cd45neg_so %>%
  mutate_meta(
    mutate,
    Ag_class = ifelse(
      Ag_score >= ag_threshold,
      "high", "low"
    )
  )

cd45pos_so <- cd45pos_so %>%
  mutate_meta(
    mutate,
    Ag_class = ifelse(
      Ag_score >= ag_threshold,
      "high", "low"
    )
  )
```

```{r "AG CLASS 2", eval = FALSE}
# Try splitting into Ag-low/high separately for each cell type
lec_so <- lec_so %>%
  subset(mouse != "d2") %>%
  mutate_meta(mutate, mouse_type = str_c(subtype, "_", mouse)) %>%
  cluster_signal(
    data_column  = "Ag_score",
    grp_column   = "mouse_type",
    clust_column = "Ag_class_2",
    method       = "km"
  )
```

```{r "LEC object", eval = create_sobjs}
# NEED TO:
# 1. check Marco_LECs, they do not express Marco

# Re-cluster and integrate endothelial cells
lec_so <- cd45neg_so %>%
  subset(cell_type == "Endothelial cells") %>%
  integrate_sobjs(group_vars = "mouse")

# Annotate LEC subsets
.annotate_lecs <- function(so_in, clst_clmn) {
  res <- so_in %>%
    mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
    clustify(
      ref_mat     = ref_lec,
      cluster_col = clst_clmn,
      n_genes     = 2000,
      threshold   = 0.53
    ) %>%
    mutate_meta(
      mutate,
      subtype   = type,
      cell_type = ifelse(subtype == "BEC", subtype, "LEC")
    )
  
  # Use higher correlation cutoff for LECs
  res <- res %>%
    mutate_meta(
      mutate,
      subtype = ifelse(
        cell_type == "LEC" & r < 0.75,
        "unassigned",
        subtype
      )
    )
  
  res
}

clst_clmn <- "RNA_snn_res.10"

lec_so <- .annotate_lecs(lec_so, clst_clmn)

# Identify contaminating B and T cells
# label other CD45+ cells as unassigned
lec_so <- lec_so %>%
  classify_markers(
    feats    = "Ptprc",
    filt     = Ptprc > 0.4,
    type     = "unassigned",
    clst_col = clst_clmn,
    type_col = "cell_type"
  ) %>%
  classify_markers(
    feats    = c("Ptprc", "Cd79a"),
    filt     = Ptprc > 0.4 & Cd79a > 0.25,
    type     = "B cells",
    clst_col = clst_clmn,
    type_col = "cell_type"
  ) %>%
  classify_markers(
    feats    = c("Ptprc", "Cd3e"),
    filt     = Ptprc > 0.4 & Cd3e > 0.25,
    type     = "T cells",
    clst_col = clst_clmn,
    type_col = "cell_type"
  )

# Adjust cell type labels
# this adds BEC label and fixes B and T cell labels
typ_data <- FetchData(lec_so, "cell_type")

cd45neg_so <- cd45neg_so %>%
  AddMetaData(typ_data, col.name = "new_type") %>%
  mutate_meta(~ {
    .x %>%
      mutate(
        cell_type = ifelse(!is.na(new_type), new_type, cell_type),
        subtype   = ifelse(!is.na(new_type), new_type, subtype)
      ) %>%
      dplyr::select(-new_type)
  })

# Re-annotate LECs after removing B and T cells
lec_so <- lec_so %>%
  subset(cell_type %in% c("LEC", "BEC")) %>%
  integrate_sobjs(group_vars = "mouse") %>%
  .annotate_lecs(clst_clmn)

# Adjust cell type labels
typ_data <- lec_so %>%
  FetchData(c("cell_type", "subtype"))

cd45neg_so <- cd45neg_so %>%
  AddMetaData(typ_data, col.name = c("new_type", "new_subtype")) %>%
  mutate_meta(~ {
    .x %>%
      mutate(
        cell_type = ifelse(!is.na(new_type),    new_type,    cell_type),
        subtype   = ifelse(!is.na(new_subtype), new_subtype, subtype)
      ) %>%
      dplyr::select(-c(new_type, new_subtype))
  })
```

```{r "FRC object", eval = create_sobjs}
# Re-cluster and integrate fibroblasts
frc_so <- cd45neg_so %>%
  subset(cell_type == "Fibroblasts")

frc_so <- frc_so %>%
  integrate_sobjs(group_vars = "mouse")

# Annotate FRC subsets
.annotate_frcs <- function(so_in, clst_clmn) {
  res <- so_in %>%
    mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
    clustify(
      ref_mat     = ref_frc,
      cluster_col = clst_clmn,
      n_genes     = 2000
    ) %>%
    mutate_meta(mutate, subtype = type)
  
  res
}

clst_clmn <- "RNA_snn_res.10"

frc_so <- .annotate_frcs(frc_so, clst_clmn)

# Identify contaminating B and T cells
frc_so <- frc_so %>%
  classify_markers(
    feats    = c("Ptprc", "Cd79a"),
    filt     = Ptprc > 0.5 & Cd79a > 0.5,
    type     = "B cells",
    clst_col = clst_clmn,
    type_col = "cell_type"
  ) %>%
  classify_markers(
    feats    = c("Ptprc", "Cd3e"),
    filt     = Ptprc > 0.5 & Cd3e > 0.5,
    type     = "T cells",
    clst_col = clst_clmn,
    type_col = "cell_type"
  )

# Adjust cell type and subtype labels
typ_data <- frc_so %>%
  FetchData("cell_type")

cd45neg_so <- cd45neg_so %>%
  AddMetaData(typ_data, col.name = "new_type") %>%
  mutate_meta(~ {
    .x %>%
      mutate(
        cell_type = ifelse(!is.na(new_type), new_type, cell_type),
        subtype   = ifelse(!is.na(new_type), new_type, subtype)
      ) %>%
      dplyr::select(-new_type)
  })

# Re-annotate fibroblasts after removing B and T cells
frc_so <- frc_so %>%
  subset(cell_type == "Fibroblasts") %>%
  integrate_sobjs(group_vars = "mouse") %>%
  .annotate_frcs(clst_clmn = "RNA_snn_res.5")

# Add FRC subset labels
typ_data <- frc_so %>%
  FetchData(c("cell_type", "subtype"))

cd45neg_so <- cd45neg_so %>%
  AddMetaData(typ_data, col.name = c("new_type", "new_subtype")) %>%
  mutate_meta(~ {
    .x %>%
      mutate(
         cell_type = ifelse(!is.na(new_type),    new_type,    cell_type),
         subtype   = ifelse(!is.na(new_subtype), new_subtype, subtype)
      ) %>%
      dplyr::select(-c(new_type, new_subtype))
  })
```

```{r "DC object", eval = create_sobjs}
# NEED TO:
# 1. check cDC2s, there is a cluster that might be T-bet+

# Re-cluster and integrate DCs
# DC subsets were annotated with broad cell types
dc_so <- cd45pos_so %>%
  subset(cell_type == "DC")

dc_so <- dc_so %>%
  integrate_sobjs(group_vars = "mouse")
```

```{r "save objects", eval = create_sobjs}
# Save meta.data for all cells combined
all_meta <- list(cd45neg_so, cd45pos_so) %>%
  map_dfr(~ .x@meta.data) %>%
  as_tibble(rownames = ".cell_id")

all_meta %>%
  write_tsv(here(params$so_dir, "all_meta.tsv.gz"))

# Save objects
save_objs(cd45neg_so, ob_dir = params$so_dir)
save_objs(cd45pos_so, ob_dir = params$so_dir)
save_objs(lec_so,     ob_dir = params$so_dir)
save_objs(frc_so,     ob_dir = params$so_dir)
save_objs(dc_so,      ob_dir = params$so_dir)

rm(all_meta, cd45neg_so, cd45pos_so, lec_so, frc_so, dc_so)
```

```{r "load seurat objects"}
all_meta <- read_tsv(here(params$so_dir, "all_meta.tsv.gz"))
lec_so   <- qread(here(params$so_dir, "lec_so.qs"))
dc_so    <- qread(here(params$so_dir, "dc_so.qs"))

# frc_so   <- qread(here(params$so_dir, "frc_so.qs"))
# cd45neg_so <- qread(here(params$so_dir, "cd45neg_so.qs"))
# cd45pos_so <- qread(here(params$so_dir, "cd45pos_so.qs"))
```

```{r "theme"}
# Plot levels
mice <- unique(sam_info$mouse)
tms  <- as.character(na.omit(unique(sam_info$tm)))
vacs <- unique(sam_info$vaccination)

# ggplot2 themes
txt_pt1  <- 10
txt_pt2  <- 12
ttl_pt1  <- 14
ttl_pt2  <- 16
ln_pt    <- 0.5
ln_col   <- "grey85"
cir_size <- 3.5
sqr_size <- 4

txt_theme_1 <- theme(
  strip.text   = element_text(size = ttl_pt2),
  legend.text  = element_text(size = txt_pt2),
  axis.title   = element_text(size = ttl_pt2),
  axis.text    = element_text(size = txt_pt2, color = "black"),
  legend.title = element_text(size = ttl_pt2),
)

line_theme <- theme(
  axis.line.x  = element_line(linewidth = ln_pt, color = ln_col),
  axis.line.y  = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.x = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.y = element_line(linewidth = ln_pt, color = ln_col)
)

base_theme <- djvdj_theme() +
  theme(
    plot.title       = element_text(face = "plain", size = ttl_pt2),
    strip.background = element_blank(),
    strip.text       = element_text(face = "plain")
  ) +
  txt_theme_1

umap_theme <- base_theme +
  theme(
    aspect.ratio = 0.9,
    panel.border = element_rect(color = NA, fill = NA),
    axis.title   = element_blank(),
    axis.line.x  = element_blank(),
    axis.line.y  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text    = element_blank()
  )

umap_theme_2 <- umap_theme %+replace%
  theme(panel.border = element_rect(colour = ln_col, linewidth = ln_pt, fill = NA))

fade_0 <- "#FAFAFA"
fade_1 <- "#F0F0F0"
fade_2 <- "#D9D9D9"

# Colors
# Okabe Ito color palettes
ito_cols <- c(
  palette_OkabeIto[c(1:3, 5)], "#D7301F",
  palette_OkabeIto[c(4, 6)],   "#6A51A3",
  palette_OkabeIto[7],         "#875C04",
  "#065D43", "#F7AF34", "#00446E"
)

ito_cols <- ito_cols[3:length(ito_cols)] %>%
  darken(0.2) %>%
  c(ito_cols, ., "#686868", "#000000")

clrs <- ito_cols

# Cell type colors
typs <- unique(all_meta$cell_type)

typ_clrs <- set_names(
  clrs[seq_along(typs)],
  typs
)

# Subtype colors
lec_clrs <- lec_so@meta.data %>%
  pull(subtype) %>%
  unique()

lec_clrs <- set_names(
  clrs[seq_along(lec_clrs)],
  lec_clrs
)

dc_clrs <- dc_so@meta.data %>%
  pull(subtype) %>%
  unique()

dc_clrs <- set_names(
  clrs[!clrs %in% lec_clrs][seq_along(dc_clrs)],
  dc_clrs
)

dc_clrs["unassigned"] <- lec_clrs["unassigned"] <- "grey65"

# Mouse colors
m_clrs <- set_names(clrs[seq_along(mice)], mice)

# Tm colors
tm_clrs <- set_names(
  clrs[seq_along(tms)],
  unname(tms)
)

tm_clrs[3] <- "#6A51A3"
tm_clrs[4] <- "#D7301F"

# Key for mouse IDs
mouse_key <- lec_so@meta.data %>%
  distinct(mouse, orig.ident)

mouse_key <- set_names(
  mouse_key$mouse, mouse_key$orig.ident
)
```



```{r "MARKERS TO CHECK ANNOTATIONS", eval = FALSE}
marks <- c(
  "type",
  "Ptprc", "Cd3e", "Cd19", "Nkg7", "Ccr7",
  "Adgre1", "Itgam",                  # Mon
  "Cd14", "Fcgr3", "Fcgr1",           # Mac            
  "Xcr1", "Cd8a", "Cd24a", "Clec9a", "Itgae", "Irf8",   # cDC1
  "Cd4", "Sirpa", "Itgam",                              # cDC2
  "Tbx21", "Dtx1", "Ccr6",                              # cDC2 Tbet+
  "Cx3cr1", "Csf1r", "Clec12a", "Lyz2",                 # cDC2 Tbet-
  "Ly6g", "Itgam"                                       # neutrophils
)

# marks %>%
# c("Dtx1", "Ccr6", "Runx1", "Runx2", "Runx3", "Srebf1", "Srebf2") %>%
# c("Sirpa", "Cd4", "Itgam", "Clec12a", "Cx3cr1", "Cd14", "Il1a", "Lyz2", "Csf1r") %>%
# "Cd3e" %>%
# "Sirpa" %>%
# "type" %>%
# "Cd19" %>%
# "Cd79a" %>%
# "adt_ABPS4" %>%
# "adt_ovalbumin" %>%
"subtype" %>%
  map(~ {
    cd45pos_so %>%
      mutate_meta(mutate, rough_type = str_remove(rough_type, " \\(.+$")) %>%
      mutate_meta(mutate, type = str_remove(type, " \\(.+$")) %>%
      plot_scatter(
        .x,
        "hUMAP_1", "hUMAP_2",
        group_col = "mouse",
        panel_nrow = 1, size = 0.1, top = Inf,
        outline = TRUE,
        plot_colors = c("lightblue", "white", "red"),
        # plot_colors = c(unassigned = "black")
      ) +
      theme(aspect.ratio = 0.9)
  }) %>%
  plot_grid(plotlist = .)

marks[-1] %>%
  map(~ {
    cd45pos_so %>%
      mutate_meta(mutate, type = str_remove(type, " \\(.+$")) %>%
      plot_violin(
        .x,
        cluster_col = "type",
        # group_col = "mouse",
        panel_nrow = 1,
        method = "boxplot"
      )
  }) %>%
  plot_grid(plotlist = .)
```

```{r "AG HIGH", eval = FALSE}
clust_dat <- lec_so@meta.data %>%
  as_tibble(rownames = "cell_id") %>%
  filter(Ag_score > 0)

# Downsample samples
# This ensures that larger samples do not skew the clustering
sam_size <- min(table(clust_dat$mouse))

set.seed(42)
  
clust_dat <- clust_dat %>%
  group_by(mouse) %>%
  slice_sample(n = sam_size) %>%
  ungroup()

# Identify threshold for Ag-high/low cells
ag_threshold <- clust_dat %>%
  filter(cell_type %in% c("LEC", "BEC")) %>%
  
  mutate(
    km_class  = kmeans(Ag_score, centers = 2)$cluster
    
    # gmm_class = normalmixEM(clust_score, k = 2)$posterior %>%
    #   as.data.frame() %>%
    #   mutate(Ag_class = ifelse(comp.2 > 0.5, "high", "low")) %>%
    #   pull(Ag_class)
  ) %>%
  group_by(km_class) %>%
  summarize(Ag_score = max(Ag_score)) %>%
  pull(Ag_score) %>%
  min()

# Set Ag-high/low classifications
lec_so <- lec_so %>%
  mutate_meta(
    mutate,
    Ag_class = ifelse(
      Ag_score >= ag_threshold,
      "high", "low"
    )
  )

# DEGs
old_so <- qread("~/Dropbox/Ryan/Projects/tamburini-antigen-tracking/results/2022-10-28/sobjs/so_lec_new.qs")

deg_dat <- old_so %>%
  mutate_meta(
    mutate,
    # mouse_type = mouse
    mouse_type = str_c(subtype, "--", mouse)
  )

typs <- deg_dat@meta.data %>%
  group_by(mouse_type) %>%
  filter(n_distinct(Ag_class) == 2) %>%
  pull(mouse_type) %>%
  unique()

degs <- typs %>%
  map_dfr(~ {
    deg_dat %>%
      subset(mouse_type == .x) %>%
      wilcoxauc(group_by = "Ag_class") %>%
      mutate(mouse_type = .x)
  })

degs_filt <- degs %>%
  filter(padj < 0.05, logFC > 0) %>%
  separate(mouse_type, into = c("mouse", "type"), sep = "--") %>%
  arrange(mouse, type, padj)

degs_filt %>%
  write_tsv(here("ag_high_degs.tsv.gz"))

# # Plot examples
# old_so %>%
#   FetchData(c("Apoe", "mouse", "tm", "subtype", "Ag_class")) %>%
#   mutate(mouse = fct_relevel(mouse, mice)) %>%
#   ggplot(aes(mouse, Apoe, fill = Ag_class)) +
#   geom_boxplot() +
#   # facet_wrap(~ subtype) +
#   djvdj_theme()
```