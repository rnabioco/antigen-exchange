---
title: "Antigen Tracking Figures"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc:            true
    toc_float:      true
    toc_depth:      4
    df_print:       "paged"
    code_folding:   "hide"
    self_contained: true
    highlight:      "kate"
params:
  template_dir:  "src"                                                                      # Directory containing template Rmarkdowns
  so_dir:        "~/Dropbox/Ryan/Projects/antigen-exchange/results/sobjs" # Directory for loading/saving Seurat objects
  ref_dir:       "ref"                                                                      # Directory to use for loading/saving clustifyr references
  sample_info:   "sample_info.xlsx"
  res_dir:                                                
    value:
      exp-0: "~/Projects/antigen-tracking/results"
      exp-1: "~/Projects/tamburini-antigen-tracking/results/2022-03-11"
      exp-2: "~/Projects/tamburini-antigen-tracking/results/2022-10-28"
editor_options: 
  chunk_output_type: console
---

---

<br>

```{r "packages", include = FALSE, warning = FALSE, message = FALSE}
# Default chunk options
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,
  dpi     = 300
)

# Load packages
R_packages <- c(
  "tidyverse",
  "ggbeeswarm",
  "ggforce",
  "Seurat",
  "gprofiler2", "knitr",
  "cowplot",
  "ggrepel",    "RColorBrewer",
  "xlsx",
  "colorblindr",
  "broom",
  "mixtools",
  "clustifyr",
  "boot",       "scales",
  "patchwork",  "ComplexHeatmap",
  "devtools",
  "presto",     "here",
  "tools",
  "clustifyrdata",
  "gtools",
  "djvdj",
  "M3Drop",     "vroom",
  "qs",         "ggtrace",
  "ggtext",     "rdrop2",
  "lubridate",
  "MetBrewer",
  "openxlsx",   "biomaRt",
  "harmony",
  "rsample",    "ranger",
  "furrr"
)

purrr::walk(R_packages, library, character.only = TRUE)

source(here(params$template_dir, "funs.R"))

# Load sample info
xlsx_path <- here(params$ref_dir, params$sample_info)
sam_info  <- xlsx::read.xlsx(xlsx_path, sheetName = "samples")
ag_key    <- xlsx::read.xlsx(xlsx_path, sheetName = "tags")

ags <- unique(ag_key$tag)

ag_key <- ag_key %>%
  split(.$experiment) %>%
  map(~ set_names(.x$tag, .x$identity))

# Check for save objects
create_sobjs <- !file.exists(here(params$so_dir, "lec_so.qs"))
```

```{r "functions"}
#' Integrate Seurat objects using harmony
#' 
#' @param obj Input object
#' @param group_vars Variable(s) to using for grouping cells
#' @noRd
integrate_sobjs <- function(so_in, group_vars = "mouse") {
  res <- so_in %>%
    FindVariableFeatures(nfeatures = 2000) %>%
    ScaleData() %>%
    RunPCA() %>%
    RunUMAP(dims = 1:40) %>%
    AddMetaData(FetchData(., c("UMAP_1", "UMAP_2")))
  
  res <- res %>%
    RunHarmony(
      group.by.vars = group_vars,
      dims = 1:40,
      plot_convergence = TRUE
    ) %>%
    RunUMAP(
      dims = 1:40,
      reduction      = "harmony",
      reduction.name = "humap",
      reduction.key  = "hUMAP_"
    ) %>%
    FindNeighbors(reduction = "harmony", dims = 1:40) %>%
    FindClusters(resolution = c(1, 3, 5, 10)) %>%
    AddMetaData(FetchData(., c("hUMAP_1", "hUMAP_2")))
  
  res
}

#' Calculate antigen score by subtracting B/T cell signal
#' 
#' @param obj Input object
#' @param clmns Columns containing antigen counts
#' @param control_types Cell types to use for calculating control signal
#' @param type_clmn Column containing cell types, this should contain the types
#' provided to control_types
#' @param sample_clmn Column containing sample names that match those provided
#' by `norm_factors`
#' @param norm_factors Named vector where names are sample names found in
#' `sample_clmn` and values are normalization factors for each sample,
#' e.g. total counts expressed in millions
#' @param q Quantile to use as cutoff for control signal
#' @noRd
calc_ag_score <- function(obj, clmns, control_types = c("B cells", "T cells"),
                          type_clmn = "cell_type", sample_clmn = "directory",
                          norm_factors, q = 0.75) {

  # Column containing cell types
  type_clmn <- names(control_types) %||% "cell_type"
  typs      <- unlist(control_types, use.names = FALSE)
  
  # Names for new columns
  cpm_clmns <- str_c(clmns, "_cpm")
  
  final_clmns <- set_names(
    str_c(cpm_clmns, "_score"),
    names(clmns) %||% str_c(clmns, "_score")
  )
  
  # Fetch clmns
  if (any(!clmns %in% colnames(obj@meta.data))) {
    DefaultAssay(obj) <- "ADT"
    
    obj <- obj %>%
      AddMetaData(FetchData(., clmns))
    
    DefaultAssay(obj) <- "RNA"
  }
  
  # Calculate Ag scores
  res <- obj %>%  
    mutate_meta(~ {
      .x %>%
        group_by(!!sym(sample_clmn)) %>%
        
        mutate(across(
          all_of(unname(clmns)),
          ~ .x / norm_factors[!!sym(sample_clmn)],
          .names = "{.col}_cpm")
        ) %>%
        
        mutate(across(
          all_of(cpm_clmns),
          ~ {
            idx   <- !!sym(type_clmn) %in% typs   # rows to use
            t_cut <- quantile(.x[idx], q)         # set cutoff
            res   <- .x - t_cut                   # subtract background
            
            # replace negative values and log-transform
            res[res < 0] <- 0
            
            res <- log1p(res)
            
            res
          },
          .names = "{.col}_score")
        ) %>%
        ungroup() %>%
        rename(!!!final_clmns)
    })
  
  res
}
#' Format and normalize Ag meta.data columns
#' 
#' @param so_in Input object
#' @param norm_factors Named vector containing normalization factors for
#' `calc_ag_score()`
#' @param ag_key List of named vectors containing labels for each Ag tag for
#' each experiment. List names should be experiment name, vector names should
#' be new label for the Ag tag.
#' @noRd
format_ag_data <- function(so_in, norm_factors, ag_key) {
  
  # Assign labels for Ag tags (ABPS2, ABPS4)
  res <- so_in %>%
    mutate_meta(~ {
      dat <- .x
      
      c("3wk", "6wk") %>%
        walk(~ {
          clmn <- str_c("Ag_", .x)
          
          dat <<- dat %>%
            group_by(exp) %>%
            mutate(
              !!sym(clmn) := ag_key[[as.character(cur_group())]][.x],
              
              !!sym(clmn) := case_when(
                !!sym(clmn) == "ABPS2" ~ ABPS2,
                !!sym(clmn) == "ABPS4" ~ ABPS4
              )
            ) %>%
            ungroup()
        })
      
      dat
    })
  
  # Calculate Ag scores
  ag_clmns <- c("ovalbumin", "Ag_3wk", "Ag_6wk")
  
  res <- res %>%
    mutate_meta(mutate, across(all_of(ag_clmns), ~ replace_na(.x, 0))) %>%
    calc_ag_score(
      clmns        = ag_clmns,
      type_clmn    = "cell_type",
      sample_clmn  = "directory",
      norm_factors = norm_factors
    )
  
  # Format Ag score columns
  res <- res %>%
    mutate_meta(
      mutate,
      Ag_score = case_when(
        exp == "exp-0" ~ ovalbumin_score,
        mouse == "3wk" ~ Ag_3wk_score,
        mouse == "6wk" ~ Ag_6wk_score,
        
        # for 6wk-3wk use highest score
        mouse == "6wk-3wk" & Ag_3wk_score >= Ag_6wk_score ~ Ag_3wk_score,
        mouse == "6wk-3wk" & Ag_6wk_score >= Ag_3wk_score ~ Ag_6wk_score
      ),
      
      # these columns are used for antigen-exchange plots
      Ag_score_3 = ifelse(vaccination == "dual", Ag_3wk_score, Ag_score),
      Ag_score_6 = ifelse(vaccination == "dual", Ag_6wk_score, Ag_score),
      
      tm_3 = ifelse(vaccination == "dual", 21, tm),
      tm_6 = ifelse(vaccination == "dual", 42, tm)
    )
}
```

```{r "references"}
# LEC reference
ref_lec <- ref_immgen[, grepl("^Endothelial cells", colnames(ref_immgen))]
ref_lec <- ref_lec[rownames(ref_lec) %in% rownames(ref_LEC_xiang), ]

colnames(ref_lec) <- colnames(ref_lec) %>%
  str_replace("Endothelial cells \\(BEC\\)", "BEC")

ref_LEC_xiang <- ref_LEC_xiang[rownames(ref_lec), ]

stopifnot(identical(rownames(ref_LEC_xiang), rownames(ref_lec)))

ref_lec <- cbind(ref_LEC_xiang, ref_lec)
ref_lec <- ref_lec[, !grepl("^Endothelial cells", colnames(ref_lec))]

# Fibroblast/stromal cell reference
ref_frc <- ref_immgen[, grepl("^Fibroblast", colnames(ref_immgen))]
ref_frc <- ref_frc[rownames(ref_frc) %in% rownames(ref_lymphnodestromal), ]

ref_lymphnodestromal <- ref_lymphnodestromal[rownames(ref_frc), ]

stopifnot(identical(rownames(ref_lymphnodestromal), rownames(ref_frc)))

ref_frc <- cbind(ref_lymphnodestromal, ref_frc)

# Combined Immgen/DC reference
rownames(ref_mousespleenDC) <- str_to_title(rownames(ref_mousespleenDC))

shared_gns    <- intersect(rownames(ref_immgen), rownames(ref_mousespleenDC))
ref_immgen_dc <- cbind(ref_immgen[shared_gns, ], ref_mousespleenDC[shared_gns, ])
```

```{r "Ag normalization factors", eval = create_sobjs}
# Calculate total UMI counts for each library using raw matrix
# do not use filtered matrix since a poor quality library would have a high
# fraction of counts in empty drops that would not be taken into account when
# normalizing data
plan(strategy = multisession, workers = 6)

norm_factors <- sam_info %>%
  mutate(
    lib_size = future_pmap_dbl(., ~ {
      args <- list(...)
      
      mat <- here(params$res_dir[[args$experiment]], args$directory)
      mat <- here(mat, "outs/raw_feature_bc_matrix")
      res <- Read10X(mat)
      sum(res$`Antibody Capture`) / 1e6
    })
  )

norm_factors %>%
  write_tsv(here(params$ref_dir, "norm_factors.tsv"))

norm_factors <- set_names(
  norm_factors$lib_size,
  norm_factors$directory
)
```

```{r "create seurat objects", eval = create_sobjs}
# Create objects
sobjs <- sam_info %>%
  pmap(~ {
    args <- list(...)
    
    mat <- args$directory %>%
      here(params$res_dir[args$experiment], .) %>%
      here("outs/filtered_feature_bc_matrix")
    
    mat %>%
      create_sobj(
        proj_name = args$sample,
        gene_min = 250,
        gene_max = 5000,
        mito_max = 20
      ) %>%
      mutate_meta(
        mutate,
        exp         = args$experiment,
        directory   = args$directory,
        sample      = args$sample,
        tm          = args$tm,
        mouse       = args$mouse,
        vaccination = args$vaccination,
        cell_sort   = args$cell_sort
      ) %>%
      norm_sobj()
  })

sobjs %>%
  qsave(here(params$so_dir, "raw_sobjs.qs"))

# Filter objects
stat_clmns <- c(
  "nCount_RNA", "nFeature_RNA",
  "nCount_ADT", "nFeature_ADT",
  "pct_mito"
)

sobjs %>%
  map_dfr(~ {
    .x@meta.data %>%
      as_tibble(rownames = "cell_id") %>%
      group_by(exp, sample, tm, mouse, vaccination, cell_sort) %>%
      mutate(across(all_of(stat_clmns), median, .names = "med_{.col}")) %>%
      group_by(qc_class, !!!syms(str_c("med_", stat_clmns)), .add = TRUE) %>%
      summarize(n = n(), .groups = "drop")
  }) %>%
  write_tsv(here(params$so_dir, "sample_stats.tsv"))

sobjs <- sobjs %>%
  map(subset, qc_class == "pass")

sobjs %>%
  qsave(here(params$so_dir, "sobjs.qs"))
```

```{r "CD45- samples", eval = create_sobjs}
# NEED TO:
# 1. check epithelial cells, some may be PvCs based on Pdpn, Pecam1, Acta2, Itga7
# 2. check unassigned cells, some may be epithelial cells
# 3. check stem cells

# Merge objects
neg_idx    <- sam_info$cell_sort == "CD45neg"
cd45neg_so <- merge(sobjs[neg_idx][[1]], sobjs[neg_idx][-1])

rm(sobjs)

cd45neg_so <- cd45neg_so %>%
  integrate_sobjs(group_vars = "mouse")

# Broad cell type annotations
clst_clmn <- "RNA_snn_res.5"

cd45neg_so <- cd45neg_so %>%
  mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
  clustify(
    ref_mat     = ref_immgen,
    cluster_col = clst_clmn,
    n_genes     = 2000,
    threshold   = 0.55
  ) %>%
  mutate_meta(mutate, rough_type = type)

# Adjust B and T cells
cd45neg_so <- cd45neg_so %>%
  classify_markers(
    feats    = c("Ptprc", "Cd19"),
    filt     = Ptprc > 1.25 & Cd19 > 0.5,
    type     = "B cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  ) %>%
  classify_markers(
    feats    = c("Ptprc", "Cd3e"),
    filt     = Ptprc > 1.25 & Cd3e > 0.75,
    type     = "T cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# Adjust BECs
cd45neg_so <- cd45neg_so %>%
  classify_markers(
    feats    = c("Ptprc", "Pdpn", "Pecam1"),
    filt     = Ptprc < 0.5 & Pdpn < 0.5 & Pecam1 > 2,
    type     = "Endothelial cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  ) %>%
  mutate_meta(mutate, cell_type = str_remove(rough_type, " \\(.+$"))
```

```{r "CD45+ samples", eval = create_sobjs}
# NEED TO:
# 1. check neutrophils, they show expression of Cd14, which is not expected

# Load objects
sobjs <- qread(here(params$so_dir, "sobjs.qs"))

# Merge objects
pos_idx    <- sam_info$cell_sort == "CD45pos"
cd45pos_so <- merge(sobjs[pos_idx][[1]], sobjs[pos_idx][-1])

rm(sobjs)

cd45pos_so <- cd45pos_so %>%
  integrate_sobjs(group_vars = "mouse")

# Cell type annotations
# assign broad cell types and DC subset using a combined reference
clst_clmn <- "RNA_snn_res.5"

cd45pos_so <- cd45pos_so %>%
  mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
  clustify(
    ref_mat     = ref_immgen_dc,
    cluster_col = clst_clmn,
    n_genes     = 2000
  ) %>%
  mutate_meta(mutate, rough_type = type)

# NK cells
# ILCs show high expression of Nkg7, label these are NK cells
cd45pos_so <- cd45pos_so %>%
  classify_markers(
    feats    = c("Ptprc", "Nkg7"),
    filt     = Ptprc > 1.25 & Nkg7 > 2,
    type     = "NK cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# T cells
cd45pos_so <- cd45pos_so %>%
  classify_markers(
    feats    = c("Ptprc", "Cd3e", "Cd19"),
    filt     = Ptprc > 1.25 & Cd3e > 1 & Cd19 < 0.3,
    type     = "T cells",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# CD45- cells
# a cluster of B cells show poor expression of Ptprc, label as unassigned
cd45pos_so <- cd45pos_so %>%
  classify_markers(
    feats    = "Ptprc",
    filt     = Ptprc < 0.75,
    type     = "unassigned",
    clst_col = clst_clmn,
    type_col = "rough_type"
  )

# cDC2 Tbet+
# evidence is lacking that these are actually Tbet+ cells, label as cDC2s
cd45pos_so <- cd45pos_so %>%
  mutate_meta(
    mutate,
    rough_type = ifelse(
      rough_type %in% c("cDC2 Mixed", "cDC2 Tbet+"),
      "cDC2", rough_type
    ),
    cell_type = str_remove(rough_type, " \\(.+$"),
    subtype   = cell_type,
    cell_type = ifelse(grepl("DC", cell_type), "DC", cell_type)
  )

# Save object
cd45pos_so %>%
  qsave(here(params$so_dir, "cd45pos_so.qs"))
```

```{r "Ag scores", eval = create_sobjs}
# CD45-
cd45neg_so <- cd45neg_so %>%
  AddMetaData(FetchData(., ags, slot = "counts"), col.name = ags)

cd45neg_so <- cd45neg_so %>%
  format_ag_data(
    norm_factors = norm_factors,
    ag_key = ag_key
  )

# CD45+
cd45pos_so <- cd45pos_so %>%
  AddMetaData(FetchData(., ags, slot = "counts"), col.name = ags)

cd45pos_so <- cd45pos_so %>%
  format_ag_data(
    norm_factors = norm_factors,
    ag_key = ag_key
  )

# Save objects
save_objs(cd45neg_so, ob_dir = params$so_dir)
save_objs(cd45pos_so, ob_dir = params$so_dir)
```

```{r "LEC subsets", eval = create_sobjs}

```

```{r "load seurat objects"}
lec_so     <- qread(here(params$so_dir, "lec_so.qs"))
cd45neg_so <- qread(here(params$so_dir, "cd45neg_so.qs"))
cd45pos_so <- qread(here(params$so_dir, "cd45pos_so.qs"))
```





```{r "Ag objects"}
# Object list
sobjs <- list()

# Load original objects
orig_dir <- here("~/Dropbox/Ryan/Projects/antigen-tracking/sobjs")

sobjs$orig_lec <- merge(
  read_rds(here(orig_dir, "walsh_d2_LEC.rds")),
  read_rds(here(orig_dir, "walsh_d14_LEC.rds"))
)

sobjs$orig_lec <- sobjs$orig_lec %>%
  mutate_meta(
    mutate,
    cell_type = recode(cell_type, `B cell` = "B cells", `T cell` = "T cells"),
    cell_type = ifelse(subtype == "BEC", subtype, cell_type),
    mouse     = str_extract(orig.ident, "d[0-9]+$"),
    exp       = "exp-0",
    sample    = mouse
  )

sobjs$orig_dc <- merge(
  read_rds(here(orig_dir, "walsh_d2_DC.rds")),
  read_rds(here(orig_dir, "walsh_d14_DC.rds"))
)

sobjs$orig_dc <- sobjs$orig_dc %>%
  mutate_meta(
    mutate,
    cell_type = recode(cell_type, `B cell` = "B cells", `T cell` = "T cells"),
    cell_type = ifelse(subtype == "BEC", subtype, cell_type),
    mouse     = str_extract(orig.ident, "d[0-9]+$"),
    exp       = "exp-0",
    sample    = mouse
  )

# Load r1 objects
r1_dir <- here(params$so_dir, params$res_dir$r1_lec, "sobjs")

obj_typs <- c("lec", "dc")

sobjs[str_c("r1_", obj_typs)] <- obj_typs %>%
  str_c(r1_dir, "/so_", ., ".qs") %>%
  map(~ {
    .x %>%
      qread() %>%
      mutate_meta(
        mutate,
        exp = "exp-1",
        sample = str_replace(sample, "6wk_3wk", "6wk-3wk"),
        mouse  = str_replace(mouse, "6wk_3wk", "6wk-3wk")
      )
  })

# Add r2 object
r2_dir <- here(params$so_dir, params$res_dir$r2_lec, "sobjs")

sobjs[str_c("r2_", obj_typs)] <- obj_typs %>%
  str_c(r2_dir, "/so_", ., ".qs") %>%
  map(~ {
    .x %>%
      qread() %>%
      mutate_meta(mutate, exp = "exp-2", rep = "r1")
  })

# Add subtype column to Ag-exchange objects
lec_nms <- c("r1_lec", "r2_lec")
dc_nms  <- c("r1_dc", "r2_dc")

sobjs[lec_nms] <- sobjs[lec_nms] %>%
  map(~ {
    .x %>%
      mutate_meta(
        mutate,
        subtype = ifelse(cell_type == "LEC", sub_type, cell_type)
      )
  })

sobjs[dc_nms] <- sobjs[dc_nms] %>%
  map(~ {
    .x %>%
      mutate_meta(
        mutate,
        subtype = ifelse(cell_type == "DC", sub_type, cell_type)
      )
  })
```

```{r "Ag scores"}
# COULD ALSO TRY TMM NORMALIZATION FROM edgeR

# Calculate Ag scores
# Set columns containing raw Ag counts to use for calculating scores
ag_args <- list(
  c(Ag_score = "adt_ovalbumin"),  # orig_lec
  c(Ag_score = "adt_ovalbumin"),  # orig_dc
  c("Ag_3wk", "Ag_6wk"),          # r1_lec
  c("Ag_3wk", "Ag_6wk"),          # r1_dc
  c("Ag_3wk", "Ag_6wk"),          # r2_lec
  c("Ag_3wk", "Ag_6wk")           # r2_lec
)

names(ag_args) <- names(sobjs)

sobjs <- ag_args %>%
  imap(~ {
    calc_ag_score(
      obj          = sobjs[[.y]],
      clmns        = .x,
      norm_factors = norm_factors[[.y]],
      q            = 0.75
    )
  })

# Set Ag score columns
tms <- c(
  d2    = 2,
  d14   = 14,
  `3wk` = 21,
  `6wk` = 42
)

sobjs <- sobjs %>%
  map(~ {
    missing <- c("Ag_score", "Ag_3wk_score", "Ag_6wk_score")
    missing <- missing[!missing %in% colnames(.x@meta.data)]
    
    .x[[missing]] <- as.numeric(NA)
    
    .x %>%
      mutate_meta(
        mutate,
        mouse = fct_relevel(mouse, c(names(tms), "6wk-3wk")),
        
        vaccination = ifelse(mouse == "6wk-3wk", "dual", "single"),
        vaccination = fct_relevel(vaccination, c("single", "dual")),
        
        Ag_score = case_when(
          grepl("d[0-9]+$", mouse) ~ Ag_score,
          grepl("^3wk$", mouse)    ~ Ag_3wk_score,
          grepl("^6wk$", mouse)    ~ Ag_6wk_score,
          
          Ag_3wk_score >= Ag_6wk_score ~ Ag_3wk_score,  # For 6wk-3wk use highest
          Ag_6wk_score >= Ag_3wk_score ~ Ag_6wk_score
        ),
        
        Ag_score_3  = ifelse(vaccination == "dual", Ag_3wk_score, Ag_score),
        Ag_score_6  = ifelse(vaccination == "dual", Ag_6wk_score, Ag_score),
        
        tm   = tms[as.character(mouse)],
        tm_3 = ifelse(vaccination == "dual", tms[["3wk"]], tm),
        tm_6 = ifelse(vaccination == "dual", tms[["6wk"]], tm)            
      )
  })

# Create Ag data.frame
ag_dat <- sobjs %>%
  imap_dfr(~ .x@meta.data, .id = "object") %>%
  mutate(cell_group = str_extract(object, "(?<=_)[a-zA-Z]+$"))

sams <- obj_typs %>%
  set_names() %>%
  map(~ grep(str_c("_", .x, "$"), names(sobjs), value = TRUE))
```

```{r "LEC data"}
if (!file.exists(lec_dir)) {
  # Merge LEC objects
  lec_so <- sobjs[sams$lec] %>%
    map(subset, cell_type %in% c("LEC", "BEC"))
  
  lec_so["orig_lec"] <- lec_so$orig_lec %>%
    mutate_meta(mutate, sample = mouse)
  
  lec_so <- merge(lec_so[[1]], lec_so[-1])
  
  rm(sobjs)
  
  # Integrate samples
  lec_so <- lec_so %>%
    FindVariableFeatures() %>%
    ScaleData() %>%
    RunPCA() %>%
    RunUMAP(dims = 1:40) %>%
    AddMetaData(FetchData(., c("UMAP_1", "UMAP_2")))
  
  lec_so <- lec_so %>%
    RunHarmony(
      "orig.ident",
      dims = 1:40, plot_convergence = TRUE
    ) %>%
    RunUMAP(
      dims = 1:40,
      reduction      = "harmony",
      reduction.name = "humap",
      reduction.key  = "hUMAP_"
    ) %>%
    FindNeighbors(reduction = "harmony", dims = 1:40) %>%
    FindClusters(resolution = 1:5) %>%
    AddMetaData(FetchData(., c("hUMAP_1", "hUMAP_2")))
  
  # New subset annotations
  clst_clmn <- "RNA_snn_res.5"
  
  lec_so <- lec_so %>%
    mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
    clustify(
      ref_mat     = ref_lec,
      cluster_col = clst_clmn,
      n_genes     = 2000
      # threshold   = 0.55
    )
  
  # Remove contaminating CD45+ cells
  lec_so <- lec_so %>%
    classify_markers(
      feats    = c("Ptprc", "Cd19"),
      filt     = Ptprc > 0.2 & Cd19 > 0.1,
      type     = "B cells",
      clst_col = clst_clmn,
      type_col = "cell_type"
    ) %>%
    classify_markers(
      feats    = c("Ptprc", "Cd3e"),
      filt     = Ptprc > 0.5 & Cd3e > 0.4,
      type     = "T cells",
      clst_col = clst_clmn,
      type_col = "cell_type"
    )
  
  # Remove contaminating erythrocytes based on Hba expression
  lec_so <- lec_so %>%
    classify_markers(
      feats    = "Hba-a1",
      filt     = `Hba-a1` > 0.5,
      type     = "Erythrocytes",
      clst_col = clst_clmn,
      type_col = "cell_type"
    )
  
  # Adjust unassigned clusters based on Pdpn and Pecam1 expression
  lec_so <- lec_so %>%
    classify_markers(
      feats    = c("Pdpn", "Pecam1"),
      filt     = Pdpn < 0.1 & Pecam1 > 0.1,
      type     = "BEC",
      clst_col = clst_clmn,
      type_col = "type"
    )
  
  # Adjust cell_type labels based on refined subtype annotations
  lec_so <- lec_so %>%
    subset(cell_type %in% c("LEC", "BEC")) %>%
    mutate_meta(
      mutate,
      type        = ifelse(type == "unassigned" & cell_type == "BEC", "BEC", type),
      cell_type   = ifelse(type == "BEC", "BEC", "LEC"),
      old_subtype = subtype,
      subtype     = type
    )
  
  # Re-integrate samples after refining annotations
  lec_so <- lec_so %>%
    FindVariableFeatures() %>%
    ScaleData() %>%
    RunPCA() %>%
    RunUMAP(dims = 1:40) %>%
    AddMetaData(FetchData(., c("UMAP_1", "UMAP_2")))
  
  lec_so <- lec_so %>%
    RunHarmony(
      "orig.ident",
      dims = 1:40, plot_convergence = TRUE
    ) %>%
    RunUMAP(
      dims = 1:40,
      reduction      = "harmony",
      reduction.name = "humap",
      reduction.key  = "hUMAP_"
    ) %>%
    FindNeighbors(reduction = "harmony", dims = 1:40) %>%
    FindClusters(resolution = 1:5) %>%
    AddMetaData(FetchData(., c("hUMAP_1", "hUMAP_2")))
  
  lec_so %>%
    qsave(file = lec_dir)
  
  rm(lec_so)
  
} else {
  rm(sobjs)
}

lec_so <- qread(lec_dir)



# # Checking different normalization
# ag_clmns <- c("Ag_score", "Ag_3wk_score", "Ag_6wk_score")
# 
# ag <- ag_dat %>%
#   as_tibble(rownames = "cell_id") %>%
#   mutate(cell_id = str_remove(cell_id, "\\.\\.\\..+$")) %>%
#   dplyr::select(cell_id, orig.ident, all_of(ag_clmns))
# 
# lec_so <- lec_so %>%
#   mutate_meta(~ {
#     .x %>%
#       dplyr::select(-ends_with("_raw")) %>%
#       mutate(
#         raw_cell_id = str_remove(.cell_id, "_[0-9]+$")
#       ) %>%
#       rename_with(.cols = all_of(ag_clmns), ~ str_c(.x, "_raw")) %>%
#       left_join(ag, by = c(raw_cell_id = "cell_id", "orig.ident")) %>%
#       mutate(
#         Ag_score_3  = ifelse(vaccination == "dual", Ag_3wk_score, Ag_score),
#         Ag_score_6  = ifelse(vaccination == "dual", Ag_6wk_score, Ag_score),
#       )
#   })
```

```{r "LEC Ag-high"}
# Format data for clustering based on Ag scores
# The strategy is to identify Ag-high/low cells for all datasets together
# One might expect that changes in gene expression will depend on absolute
# levels of Ag taken up by the cell, and so it would make the most sense to
# use a consistent cutoff for Ag-high cells across all cell types and datasets.
# This should work since Ag scores are corrected based on background T/B signal.
# 
# Duplicate 6wk-3wk data so both Ag scores are included when classifying Ag-high
# cells
# clust_dat <- lec_ag_dat %>%
#   mutate(
#     clust_score = Ag_score_3,
#     Ag_mouse = ifelse(
#       mouse == "6wk-3wk",
#       str_c(mouse, "_Ag-3wk"),
#       as.character(mouse)
#     )
#   )
# 
# clust_dat <- lec_ag_dat %>%
#   filter(mouse == "6wk-3wk") %>%
#   mutate(
#     clust_score = Ag_score_6,
#     Ag_mouse = ifelse(
#       mouse == "6wk-3wk",
#       str_c(mouse, "_Ag-6wk"),
#       as.character(mouse)
#     )
#   ) %>%
#   bind_rows(clust_dat, .) %>%
#   as_tibble(rownames = "cell_id")

clust_dat <- lec_so@meta.data %>%
  as_tibble(rownames = "cell_id") %>%
  filter(Ag_score > 0)

# Downsample samples
# This ensures that larger samples do not skew the clustering
sam_size <- min(table(clust_dat$mouse))

set.seed(42)
  
clust_dat <- clust_dat %>%
  group_by(mouse) %>%
  slice_sample(n = sam_size) %>%
  ungroup()

# Identify threshold for Ag-high/low cells
ag_threshold <- clust_dat %>%
  filter(cell_type %in% c("LEC", "BEC")) %>%
  
  mutate(
    km_class  = kmeans(Ag_score, centers = 2)$cluster
    
    # gmm_class = normalmixEM(clust_score, k = 2)$posterior %>%
    #   as.data.frame() %>%
    #   mutate(Ag_class = ifelse(comp.2 > 0.5, "high", "low")) %>%
    #   pull(Ag_class)
  ) %>%
  group_by(km_class) %>%
  summarize(Ag_score = max(Ag_score)) %>%
  pull(Ag_score) %>%
  min()

# Set Ag-high/low classifications
lec_so <- lec_so %>%
  mutate_meta(
    mutate,
    Ag_class = ifelse(
      Ag_score >= ag_threshold,
      "high", "low"
    )
  )
```

```{r "DC data"}
# Merge DC objects
dc_dir <- here(params$so_dir, "results/2022-10-28/sobjs")

if (!file.exists(here(dc_dir, "so_dc_sub_merge.qs"))) {
  dc_so <- sobjs[sams$dc]
  
  rm(sobjs)
  
  dc_so <- merge(dc_so[[1]], dc_so[-1])
  
  dc_so <- dc_so %>%
    FindVariableFeatures(assay = "RNA", nfeatures = 2000) %>%
    ScaleData(assay = "RNA") %>%
    RunPCA(assay = "RNA") %>%
    RunUMAP(assay = "RNA", dims = 1:40) %>%
    FindNeighbors(dims = 1:40) %>%
    FindClusters(resolution = c(1, 3, 5, 10))
  
  # Integrate samples
  dc_so <- dc_so %>%
    RunHarmony(
      group.by.vars = c("mouse", "exp"),
      plot_convergence = TRUE
    ) %>%
    RunUMAP(
      reduction      = "harmony",
      reduction.name = "humap",
      reduction.key  = "hUMAP_",
      dims = 1:40
    ) %>%
    FindNeighbors(reduction = "harmony", dims = 1:40) %>% 
    FindClusters(resolution = c(1, 3, 5, 10))
  
  # Annotate cell types
  dc_so <- dc_so %>%
    mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
    clustify(
      ref_mat = ref_immgen,
      cluster_col = "RNA_snn_res.3"
    )
  
  dc_so %>%
    qsave(here(dc_dir, "so_dc_merge.qs"))
  
  # Annotate DC subsets
  dc_so <- dc_so %>%
    subset(cell_type == "DC")
  
  dc_so <- dc_so %>%
    FindVariableFeatures(assay = "RNA", nfeatures = 2000) %>%
    ScaleData(assay = "RNA") %>%
    RunPCA(assay = "RNA") %>%
    RunUMAP(assay = "RNA", dims = 1:40) %>%
    FindNeighbors(dims = 1:40) %>%
    FindClusters(resolution = c(1, 3, 5, 10))
  
  dc_so <- dc_so %>%
    RunHarmony(
      group.by.vars = c("mouse", "exp"),
      plot_convergence = TRUE
    ) %>%
    RunUMAP(
      reduction      = "harmony",
      reduction.name = "humap",
      reduction.key  = "hUMAP_",
      dims = 1:40
    ) %>%
    FindNeighbors(reduction = "harmony", dims = 1:40) %>% 
    FindClusters(resolution = c(1, 3, 5, 10))
  
  rownames(ref_mousespleenDC) <- ref_mousespleenDC %>%
    rownames() %>%
    str_to_title()
  
  dc_so <- dc_so %>%
    mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
    clustify(
      ref_mat = ref_mousespleenDC,
      cluster_col = "RNA_snn_res.1"
    )
  
  dc_so %>%
    qsave(here(dc_dir, "so_dc_sub_merge.qs"))
  
} else {
  rm(sobjs)
}

dc_so <- qread(here(dc_dir, "so_dc_sub_merge.qs"))

dc_type_dat <- dc_so %>%
  FetchData("type")

rm(dc_so)

dc_ag_dat <- here(dc_dir, "so_dc_merge.qs") %>%
  qread() %>%
  AddMetaData(dc_type_dat, col.name = "subtype") %>%
  .@meta.data %>%
  mutate(
    subtype    = ifelse(is.na(subtype), cell_type, subtype),
    vaccination = fct_relevel(vaccination, c("single", "dual"))
  )



# # Try annotating using combined DC reference
# rownames(ref_mousespleenDC) <- ref_mousespleenDC %>%
#   rownames() %>%
#   str_to_title()
# 
# shared_gns <- rownames(ref_mousespleenDC)
# shared_gns <- shared_gns[shared_gns %in% rownames(ref_immgen)]
# 
# ref_combined <- cbind(
#   ref_immgen[shared_gns, ],
#   ref_mousespleenDC[shared_gns, ]
# )
# 
# x <- dc_so %>%
#   mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2", "type", "r"))) %>%
#   clustify(
#     ref_mat       = ref_combined,
#     cluster_col   = "RNA_snn_res.5",
#     rename_prefix = "combined",
#     n_genes       = 2000
#   ) %>%
#   mutate_meta(dplyr::select, -any_of(c("UMAP_1", "UMAP_2"))) %>%
#   clustify(
#     ref_mat       = ref_immgen,
#     cluster_col   = "RNA_snn_res.5",
#     rename_prefix = "immgen",
#     n_genes       = 2000
#   )
# 
# x %>%
#   plot_scatter(
#     "combined_type",
#     x = "hUMAP_1", y = "hUMAP_2",
#     size = 0.001
#   ) +
#   facet_wrap(~ mouse)

# x %>%
#   plot_scatter(
#     "Ag_score",
#     x = "hUMAP_1", y = "hUMAP_2",
#     plot_colors = c("white", "red"),
#     size = 0.2, outline = TRUE
#   ) +
#   facet_wrap(~ mouse)
#   
# x %>%
#   plot_scatter(
#     "combined_r",
#     x = "hUMAP_1", y = "hUMAP_2",
#     plot_colors = c("white", "red"),
#     size = 0.2, outline = TRUE
#   ) +
#   facet_wrap(~ mouse)
# 
# x %>%
#   plot_violin(
#     "combined_r", "combined_type",
#     group_col = "mouse",
#     method = "boxplot"
#   )
# 
# x %>%
#   plot_violin(
#     "immgen_r", "immgen_type",
#     group_col = "mouse",
#     method = "boxplot"
#   )

# # Marker genes
# gns <- c(
#   "Itgax",                                             # most DCs
#   "Cd8a", "Xcr1", "Cd24a", "Clec9a", "Itgae", "Irf8",  # cDC1
#   "Clec12a", "Cx3cr1", "Cd14", "Il1a",                 # cDC2 T-bet-
#   "P2rx7", "Lyz2", "Csf1r",
#   "Tbx21", "Dtx1", "Ccr6",                             # cDC2 T-bet+
#   "Siglech", "Tcf4", "Bst2",                           # Siglec-H
#   "Cd4", "Sirpa", "Itgam",                             # cDC2
#   "Cd207",                                             # Langerhans
#   "Ccr7"                                               # CCR7 high
# )
# 
# gns <- c(
#   "Cd3e",           # T cells
#   "Fcer1a",         # Basophils
#   "Cd19", "Ms4a1",  # B cells (CD20)
#   "Cd14"            # Monocytes
# )
# 
# x <- x %>%
#   subset(mouse == "d14")
# 
# gns %>%
#   map(~ {
#     x %>%
#       plot_violin(
#         .x,
#         cluster_col = "combined_type",
#         method = "boxplot"
#       ) +
#       theme(axis.text.x = element_text(angle = 45, hjust = 1))
#   }) %>%
#   plot_grid(plotlist = .)
```

```{r "theme"}
# Plot levels
reps <- na.omit(unique(lec_so$rep))
reps <- str_c("_", reps)

lvls <- c(
  "d2", "d14",
  str_c("3wk", c("", reps)),
  str_c("6wk", c("", reps)),
  str_c("6wk-3wk", c("", reps))
)

# ggplot2 themes
txt_pt1  <- 10
txt_pt2  <- 12
ttl_pt1  <- 14
ttl_pt2  <- 16
ln_pt    <- 0.5
ln_col   <- "grey85"
cir_size <- 3.5
sqr_size <- 4

txt_theme_1 <- theme(
  strip.text   = element_text(size = ttl_pt2),
  legend.text  = element_text(size = txt_pt2),
  axis.title   = element_text(size = ttl_pt2),
  axis.text    = element_text(size = txt_pt2, color = "black"),
  legend.title = element_text(size = ttl_pt2),
)

line_theme <- theme(
  axis.line.x  = element_line(linewidth = ln_pt, color = ln_col),
  axis.line.y  = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.x = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.y = element_line(linewidth = ln_pt, color = ln_col)
)

base_theme <- djvdj_theme() +
  theme(
    plot.title       = element_text(face = "plain", size = ttl_pt2),
    strip.background = element_blank(),
    strip.text       = element_text(face = "plain")
  ) +
  txt_theme_1

umap_theme <- base_theme +
  theme(
    aspect.ratio = 0.9,
    panel.border = element_rect(color = NA, fill = NA),
    axis.title   = element_blank(),
    axis.line.x  = element_blank(),
    axis.line.y  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text    = element_blank()
  )

fade_0 <- "#FAFAFA"
fade_1 <- "#F0F0F0"
fade_2 <- "#D9D9D9"

# Colors
# Okabe Ito color palettes
ito_cols <- c(
  palette_OkabeIto[c(1:3, 5)], "#D7301F",
  palette_OkabeIto[c(4, 6)],   "#6A51A3",
  palette_OkabeIto[7],         "#875C04",
  "#065D43", "#F7AF34", "#00446E"
)

ito_cols <- ito_cols[3:length(ito_cols)] %>%
  darken(0.2) %>%
  c(ito_cols, ., "#686868", "#000000")

clrs <- ito_cols

# Cell type colors
typs <- unique(ag_dat$cell_type)

typ_clrs <- set_names(
  clrs[seq_along(typs)],
  typs
)

# Subtype colors
lec_clrs <- lec_so@meta.data %>%
  filter(cell_type %in% c("LEC", "BEC")) %>%
  pull(subtype) %>%
  unique()

lec_clrs <- set_names(
  clrs[seq_along(lec_clrs)],
  lec_clrs
)

dc_clrs <- dc_ag_dat %>%
  filter(cell_type == "DC") %>%
  pull(subtype) %>%
  unique()

dc_clrs <- set_names(
  clrs[!clrs %in% lec_clrs][seq_along(dc_clrs)],
  dc_clrs
)

dc_clrs["unassigned"] <- lec_clrs["unassigned"] <- "grey65"

# Mouse colors
m_clrs <- set_names(
  clrs[1:(length(tms) + 1)],
  c(names(tms), "6wk-3wk")
)

# Tm colors
tm_clrs <- set_names(
  clrs[seq_along(tms)],
  unname(tms)
)

tm_clrs[3] <- "#6A51A3"
tm_clrs[4] <- "#D7301F"

# Key for mouse IDs
mouse_key <- lec_so@meta.data %>%
  distinct(mouse, orig.ident)

mouse_key <- set_names(
  mouse_key$mouse, mouse_key$orig.ident
)

vacs <- c("single", "dual")
```



```{r "MARKERS TO CHECK ANNOTATIONS", eval = FALSE}
marks <- c(
  "type",
  "Ptprc", "Cd3e", "Cd19", "Nkg7", "Ccr7",
  "Adgre1", "Itgam",                  # Mon
  "Cd14", "Fcgr3", "Fcgr1",           # Mac            
  "Xcr1", "Cd8a", "Cd24a", "Clec9a", "Itgae", "Irf8",   # cDC1
  "Cd4", "Sirpa", "Itgam",                              # cDC2
  "Tbx21", "Dtx1", "Ccr6",                              # cDC2 Tbet+
  "Cx3cr1", "Csf1r", "Clec12a", "Lyz2",                 # cDC2 Tbet-
  "Ly6g", "Itgam"                                       # neutrophils
)

# marks %>%
# c("Dtx1", "Ccr6", "Runx1", "Runx2", "Runx3", "Srebf1", "Srebf2") %>%
# c("Sirpa", "Cd4", "Itgam", "Clec12a", "Cx3cr1", "Cd14", "Il1a", "Lyz2", "Csf1r") %>%
# "Cd3e" %>%
# "Sirpa" %>%
# "type" %>%
# "Cd19" %>%
# "Cd79a" %>%
# "adt_ABPS4" %>%
# "adt_ovalbumin" %>%
"subtype" %>%
  map(~ {
    cd45pos_so %>%
      mutate_meta(mutate, rough_type = str_remove(rough_type, " \\(.+$")) %>%
      mutate_meta(mutate, type = str_remove(type, " \\(.+$")) %>%
      plot_scatter(
        .x,
        "hUMAP_1", "hUMAP_2",
        group_col = "mouse",
        panel_nrow = 1, size = 0.1, top = Inf,
        outline = TRUE,
        plot_colors = c("lightblue", "white", "red"),
        # plot_colors = c(unassigned = "black")
      ) +
      theme(aspect.ratio = 0.9)
  }) %>%
  plot_grid(plotlist = .)

marks[-1] %>%
  map(~ {
    cd45pos_so %>%
      mutate_meta(mutate, type = str_remove(type, " \\(.+$")) %>%
      plot_violin(
        .x,
        cluster_col = "type",
        # group_col = "mouse",
        panel_nrow = 1,
        method = "boxplot"
      )
  }) %>%
  plot_grid(plotlist = .)
```

