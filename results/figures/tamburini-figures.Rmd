---
title: "Antigen Tracking Figures"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc:            true
    toc_float:      true
    toc_depth:      4
    df_print:       "paged"
    code_folding:   "hide"
    self_contained: true
    highlight:      "kate"
params:
  template_dir: "src"                                                                 # Rmd templates
  so_dir:       "~/Dropbox/Ryan/Projects/antigen-exchange/results/sobjs/2024-07-01"   # Seurat objects
  mod_dir:      "~/Dropbox/Ryan/Projects/antigen-exchange/results/models/2024-07-17"  # RF models
  abe_dir:      "~/Dropbox/Ryan/Projects/antigen-exchange/results/abe"                # Abe et al objects
  geomx_dir:    "results/geomx"                                                       # GeoMx objects
  chikv_dir:    "~/Dropbox/Ryan/Projects/morrison-lnsc/results/sobjs"                 # CHIKV objects
  xen_dir:      "~/Dropbox/Ryan/Projects/antigen-exchange/results/xenium/2024-03-22"  # Xenium objects
  ref_dir:      "ref"                                                                 # clustifyr references
  geo_dir:      "results/geo"                                                         # GEO submission files
  table_dir:    "results/tables/2024-07-17"                                           # tables
  sample_info:  "sample_info.xlsx"                                                    # samples names/info
  res_dir:
    value:
      exp-0: "~/Projects/antigen-tracking/results"
      exp-1: "~/Projects/tamburini-antigen-tracking/results/2022-03-11"
      exp-2: "~/Projects/tamburini-antigen-tracking/results/2022-10-28"
  xen_res_dir: "results/xenium/20240322__194506__032224_Tamburini_Run_1"                     # Directory with Xenium data
  xen_regex:   ["output-XETG00230__0022624__[A-Z]__", "output-XETG00230__0022841__[A-Z]__"]  # Regex to pull samples for Xenium slides
  xen_samples: 
    value:
      A: ["6wk", 1, 2]      # Sample identity and 6wk and 3wk barcode identity (in this order)
      B: ["6wk", 2, 1]      # e.g. `1` indicates GeoMx-Barcode01
      C: ["6wk-3wk", 1, 2]
      D: ["6wk-3wk", 2, 1]
      E: ["3wk", 2, 1]
      F: ["3wk", 1, 2]
  xen_ag_targets:
    value:
      Ag_tag_1: "GeoMx-Barcode01-ERCC00142"
      Ag_tag_2: "GeoMx-Barcode02-ERCC00144"
  xen_custom_targets:
    - "Ag-tag-A-(ERCC2)"
    - "Ag-tag-B-(ERCC3)"
    - "Ag-tag-C-(ERCC4)"
    - "T2-Sensitive-Ag-tag-(ERCC9)"
    - "T2-Resistant-Ag-tag-(ERCC12)"
    - "DNA-only-T2-Control-Ag-tag-(ERCC16)"
    - "GeoMx-Barcode01-ERCC00142"
    - "GeoMx-Barcode02-ERCC00144"
    - "CHIKV-5-(0-7566)"
    - "CHIKV-sgRNA-(7566-12036)"
    - "CHIKV-negative-(0-12036)"
    - "LCMV-(Armstrong)-Segment"
    - "Listeria-monocytogenes-10403S-gyrase-B-CP002002-1"
    - "Vaccinia-(Western-Reserve)-J6R"
    - "mRNA-vaccine-(3-UTR)"
    - "mRNA-vaccine-(ovalbumin)"
    - "mRNA-vaccine-(FLAG-3x)"
    - "mRNA-vaccine-(eGFP)"
editor_options: 
  chunk_output_type: console
---

```{r "setup", include = FALSE}
# Default chunk options
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,
  dpi     = 300
)

options(java.parameters = "-Xmx12000m")

# Set environment for running UMAP
reticulate::use_condaenv("umap", conda = "~/.local/bin/micromamba")

# Main setup
knitr::knit(here::here(params$template_dir, "setup.Rmd"), "")

# Xenium setup
xen_slides <- seq_along(params$xen_regex)

chunks <- xen_slides %>%
  map_chr(~ knit_expand(here(params$template_dir, "setup-xenium.Rmd")))

knit(text = chunks, output = "")

# Process other datasets
knit(here(params$template_dir, "setup-ml.Rmd"), "")
knit(here(params$template_dir, "setup-geomx.Rmd"), "")
knit(here(params$template_dir, "setup-abe.Rmd"), "")

# Plot parameters
min_cells <- 5
rf_typs   <- c("cLEC", "fLEC", "Collecting")
rf_tms    <- c(14, 21, 42)

ag_modules <- rf_typs %>%
  map(str_c, c("_high", "_low")) %>%
  unlist()

# Keys for naming labels
ag_clmns <- c("Ag_3wk_score", "Ag_6wk_score")

ag_labs <- set_names(
  c("Ag-score (21 day)", "Ag-score (42 day)"),
  ag_clmns
)

ag_labs_2 <- set_names(
  c("Ag-score\n21 day", "Ag-score\n42 day"),
  ag_clmns
)

# Mouse key
m_key <- c(
  d2        = "2 day",
  d14       = "14 day",
  `3wk`     = "21 day",
  `6wk`     = "42 day",
  `6wk-3wk` = "dual"
)

# Experiment to show in main figures
ag_exps <- list(LEC = "exp-1", DC = "exp-2")

# LEC/DC subset colors
subtype_clrs <- list(LEC = lec_clrs, DC = dc_clrs)
```

```{r "load xenium data"}
# Key Xenium marker genes
xen_gns <- c(
  "Ptprc",
  "Cd3d", "Cd19",
  "Cd8a",
  "Prox1", "Lyve1",
  "Pdpn", "Pecam1",
  "Itgam",  # cDC2
  "Itgax",  # DCs
  "Zbtb46", # DCs
  "Sirpa",
  "Xcr1",
  "Siglech",
  "Tbx21"
)

# Load Xenium data
xen <- xen_slides %>%
  map(~ {
    here(params$xen_dir, str_c("xen_s", .x, ".qs")) %>%
      qread() %>%
      FetchData(c(colnames(.@meta.data), xen_gns, "Car3")) %>%
      as_tibble(rownames = "cell_id") %>%
      mutate(slide = .x)
  }) %>%
  bind_rows() %>%
  mutate(
    cell_type = if_else(grepl("^other", cell_type), "unassigned", cell_type),
    cell_type = if_else(
      cell_type %in% c("Macrophages", "Monocytes"),
      "Mon/Mac",
      cell_type
    )
  )

# Top cell types to plot
dcs <- xen$cell_type %>%
  unique() %>%
  grep("DC", ., value = TRUE) %>%
  sort()

ag_dcs <- xen %>%
  filter(cell_type %in% dcs) %>%
  group_by(cell_type) %>%
  filter(all(table(Ag_class) > 15)) %>%
  pull(cell_type) %>%
  unique()

top_types <- c("LEC", dcs)

# FOVs to plot
fovs    <- sort(unique(xen$fov))
top_fov <- "D"
bad_fov <- "C"  # section from very end of LN

# Format plotting data
xen_ag_classes <- c(
  `Ag-low`  = "Ag-",
  `Ag-high` = "Ag+"
)

xen <- xen %>%
  mutate(
    Ag_class = recode(Ag_class, !!!xen_ag_classes),
    Ag_class = fct_relevel(Ag_class, unname(xen_ag_classes)),
    slide    = str_c("section ", slide)
  ) %>%
  arrange(Ag_class)

# Xenium colors
xen_clrs <- typ_clrs

xen_clrs["Mon/Mac"] <- typ_clrs["Macrophages"]

xen_clrs <- xen_clrs[names(xen_clrs) %in% xen$cell_type]
```

```{r "load naive data", include = FALSE}
# Load 24 hpi mock-infected data
# * merge mock-infected with Ag LEC object
# * to compare timepoints, need all cells used for comparison to be present when
#   scores are calculated
chikv_naive <- qread(here(params$chikv_dir, "so_lec.qs"))

chikv_naive <- chikv_naive %>%
  subset(tm == "24hpi" & treatment == "mock") %>%
  mutate_meta(mutate, tm = 0)

naive_so <- lec_so %>%
  subset(mouse != "6wk-3wk") %>%
  merge(chikv_naive)

# Add module scores
# * need to recalculate scores since we are now including the mock-infected data
rf_feats %>%
  iwalk(~ {
    clmn_nms <- str_c(.y, "_", names(.x))

    clmn_nms <- set_names(
      str_c(clmn_nms, seq_along(clmn_nms)),
      clmn_nms
    )

    naive_so <<- naive_so %>%
      mutate_meta(dplyr::select, -any_of(names(clmn_nms))) %>%
      AddModuleScore(
        features = .x,
        name     = names(clmn_nms)
      ) %>%
      mutate_meta(dplyr::rename, !!!syms(clmn_nms))
  })

naive_dat <- naive_so@meta.data %>%
  as_tibble(rownames = ".cell_id")

rm(chikv_naive, naive_so)
gc()
```

```{r "format lec data"}
# Objects to use for each cell type
ag_objs <- list(LEC = lec_so, DC = dc_so)

# Format prediction labels
# * make sure the correct predictions and module scores are being used
# * once the models are finalized, this information can be saved in the
#   meta.data
# * rf_pred will be NA if cell type was not used for training
# * pred_grp includes Ag-competent groups based on Ag predictions
lec_so <- lec_so %>%
  AddMetaData(rf_preds, col.name = str_c("rf_", colnames(rf_preds)))

lec_so <- lec_so %>%
  mutate_meta(
    mutate,
    pred_grp = ifelse(
      rf_pred == "high" & !rf_correct,
      "Ag-competent", str_c("Ag-", !!sym(rf_dat_clmn))
    ),
    rf_pred = str_c("Ag-", rf_pred),
    mouse   = fct_relevel(mouse, mice)
  )

# Add module scores
rf_feats %>%
  iwalk(~ {
    clmn_nms <- str_c(.y, "_", names(.x))

    clmn_nms <- set_names(
      str_c(clmn_nms, seq_along(clmn_nms)),
      clmn_nms
    )

    lec_so <<- lec_so %>%
      mutate_meta(dplyr::select, -any_of(names(clmn_nms))) %>%
      AddModuleScore(
        features = .x,
        name     = names(clmn_nms)
      ) %>%
      mutate_meta(dplyr::rename, !!!syms(clmn_nms))
  })
```

```{r "format CD45+ marker data", include = FALSE, eval = FALSE}
cd45_so <- qread(here(params$so_dir, "cd45pos_so.qs"))

DefaultAssay(cd45_so) <- "RNA"

cd45pos_gns <- c(
  "Ptprc",
  "Cd3d", "Cd19",
  "H2-Aa",
  "Itgax",  # DCs
  "Zbtb46", # DCs
  "Ly6c2",
  "Fcgr1",  # CD64, mon/mac
  "Itgam",  # cDC2
  "Cd14",   # mon/mac/neutrophils
  "Ly6g",   # neutrophils
  "Nkg7",   # NK cells
  "Tbx21",  # NK cells
  "Il7r"
)

lvls <- c(
  "T cells", "B cells",
  "DC", "Monocytes", "Neutrophils",
  "NK cells", "ILC"
)

# Calculate mean expression
cd45pos_marks <- cd45_so %>%
  FetchData(c("cell_type", "mouse", cd45pos_gns)) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(cd45pos_gns)) %>%
  mutate(
    cell_type = fct_relevel(cell_type, lvls),
    mouse     = fct_relevel(mouse, mice),
    name      = fct_relevel(name, rev(cd45pos_gns))
  )

rm(cd45_so)
gc()
```

```{r "format CD45- marker data", include = FALSE, eval = FALSE}
cd45_so <- qread(here(params$so_dir, "cd45neg_so.qs"))

DefaultAssay(cd45_so) <- "RNA"

cd45neg_gns <- c(
  "Ptprc",
  "Prox1", "Lyve1",
  "Pdpn", "Pecam1",
  "Cd3d", "Cd19",
  "Ly6c2",
  "Nkg7",
  "Tbx21",
  "Itgax",  # DCs
  "Zbtb46", # DCs
  "Fcgr1",  # CD64
  "Itgam"
)

lvls <- c(
  "LEC", "Fibroblasts", "BEC", "Epithelial cells",
  "T cells", "B cells",
  "DC", "NK cells"
)

# Calculate mean expression
cd45neg_marks <- cd45_so %>%
  FetchData(c("cell_type", "mouse", cd45neg_gns)) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(cd45neg_gns)) %>%
  mutate(
    cell_type = fct_relevel(cell_type, lvls),
    mouse     = fct_relevel(mouse, mice),
    name      = fct_relevel(name, rev(cd45neg_gns))
  )

rm(cd45_so)
gc()
```

---

<br>

## Figure 1

*Antigen persists in discrete cell populations within the lymph node*

A.  Experimental design
B.  Mean Ag-score is shown for each cell type for 2, 14, 21, and 42 days post
    vaccination.
C.  UMAP projection shows LEC subsets.
D.  UMAP projections show Ag-scores for LEC subsets for each timepoint.
E.  Mean Ag-score is shown for LEC subsets for each timepoint.
F.  Ag-scores are shown for each timepoint for each LEC subset.
G.  UMAP projection shows DC subsets.
H.  UMAP projections show Ag-scores for DC subsets for each timepoint.
I.  Mean Ag-score is shown for DC subsets for each timepoint.
J.  Ag-scores are shown for each timepoint for each DC subset.

<u>Notes</u>

* Only experiment 1 is shown for the LEC 21 and 42 day timepoints (including
  for the UMAPs). Experiment 2 data include very few LECs for the 21 day
  timepoint.
* Experiment 2 is shown for the DC 21 and 42 day timepoints. Experiment 1 data
  are lower quality (sparse signal, mostly zeros).
* Subsets are only shown if there are >= `r min_cells` cells for each timepoint
* CD45+ and CD45- cell types are only shown for the CD45+ and CD45- datasets,
  respectively.

```{r "type Ag heat", fig.width = 16, fig.height = 5}
# Format Ag data for broad cell types
# exclude CD45+ cell types from CD45- datasets and vice versa
cd45neg_typs <- c("LEC", "BEC", "Fibroblasts", "Epithelial cells")

typ_ag_dat <- all_meta %>%
  filter(
    vaccination == "single",
    cell_type != "unassigned"
  ) %>%
  group_by(cell_sort) %>%
  mutate(
    tm        = fct_relevel(as.character(tm), tms),
    cell_type = fct_infreq(cell_type),
    cell_type = fct_relevel(cell_type, c("LEC", "Fibroblasts", "DC"))
  ) %>%
  ungroup() %>%
  filter(
    (cell_sort == "CD45neg" & cell_type %in% cd45neg_typs) |
      (cell_sort == "CD45pos" & !cell_type %in% cd45neg_typs)
  )

# Format data for heatmap
# exclude unassigned cells since these likely include multiple cell types
heat_dat <- typ_ag_dat %>%
  group_by(tm, cell_type) %>%
  summarize(
    Ag_score = mean(Ag_score), .groups = "drop",
    n        = n()
  ) %>%
  group_by(cell_type) %>%
  mutate(cell_type = str_c(cell_type, "\nn = ", label_comma()(sum(n)))) %>%
  ungroup() %>%
  mutate(
    tm      = fct_relevel(as.character(tm), rev(as.character(tms))),
    cell_type = fct_reorder(cell_type, Ag_score, mean, .desc = TRUE)
  )

# Create heatmap summarizing Ag scores
typ_heat <- heat_dat %>%
  ggplot(aes(cell_type, tm, fill = Ag_score)) +
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "#D55E00"), na.value = "black") +
  guides(fill = guide_colorbar(
    title.position = "top", ticks = FALSE, title = "Ag-score",
    barwidth = unit(150, "pt"), barheight = unit(10, "pt")
  )) +
  labs(y = "days post vaccination") +
  base_theme +
  theme(
    plot.margin  = margin(0, 15, 0, 15),
    legend.position = "top",
    legend.justification = 0,
    legend.text  = element_text(size = txt_pt1),
    aspect.ratio = n_distinct(heat_dat$tm) / n_distinct(heat_dat$cell_type) * 0.9,
    axis.title.x = element_blank(),
    axis.text.x  = element_text(angle = 45, hjust = 1),
  )
```

```{r "subtype Ag UMAPs"}
# Data for UMAPs
# show exp1 for LECs and exp2 for DCs
fig1_dat <- ag_objs %>%
  imap(~ {
    .x@meta.data %>%
      as_tibble(rownames = ".cell_id") %>%
      filter(
        exp %in% c("exp-0", ag_exps[[.y]]),
        vaccination == "single"
      ) %>%
      mutate(tm_lab = factor(as.character(tm), tms))    
  })

# Subtype UMAPs
fig1_typ_u <- fig1_dat %>%
  imap(~ {
    typ_lvls <- .x %>%
      pull(subtype) %>%
      unique() %>%
      as.character()
    
    res <- .x %>%
      plot_scatter(
        "subtype", "hUMAP_1", "hUMAP_2",
        size         = 0.1,
        plot_colors  = c(lec_clrs, dc_clrs),
        plot_lvls    = rev(typ_lvls),
        label_params = list(size = ttl_pt1),
        panel_nrow   = 2
      ) +
      guides(color = guide_legend(ncol = 1, override.aes = list(size = 4))) +
      umap_theme +
      theme(
        aspect.ratio = 0.9,
        legend.position = "right",
        legend.title = element_blank(),
        legend.text  = element_text(size = txt_pt2)
      )
    
    res
  })

# Ag-score UMAPs
u_clrs <- list(
  LEC = c("lightblue", "white", "#D7301F"),
  DC  = c("lightblue", "white", "#6A51A3", "#6A51A3")
  # DC  = c("white", "#6A51A3")
)

fig1_ag_u <- fig1_dat %>%
  imap(~ {
    .x %>%
      filter(tm_lab %in% as.character(tms)) %>%
      plot_scatter(
        "Ag_score", "hUMAP_1", "hUMAP_2",
        plot_colors  = u_clrs[[.y]],
        label_params = list(size = ttl_pt1),
        group_col    = "tm_lab",
        panel_nrow   = 1,
        outline      = TRUE,
        size         = 0.2,
        stroke       = 0.7
      ) +
      facet_wrap(
        ~ tm_lab, nrow = 1,
        labeller = as_labeller(function(x) str_c("day ", x))
      ) +
      guides(fill = guide_colorbar(
        title.position = "right", ticks = FALSE, title = "Ag-score",
        barheight = unit(120, "pt"), barwidth = unit(10, "pt")
      )) +
      umap_theme +
      theme(
        aspect.ratio         = 0.9,
        panel.border         = element_rect(color = ln_col, linewidth = ln_pt, fill = NA),
        legend.position      = "right",
        legend.justification = 0,
        legend.title         = element_text(angle = 270, hjust = 0.5),
        strip.text.y         = element_blank()
      )
  })
```

```{r "subtype Ag boxplots", fig.width = 8, fig.height = 2}
# Format data for boxplots
ag_bx_dat <- fig1_dat %>%
  map(~ {
    .x %>%
      filter(subtype != "unassigned") %>%
      mutate(mouse = as.character(mouse)) %>%
      group_by(subtype) %>%
      filter(all(table(mouse) >= min_cells)) %>%
      ungroup() %>%
      mutate(subtype = fct_reorder(subtype, Ag_score, mean, .desc = TRUE))
  })
  
# Create boxplots
ag_bxs <- ag_bx_dat %>%
  imap(~ create_ag_boxes(.x, clrs = subtype_clrs[[.y]]))

# Pull subsets used for main figures
ag_plt_typs <- ag_bx_dat %>%
  map(~ levels(.x$subtype))
```

```{r "subtype Ag heat"}
# Create heatmaps
heat_clrs <- c(LEC = "#D7301F", DC = "#6A51A3")

ag_heats <- ag_bx_dat %>%
  imap(~ {
    dat <- .x %>%
      group_by(mouse, tm, subtype) %>%
      summarize(Ag_score = mean(Ag_score), .groups = "drop") %>%
      mutate(
        subtype = fct_reorder(subtype, Ag_score, mean),
        tm      = fct_relevel(as.character(tm), as.character(tms)),
        ttl     = "Ag-score"
      )

    rat <- n_distinct(dat$subtype) / n_distinct(dat$tm)

    dat %>%
      ggplot(aes(tm, subtype, fill = Ag_score)) +
      geom_tile() +
      facet_wrap(~ ttl) +
      labs(x = "days post vaccination") +
      scale_fill_gradientn(colours = c("lightblue", "white", heat_clrs[[.y]])) +
      guides(fill = guide_colorbar(
        ticks = FALSE, title = "Ag-score",
        barheight = unit(105, "pt"), barwidth = unit(10, "pt")
      )) +
      base_theme +
      theme(
        legend.title = element_blank(),
        aspect.ratio = rat,
        axis.title.y = element_blank(),
        plot.margin  = margin(0, 15, 0, 15),
        plot.title   = element_text(hjust = 0.5, size = ttl_pt2)
      )
  })
```

```{r "Fig 1 diagram"}
img <- readPNG(here("results/figures/experiment_design/fig1_exp_design.png"))
img <- rasterGrob(img, interpolate = TRUE)

# Adjust plot limits if necessary
img_lims <- tibble(x = c(0, 1), y = c(0, 1))

# Create an empty plot for placing the image, adjusted to fill the area
fig1_dsgn <- ggplot(img_lims, aes(x, y)) + 
  annotation_custom(
    grob = img,
    xmin = -Inf, xmax = Inf,
    ymin = -Inf, ymax = Inf
  ) +
  xlim(c(-Inf, Inf)) +
  ylim(c(-Inf, Inf)) +
  theme_void()
```

```{r "Fig 1", fig.width = 16, fig.height = 15.5}
# Create final figure
top <- plot_grid(
  fig1_dsgn, typ_heat,
  labels     = c("A", "B"),
  label_size = ttl_pt2 * 1.5,
  nrow       = 1,
  hjust      = 1.1
)

bot <- list(
  "C" = fig1_typ_u$LEC,
  "D" = fig1_ag_u$LEC,
  "E" = ag_heats[[1]],
  "F" = ag_bxs$LEC,
  "G" = fig1_typ_u$DC,
  "H" = fig1_ag_u$DC,
  "I" = ag_heats[[2]],
  "J" = ag_bxs$DC
)

bot <- bot %>%
  imap(~ .x + labs(tag = .y))

fig1 <- top /
  (bot[[1]] + bot[[2]]) /
  (bot[[3]] + bot[[4]]) /
  (bot[[5]] + bot[[6]]) /
  (bot[[7]] + bot[[8]]) +
  plot_layout(heights = c(1.4, 1, 0.7, 1, 0.7)) &
  theme(
    plot.tag = element_text(size = ttl_pt2 * 1.5, face = "bold"),
    plot.tag.position = c(0, 1)
  )

fig1
```

<br>

<br>

### Figure S1

A.  UMAP projections show cell types identified for CD45- and CD45+ samples.
B.  UMAP projections show LEC subsets identified for each timepoint.
C.  UMAP projections show DC subsets identified for each timepoint.
D.  The expression of key marker genes is shown for LEC subsets.
E.  The expression of key marker genes is shown for DC subsets.

```{r "type UMAPs"}
# Format data
typ_dat <- all_meta %>%
  mutate(
    vaccination = str_c(vaccination, "\nvaccination"),
    tm          = ifelse(is.na(tm), vaccination, str_c("day ", tm)),
    tm          = fct_relevel(tm, str_c("day ", tms)),
    cell_type   = fct_infreq(cell_type),
    cell_sort   = recode(cell_sort, CD45neg = "CD45-", CD45pos = "CD45+")
  )

n_dat <- typ_dat %>%
  group_by(tm, cell_sort) %>%
  summarize(n = str_c("n = ", label_comma()(n())), .groups = "drop")

# Create UMAP projections
typ_u <- typ_dat %>%
  plot_scatter(
    "cell_type",
    "hUMAP_1", "hUMAP_2",
    plot_colors  = typ_clrs,
    plot_lvls    = c("BEC", "LEC", "Epithelial cells", "Monocytes"),
    size         = 0.001,
    n_label      = "legend"
  ) +
  geom_text(
    aes(-Inf, Inf, label = n, color = NULL), data = n_dat,
    hjust = -0.1, vjust = 1.5, size = 10 / .pt,
    show.legend = FALSE
  ) +
  facet_grid(cell_sort ~ tm) +
  guides(color = guide_legend(nrow = 2, override.aes = list(size = 4))) +
  umap_theme_2 +
  theme(
    legend.position = "bottom",
    legend.title    = element_blank()
  )
```

```{r "subtype UMAPs"}
# Marker genes to plot
typ_gns <- list(
  LEC = c(
    "Lyve1", "Marco", "Madcam1",
    "Vcam1", "Ptx3",  "Ackr4"
  ),
  DC = c(
    "Xcr1", "Itgax", "Sirpa",
    "Lyz2", "Ccr7",  "Siglech"
  )
)

# Format data for subtype plots
subtype_dat <- ag_objs %>%
  imap(~ {
    clmns <- c("subtype", "tm", "vaccination", "hUMAP_1", "hUMAP_2")
    
    .x %>%
      FetchData(c(clmns, typ_gns[[.y]])) %>%
      as_tibble(rownames = ".cell_id") %>%
      mutate(
        vaccination = str_c(vaccination, "\nvaccination"),
        tm          = ifelse(is.na(tm), vaccination, str_c("day ", tm)),
        tm          = fct_relevel(tm, str_c("day ", tms)),
        subtype     = fct_relevel(subtype, levels(markers$annotation))
      )
  })

# Create UMAPs
subtype_u <- subtype_dat %>%
  imap(~ {
    .x %>%
      plot_scatter(
        "subtype", "hUMAP_1", "hUMAP_2",
        group_col    = "tm", panel_nrow = 2,
        n_label      = "corner",
        label_params = list(size = 14),
        size         = 0.1,
        plot_colors  = subtype_clrs[[.y]],
        plot_lvls    = levels(.x$subtype)
      ) +
      umap_theme_2 +
      theme(
        legend.position  = c(0.85, 0.25),
        legend.title     = element_blank()
      )
  })
```

```{r "subtype boxplots"}
# Create LEC/DC subtype boxplots
subtype_bxs <- subtype_dat %>%
  imap(~ {
    dat <- .x %>%
      pivot_longer(all_of(typ_gns[[.y]])) %>%
      mutate(
        subtype_tm = str_c(subtype, "_", tm),
        name       = fct_relevel(name, typ_gns[[.y]])
      ) %>%
      arrange(subtype) %>%
      mutate(subtype_tm = fct_inorder(subtype_tm))
    
    # Data for n labels
    n_labs <- dat %>%
      group_by(subtype, tm, subtype_tm) %>%
      summarize(
        n = label_comma()(n_distinct(.cell_id)),
        .groups = "drop"
      ) %>%
      mutate(
        n_lab = str_replace(subtype, "_", " "),
        n_lab = str_c(n_lab, " (", n, ")")
      )
    
    n_labs <- set_names(n_labs$n_lab, n_labs$subtype_tm)

    # Create boxplots
    n_typs <- n_distinct(dat$subtype)

    dat %>%
      ggplot(aes(subtype_tm, value, fill = subtype)) +
      geom_boxplot(outlier.size = 0.1, key_glyph = draw_key_point, alpha = 0.9) +
      facet_grid(name ~ tm, scales = "free") +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 4))) +
      scale_x_discrete(labels = n_labs) +
      scale_fill_manual(values = subtype_clrs[[.y]]) +
      base_theme +
      theme(
        aspect.ratio    = 4 / n_typs,
        legend.position = "none",
        strip.clip      = "off",
        axis.title      = element_blank(),
        axis.text.x     = element_text(angle = 90, hjust = 1, vjust = 0.5)
      )
  })
```

```{r "Fig S1", fig.width = 16, fig.height = 20}
# plts <- list(
#   "A" = typ_u,
#   "B" = 
# )

figS1 <- typ_u /
  (subtype_u$LEC + subtype_u$DC) /
  
  wrap_plots(subtype_bxs$LEC, subtype_bxs$DC, widths = c(1, 0.63)) +
  
  plot_layout(heights = c(0.7, 0.7, 1)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = ttl_pt2 * 1.5, face = "bold"))

figS1
```

<br>

<br>

### Figure S2

A.  Ag-scores are shown for each timepoint for CD45- cell types.
    Two biological replicates are shown for the day 21 and day 42 timepoints
    (r1, r2),
    one biological replicate is shown for the day 2 and day 14 timepoints
    (this replicate is plotted for both r1 and r2).
    The number of cells identified for each cell type is shown above each
    timepoint.
B.  Ag-scores are shown for each timepoint for CD45+ cell types,
    as described in A.
C.  Ag-scores are shown for each timepoint for LEC subsets, as described in A.
D.  Ag-scores are shown for each timepoint for DC subsets, as described in A.

```{r "type Ag boxplots"}
# Format data for boxplots
dat <- c("exp-1", "exp-2") %>%
  map_dfr(~ {
    typ_ag_dat %>%
      filter(exp %in% c("exp-0", .x)) %>%
      mutate(
        exp       = str_replace(.x, "exp-", "r"),
        tm        = as.numeric(as.character(tm)),
        cell_sort = recode(cell_sort, CD45neg = "CD45-", CD45pos = "CD45+")
      )
  })

# Create boxplots
typ_ag_bxs <- c("CD45-", "CD45+") %>%
  set_names() %>%
  map(~ {
    dat <- dat %>%
      filter(cell_sort == .x)
      
    n_dat <- dat %>%
      group_by(cell_sort, exp, tm, cell_type) %>%
      summarize(n = label_comma()(n()), .groups = "drop")
    
    dat %>%
      create_ag_boxes(clrs = typ_clrs, facet_vars = c("exp", "cell_type")) +
      geom_text_repel(
        aes(y = Inf, label = n), data = n_dat,
        seed = 42, force = 0.005,
        size = 8 / .pt, vjust = 1.2
      ) +
      scale_y_continuous(expand = expansion(c(0.05, 0.15))) +
      theme(plot.margin = margin(15, 15, 30, 15))
  })
```

```{r "all subtype Ag boxplots"}
# Format data for boxplots
bx_dat <- ag_objs %>%
  map(~ {
    .x@meta.data %>%
      as_tibble(rownames = ".cell_id") %>%
      filter(vaccination == "single") %>%
      group_by(mouse, subtype, exp) %>%
      ungroup() %>%
      mutate(
        mouse   = as.character(mouse),
        tm_lab  = factor(as.character(tm), tms),
        subtype = fct_reorder(subtype, Ag_score, mean, .desc = TRUE)
      )
  })

# Create boxplots showing all LEC/DC subsets
all_ag_bxs <- bx_dat %>%
  imap(~ {
    dat <- .x
    
    dat <- c("exp-1", "exp-2") %>%
      map_dfr(~ {
        dat %>%
          filter(exp %in% c("exp-0", .x)) %>%
          mutate(exp = str_replace(.x, "exp-", "r"))
      })
    
    n_dat <- dat %>%
      group_by(tm, subtype, exp) %>%
      summarize(n = label_comma()(n()), .groups = "drop")
    
    dat %>%
      create_ag_boxes(clrs = subtype_clrs[[.y]], facet_vars = c("exp", "subtype")) +
      geom_text_repel(
        aes(y = Inf, label = n), data = n_dat,
        seed = 42, force = 0.005,
        size = 8 / .pt, vjust = 1.2
      ) +
      scale_y_continuous(expand = expansion(c(0.05, 0.15))) +
      theme(plot.margin = margin(15, 15, 30, 15))
  })
```

```{r "Fig S2", fig.width = 15, fig.height = 17.5}
# Create final figure
figS2 <- plot_grid(
  typ_ag_bxs$`CD45-`, typ_ag_bxs$`CD45+`,
  all_ag_bxs$LEC, all_ag_bxs$DC,
  labels = c("A", "B", "C", "D"),
  label_size = ttl_pt2 * 1.5,
  # rel_heights = c(1.1, 1.2, 1, 1.2),
  align = "v", axis = "rl",
  ncol = 1
)

figS2
```

---

<br>

<br>

## Figure 2

*Identification of an antigen archiving gene signature*

A.  Ag-score is shown for day 14 Ag-high and -low cells identified for LEC
    subsets with the highest Ag-score.
B.  The fraction of cells predicted to be Ag-competent is shown for each LEC
    subset 14, 21, and 42 days post vaccination.
C.  Ag-high module score is shown for Ag-low, Ag-high, and predicted
    Ag-competent LECs.
    The Spearman correlation between Ag classes and Ag-high module score is
    shown for each timepoint.
    One-sided p values were calculated and adjusted using Benjamini-Hochberg
    correction.
D.  UMAP projections show cLEC Ag-high module scores for each timepoint.
E.  The expression of select genes from the Ag-high (top four) and Ag-low
    (bottom four) gene modules is shown for cLECs. Genes identified as top
    predictors for multiple LEC subsets are shown. Triangles indicate the gene
    is differentially expressed when compared to Ag-low cells. P values were
    calculated using a one-sided Wilcoxon rank sum test with Benjamini-Hochberg
    correction.

<u>Notes</u>

* Ag-low and -high cells were identified by separately clustering each d14 LEC
  subset for each sample into two groups based on Ag-score.
* The cutoffs identified for the d14 dataset were then used to identify Ag-high
  cells for the other timepoints.
* With this approach there is a different cutoff for each LEC subset, but the
  cutoff is consistent across timepoints.

```{r "RF Ag signal", fig.width = 12, fig.height = 3.25}
# Format plotting data
plt_dat <- lec_so@meta.data %>%
  filter(
    subtype %in% rf_typs,
    mouse %in% rf_mouse
  ) %>%
  mutate(
    mouse = as.character(mouse),  # to remove factor
    !!sym(rf_dat_clmn) := fct_relevel(!!sym(rf_dat_clmn), c("low", "high"))
  ) %>%
  arrange(!!sym(rf_dat_clmn))

# Format plot labels
plt_labs <- plt_dat %>%
  group_by(subtype, mouse, tm, !!sym(rf_dat_clmn)) %>%
  summarize(
    n = label_comma()(n()),
    .groups = "drop"
  ) %>%
  mutate(n = str_c(!!sym(rf_dat_clmn), ": ", n, " cells")) %>%
  group_by(subtype, mouse, tm) %>%
  arrange(!!sym(rf_dat_clmn)) %>%
  mutate(n = str_c(n, collapse = "\n"))

plt_clrs <- lec_clrs

# Create bargraphs
brs <- rf_typs %>%
  imap(~ {
    dat <- plt_dat %>%
      filter(subtype == .x) %>%
      mutate(!!sym(rf_dat_clmn) := fct_rev(!!sym(rf_dat_clmn)))
    
    dat %>%
      ggplot(aes(y = mouse, fill = subtype, alpha = !!sym(rf_dat_clmn))) +
      geom_bar() +
      facet_wrap(~ subtype, nrow = 1, scales = "free") +
      scale_alpha_manual(values = c(low = 0.35, high = 1)) +
      scale_fill_manual(values = plt_clrs) +
      scale_y_discrete(expand = expansion(c(0, 0))) +
      scale_x_continuous(expand = expansion(c(0, 0))) +
      theme_void() +
      theme(
        legend.position = "none",
        plot.margin     = margin(t = 5),
        strip.text      = element_text(size = ttl_pt2)
      )
  })

hsts <- rf_typs %>%
  imap(~ {
    dat <- plt_dat %>%
      filter(subtype == .x)
    
    fst <- .y == 1
    lst <- .y == length(rf_typs)
    
    # Create histograms
    hst <- dat %>%
      ggplot(aes(Ag_score, fill = subtype, alpha = !!sym(rf_dat_clmn))) +
      geom_histogram(bins = 30, key_glyph = draw_key_point) +
      geom_text(
        aes(-Inf, Inf, label = n),
        data = filter(plt_labs, subtype == .x),
        check_overlap = TRUE,
        alpha = 1,
        hjust = -0.25,
        vjust = 1.1,
        size  = txt_pt2 / .pt
      ) +
      facet_wrap(~ subtype, scales = "free", nrow = 1) +
      guides(fill = "none") +
      scale_alpha_manual(
        values = c(low = 0.35, high = 1),
        labels = function(x) str_c("Ag-", x)
      ) +
      scale_fill_manual(values = plt_clrs) +
      scale_y_continuous(expand = expansion(c(0.05, 0.25))) +
      guides(alpha = guide_legend(override.aes = list(shape = 22, size = 5))) +
      labs(x = "Ag-score", y = "number of cells") +
      base_theme +
      theme(
        aspect.ratio    = 0.6,
        strip.text      = element_blank(),
        legend.position = "none",
        legend.title    = element_blank(),
        plot.margin     = margin(t = 0, r = 5, b = 0, l = 5)
      )
    
    if (!fst && !lst) {
      hst <- hst +
        theme(legend.position = "bottom")
    }
    
    if (!fst) {
      hst <- hst +
        theme(axis.title.y = element_blank())
    }
    
    if (fst || lst) {
      hst <- hst +
        theme(axis.title.x = element_blank())
    }
    
    hst
  })

# Create final figure
hsts <- wrap_plots(
  append(brs, hsts),
  ncol = length(rf_tms),
  heights = c(0.1, 1)
)
```

```{r "RF Ag-competent bars", fig.width = 8, fig.height = 5}
# Format data for bargraphs
# * for main figure include cells used for training
# * exclude training data for supp figure
rf_bar_dat <- lec_so@meta.data %>%
  filter(
    tm %in% rf_tms,
    subtype %in% rf_typs
  ) %>%
  mutate(
    subtype    = fct_relevel(subtype, rf_typs),
    rf_correct = fct_relevel(as.character(rf_correct), c("TRUE", "FALSE")),
    pred_grp   = fct_relevel(pred_grp, rev(names(pred_clrs))),
    tm         = as.character(tm)
  )

bar_thm <- base_theme +
  theme(aspect.ratio = 1.4)

rf_bar_1 <- rf_bar_dat %>%
  ggplot(aes(tm, fill = pred_grp)) +
  geom_bar(position = "fill", alpha = 0.85, key_glyph = draw_key_point) +
  facet_grid(~ subtype) +
  scale_fill_manual(values = pred_clrs) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  guides(fill = guide_legend(override.aes = list(shape = 22, size = 5))) +
  labs(y = "fraction of cells", x = "days post vaccination") +
  bar_thm +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom"
  )
```

```{r "RF module boxplots", fig.width = 10, fig.height = 4}
# Format plot data
# exclude dual vaccination data
clmns <- c(
  "tm", "subtype", "pred_grp",
  "Ag_score", ag_modules
)

rf_bx_dat <- lec_so %>%
  FetchData(clmns) %>%
  as_tibble(rownames = ".cell_id") %>%
  filter(tm %in% rf_tms)

rf_mod_args <- list(
  mod_typ = c("high", "low"),
  p_alt   = c("greater", "less"),
  p_hjust = c(0.7, 0.55),
  n_label = c(FALSE, TRUE)
)

mod_bxs <- rf_mod_args %>%
  pmap(~ {
    args <- list(...)
    
    module_clmns <- str_c(rf_typs, "_", args$mod_typ)
    module_title <- str_c("Ag-", args$mod_typ, " module score")
    
    rf_bx_dat %>%
      create_rf_module_boxes(
        module_clmns = module_clmns,
        module_title = module_title,
        p_alt        = args$p_alt,
        p_hjust      = c(args$p_hjust, 0.5),
        p_vjust      = c(1.2, 2),
        clrs         = pred_clrs,
        n_label      = args$n_label,
        linewidth    = 0.6
      )
  })
```

```{r "RF cLEC module UMAPs", fig.width = 8, fig.height = 6.5}
# Format plotting data
u_dat <- lec_so@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  filter(tm %in% rf_tms) %>%
  mutate(Ag_class_ml = str_c("Ag-", Ag_class_ml))

# Create UMAPs
u_args <- list(
  typ = set_names(rf_typs),
  pt_size = list(1, c(0.5, 0.1), c(0.5, 0.1)),
  ag_clrs = list(
    c("lightblue", "lightblue", "lightblue", "white", "#D7301F"),
    c("lightblue", "white", "#D7301F"),
    c("lightblue", "white", "#D7301F")
  )
)

mod_u <- u_args %>%
  pmap(~ {
    args <- list(...)
    
    u_dat %>%
      create_rf_module_umaps(
        typ           = args$typ,
        ag_class_clmn = "Ag_class_ml",
        module_clmn   = str_c(args$typ, "_high"),
        module_title  = str_c(args$typ, " Ag-high module"),
        equal_scales  = FALSE,
        pt_size       = args$pt_size,
        ag_clrs       = args$ag_clrs
      )
  })
```

```{r "RF top features examples", fig.height = 8, fig.width = 8}
# Calculate p-values
# * use all features included in models, adjust based on this number of genes
# * adjust p-values separately for each tm and pred_grp
p_vals <- rf_feats[rf_typs] %>%
  imap_dfr(~ {
    p_alt <- c(high = "greater", low = "less")
    
    typ <- .y
    
    gns <- .x %>%
      imap(~ set_names(rep(.y, length(.x)), .x)) %>%
      reduce(c)
    
    dat <- lec_so %>%
      subset(subtype == typ & tm %in% rf_tms) %>%
      FetchData(c("pred_grp", "tm", names(gns))) %>%
      as_tibble(rownames = ".cell_id") %>%
      pivot_longer(all_of(names(gns)), names_to = "gene") %>%
      mutate(
        class = gns[gene],
        p_alt = p_alt[class]
      ) %>%
      split(.$gene)
      
    dat %>%
      map_dfr(~ {
        p_grps <- names(pred_clrs)[-1]
        p_con  <- names(pred_clrs)[1]
        
        dat <- .x
        
        p_grps %>%
          map_dfr(~ {
            dat %>%
              filter(pred_grp %in% c(p_con, .x)) %>%
              group_by(tm) %>%
              summarize(
                p = wilcox.test(
                  value[pred_grp == .x], value[pred_grp == p_con],
                  alternative = unique(p_alt),
                  exact       = FALSE
                )$p.value,
                med_diff = abs(median(value[pred_grp == .x]) - median(value[pred_grp == p_con])),
                n        = length(value[pred_grp == .x]),
                gene     = unique(gene),
                class    = unique(class),
                p_alt    = unique(p_alt),
                pred_grp = .x,
                .groups  = "drop"
              )
          })
      }) %>%
      mutate(subtype = typ)
  })

# Adjust p-values for multiple testing
# * adjust each tm and pred_grp separately
p_vals <- p_vals %>%
  group_by(tm, pred_grp, subtype) %>%
  mutate(
    p_adj   = p.adjust(p, method = "BH"),
    n_genes = n()
  ) %>%
  ungroup()

# Identify genes shared between multiple cell types
shared_feats <- rf_feats %>%
  imap_dfr(~ {
    typ <- .y
    
    .x %>%
      imap_dfr(~ {
        tibble(
          subtype = typ,
          class   = .y,
          gene    = .x,
        )
      })
  }) %>%
  group_by(class, gene) %>%
  filter(n_distinct(subtype) > 1) %>%
  ungroup()

p_dat <- p_vals %>%
  filter(
    subtype == rf_cell_type,
    p_adj < 0.05
  ) %>%
  group_by(gene) %>%
  filter(any(med_diff > 0)) %>%
  mutate(n_sig = n()) %>%
  ungroup() %>%
  arrange(desc(n_sig))

# Plot example genes
gene_examples <- lec_so %>%
  subset(subtype == rf_cell_type) %>%
  subset(tm %in% rf_tms) %>%
  create_gn_plots(
    p_data = p_dat,
    top_gns = c(
      "Naaa", "Parm1",
      "Psap", "Ctsd",
      # "Lgmn", "Grn",       # other endosome related genes
      "Col4a2", "Tmsb4x",  # cell migration, angiogenesis
      "Ctla2a", "Ltbp4"    # immune response
      # "Hmgb1", "Ccl21a"
      # "Col4a2", "Lamc1"
    ),
    n_gns     = 4,
    plt_clrs  = pred_clrs,
    x_lvls    = names(pred_clrs),
    draw_line = FALSE,
    pt_size   = 2.5
  )
```

```{r "Fig 2", fig.width = 15, fig.height = 16.1}
left <- plot_grid(
  plot_grid(hsts, nrow = 2, rel_heights = c(1, 0.1)),
  mod_bxs[[1]],
  mod_u$cLEC[[1]],
  mod_u$cLEC[[2]],
  ncol = 1,
  rel_heights = c(1, 1, 1.11, 1.1),
  labels = c("A", "C", "D"),
  label_size = ttl_pt2 * 1.5,
  label_y = c(1, 1.1, 1)
)

right <- plot_grid(
  plotlist = gene_examples,
  ncol     = 1,
  align    = "v",
  axis     = "rl",
  rel_heights = c(1, 1.225)
)

right <- plot_grid(
  rf_bar_1, right,
  ncol = 1,
  rel_heights = c(1, 3),
  labels = c("B", "E"),
  label_size = ttl_pt2 * 1.5
)

fig2 <- plot_grid(
  left, right,
  rel_widths = c(1, 0.5)
)

fig2
```

<br>

<br>

### Figure S3

A.  Venn diagram shows the number of genes shared between the cLEC, fLEC and
    collecting LEC gene modules.
A.  The top gene ontology terms (biological process, cellular component) are
    shown for the cLEC, fLEC, and collecting LEC Ag-high gene modules.
    The number of overlapping genes is shown to the right of each ontology term.
B.  Top gene ontology terms are shown for Ag-low gene modules as described in A.
C.  The expression of each Ag-high gene module is shown for naive LECs
    (0 days post vaccination) along with each time point.
D.  The expression of each Ag-low gene module is shown as described in C.
E.  The fraction of cells predicted to be Ag-low and Ag-high is shown for each
    LEC subset.
F.  Ag-low module score is shown for Ag-low, Ag-high, and predicted
    Ag-competent LECs.
    The Spearman correlation between Ag classes and Ag-high module score is
    shown for each timepoint.
    One-sided p values were calculated and adjusted using Benjamini-Hochberg
    correction.
    The number of cells plotted is shown below each boxplot.
G.  UMAP projections show fLEC Ag-high module scores for each timepoint.
H.  UMAP projections show collecting LEC Ag-high module scores for each
    timepoint.

```{r "RF venn diagram"}
rf_venn <- rf_feats[rf_typs] %>%
  map(~ c(.x, recursive = TRUE, use.names = FALSE)) %>%
  ggVennDiagram(set_size = ttl_pt2 / .pt) +
  scale_fill_gradientn(colours = c("#56B4E9", "white", "#E7301F"), name = "number\nof genes") +
  theme(
    legend.key.height = unit(12, "pt"),
    legend.key.width  = unit(7, "pt"),
    legend.ticks      = element_blank()
  )
```

```{r "RF GO"}
# Term similarity for simplifying terms
dbs <- set_names(c("BP", "CC", "MF"))

go_sim_data <- dbs %>%
  map(~ {
    godata(
      OrgDb   = org.Mm.eg.db,
      keytype = "SYMBOL",
      ont     = .x
    )
  })

# Get GO terms
rf_grps <- rf_feats %>%
  map(names) %>%
  reduce(unique)

go_res <- rf_grps %>%
  map_dfr(~ {
    grp <- .x
    
    go_feats <- rf_feats[rf_typs] %>%
      map(pluck, grp)
    
    go_sim_data %>%
      imap_dfr(~ {
        file <- str_c("ag-", grp, "_", .y, "_go")
        file <- here(params$table_dir, file)
        
        res <- go_feats %>%
          get_go(
            lec_so,
            type_clmn      = "subtype",
            max_term_size  = 1000,
            min_term_size  = 10,
            db             = .y,
            simplify_terms = TRUE,
            sim_data       = .x,
            file           = file
          )
        
        res@compareClusterResult %>%
          as_tibble() %>%
          mutate(db = .y, pred_grp = grp)
      })
  })

# Filter for significant GO terms
go_sig <- go_res %>%
  filter(p.adjust < 0.05) %>%
  arrange(p.adjust)
```

```{r "RF GO plot"}
# Plot top CC GO terms
# * only plot top BP and CC terms
go_fig <- go_sig %>%
  filter(db %in% c("CC", "BP")) %>%
  group_by(db, Cluster, pred_grp) %>%
  slice(1:5) %>%
  ungroup() %>%
  arrange(p.adjust) %>%
  split(.$pred_grp) %>%
  imap(~ {
    dat <- .x %>%
      mutate(
        y_var       = str_c(Cluster, "-", Description),
        y_var       = fct_reorder(y_var, p.adjust, min, .desc = TRUE),
        Description = str_trunc(Description, width = 60)
      )
      
    y_labs <- dat %>%
      distinct(Description, y_var)
    
    y_labs <- set_names(y_labs$Description, y_labs$y_var)
    
    dat %>%
      ggplot(aes(-log10(p.adjust), y_var, fill = Cluster)) +
      geom_col() +
      geom_vline(xintercept = -log10(0.05), color = "black", linetype = 2) +
      geom_text(
        aes(label = GeneRatio),
        hjust = -0.1
      ) +
      
      facet_grid(space = "free", scales = "free_y", rows = vars(Cluster)) +
      labs(title = str_c("Ag-", .y), x = "-log10(p-value)") +
      scale_x_continuous(expand = expansion(c(0, 0.15))) +
      scale_y_discrete(labels = y_labs) +
      scale_fill_manual(values = lec_clrs) +
      base_theme +
      theme(
        legend.position = "none",
        plot.title      = element_text(size = ttl_pt2, hjust = 0.25),
        strip.clip      = "off",
        axis.title.y    = element_blank(),
        axis.text.y     = element_text(size = txt_pt1)
      )
  }) %>%
  plot_grid(
    plotlist   = .,
    nrow       = 1,
    align      = "vh",
    axis       = "trbl",
    labels     = c("B", "C"),
    label_size = ttl_pt2 * 1.5
  )

# Create final GO figure
go_fig <- plot_grid(
  rf_venn, go_fig,
  nrow       = 1,
  rel_widths = c(0.5, 1),
  labels     = c("A", ""),
  label_size = ttl_pt2 * 1.5
)
```

```{r "RF naive expression", fig.width = 10, fig.height = 4}
naive_dat <- naive_dat %>%
  filter(subtype %in% rf_typs) %>%
  pivot_longer(all_of(ag_modules), names_to = "module_type") %>%
  separate(module_type, sep = "_", into = c("module_type", "module_ag")) %>%
  
  filter(subtype == module_type) %>%
  
  mutate(
    module_type = str_c(module_type, " Ag-", module_ag),
    tm = fct_relevel(as.character(tm), c("0", tms))
  )

naive_fig <- naive_dat %>%
  split(.$module_ag) %>%
  imap(~ {
    .x %>%
      ggplot(aes(tm, value, fill = subtype)) +
      geom_boxplot(linewidth = 0.7, outlier.size = 0.25, width = 0.5) +
      facet_grid(~ module_type) +
      scale_fill_manual(values = lec_clrs) +
      labs(x = "days post vaccination", y = "module score") +
      base_theme +
      theme(
        aspect.ratio = 1.1,
        legend.position = "none"
      )
  })

naive_fig <- plot_grid(
  plotlist = append(naive_fig, list(NULL)),
  nrow  = 1,
  align = "h",
  axis  = "tb",
  rel_widths = c(1, 1, 0.5),
  labels     = c("D", "E", ""),
  label_size = ttl_pt2 * 1.5
)
```

```{r "RF predicted Ag class", fig.width = 8, fig.height = 5}
# Plot fraction predicted groups
rf_bar_2 <- rf_bar_dat %>%
  filter(!rf_training_data) %>%
  ggplot(aes(tm, fill = rf_pred, alpha = rf_correct)) +
  geom_bar(position = "fill") +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = 0.5)) +
  scale_fill_manual(values = pred_clrs) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  facet_grid(~ subtype) +
  labs(y = "fraction of cells", x = "days post vaccination") +
  guides(
    fill = guide_legend(order = 1, title = "prediction"),
    alpha = guide_legend(title.theme = element_blank())
  ) +
  bar_thm
```

```{r "Fig S3", fig.width = 20, fig.height = 22}
top <- plot_grid(
  rf_bar_2, mod_bxs[[2]],
  rel_widths = c(0.75, 1),
  labels = c("F", "G"),
  label_size = ttl_pt2 * 1.5,
  align = "h",
  axis  = "tb"
)

left <- plot_grid(
  plotlist = mod_u$fLEC,
  ncol  = 1,
  align = "v",
  axis  = "rl"
)

right <- plot_grid(
  plotlist = mod_u$Collecting,
  ncol  = 1,
  align = "v",
  axis  = "rl"
)

bot <- plot_grid(
  left, right,
  labels = c("H", "I"),
  label_size = ttl_pt2 * 1.5,
  nrow  = 1,
  align = "h",
  axis  = "tb"
)

figS3 <- plot_grid(
  go_fig, naive_fig, top, bot,
  ncol = 1,
  rel_heights = c(0.5, 0.5, 0.5, 1)
)

figS3
```

```{r "GENE SIMILARITY", eval = FALSE, inclue = FALSE}
go_info <- go_sig %>%
  filter(Cluster == "cLEC", pred_grp == "high") %>%
  
  select(Cluster, ID, Description, geneID, p.adjust) %>%
  mutate(geneID = str_split(geneID, pattern = "/")) %>%
  unnest(geneID) %>%
  arrange(geneID, p.adjust)

# Simplified GO terms
gns <- rf_feats$cLEC$high

go <- gns %>%
  enrichGO(
    OrgDb   = org.Mm.eg.db,
    keyType = "SYMBOL",
    ont     = "BP"
  )



# go@result <- go[go$ID %in% go_info$ID]


sim <- pairwise_termsim(new)

x <- new %>%
  clusterProfiler::simplify(cutoff = 0.5)

# # GO slim terms
# go_slim_terms <- getBM(
#   attributes = c("go_id", "goslim_goa_accession", "goslim_goa_description"), 
#   filters = "go",
#   values = unique(go_sig$ID),
#   mart = m_mart
# )
# 
# # Prepare GO data to measure gene similarity
# go_sim_data <- godata(
#   OrgDb   = org.Mm.eg.db,
#   keytype = "SYMBOL",
#   ont     = "BP"
# )
# 

# # biomaRt GO terms
# biomrt <- "ensembl"
# m_mart <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
# 
# gn_ids <- getBM(
#   attributes = c("external_gene_name", "entrezgene_id", "go_id"),
#   filters    = "external_gene_name",
#   values     = gns,
#   mart       = m_mart
# )
```

```{r "GENE SIMILARITY-2", eval = FALSE, include = FALSE}
# Calculate gene similarity
typ  <- "Collecting"
clss <- "high"
db   <- "CC"
gns  <- rf_feats[[typ]][[clss]]

gn_sim <- mgeneSim(gns, semData = go_sim_data[[db]])
gn_sim <- as.dist(1 - gn_sim)

# Cluster genes
clsts <- gn_sim %>%
  hclust() %>%
  cutree(k = 10)

clst_list <- split(names(clsts), as.factor(clsts))

# Identify GO terms for each gene cluster
res <- get_go(
  genes         = clst_list,
  so_in         = subset(lec_so, subtype == typ),
  max_term_size = 5000,
  min_term_size = 10,
  db            = db,
  sim_data      = go_sim_data[[db]]
)



# res@compareClusterResult %>%
#   select(-bgID) %>%
#   mutate(geneID = str_split(geneID, "/")) %>%
#   unnest(geneID) %>%
#   
#   group_by(ID) %>%
#   mutate(n_genes = n_distinct(geneID), term_size = as.numeric(str_extract(BgRatio, "^[0-9]+"))) %>%
#   filter(term_size < 2000) %>%
#   arrange(Cluster, desc(n_genes), p.adjust) %>%
#   
#   group_by(geneID) %>%
#   
#   ungroup() %>%
#   as.data.frame() %>%
#   arrange(Cluster, p.adjust) %>%
#   filter(p.adjust < 0.05)



# res@compareClusterResult %>%
#   select(-bgID) %>%
#   mutate(geneID = str_split(geneID, "/")) %>%
#   unnest(geneID) %>%
#   
#   group_by(ID) %>%
#   mutate(n_genes = n_distinct(geneID)) %>%
#   arrange(Cluster, desc(n_genes), p.adjust) %>%
#            
#   group_by(geneID) %>%
#   
#   slice(1) %>%
#   
#   ungroup()
  
  

# x <- go_res %>%
#   mutate(
#     geneID = str_split(geneID, "/")
#   ) %>%
#   unnest(geneID) %>%
#   filter(geneID %in% names(clsts)) %>%
#   mutate(go_clst = clsts[geneID]) %>%
#   group_by(go_clst, ID) %>%
#   mutate(n_genes = n_distinct(geneID)) %>%
#   ungroup() %>%
#   select(-bgID)
# 
# x %>%
#   filter(
#     Cluster == "Collecting",
#     pred_grp == "high",
#     db == "BP"
#   ) %>%
#   group_by(go_clst) %>%
#   slice_max(n_genes, n = 5) %>%
#   ungroup() %>%
#   arrange(go_clst, desc(n_genes)) %>%
# 
#   filter(go_clst == 1) %>%
#   group_by(geneID) %>%
#   slice_min(p.adjust, n = 1) %>%
#   slice_max(n_genes) %>%
#   ungroup() %>%
#   arrange(geneID, desc(n_genes), p.adjust)
# 
# go <- gost(
#   clsts,
#   organism = "mmusculus"
# )
# 
# # biomaRt GO terms
# biomrt <- "ensembl"
# m_mart <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
# 
# attrs <- c(
#   "external_gene_name", "entrezgene_id",
#   "go_id", "goslim_goa_accession", "goslim_goa_description"
# )
# 
# gn_ids <- getBM(
#   attributes = attrs,
#   filters    = "external_gene_name",
#   values     = gns,
#   mart       = m_mart
# )
```

<br>

<br>

### Table S1

Stats are included for each random forest model.

```{r}
rf_clmns <- c(
  "F1", "Balanced Accuracy",
  "Precision", "Recall",
  "mtry", "min.node.size", "num.trees"
)

tbl_s1 <- rf_mods_best %>%
  filter(subtype %in% rf_typs) %>%
  select(cell_type = subtype, all_of(rf_clmns)) %>%
  mutate(cell_type = fct_relevel(cell_type, rf_typs)) %>%
  arrange(cell_type)

tbl_s1 %>%
  write_tsv(here(params$table_dir, "table_s1.tsv"))

tbl_s1
```

<br>

<br>

### Table S2

Genes used to train random forest models are included along with p-values
indicating overall feature importance.

```{r}
tbl_s2 <- rf_mods_best %>%
  filter(subtype %in% rf_typs) %>%
  mutate(subtype = fct_relevel(subtype, rf_typs)) %>%
  arrange(subtype) %>%
  pmap_dfr(~ {
    args <- list(...)
    typ  <- as.character(args$subtype)
    
    gns <- args$feats_p %>%
      names() %>%
      str_replace_all("_", "-") %>%  # names were adjusted when training models
      str_remove("^x")               # fix names here
    
    tibble(
      cell_type = args$subtype,
      gene      = gns,
      p_value   = args$feats_p
    ) %>%
      mutate(
        Ag_class = case_when(
          gene %in% rf_feats[[typ]]$high ~ "Ag-high",
          gene %in% rf_feats[[typ]]$low  ~ "Ag-low"
        )
      )
  })

tbl_s2 %>%
  write_tsv(here(params$table_dir, "table_s2.tsv"))

tbl_s2
```

<br>

<br>

### Table S3

Gene ontology terms are shown for
Ag-low and Ag-high cells.

```{r}
ex_clmns <- c(
  "bgID", "n_ovlp", "tot_genes",
  "n_bg_ovlp", "tot_bg_genes",
  "Count", "enrichment"
)

tbl_s3 <- go_sig %>%
  rename(Ag_class = pred_grp, cell_type = Cluster) %>%
  mutate(Ag_class = str_c("Ag-", Ag_class)) %>%
  arrange(cell_type, Ag_class, p.adjust) %>%
  select(-all_of(c(ex_clmns))) %>%
  relocate(Ag_class, .after = cell_type)
  
tbl_s3 %>%
  write_tsv(here(params$table_dir, "table_s3.tsv"))

tbl_s3
```

---

<br>

<br>

## Figure 3

*Antigen archiving is enhanced by sequential vaccinations*

A.  Experimental design
B.  Mean 21 day Ag-score is shown for LECs from mice that received a single
    vaccination (21 day or 42 day) or dual vaccination (21 day and 42 day).
C.  UMAP projections show 21 day Ag-scores for LEC subsets for single and dual
    vaccinations.
D.  Prior vaccination enhances antigen archiving.
    Ag-score is shown for single and dual vaccinations for the 21 day timepoint
    for each LEC subset. Other timepoints are shown in grey. P values
    were calculated using a one-sided Wilcoxon rank sum test with
    Benjamini-Hochberg correction.
E.  Mean 42 day Ag-score is shown as described in A.
F.  UMAP projections show 42 day Ag-scores for LEC subsets as described in B.
G.  Successive vaccinations enhances retention of previously archived antigen.
    Ag-score is shown for the 42 day timepoint as described in C.
H.  21 day and 42 day Ag-score is compared for LEC subsets.
I.  Ag-high module scores described in Figure 2 are shown for LECs that archived
    antigens from both vaccinations (double-high), from only one vaccination
    (single-high), or have low levels of both antigens (Ag-low). Module scores
    are shown for the corresponding LEC subset. P values were calculated using
    a one-sided Wilcoxon rank sum test with Benjamini-Hochberg correction.
J.  Ag-low module scores are shown for LEC subset as described in H.

```{r "exchange UMAPs", fig.width = 16, fig.height = 4}
# Format Ag exchange plot data
# use experiment 1 since, experiment 2 is missing 3wk LECs
ex_dat <- lec_so@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  filter(exp %in% c("exp-0", ag_exps$LEC)) %>%
  mutate(
    mouse = m_key[as.character(mouse)],
    mouse = fct_relevel(mouse, unname(m_key))
  )

# Create UMAPs
ex_heat_args <- list(
  ag_clmns = ag_clmns,
  clr      = tm_clrs[c("21", "42")]
)

ex_u <- ex_heat_args %>%
  pmap(~ {
    dat <- ex_dat %>%
      filter(exp == ag_exps$LEC)
    
    # mx_sig <- max(dat[ex_heat_args$ag_clmns])
    
    dat %>%
      plot_scatter(
        ..1,
        x           = "hUMAP_1",
        y           = "hUMAP_2",
        group_col   = "mouse",
        panel_nrow  = 1,
        outline     = TRUE,
        size        = 0.6,
        stroke      = 0.7,
        plot_colors = c("lightblue", "white", ..2),
        label_params = list(size = ttl_pt1)
      ) +
      # scale_fill_gradientn(colours = c("lightblue", "white", ..2), limits = c(0, mx_sig)) +
      guides(fill = guide_colorbar(
        ticks = FALSE,
        title = ag_labs[.x],
        barheight = unit(150, "pt"), barwidth = unit(10, "pt")
      )) +
      umap_theme +
      theme(
        legend.position = "right",
        panel.border    = element_rect(color = ln_col, linewidth = ln_pt)
      )
  })
```

```{r "exchange heatmaps"}
# Format data for heatmaps
heat_dat <- ex_dat %>%
  filter(
    exp == ag_exps$LEC,
    subtype %in% ag_plt_typs$LEC
  ) %>%
  group_by(mouse, subtype) %>%
  summarize(across(all_of(ag_clmns), mean), .groups = "drop")

# Create heatmaps
ex_heat <- ex_heat_args %>%
  pmap(~ {
    heat_dat %>%
      create_exchange_heats(
        ag_clmn = .x,
        ttl     = ag_labs_2[[.x]],
        clr     = .y
      )
  })
```

```{r "exchange boxes"}
# Effect of successive vaccinations on antigen uptake/retention
# use LEC subsets shown in Fig 1
ex_bx_args <- list(
  tm      = c("21", "42"),
  tm_clmn = c("tm_3", "tm_6"),
  ag_clmn = c("Ag_score_3", "Ag_score_6"),
  p_hjust = c(0.5, 0.8)
)

ex_bxs <- ex_bx_args %>%
  pmap(~ {
    args <- list(...)
    
    ex_dat %>%
      create_exchange_boxes(
        tm        = args$tm,
        tm_clmn   = args$tm_clmn,
        ag_clmn   = args$ag_clmn,
        typs      = ag_plt_typs$LEC,
        clrs      = tm_clrs,
        p_cutoff = Inf,
        p_hjust   = args$p_hjust,
        p_vjust   = 0.7
      )
  })
```

```{r "exchange correlation", fig.width = 10, fig.height = 4}
# Format scatter plot data
scat_dat <- lec_so@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  filter(
    vaccination == "dual",
    subtype %in% ag_plt_typs$LEC,
  ) %>%
  mutate(subtype = fct_relevel(subtype, ag_plt_typs$LEC))

ex_scat <- scat_dat %>%
  split(.$exp) %>%
  map(create_exchange_scatter)
```

```{r "exchange Ag-high module scores", fig.width = 9, fig.height = 5.5}
# Format plot data
# module scores for biological replicates are similar
# pool all cells together to increase power
clmns <- c(
  "exp", "subtype", "mouse", "vaccination",
  "rf_pred", "Ag_class_dual", ag_modules
)

ex_mod_bx_dat <- lec_so %>%
  FetchData(clmns) %>%
  filter(vaccination == "dual") %>%
  mutate(Ag_class_dual = recode(Ag_class_dual, low = "Ag-low")) %>%
  
  mutate(Ag_class_dual = ifelse(
    Ag_class_dual == "Ag-low" & rf_pred == "Ag-high",
    "Ag-competent",
    Ag_class_dual)
  )

# Create boxplots
bx_lvls <- c("Ag-low", "Ag-competent", "single-high", "double-high")

rf_mod_args$p_x <- c(1, 4)
rf_mod_args$p_hjust <- c(0.2, 0.8)

ex_mod_bxs <- rf_mod_args %>%
  pmap(~ {
    args <- list(...)

    module_clmns <- str_c(rf_typs, "_", args$mod_typ)
    module_title <- str_c("Ag-", args$mod_typ, " module score")

    ex_mod_bx_dat %>%
      create_module_boxes(
        module_clmns = module_clmns,
        module_title = module_title,
        lvls         = bx_lvls,
        p_alt        = args$p_alt,
        p_x          = args$p_x,
        p_hjust      = args$p_hjust
      ) +
      theme(plot.margin = margin(15, 15, 5, 15))
  })
```

```{r "Fig 3 diagram", fig.width = 15.5, fig.height = 10}
img <- "results/figures/experiment_design/fig3_exp_design_landscape-2.png"
img <- readPNG(here(img))
img <- rasterGrob(img, interpolate = TRUE)

# Adjust plot limits if necessary
img_lims <- tibble(x = c(0, 1), y = c(0, 1))

# Create an empty plot for placing the image, adjusted to fill the area
fig3_dsgn <- ggplot(img_lims, aes(x, y)) + 
  annotation_custom(
    grob = img,
    xmin = -Inf, xmax = Inf,
    ymin = -Inf, ymax = Inf
  ) +
  xlim(c(-Inf, Inf)) +
  ylim(c(-Inf, Inf)) +
  theme_void() +
  theme(plot.margin = margin(0, 0, 30, 0))

fig3_dsgn <- plot_grid(
  fig3_dsgn, NULL,
  rel_widths = c(1, 0.4)
)
```

```{r "Fig 3", fig.width = 15.5, fig.height = 23}
fig3 <- fig3_dsgn /
  (ex_heat[[1]] + ex_u[[1]]) / ex_bxs[[1]] /
  (ex_heat[[2]] + ex_u[[2]]) / ex_bxs[[2]] /
  ex_scat[[ag_exps$LEC]] /
  (ex_mod_bxs[[1]] + ex_mod_bxs[[2]]) +
  plot_layout(heights = c(1.1, 1, 0.55, 1, 0.55, 0.8, 0.95)) +
  plot_annotation(tag_levels = "A") &
  theme(
    plot.tag = element_text(size = ttl_pt2 * 1.5, face = "bold"),
    plot.tag.position = c(0, 1)
  )

fig3
```

<br>

<br>

### Figure S4

A.  Ag-score is shown for single and dual vaccinations for the 21 day timepoint
    for DC subsets from a biological replicate.
    This analysis was not performed for a biological replicate for LEC subsets
    due to the low number of LECs recovered (<40 total cells).
    Other timepoints are shown in grey.
    P values were calculated using a one-sided Wilcoxon rank sum test with
    Benjamini-Hochberg correction.
B.  Ag-score is shown for the 42 day timepoint for LEC subsets from a
    biological replicate, as described in A.
C.  Ag-score is shown for the 42 day timepoint for DC subsets from a biological
    replicate, as described in A.
D.  21 day and 42 day Ag-score is compared for LEC subsets from a biological
    replicate.

```{r "rep exchange boxes"}
# Set input data
# * plot replicates not shown in main figure
exps        <- c("exp-1", "exp-2")
plt_lec_exp <- exps[exps != ag_exps$LEC]
plt_dc_exp  <- exps[exps != ag_exps$DC]

ex_bx_args$exps <-list(
  list(LEC = NULL,        DC = plt_dc_exp),
  list(LEC = plt_lec_exp, DC = plt_dc_exp)
)

# Create boxplots for biological replicates
rep_ex_bxs <- ex_bx_args %>%
  pmap(~ {
    args <- list(...)
    
    objs <- purrr::discard(args$exps, is.null)
    objs <- ag_objs[names(objs)]
    
    objs %>%
      imap(~ {
        dat <- .x@meta.data
        
        dat <- args$exps[[.y]] %>%
          map_dfr(~ {
            dat %>%
              filter(exp %in% c("exp-0", .x))
          })
        
        dat %>%
          create_exchange_boxes(
            tm         = args$tm,
            tm_clmn    = args$tm_clmn,
            ag_clmn    = args$ag_clmn,
            clrs       = tm_clrs,
            typs       = ag_plt_typs[[.y]],
            p_hjust    = args$p_hjust,
            facet_vars = "subtype",
            p_cutoff   = Inf
          ) +
          scale_y_continuous(expand = expansion(c(0.05, 0.15)))
      })
  }) %>%
  flatten()
```

```{r "RF module exchange correlation", fig.height = 8}
# Set plot colors
ex_ag_clrs <- c(
  `double-high` = "#D7301F",
  `single-high` = "black",
  `Ag-low`      = "#56B4E9"
  # `single-high` = "#6A51A3",
)

# Format plotting data
scat_dat <- lec_so@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  filter(vaccination == "dual") %>%
  mutate(Ag_class_dual = recode(Ag_class_dual, low = "Ag-low"))

# Create scatter plots
scat_args <- list(
  mod_typ     = c("high", "low"),
  label_x     = c(-Inf, Inf),
  label_hjust = c(-0.1, 1.1)
)

ex_mod_scat <- scat_args %>%
  pmap(~ {
    args <- list(...)
    
    module_clmns <- str_c(rf_typs, "_", args$mod_typ)
    module_title <- str_c("Ag-", args$mod_typ, " module score")
    
    scat_dat %>%
      create_module_scatter(
        ag_clmns     = ag_clmns,
        module_clmns = module_clmns,
        clrs         = ex_ag_clrs,
        module_title = module_title,
        label_x      = args$label_x,
        label_hjust  = args$label_hjust
      )
  })
```

```{r "Fig S4", fig.width = 13, fig.height = 15}
# Create final figure
top <- wrap_plots(rep_ex_bxs, ncol = 1) /
  ex_scat$`exp-2` /
  plot_layout(heights = c(1, 1, 1, 1.5)) +
  plot_annotation(tag_levels = "A") &
  theme(
    legend.margin     = margin(r = 5),
    plot.tag          = element_text(size = ttl_pt2 * 1.5, face = "bold"),
    plot.tag.position = c(0, 1)
  )

bot <- plot_grid(
  plotlist = ex_mod_scat[1:2],
  nrow = 1,
  labels = c("E", "F"),
  label_size = ttl_pt2 * 1.5 
)

figS4 <- plot_grid(
  top, bot,
  ncol = 1,
  rel_heights = c(4.5, 2.7)
)

figS4
```

---

<br>

<br>

## Figure 4

*Antigen exchange with DCs correlates with levels of antigen archiving*

A.  Antigen counts are shown for adjacent LN tissue sections from
    a dual-immunized mouse analyzed with the Xenium platform.
B.  Localization of Ag+ and Ag- cells is shown for LECs for tissue sections
    from A.
C.  Localization of Ag+ and Ag- cells is shown for DCs for tissue sections from
    A.
C.  The distance to the closest Ag+ LEC is shown for Ag+ and Ag- DCs for tissue
    sections from A.
D.  Mean 21 day Ag-score is shown for DCs from mice that received a single
    vaccination (21 day or 42 day) or dual vaccination (21 day and 42 day).
E.  Ag-score is shown for single and dual vaccinations for the 21 day timepoint
    for DC subsets with highest Ag-score. Other timepoints are shown in grey.
    P values were calculated using a one-sided Wilcoxon rank sum test with
    Benjamini-Hochberg correction.
F.  Mean 42 day Ag-score is shown for DCs from mice that received single or
    dual vaccination as described in F.
G.  Ag-score is shown for single and dual vaccinations for the 42 day timepoint
    as described in G.

```{r "xenium Ag counts"}
plot_xenium <- function(df_in, dat_clmn, grp_clmn = NULL, clrs = NULL,
                        x = "y_cell", y = "x_cell", ttl = NULL,
                        pt_size = 0.35, outline = TRUE,
                        trans = "identity", show_scale = TRUE, scale_len = 300,
                        scale_linewidth = 1,
                        scale_unit = "\u03BCm", scale_lab_pad = 0.05,
                        scale_lab_size = 8, ...) {
  
  is_num <- !is.null(dat_clmn) && is.numeric(df_in[[dat_clmn]])
  
  if (is_num && length(clrs) == 1) clrs <- c("white", clrs)
  
  # Create UMAPs
  res <- df_in %>%
    plot_scatter(
      dat_clmn,
      x            = x,
      y            = y,
      group_col    = grp_clmn,
      size         = pt_size,
      stroke       = 0.75,
      outline      = outline,
      plot_colors  = clrs,
      plot_lvls    = names(clrs),
      trans        = trans,
      label_params = list(size = 14),
      ...
    ) +
    coord_fixed() +
    umap_theme_2 +
    theme(
      legend.position = "bottom",
      legend.text     = element_text(size = ttl_pt2),
      strip.text      = element_text(size = ttl_pt2)
    )
  
  if (is_num) {
    res <- res +
      guides(fill = guide_colorbar(
        title.position = "top",
        title          = ttl,
        ticks          = FALSE
      )) +
      theme(
        legend.key.width  = unit(35, "pt"),
        legend.key.height = unit(7, "pt"),
        legend.title      = element_text(size = ttl_pt2, hjust = 0.5)
      )
    
  } else if (!is.null(dat_clmn)) {
    res <- res +
      guides(fill = guide_legend(
        nrow           = 2,
        title.position = "top",
        title          = ttl,
        override.aes   = list(size = 4, color = "black"),
        reverse        = TRUE
      )) +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank()
      )
  }

  # Add scale bar
  scale_dat <- df_in %>%
    summarize(
      x    := min(!!sym(x)),
      ymax := max(!!sym(y)),
      y    := min(!!sym(y)),
      xend  = x + scale_len,
      yend  = y
    ) %>%
    mutate(
      xlab      = median(c(x, xend)),
      ylab      = abs(diff(c(ymax, y))),
      ylab      = y + (ylab * scale_lab_pad),
      scale_lab = str_c(c(as.character(scale_len), scale_unit), collapse = " ")
    )
  
  if (show_scale) {
    res <- res +
      geom_segment(
        aes(x = x, xend = xend, y = y, yend = yend, fill = NULL, color = NULL),
        data = scale_dat,
        linewidth = scale_linewidth
      ) +
      geom_text(
        aes(xlab, ylab, label = scale_lab, fill = NULL, color = NULL),
        data  = scale_dat,
        size  = scale_lab_size / .pt
      )
  }
  
  res
}

# Format plot data
xen_dat <- xen %>%
  filter(fov %in% top_fov) %>%
  mutate(
    type_ag = if_else(
      cell_type %in% c("LEC", "DC", "B cells"),
      cell_type,
      "other"
    ),
    type_ag = fct_relevel(type_ag, c("LEC", "DC", "other")),
    
    Ag_class = fct_relevel(Ag_class, rev(unname(xen_ag_classes))),
    
    type_ag = if_else(
      type_ag %in% c("LEC", "DC"),
      str_c(type_ag, " (", Ag_class, ")"),
      type_ag
    ),
    
    lec_ag = ifelse(cell_type %in% c("LEC", "B cells"), type_ag, "other"),
    dc_ag  = ifelse(cell_type %in% c("DC", "B cells"),  type_ag, "other"),
  ) %>%
  arrange(type_ag, Ag_class) %>%
  mutate(
    across(c(type_ag, lec_ag, dc_ag), ~ fct_relevel(.x, unique(type_ag))),
    slide = fct_relevel(slide, str_c("section ", xen_slides))
  )

# Plot Ag+ cells
# * add pseudo count
ag_sig_fig <- xen_dat %>%
  mutate(Ag_counts = Ag_counts + 1) %>%
  plot_xenium(
    "Ag_counts",
    grp_clmn       = "slide",
    clrs           = c("white", xen_clrs[["LEC"]]),
    ttl            = "Ag counts + 1",
    trans          = "log10",
    trace_position = "bottom",
    panel_nrow     = 2
  )
```

```{r "xenium Ag class"}
# Adjust color palette
new_clrs <- c("white", xen_clrs[c("B cells", "DC", "LEC")]) %>%
  expand_colors(
    n             = c(1, 1, 2, 2),
    keep_original = TRUE,
    filter        = c("deutan", "protan", "tritan"),
    difference    = Inf,
    direction     = -1,
    range         = c(10, 90),
    maxit         = 2000
  ) %>%
  rev()

names(new_clrs) <- c(
  "LEC (Ag+)", "LEC (Ag-)",
  "DC (Ag+)", "DC (Ag-)",
  "B cells", "other"
)

# Plot Ag+ cells
ag_pos_fig <- c("lec_ag", "dc_ag") %>%
  map(~ {
    xen_dat %>%
      plot_xenium(
        .x,
        grp_clmn       = "slide",
        clrs           = new_clrs,
        pt_size        = 0.2,
        trace_position = "bottom",
        panel_nrow     = 2
      )
  })
```

```{r "xenium LEC proximity", fig.width = 18, fig.height = 13}
# Format data for histograms
hist_dat <- xen_dat %>%
  filter(cell_type == "DC")
  
# Format data for median lines
ln_dat <- hist_dat %>%
  group_by(slide, fov, cell_type, Ag_class) %>%
  summarize(
    lec_dist = median(lec_dist),
    n        = n(),
    .groups  = "drop"
  )

# Format data for n labels
n_dat <- ln_dat %>%
  group_by(slide, fov, cell_type) %>%
  mutate(
    n_lab = str_c(Ag_class, " ", label_comma()(n), " cells")
  ) %>%
  summarize(
    n_lab = str_c(n_lab, collapse = "\n"),
    .groups = "drop"
  )

# Format data for p-values
p_dat <- hist_dat %>%
  group_by(slide, fov, cell_type) %>%
  summarize(
    p = wilcox.test(
      lec_dist[Ag_class == "Ag+"],
      lec_dist[Ag_class == "Ag-"],
      alternative = "less"
    )$p.value,
    .groups = "drop"
  ) %>%
  mutate(p_adj = p.adjust(p, method = "BH")) %>%
  rowwise() %>%
  mutate(
    p_lab = .format_pvalue(p_adj),
    p_lab = ifelse(
      p_adj != 0,
      str_c("italic(p) == ", p_lab),
      p_lab
    )
  ) %>%
  ungroup()

# Plot distance from nearest Ag+ LEC
hist <- hist_dat %>%
  mutate(lec_dist = lec_dist + 1) %>%  # ADD 1
  ggplot(aes(lec_dist, fill = Ag_class, alpha = Ag_class)) +
  
  geom_density(aes(color = Ag_class)) +
  geom_vline(
    aes(xintercept = lec_dist, color = Ag_class, alpha = NULL),
    data      = ln_dat,
    linetype  = 2,
    linewidth = 0.75,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = 1, y = Inf, label = n_lab, fill = NULL, alpha = NULL),
    data = n_dat,
    hjust = 0,
    vjust = 1.2,
    size  = txt_pt2 / .pt,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = Inf, y = Inf, label = p_lab, fill = NULL, alpha = NULL),
    data  = p_dat,
    parse = TRUE,
    hjust = 1.1,
    vjust = 1.2,
    size  = txt_pt2 / .pt,
    show.legend = FALSE
  ) +
  
  facet_wrap(~ slide, nrow = 1) +
  labs(x = "distance from nearest Ag+ LEC (\U00B5m)", y = "density") +
  scale_fill_manual(values  = c(`Ag-` = other_clr, `Ag+` = xen_clrs[["LEC"]])) +
  scale_color_manual(values = c(`Ag-` = "black",  `Ag+` = xen_clrs[["LEC"]])) +
  scale_alpha_manual(values = c(`Ag-` = 0.5,      `Ag+` = 0.85)) +
  scale_x_log10() +
  scale_y_continuous(expand = expansion(c(0.05, 0.2))) +
  base_theme +
  theme(
    aspect.ratio    = 0.5,
    legend.position = "right",
    legend.title    = element_blank(),
    strip.text      = element_text(size = ttl_pt2),
    legend.text     = element_text(size = ttl_pt2),
    axis.title      = element_text(size = ttl_pt2)
  )
```

```{r "xenium figure", fig.width = 14, fig.height = 8.5}
top <- append(list(ag_sig_fig), ag_pos_fig) %>%
  imap(~ .x + labs(tag = LETTERS[.y])) %>%
  wrap_plots(nrow = 1)

bot <- wrap_plots(
  plot_spacer(), hist + labs(tag = "D"), plot_spacer(),
  nrow = 1,
  widths = c(0.3, 1, 0.3)
)

xen_fig <- wrap_plots(
  top, bot,
  ncol = 1,
  heights = c(1, 0.35)
) &
  theme(
    plot.tag = element_text(
      size  = ttl_pt2 * 1.5,
      face  = "bold",
      hjust = 2,
      vjust = -0.2
    )
  )
```

```{r "DC exchange heatmaps", fig.width = 16, fig.height = 4}
# Format data for DC exchange plots
dc_ex_dat <- dc_so@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  filter(
    exp %in% c("exp-0", ag_exps$DC),
    subtype %in% ag_plt_typs$DC
  ) %>%
  mutate(
    mouse = m_key[as.character(mouse)],
    mouse = fct_relevel(mouse, unname(m_key))
  )

# Format data for heatmaps
dc_heat_dat <- dc_ex_dat %>%
  filter(exp == ag_exps$DC) %>%
  group_by(mouse, subtype) %>%
  summarize(across(all_of(ag_clmns), mean), .groups = "drop")

# Create heatmaps
dc_ex_heat <- ex_heat_args %>%
  pmap(~ {
    dc_heat_dat %>%
      create_exchange_heats(
        ag_clmn = .x,
        ttl     = ag_labs_2[[.x]],
        clr     = .y
      )
  })
```

```{r "DC exchange boxes", fig.width = 10, fig.height = 2}
# Effect of successive vaccinations on antigen uptake/retention
# * use DC subsets shown in figure 1
dc_ex_bxs <- ex_bx_args %>%
  pmap(~ {
    args <- list(...)
    
    dc_ex_dat %>%
      create_exchange_boxes(
        tm        = args$tm,
        tm_clmn   = args$tm_clmn,
        ag_clmn   = args$ag_clmn,
        typs      = ag_plt_typs$DC[1:3],
        clrs      = tm_clrs,
        p_size    = 11,
        p_hjust   = args$p_hjust,
        p_vjust   = 0.7
      ) +
      theme(legend.position = "bottom")
  })
```

```{r "Fig 4", fig.width = 14, fig.height = 21}
bot <- list(
  E   = dc_ex_heat[[1]],
  `F` = dc_ex_bxs[[1]],
  G   = dc_ex_heat[[2]],
  H   = dc_ex_bxs[[2]]
)

bot <- bot %>%
  imap(~ .x + labs(tag = .y))

bot <- wrap_plots(
  bot,
  nrow = 2,
  widths = c(0.25, 1)
) &
  theme(
    plot.tag = element_text(size = ttl_pt2 * 1.5, face = "bold"),
    plot.tag.position = c(0, 1)
  )

fig4 <- plot_grid(
  xen_fig, NULL, bot,
  ncol = 1,
  rel_heights = c(1.7, 0.01, 1)
)

fig4
```

<br>

<br>

### Figure S6

A.  Localization of annotated cell types is shown for replicate tissue sections
    analyzed with the Xenium platform.
    Annotated cell types with >100 identified cells are shown.
    Color indicates cell density.
B.  Total Ag counts are shown for the 21 day and 42 day Ag tags, for mice
    immunized with the 21 day tag (left), 42 day tag (middle),
    or both 21 and 42 day tags (right).
    For each immunization group, tissue sections were analyzed for two LNs from
    separate mice (LN-1, LN-2), with the exception of the dual-immunization group.
    For each LN, two adjacent tissue sections were analyzed
    (section 1, section 2).
B.  The fraction of Ag+ cells is shown for each cell type for tissue sections
    shown in Figure 4A.

```{r "xenium cell type sections", fig.width = 14, fig.height = 10}
# Format data for plots
xen_typs <- xen_dat$cell_type %>%
  table() %>%
  sort(decreasing = TRUE)

xen_typs <- xen_typs[xen_typs > 100]
xen_typs <- xen_typs[names(xen_typs) != "unassigned"]

# Function to set number of bins based on number of cells
fn <- approxfun(c(last(xen_typs), xen_typs[[1]]), c(45, 100))

# Create base plot to use for overlaying frequency data
base_xen <- xen_dat %>%
  plot_xenium(
    dat_clmn = NULL,
    grp_clmn = "slide",
    fill = "white"
  )

# Create plots
typ_plts <- names(xen_typs) %>%
  map(~ {
    typ <- .x
    
    typ_dat <- xen_dat %>%
      filter(cell_type == typ)
    
    ttl <- typ_dat %>%
      nrow() %>%
      label_comma()() %>%
      str_c(typ, " (n = ", ., ")")
    
    base_xen +
      geom_bin2d(
        aes(y_cell, x_cell),
        data = typ_dat,
        bins = floor(fn(xen_typs[[typ]]))
      ) +
      
      ggtitle(ttl) +
      guides(fill = guide_colorbar(ticks = FALSE)) +
      scale_fill_gradientn(
        colours = c("white", xen_clrs[[typ]]),
        name = "number of cells"
      ) +
      facet_wrap(~ slide, nrow = 1) +
      umap_theme_2 +
      theme(
        plot.title        = element_text(hjust = 0.5),
        legend.position   = "bottom",
        legend.key.height = unit(7, "pt"),
        legend.key.width  = unit(20, "pt"),
        legend.title      = element_text(size = 10, hjust = 0.5),
        legend.text       = element_text(size = 10),
        legend.title.position = "top"
      )
  })

typ_plts <- typ_plts %>%
  wrap_plots(ncol = 3)
```

```{r "xenium total Ag counts", fig.height = 6, fig.width = 20, include = FALSE}
# Format plotting data
xen_ag_clmns <- c(
  Ag_3wk_counts = "21 day",
  Ag_6wk_counts = "42 day"
)

feats <- c(
  "mouse", "fov", "cell_type",
  "nCount_Xenium", "nCount_Xenium_custom",
  names(xen_ag_clmns), params$xen_ag_targets,
  recursive = TRUE, use.names = FALSE
)

xen_ag_clrs <- set_names(
  tm_clrs,
  str_c(names(tm_clrs), " day")
)

xen_qc_dat <- seq_along(xen_slides) %>%
  map(~ {
    s <- qread(here(params$xen_dir, str_c("xen_s", .x, ".qs")))
    
    DefaultAssay(s) <- "Xenium_custom"
    
    s %>%
      FetchData(feats, slot = "counts") %>%
      as_tibble(rownames = ".cell_id") %>%
      pivot_longer(all_of(names(xen_ag_clmns)), names_to = "Ag-tag") %>%
      mutate(slide  = .x)
  }) %>%
  bind_rows() %>%
  filter(!fov %in% bad_fov)

# Format heatmap data
xen_bar_dat <- xen_qc_dat %>%
  group_by(slide, fov, mouse, `Ag-tag`) %>%
  mutate(
    tot_counts = sum(nCount_Xenium + nCount_Xenium_custom)
  ) %>%
  group_by(slide, fov, mouse, `Ag-tag`, tot_counts) %>%
  summarize(
    value   = sum(value),
    .groups = "drop"
  ) %>%
  group_by(slide, mouse, `Ag-tag`) %>%
  mutate(
    LN = str_c("LN-", seq_along(fov))
  ) %>%
  ungroup() %>%
  mutate(
    slide    = str_c("section ", slide),
    `Ag-tag` = xen_ag_clmns[`Ag-tag`],
    tm       = str_c(tm_key[mouse], " day"),
    tm       = replace_na(tm, "dual")
  )

rm(xen_qc_dat)
gc()

# Create bar graph
xen_bars <- xen_bar_dat %>%
  ggplot(aes(LN, value, fill = `Ag-tag`)) +
  geom_col(position = position_dodge2()) +
  facet_grid(slide ~ tm, scales = "free_x", space = "free") +
  scale_fill_manual(values = xen_ag_clrs) +
  labs(y = "total Ag counts") +
  base_theme +
  theme(
    legend.position = "bottom",
    axis.title.x = element_blank()
  )
```

```{r "xenium Ag+ cell types", fig.width = 14, fig.height = 6}
bar_dat <- xen_dat %>%
  filter(cell_type %in% c(names(xen_typs), "unassigned")) %>%
  group_by(cell_type, fov, slide) %>%

  group_by(slide, fov, cell_type) %>%
  summarize(
    n = n_distinct(cell_id),
    n_ag = sum(Ag_class == "Ag+"),
    .groups = "drop"
  ) %>%
  filter(n_ag > 0) %>%
  mutate(
    pct_ag_pos = (n_ag / n),
    
    n_ag  = ifelse(n_ag > 1000, str_c(round(n_ag / 1000, 1), "k"), label_comma()(n_ag)),
    n     = ifelse(n > 1000, str_c(round(n / 1000, 1), "k"), label_comma()(n)),
    n_lab = str_c(n_ag, "/", n)
  )
    
# Create bargraphs
xen_typ_bars <- bar_dat %>%
  mutate(
    cell_type = fct_reorder(cell_type, pct_ag_pos),
    fov       = fct_reorder(fov, pct_ag_pos, .fun = max)
  ) %>%
  group_by(fov, slide) %>%
  
  ggplot(aes(pct_ag_pos, cell_type, fill = cell_type)) +
  geom_col() +
  geom_text(
    aes(label = n_lab),
    hjust = -0.25
  ) +
  facet_wrap(~ slide, nrow = 1) +
  scale_fill_manual(values = xen_clrs) +
  scale_x_continuous(
    labels = label_percent(),
    name   = "% Ag+ cells",
    expand = expansion(c(0.05, 0.3))
  ) +
  base_theme +
  theme(
    # aspect.ratio = 1,
    legend.position = "none",
    axis.title.y = element_blank()
  )
```

```{r "Fig S6", fig.width = 14, fig.height = 16}
bot <- wrap_plots(
  xen_bars + labs(tag = "B"),
  xen_typ_bars + labs(tag = "C"),
  nrow   = 1,
  widths = c(0.7, 1)
) &
  theme(plot.tag = element_text(face = "bold", size = ttl_pt2 * 1.5))

# bot <- plot_grid(
#   xen_bars, xen_typ_bars,
#   nrow   = 1,
#   align  = "h",
#   axis   = "tb",
#   labels = c("B", "C"),
#   label_size = ttl_pt2 * 1.5,
#   rel_widths = c(0.7, 1)
# )

plot_grid(
  typ_plts, bot,
  ncol = 1,
  rel_heights = c(1, 0.4),
  labels = c("A", ""),
  label_size = ttl_pt2 * 1.5
)
```

<br>

<br>

### Figure S7

A.  Sample identity is shown for all regions analyzed using the GeoMx DSP
    platform.
B.  Annotated regions are shown as described in A.
C.  Relative antigen tag signal is shown for each sample and each
    region segmented based on Lyve1 (LECs) and CD11C (DCs).
    Normalized 21 day antigen signal was scaled across all regions from 21 day
    mice and dual immunized mice,
    42 day antigen signal was scaled across all regions from 42 day mice and
    dual immunized mice.
    The number of plotted segments is shown above each boxplot.
    P values were calculated using a one-sided Wilcoxon rank sum test with
    Benjamini-Hochberg correction, p values <0.05 are shown.
D.  Normalized antigen tag signal is shown for regions that included both Lyve1+
    and CD11C+ segments.
    21 day antigen signal is shown for 21 day and dual immunized mice,
    42 day signal is shown for 42 day and dual immunized mice.
    The Spearman correlation coefficient is shown.    

```{r "geomx uncropped images", fig.width = 10, fig.height = 8}
plot_geomx_image <- function(obj_in, color, clrs = NULL, labs = NULL,
                             legend_values = names(labs) %||% names(clrs),
                             ttl = NULL, line_size = 0.5, scale_size = 8,
                             scale_dist = 1.5, ...) {
  
  # `NA`s will get plotted since all segements must be included in the object
  #  to plot. `NA`s are segments that did pass QC.
  
  labs <- labs %||% waiver()
  ttl  <- ttl %||% color
  
  res <- obj_in %>%
    plotSpatialOverlay(
      colorBy          = color,
      scaleBar         = TRUE,
      corner           = "bottomleft",
      textDistance     = scale_dist,
      scaleBarLineSize = line_size,
      scaleBarFontSize = scale_size / .pt,
      ...
    ) +
    ggtitle(ttl) +
    theme(
      plot.margin  = margin(r = 15, l = 15),
      plot.title   = element_text(hjust = 0.5, size = ttl_pt2 * 1.5),
      legend.title = element_blank()
    )
  
  if (!is.null(legend_values)) {
    all_sams_df <- tibble(x = 1, y = 1, colorBy = legend_values)
    
    res <- res +
      geom_blank(aes(x, y, fill = colorBy), data = all_sams_df)
  }
  
  if (!is.null(clrs)) {
    if (is.numeric(obj_in@plottingFactors[[color]])) {
      res <- res +
        scale_fill_gradientn(colours = clrs) +
        guides(fill = guide_colorbar(ticks = FALSE)) +
        theme(
          legend.position   = "bottom",
          legend.key.width  = unit(50, "pt"),
          legend.key.height = unit(7, "pt"),
          legend.text       = element_text(size = txt_pt2)
        )
      
    } else {
      res <- res +
        scale_fill_manual(
          values = clrs,
          labels = labs,
          limits = names(labs) %||% names(clrs),
          drop   = FALSE
        ) +
        theme(legend.text = element_text(size = ttl_pt2))
    }
  }
  
  res
}

# GeoMx arguments
img_args <- list(
  color = c("Sample", "Region", "Segment", "Ag-score"),
  clrs  = list(geo_m_clrs, reg_clrs, seg_clrs, c("white", "#D7301F")),
  labs  = list(geo_m_key, NULL, geo_seg_key, NULL),
  ttl   = list(NULL, NULL, "Segment type", "Ag signal")
)

# Plot uncropped images
all_img_fig <- img_args %>%
  pmap(~ {
    args <- list(...)
    
    res <- geomx_imgs %>%
      imap(~ {
        res <- .x %>%
          plot_geomx_image(
            color = args$color,
            clrs  = args$clrs,
            labs  = args$labs,
            ttl   = .y
          )
        
        # Only show legend for slide 1, since wrap_plots() does not correctly
        # 'collect' the legends
        if (!identical(.y, names(geomx_imgs[1]))) {
          res <- res +
            theme(legend.position = "none")
        }
        
        res
      }) %>%
      wrap_plots(
        guides = "collect",
        nrow = 1
      )
  })

# Create final figure
all_img_fig <- plot_grid(
  plotlist = all_img_fig[1:2],
  nrow     = 1,
  align    = "h",
  axis     = "tb",
  labels   = c("A", "B"),
  label_size = ttl_pt2 * 1.5
)
```

```{r "geomx Ag boxplots", fig.height = 4}
# Signals to plot
geo_clmns <- c(
  Ag_3wk_score = "Ag signal (21 day)",
  Ag_6wk_score = "Ag signal (42 day)"
)

# Function for strip labels
geo_lab_fn <- function(x) {
  keys <- list(geo_m_key, geo_seg_key)
  
  keys %>%
    walk(~ {
      idx    <- x %in% names(.x)
      x[idx] <- .x[x[idx]]
      x      <<- x
    })
  
  x
}

# Calculate relative Ag signal
# want to plot both Ag tags on same plot
# this is not useful without scaling values since Ag-3wk signal is much higher
# than Ag-6wk signal
bx_dat <- geo_clmns %>%
  imap_dfr(~ {
    sam <- str_extract(.y, "(?<=Ag_)[0-9]+wk")
    
    geomx_dat %>%
      filter(
        sample %in% c(sam, "6wk-3wk"),
        Segment %in% c("Lyve1", "CD11C")
      ) %>%
      mutate(
        key = .y,
        Ag_rel = as.numeric(scale(!!sym(.y))),
        Segment = fct_relevel(Segment, names(seg_clrs))
      )
  })

# Calculate p-values
# * one-sided wilcox test with BH correction
p_dat <- bx_dat %>%
  split(.$Segment) %>%
  imap_dfr(~ {
    mx <- max(.x$Ag_rel)
    mn <- min(.x$Ag_rel)
    
    pairwise.wilcox.test(
      .x$Ag_rel, .x$region_3,
      p.adjust.method = "none",
      alternative = "greater"
    ) %>%
      tidy() %>%
      mutate(
        Segment = .y,
        y_max   = mx,
        y_dif   = diff(c(mn, mx))
      )
  }) %>%
  mutate(
    p_adj = p.adjust(p.value, method = "BH"),
    y_max = max(y_max),
    y_dif = max(y_dif)
  ) %>%
  rowwise() %>%
  mutate(p_lab = .format_pvalue(p_adj))

p_dat <- p_dat %>%
  filter(p_adj < 0.05) %>%
  group_by(Segment) %>%
  
  arrange(
    desc(match(group1, names(reg_clrs))),
    desc(match(group2, names(reg_clrs)))
  ) %>%
  
  mutate(
    y = row_number(),
    y = y_max + (y_dif * (0.15 * y))
  ) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(
    x1   = match(group1, names(reg_clrs)),
    x2   = match(group2, names(reg_clrs)),
    x    = min(c(x1, x2)),
    xend = max(c(x1, x2)),
    p_x  = x + ((xend - x) / 2)
  ) %>%
  ungroup() %>%
  mutate(Segment = fct_relevel(Segment, names(seg_clrs)))

# Calculate n values
n_dat <- bx_dat %>%
  group_by(region_3, Segment) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(n = str_c("n = ", n))

# Create boxplots
geo_bxs <- bx_dat %>%  
  ggplot(aes(region_3, Ag_rel, fill = region_3)) +
  geom_boxplot(
    linewidth = ln_pt * 1.5, alpha = 1, outlier.color = NA, width = 0.65,
    key_glyph = draw_key_point
  ) +
  geom_jitter(size = 2, width = 0.1) +
  geom_text(
    aes(region_3, Inf, label = n, fill = NULL),
    data  = n_dat,
    vjust = 1.4,
    size  = txt_pt2 / .pt
  ) +
  
  # Add p-values
  geom_segment(
    aes(x = x, xend = xend, y = y, fill = NULL),
    data = p_dat
  ) +
  geom_text(
    aes(x = p_x, y = y, fill = NULL, label = p_lab),
    data = p_dat,
    vjust = -0.2,
    hjust = 0.4,
    parse = TRUE
  ) +
  
  facet_grid(~ Segment, scales = "free_y", labeller = as_labeller(geo_lab_fn)) +
  scale_fill_manual(values = reg_clrs) +
  scale_y_continuous(expand = expansion(c(0.05, 0.2))) +
  labs(y = "Relative Ag signal") +
  base_theme +
  theme(
    aspect.ratio    = 1.4,
    legend.position = "none",
    axis.text.x     = element_text(size = ttl_pt2, angle = 45, hjust = 1),
    axis.title.y    = element_text(size = ttl_pt2),
    axis.title.x    = element_blank()
  )
```

```{r "geomx Ag scatter"}
# Format data
# * want to plot both Ag tags on same plot
sct_dat <- geo_clmns %>%
  imap_dfr(~ {
    sam <- str_extract(.y, "(?<=Ag_)[0-9]+wk")
    
    geomx_dat %>%
      filter(
        sample %in% c(sam, "6wk-3wk"),
        Segment %in% c("Lyve1", "CD11C")
      ) %>%
      mutate(
        key      = .y,
        Ag_score = !!sym(.y)
      )
  })

sct_dat <- sct_dat %>%
  dplyr::select(
    `ROI Coordinate X`, `ROI Coordinate Y`,
    region_3, Segment, sample, key,
    Ag_score
  ) %>%
  group_by(key, `ROI Coordinate X`, `ROI Coordinate Y`) %>%
  filter(all(c("Lyve1", "CD11C") %in% Segment)) %>%
  ungroup() %>%
  mutate(Segment = str_c(Segment, "+ Ag signal")) %>%
  pivot_wider(names_from = Segment, values_from = Ag_score) %>%
  mutate(
    tm = str_extract(key, "[0-9+]wk"),
    tm = as.character(tm_key[tm])
  )

# Legend labels
sct_labs <- sct_dat %>%
  group_by(key, tm) %>%
  summarize(n = str_c("n = ", n()), .groups = "drop") %>%
  mutate(n = str_c(geo_clmns[key], "\n", n))

sct_labs <- set_names(sct_labs$n, sct_labs$tm)

# Calculate correlation
cor <- cor(
  sct_dat$`CD11C+ Ag signal`,
  sct_dat$`Lyve1+ Ag signal`,
  method = "spearman"
)
cor <- round(cor, digits = 2)
cor = str_c("italic(r[s]) == ", cor)

geo_sct <- sct_dat %>%
  ggplot(aes(`CD11C+ Ag signal`, `Lyve1+ Ag signal`, color = tm)) +
  geom_smooth(method = "lm", color = "black", alpha = 0.1, linewidth = 0.5, linetype = 2) +
  geom_point(size = 3) +
  annotate(
    "text",
    x = min(sct_dat$`CD11C+ Ag signal`),
    y = max(sct_dat$`Lyve1+ Ag signal`),
    label = cor,
    parse = TRUE,
    hjust = -0.3,
    vjust = 0.5,
    color = "black",
    size  = ttl_pt1 / .pt,
  ) +
  scale_color_manual(values = tm_clrs, labels = sct_labs) +
  scale_x_continuous(transform = "log10") +
  scale_y_continuous(transform = "log10") +
  guides(color = guide_legend(override.aes = list(size = 4))) +
  base_theme +
  theme(
    aspect.ratio = 1,
    legend.title = element_blank(),
    legend.text  = element_text(size = ttl_pt2),
    axis.title   = element_text(size = ttl_pt2)
  )
```

```{r "Fig S7", fig.width = 14, fig.height = 11.5}
bot <- plot_grid(
  geo_bxs, geo_sct,
  nrow   = 1,
  align  = "h",
  axis   = "tb",
  labels = c("C", "D"),
  label_size = ttl_pt2 * 1.5
)

figS6 <- plot_grid(
  all_img_fig, bot,
  ncol = 1,
  rel_heights = c(1, 0.5)
)

figS6
```

---

<br>

<br>

## Figure 5

*Antigen archiving is impaired during CHIKV infection*

A.  UMAP projections show LEC subsets for mock and CHIKV-infected mice.
B.  UMAP projections show predicted Ag-competent cLECs for mock and
    CHIKV-infected mice.
C.  The fraction of predicted Ag-competent cLECs is shown for mock and
    CHIKV-infected mice for each biological replicate. P values were calculated
    using Fisher's exact test with Benjamini-Hochberg correction.
D.  UMAP projections show cLEC Ag-high module scores for mock and CHIKV-infected
    mice.
E.  cLEC Ag-high module scores are shown for mock and CHIKV-infected mice for
    each biological replicate. P values were calculated
    using a two-sided Wilcoxon rank sum test with Benjamini-Hochberg correction.
F.  Expression of the cLEC Ag-high gene module is shown for mock and CHIKV-infected
    mice for cLECs from each biological replicate.

```{r "CHIKV data", include = FALSE}
# CHIKV theme
chikv_clrs <- c(
  `Ag-low`       = "#56B4E9",
  `Ag-competent` = "#D7301F",
  other          = "white"
)

treat_clrs <- set_names(chikv_clrs[1:2], c("mock", "CHIKV"))

chikv_u_theme <- umap_theme_2 +
  theme(aspect.ratio = 0.7)

# Load CHIKV data
rm(ag_objs)
gc()

chikv_so <- qread(here(params$chikv_dir, "so_lec.qs"))

chikv_so <- chikv_so %>%
  subset(tm == "24hpi") %>%
  AddMetaData(chikv_preds, col.name = str_c("rf_", colnames(chikv_preds)))

chikv_so <- chikv_so %>%
  mutate_meta(
    mutate,
    pred_grp  = dplyr::recode(rf_pred, high = "Ag-competent", low = "Ag-low"),
    pred_grp  = fct_relevel(pred_grp, rev(names(chikv_clrs))),
    treatment = fct_relevel(treatment, c("mock", "CHIKV")),
    subtype   = lec_subtype  # add subtype column to keep consistent with other
  )                          # objects

chikv_so <- chikv_so %>%
  AddMetaData(FetchData(., c("hUMAP_1", "hUMAP_2")))

# Add module scores
rf_feats %>%
  iwalk(~ {
    clmn_nms <- str_c(.y, "_", names(.x))

    clmn_nms <- set_names(
      str_c(clmn_nms, seq_along(clmn_nms)),
      clmn_nms
    )

    chikv_so <<- chikv_so %>%
      AddModuleScore(
        features = .x,
        name     = names(clmn_nms)
      ) %>%
      mutate_meta(dplyr::rename, !!!syms(clmn_nms))
  })

# Data for plotting
chikv_dat <- chikv_so@meta.data %>%
  as_tibble(rownames = ".cell_id")
```

```{r "CHIKV subsets"}
# LEC subsets
top <- chikv_dat %>%
  plot_scatter(
    "lec_subtype",
    x            = "hUMAP_1",
    y            = "hUMAP_2",
    group_col    = "treatment",
    plot_colors  = lec_clrs,
    size         = 0.75,
    label_params = list(size = ttl_pt2)
  ) +
  chikv_u_theme +
  theme(
    legend.title = element_blank(),
    legend.text  = element_text(size = 11.5),
    panel.border = element_blank()
  )
```

```{r "CHIKV Ag class UMAPs"}
# Create UMAPs
u_args <- list(
  typ = set_names(rf_typs),
  pt_size = list(1, c(0.5, 0.1), c(0.5, 0.1))
)

chikv_u <- u_args %>%
  pmap(~ {
    chikv_dat %>%
      create_rf_module_umaps(
        typ           = .x,
        ag_class_clmn = "pred_grp",
        module_clmn   = str_c(.x, "_high"),
        module_title  = str_c(.x, " Ag-high module"),
        facet_var     = "treatment",
        lab_fn        = "label_value",
        class_clrs    = chikv_clrs,
        ag_clrs       = c("lightblue", "white", "#D7301F"),
        pt_size       = 0.75,
        circle_cells  = FALSE,
        show_scale_title = TRUE
      )
  })
```

```{r "CHIKV Ag class bargraphs"}
# Format data for bargraphs
chikv_bar_dat <- chikv_dat %>%
  filter(subtype %in% rf_typs) %>%
  mutate(subtype = fct_relevel(subtype, rf_typs))

# Create Ag class bargraphs
chikv_ag_bars <- chikv_bar_dat %>%
  filter(subtype == rf_cell_type) %>%
  create_chikv_class_bars(
    x   = "treatment",
    n_p = n_distinct(chikv_bar_dat$subtype),
    ttl = str_c("fraction Ag-competent ", rf_cell_type, "s")
  ) +
  theme(strip.text = element_blank())
```

```{r "CHIKV Ag module score boxplots"}
# Format data for plotting
chikv_bx_dat <- chikv_dat %>%
  filter(subtype %in% rf_typs) %>%
  mutate(subtype = fct_relevel(subtype, rf_typs))

# Plot Ag module scores
chikv_ag_bxs <- chikv_bx_dat %>%
  filter(subtype == rf_cell_type) %>%
  create_chikv_module_boxes(
    module_clmns = "cLEC_high",
    ttl          = "cLEC Ag-high module",
    n_p          = length(ag_modules)
  ) +
  theme(strip.text = element_blank())
```

```{r "CHIKV Ag-high heatmap"}
# Ag-high heatmap data
# * two genes are not in the CHIKV object
heat_feats <- rf_feats$cLEC$high
heat_feats <- heat_feats[heat_feats %in% rownames(chikv_so)]

heat_dat <- chikv_so %>%
  FetchData(c("treatment", "rep", "lec_subtype", heat_feats)) %>%
  filter(lec_subtype %in% rf_cell_type) %>%
  pivot_longer(all_of(heat_feats)) %>%
  group_by(lec_subtype, treatment, rep, name) %>%
  summarize(value = mean(value), .groups = "drop")

gn_lvls <- heat_dat %>%
  pivot_wider(names_from = treatment, values_from = value) %>%
  mutate(value = CHIKV / mock, .keep = "unused") %>%
  arrange(desc(value)) %>%
  pull(name) %>%
  unique()
  
heat_dat <- heat_dat %>%
  group_by(name) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup() %>%
  mutate(
    treatment = fct_relevel(treatment, c("mock", "CHIKV")),
    name      = fct_relevel(name, rev(gn_lvls))
  )

# Ag heatmap
heat <- heat_dat %>%
  ggplot(aes(name, rep, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = c("#56B4E9", "white", "#D7301F")) +
  facet_wrap(~ treatment, ncol = 1, strip.position = "left") +
  guides(fill = guide_colorbar(
    barwidth = unit(150, "pt"),
    barheight = unit(6, "pt")
  )) +
  base_theme +
  theme(
    aspect.ratio    = length(rf_typs) / length(heat_feats),
    strip.placement = "outside",
    strip.clip      = "off",
    legend.position = "bottom",
    legend.title    = element_blank(),
    axis.title      = element_blank(),
    axis.text.x     = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )
```

```{r "Cormac's figure"}
img_g <- readPNG(here("results/figures/morrison_chikv/fig5g.png"))
img_h <- readPNG(here("results/figures/morrison_chikv/fig5h.png"))

fig5gh <- list(img_g, img_h) %>%
  map(~ {
    img <- rasterGrob(.x, interpolate = TRUE)
    
    # Adjust plot limits if necessary
    img_lims <- tibble(x = c(0, 1), y = c(0, 1))
    
    # Create an empty plot for placing the image, adjusted to fill the area
    ggplot(img_lims, aes(x, y)) + 
      annotation_custom(
        grob = img,
        xmin = -Inf, xmax = Inf,
        ymin = -Inf, ymax = Inf
      ) +
      xlim(c(-Inf, Inf)) +
      ylim(c(-Inf, Inf)) +
      theme_void()
  }) %>%
  plot_grid(
    plotlist = .,
    nrow     = 1,
    align    = "h",
    axis     = "tb",
    labels   = c("G", "H"),
    label_size = ttl_pt2 * 1.5,
    rel_widths = c(1, 0.7)
  )
```

```{r "Cormac's data", eval = FALSE}
# Format data for plot
tbl_nm <- "ova+ LECs (%)"

pzfx_dat <- read_pzfx(
  here("results/figures/morrison_chikv/TEM2306 results.pzfx"),
  table = tbl_nm
)

pzfx_lvls <- colnames(pzfx_dat)

pzfx_clrs <- set_names(
  c("#56B4E9", "#E69F00", "#D7301F"),
  pzfx_lvls
)

pzfx_dat <- pzfx_dat %>%
  as_tibble() %>%
  filter(if_any(everything(), ~ !is.na(.x))) %>%
  mutate(mouse = row_number()) %>%
  pivot_longer(-mouse) %>%
  filter(!is.na(value)) %>%
  mutate(name = fct_relevel(name, pzfx_lvls))

# Add significance labels based on Cormac's original plot
pzfx_sig <- list(
  `CHIKV 181/25` = "*",
  `polyI:C/ova`  = "**"
)

p_dat <- pzfx_dat %>%
  pull(name) %>%
  unique() %>%
  expand.grid(., .) %>%
  filter(
    Var1 != Var2,
    Var1 == last(pzfx_lvls),
  ) %>%
  mutate(Var2 = fct_relevel(Var2, pzfx_lvls)) %>%
  arrange(desc(Var2)) %>%
  mutate(
    sig  = pzfx_sig[as.character(Var2)],
    y    = 110 + (10 * (row_number() - 1)),
    x    = match(Var2, pzfx_lvls),
    x    = x + ((length(pzfx_lvls) - x) / 2)
  )

# Format data for bargraphs
bar_dat <- pzfx_dat %>%
  group_by(name) %>%
  summarize(value = median(value), .groups = "drop")

# Create bargraphs
pzfx_plt <- pzfx_dat %>%
  ggplot(aes(name, value, fill = name)) +
  geom_col(data = bar_dat, width = 0.75) +
  geom_point(size = 3, show.legend = FALSE) +
  
  geom_segment(
    aes(x = Var1, xend = Var2, y = y, yend = y, fill = NULL),
    data = p_dat
  ) +
  geom_text(
    aes(x = x, y = y, label = sig, fill = NULL),
    data = p_dat,
    size = ttl_pt2 * 1.5 / .pt
  ) +
  
  scale_fill_manual(values = pzfx_clrs) +
  scale_y_continuous(expand = expansion(c(0.01, 0.05))) +
  labs(y = tbl_nm) +
  base_theme +
  theme(
    plot.margin     = margin(20, 0, 0, 0),
    aspect.ratio    = 1.3,
    legend.position = "none",
    axis.title.x    = element_blank(),
    axis.text.x     = element_text(size = ttl_pt2, angle = 30, hjust = 1)
  )
```

```{r "Fig 5", fig.width = 12, fig.height = 20}
# Combine and annotate center panels
c("D", "B") %>%
  iwalk(~ {
    chikv_u$cLEC[[.y]][[1]] <<- chikv_u$cLEC[[.y]][[1]] + labs(tag = .x)
  })

chikv_u$cLEC[[1]] <- chikv_u$cLEC[[1]] &
  theme(
    legend.position   = "left",
    legend.title      = element_text(size = ttl_pt2, hjust = 0.5, angle = 90),
    legend.key.height = unit(30, "pt"),
    legend.key.width  = unit(6, "pt")
  )

mid <- wrap_plots(
  chikv_u$cLEC[[2]],
  chikv_ag_bars + labs(tag = "C"),
  chikv_u$cLEC[[1]],
  chikv_ag_bxs + labs(tag = "E"),
  widths = c(1, 0.3)
) &
  theme(plot.tag = element_text(size = ttl_pt2 * 1.5, face = "bold"))

# Final figure
fig5 <- plot_grid(
  top, mid, heat, fig5gh,
  ncol       = 1,
  labels     = c("A", "", "F", ""),
  label_size = ttl_pt2 * 1.5,
  hjust      = c(0, 0, -0.5),
  vjust      = c(1.5, 1, 0),
  rel_heights = c(1, 2.5, 1, 1)
)

fig5
```

<br>

<br>

### Figure S8

A.  Ag-high and Ag-low module scores are shown for the predicted Ag classes.
    P values were calculated using a two-sided Wilcoxon rank sum test with
    Benjamini-Hochberg correction.
B.  Ag-high and Ag-low module scores are shown for mock and CHIKV-infected mice
    for each biological replicate. P values were calculated using a two-sided
    Wilcoxon rank sum test with Benjamini-Hochberg correction.
C.  The total fraction of cLECs, fLECs, and collecting LECs predicted to be
    Ag-competent is shown for mock and CHIKV-infected mice for each biological
    replicate.
    P values were calculated using Fisher's exact test with Benjamini-Hochberg
    correction.
D.  The fraction of fLECs and collecting LECs predicted to be Ag-competent is
    shown as described in C.

```{r "Fig S8", fig.width = 13.5, fig.height = 13}
# Plot Ag module scores for predicted classes
all_chikv_bxs_1 <- chikv_bx_dat %>%
  create_chikv_module_boxes(
    module_clmns = ag_modules,
    x            = "pred_grp",
    clrs         = pred_clrs,
    ttl          = "module score"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# Plot Ag module scores for treatment groups for all cell types
all_chikv_bxs_2 <- chikv_bx_dat %>%
  create_chikv_module_boxes(
    module_clmns = ag_modules,
    ttl = "module score"
  )

# Bargraphs for combined LEC subsets
all_chikv_bars <- chikv_bar_dat %>%
  mutate(subtype = "cLEC, fLEC, Collecting") %>%
  create_chikv_class_bars(
    x   = "treatment",
    n_p = n_distinct(chikv_bar_dat$subtype),
    ttl = "fraction Ag-competent"
  )

# Bargraphs for other LEC subtypes
other_chikv_bars <- chikv_bar_dat %>%
  filter(subtype != rf_cell_type) %>%
  create_chikv_class_bars(
    x   = "treatment",
    n_p = n_distinct(chikv_bar_dat$subtype),
    ttl = "fraction Ag-competent"
  )

# Create final figure
figS6 <- plot_grid(
  all_chikv_bxs_1, all_chikv_bxs_2,
  all_chikv_bars,  other_chikv_bars,
  labels = c("A", "B", "C", "D"),
  label_size = ttl_pt2 * 1.5,
  nrow  = 2,
  align = "vh",
  axis  = "trbl",
  rel_heights = c(1, 0.6)
)

figS6
```

<br>

<br>

### Figure S9

A.  Mean expression is shown for LEC marker genes for
    metastasis-free control lymph node (MFLN) and follicular lymphoma (FL)
    samples from Abe et al.
B.  The fraction of cLECs predicted to be Ag-competent is shown for each 
    MFLN and FL sample with at least 20 identified cLECs (left).
    P values were calculated using a two-sided Wilcoxon rank sum test with
    Benjamini-Hochberg correction (right).
C.  The fraction of fLECs predicted to be Ag-competent is shown as in A.
D.  The fraction of collecting LECs predicated to be Ag-compentent is shown as
    in A.

```{r "Abe marker expression"}
# Format marker data
abe_gns <- c(
  "ACKR4",
  "MFAP4",
  "SERPINE1",
  "BMP2",
  "CXCL5",
  "MARCO",
  "PTX3",
  "CLDN11",
  "GJA4"
)

tissue_nms <- c(
  "MFLN" = "Metastasis-free LN",
  "FL"   = "Follicular Lymphoma"
)

abe_gn_dat <- abe_lec_so %>%
  FetchData(c("tissue", "orig.ident", "subtype", abe_gns)) %>%
  as_tibble(rownames = "cell_id") %>%
  filter(subtype != "unassigned") %>%
  pivot_longer(all_of(abe_gns)) %>%
  mutate(
    name   = fct_relevel(name, abe_gns),
    tissue = fct_relevel(tissue, names(tissue_nms))
  )

# Create heatmap
abe_heat_dat <- abe_gn_dat %>%
  group_by(tissue, subtype, name) %>%
  summarize(
    n       = n_distinct(cell_id),
    value   = mean(value),
    .groups = "drop"
  ) %>%
  group_by(tissue, name) %>%
  mutate(value = as.numeric(scale(value))) %>%
  mutate(
    name  = fct_relevel(name, rev(abe_gns)),
    n_lab = str_c(subtype, "\nn = ", label_comma()(n))
  )

abe_gn_heat <- abe_heat_dat %>%
  ggplot(aes(n_lab, name, fill = value)) +
  geom_tile() +
  facet_wrap(~ tissue, nrow = 1, scales = "free_x", labeller = as_labeller(tissue_nms)) +
  scale_fill_gradientn(colours = c("white", abe_clrs[["FL"]])) +
  guides(fill = guide_colorbar(ticks = FALSE, title = "z-score")) +
  base_theme +
  theme(
    aspect.ratio = length(abe_gns) / n_distinct(abe_gn_dat$subtype) * 0.65,
    legend.key.width = unit(7, "pt"),
    axis.title   = element_blank(),
    axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )
```

```{r "Abe frac Ag-competent"}
# Format Abe data
# * cLECs are the LEC1 population
# * only include samples with at least 20 cLECs
abe_bars <- set_names(rf_typs) %>%
  map(~ {
    abe_type <- .x
    
    y_ttl <- str_c(abe_type, "\nfraction Ag-competent")
    
    abe_bar_dat <- abe_lec_so@meta.data %>%
      as_tibble(rownames = "cell_id") %>%
      filter(subtype == abe_type) %>%
      mutate(
        tissue = fct_relevel(tissue, names(abe_clrs)),
        sample = str_remove(sample, "_NHC$")
      ) %>%
      group_by(sample, tissue) %>%
      mutate(n = n_distinct(cell_id)) %>%
      filter(n > 20) %>%
      group_by(sample, tissue, n) %>%
      summarize(
        frac_high = sum(pred_grp == "Ag-competent"),
        .groups = "drop"
      ) %>%
      mutate(
        frac_high = frac_high / n,
        n_lab     = str_c(sample, "\nn = ", label_comma()(n))
      )
    
    # Create bar graph for all samples
    abe_bars_1 <- abe_bar_dat %>%
      ggplot(aes(n_lab, frac_high, fill = tissue)) +
      geom_col() +
      facet_grid(~ tissue, scales = "free_x", space = "free_x", labeller = as_labeller(tissue_nms)) +
      scale_fill_manual(values = abe_clrs) +
      scale_y_continuous(breaks = c(0, 0.5, 1), limits = c(0, 1)) +
      labs(y = y_ttl) +
      base_theme +
      theme(
        legend.position = "none",
        strip.clip      = "off",
        axis.title.x    = element_blank(),
        axis.text.x     = element_text(angle = 90, hjust = 1, vjust = 0.5)
      )
    
    # Bargraphs for combined samples
    # * use wilcox test instead of fisher's exact test since there is a large
    #   difference in the number of cells for each sample
    # * this will cause one sample to disproportionately influence the results
    p_dat <- abe_bar_dat %>%
      mutate(
        p = wilcox.test(
          frac_high[tissue == "FL"],
          frac_high[tissue == "MFLN"]
        )$p.value
      ) %>%
      group_by(tissue, p) %>%
      summarize(n = n(), .groups = "drop") %>%
      mutate(p_adj = p.adjust(p, method = "BH", n = length(rf_typs))) %>%
      rowwise() %>%
      mutate(
        p_lab = str_c("italic(p) == ", .format_pvalue(p_adj)),
        n_lab = str_c(tissue, "\nn = ", n)
      )
    
    n_labs <- set_names(p_dat$n_lab, p_dat$tissue)
    
    set.seed(1)
    
    abe_bars_2 <- abe_bar_dat %>%
      group_by(tissue) %>%
      summarize(frac_high = median(frac_high), .groups = "drop") %>%
      ggplot(aes(tissue, frac_high, fill = tissue)) +
      geom_col() +
      geom_jitter(data = abe_bar_dat, size = 1.5, width = 0.03) +
      geom_text(
        aes(1.5, Inf),
        label = unique(p_dat$p_lab),
        parse = TRUE,
        size  = 12 / .pt,
        vjust = 1.25,
      ) +
      scale_fill_manual(values = abe_clrs) +
      scale_y_continuous(
        breaks = c(0, 0.5, 1),
        limits = c(0, 1)
      ) +
      scale_x_discrete(labels = n_labs) +
      labs(y = y_ttl) +
      base_theme +
      theme(
        aspect.ratio    = 1.75,
        legend.position = "none",
        axis.title      = element_blank()
      )
    
    # Create final figure
    res <- plot_grid(
      abe_bars_1, abe_bars_2,
      rel_widths = c(1, 0.35),
      align      = "h",
      axis       = "tb"
    )
    
    res
  })

abe_bars <- plot_grid(
  plotlist = abe_bars,
  ncol       = 1,
  labels     = c("B", "C", "D"),
  label_size = ttl_pt2 * 1.5,
  label_x    = -0.01,
  label_y    = 1.03
)
```

```{r "Fig S9", fig.width = 9, fig.height = 12}
plot_grid(
  abe_gn_heat,
  abe_bars,
  ncol        = 1,
  rel_heights = c(0.4, 1),
  labels      = c("A", ""),
  label_size  = ttl_pt2 * 1.5
)

rm(abe_lec_so)
```

---

<br>

<br>

## Cell type markers

### CD45+ markers {.tabset .tabset-pills}

Mean expression is shown for key marker genes for CD45+ scRNA-seq datasets.

```{r "CD45+ markers 1", fig.width = 10, fig.height = 4}
heat_dat <- cd45pos_marks %>%
  group_by(cell_type, mouse, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  group_by(name, mouse) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup()

# Create heatmap
heat_dat %>%
  ggplot(aes(cell_type, name, fill = value)) +
  geom_tile() +
  facet_wrap(~ mouse, nrow = 1) +
  scale_fill_gradientn(colours = c("white", "red")) +
  base_theme +
  theme(
    legend.title = element_blank(),
    aspect.ratio = length(cd45pos_gns) / n_distinct(heat_dat$cell_type),
    axis.title   = element_blank(),
    axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )
```

```{r "CD45+ markers 2", fig.width = 10, fig.height = 4, results = "asis"}
cd45pos_gns %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    dat <- cd45pos_marks %>%
      filter(name == .x) %>%
      group_by(cell_type, mouse) %>%
      mutate(
        n = n_distinct(.cell_id),
        n_lab = str_c(cell_type, " (", label_comma()(n), ")")
      ) %>%
      group_by(cell_type) %>%
      mutate(
        med = median(value),
        q3  = boxplot.stats(value)$stats[4],
        q4  = boxplot.stats(value)$stats[5],
        max = max(value)
      ) %>%
      ungroup() %>%
      arrange(desc(med), desc(q3), desc(q4), desc(max)) %>%
      mutate(n_lab = fct_inorder(n_lab))
    
    plt <- dat %>%
      ggplot(aes(n_lab, value, fill = cell_type, color = cell_type)) +
      geom_boxplot(alpha = 0.5, outlier.size = 0.25) +
      facet_wrap(~ mouse, nrow = 1, scales = "free_x") +
      scale_fill_manual(values = typ_clrs) +
      scale_color_manual(values = typ_clrs) +
      labs(y = str_c(.x, " expression")) +
      base_theme +
      theme(
        aspect.ratio    = 1,
        axis.text.x     = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x    = element_blank(),
        legend.position = "none"
      )
    
    print(plt)
    cat("\n\n<br>\n\n")
  })
```

### CD45- markers {.tabset .tabset-pills}

Mean expression is shown for key marker genes for CD45- scRNA-seq datasets.

```{r "CD45- markers 1", fig.width = 10, fig.height = 4}
heat_dat <- cd45neg_marks %>%
  group_by(cell_type, mouse, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  group_by(name, mouse) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup()

# Create heatmap
heat_dat %>%
  ggplot(aes(cell_type, name, fill = value)) +
  geom_tile() +
  facet_wrap(~ mouse, nrow = 1) +
  scale_fill_gradientn(colours = c("white", "red"), na.value = "grey80") +
  base_theme +
  theme(
    legend.title = element_blank(),
    aspect.ratio = length(cd45neg_gns) / n_distinct(heat_dat$cell_type),
    axis.title   = element_blank(),
    axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )
```

```{r "CD45- markers 2", fig.width = 10, fig.height = 4, results = "asis"}
cd45neg_gns %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    dat <- cd45neg_marks %>%
      filter(name == .x) %>%
      group_by(cell_type, mouse) %>%
      mutate(
        n = n_distinct(.cell_id),
        n_lab = str_c(cell_type, " (", label_comma()(n), ")")
      ) %>%
      group_by(cell_type) %>%
      mutate(
        med = median(value),
        q3  = boxplot.stats(value)$stats[4],
        q4  = boxplot.stats(value)$stats[5],
        max = max(value)
      ) %>%
      ungroup() %>%
      arrange(desc(med), desc(q3), desc(q4), desc(max)) %>%
      mutate(n_lab = fct_inorder(n_lab))
    
    plt <- dat %>%
      ggplot(aes(n_lab, value, fill = cell_type, color = cell_type)) +
      geom_boxplot(alpha = 0.5, outlier.size = 0.25) +
      facet_wrap(~ mouse, nrow = 1, scales = "free_x") +
      scale_fill_manual(values = typ_clrs) +
      scale_color_manual(values = typ_clrs) +
      labs(y = str_c(.x, " expression")) +
      base_theme +
      theme(
        aspect.ratio    = 1,
        axis.text.x     = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x    = element_blank(),
        legend.position = "none"
      )
    
    print(plt)
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

## Xenium

These are extra Xenium plots that currently are not included in the paper.
Ag-tag barcodes used for each mouse are shown below.

```{r}
params$xen_samples %>%
  imap_dfr(~ {
    tibble(
      fov       = .y,
      mouse     = .x[[1]],
      `6wk tag` = params$xen_ag_targets[[.x[[2]]]],
      `3wk tag` = params$xen_ag_targets[[.x[[3]]]]
    ) %>%
      mutate(
        across(ends_with(" tag"), ~ {
          .x %>%
            str_remove("-ERCC[0-9]+$") %>%
            str_remove("^GeoMx-")
        })
      )
  })
```

<br>

The expression of key marker genes is shown below for each cell type.

```{r "xenium marker genes", fig.width = 24, fig.height = 14}
xen_marker_plt <- xen_gns %>%
  map(~ {
    xen %>%
      filter(fov == top_fov) %>%
      plot_violin(
        .x,
        cluster_col = "cell_type",
        plot_colors = xen_clrs,
        method      = "boxplot"
      ) +
      base_theme +
      theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)
      )
  }) %>%
  plot_grid(plotlist = .)

xen_marker_plt
```

<br>

The fraction of total counts assigned to each custom target is shown below for
each tissue section.
The GeoMx-Barcode02 probes produced very sparse signals regardless of sample
identity.
Values are labeled for targets assigned >0.01% of total counts.

```{r "fraction custom counts", fig.height = 6, fig.width = 20, include = FALSE}
# Format plotting data
feats <- c(
  "mouse", "fov", "cell_type",
  "nCount_Xenium", "nCount_Xenium_custom"
)

xen_qc_dat <- seq_along(xen_slides) %>%
  map(~ {
    s <- qread(here(params$xen_dir, str_c("xen_s", .x, ".qs")))
    
    DefaultAssay(s) <- "Xenium_custom"
    
    s %>%
      FetchData(c(feats, params$xen_custom_targets), slot = "counts") %>%
      as_tibble(rownames = ".cell_id") %>%
      pivot_longer(all_of(params$xen_custom_targets)) %>%
      mutate(
        slide  = .x,
        sample = str_c(mouse, "-", fov)
      )
  })

xen_qc_dat <- bind_rows(xen_qc_dat)

# Format heatmap data
heat_dat <- xen_qc_dat %>%
  group_by(slide, fov, mouse, name) %>%
  mutate(
    tot_counts = sum(nCount_Xenium + nCount_Xenium_custom)
  ) %>%
  group_by(name, slide, fov, mouse, sample, tot_counts) %>%
  summarize(
    value   = sum(value),
    .groups = "drop"
  ) %>%
  mutate(
    frac   = value / tot_counts,
    fov    = fct_relevel(fov, fovs),
    name   = fct_reorder(name, value),
    mouse  = fct_relevel(mouse, c("6wk", "3wk", "6wk-3wk"))
  )

# Tiles to outline
min_frac <- 0.0001

custom_counts_heat <- seq_along(xen_slides) %>%
  map(~ {
    dat <- heat_dat %>%
      filter(slide == .x)
    
    top_dat <- dat %>%
      filter(frac >= min_frac)
    
    # Tiles to label
    lab_dat <- dat %>%
      filter(frac >= min_frac) %>%
      mutate(
        lab = round(frac * 100, 2),
        lab = str_c(lab, "%")
      )
    
    # Create heatmap
    heat <- dat %>%
      ggplot(aes(fov, name, fill = frac + min_frac)) +
      geom_tile() +
      geom_tile(
        data = top_dat,
        color = "black"
      ) +
      geom_text(
        aes(color = NULL, fill = NULL, label = lab),
        data = lab_dat
      ) +
      facet_grid(~ mouse, scales = "free") +
      scale_fill_gradientn(
        colours = c("white", "#D7301F"),
        labels  = label_percent(),
        trans   = "log10",
        name    = str_c("fraction of\ntotal counts\n(+", min_frac * 100, "%)")
      ) +
      ggtitle(str_c("r", .x)) +
      base_theme +
      theme(
        aspect.ratio       = 5,
        plot.title         = element_text(hjust = 0.5),
        strip.clip         = "off",
        strip.text.y.right = element_text(angle = 0, hjust = 0),
        axis.title         = element_blank()
      )
    
    heat
  })

rm(xen_qc_dat, heat_dat)
gc()
```

```{r "fraction custom counts heatmap", fig.height = 6, fig.width = 20}
plot_grid(
  plotlist = custom_counts_heat,
  nrow  = 1,
  align = "h",
  axis  = "tb"
)
```

<br>

Cells were identified as Ag+ if they have at least 1 Ag-tag count.
The fraction of Ag+ cells is shown below for each Ag-tag for
each tissue section.

```{r "fraction 3wk/6wk Ag+ cells", fig.height = 3.5, fig.width = 12}
bar_dat <- xen %>%
  group_by(slide, fov, mouse) %>%
  summarize(
    `3wk tag` = (sum(Ag_3wk_counts > 0) / n()) * 100,
    `6wk tag` = (sum(Ag_6wk_counts > 0) / n()) * 100,
    .groups   = "drop"
  )

bar_dat %>%
  pivot_longer(ends_with("wk tag")) %>%
  mutate(mouse = fct_relevel(mouse, c("6wk", "3wk", "6wk-3wk"))) %>%
  
  ggplot(aes(fov, value, fill = name)) +
  geom_col(position = position_dodge2()) +
  facet_grid(slide ~ mouse, scales = "free_x") +
  scale_fill_brewer() +
  scale_fill_spruce(difference = 30, range = c(25, 75)) +
  
  labs(y = "% Ag+ cells") +
  base_theme +
  theme(
    aspect.ratio = 1.5,
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )
```

<br>

The percent of cells that are Ag+ is shown for each cell type for each tissue
section.
Only cell types with >100 cells identified for the tissue section are shown.
The color scale is log10-transformed.

```{r "XENIUM AG TYPE HEAT ALL", fig.width = 14, fig.height = 4.5}
bar_dat <- xen %>%
  group_by(cell_type, fov, slide) %>%
  # filter(n() > 100) %>%

  group_by(slide, fov, cell_type) %>%
  summarize(
    n = n(),
    pct_ag_pos = (sum(Ag_class == "Ag+") / n) * 100,
    .groups = "drop"
  ) %>%
  mutate(slide = str_c("r", slide))
    
# Filter to exclude cell types with < 100 cells
bar_dat %>%
  mutate(
    cell_type = fct_reorder(cell_type, pct_ag_pos),
    fov       = fct_reorder(fov, pct_ag_pos, .fun = max)
  ) %>%
  group_by(fov, slide) %>%
  mutate(pct_ag_pos = pct_ag_pos + 1) %>%
  
  ggplot(aes(fov, cell_type, fill = pct_ag_pos)) +
  geom_tile() +
  facet_wrap(~ slide, nrow = 1) +
  scale_fill_gradientn(
    colours = c("white", "#E7301F"),
    name    = "fraction Ag+ cells\n(+1%)",
    trans   = "log10"
  ) +
  base_theme +  
  theme(
    aspect.ratio = n_distinct(bar_dat$cell_type) / n_distinct(bar_dat$fov),
    axis.title = element_blank()
  )
```

---

<br>

<br>

## Session info

```{r "session info"}
sessionInfo()
```

```{r "save matrices", eval = FALSE}
# Metadata columns to include
clmns_1 <- c(
  "cell_id",
  "exp",
  "sample",
  "mouse",
  "tm",
  "vaccination",
  "RNA_snn_res.5",
  "RNA_snn_res.10",
  "cell_type",
  "subtype",
  "Ag_score",
  "Ag_score_3",
  "Ag_score_6",
  "Ag_class_ml",
  "Ag_class_dual",
  "hUMAP_1",
  "hUMAP_2"
)

clmns_2 <- clmns_1[clmns_1 != "subtype"]

# Write files for GEO
geo_objs <- list(
  obj   = c("cd45neg", "cd45pos", "lec", "dc"),
  clmns = list(clmns_1, clmns_1, clmns_2, clmns_2)
)

geo_objs %>%
  pwalk(~ {
    prfx      <- str_c(.x, "_")
    geo_files <- str_c(prfx, c("count_matrix.tsv.gz", "metadata.tsv.gz"))
    geo_files <- here(params$geo_dir, geo_files)
    
    # Write matrices and meta.data
    if (all(file.exists(geo_files))) return(NULL)
    
    obj <- qread(here(params$so_dir, str_c(prfx, "so.qs")))
    
    obj %>%
      export_matrices(
        assays      = c("RNA", "ADT"),
        feat_type   = c("Gene Expression", "Antibody Capture"),
        columns     = .y,
        out_dir     = params$geo_dir,
        file_prefix = prfx
      )
  })
```
