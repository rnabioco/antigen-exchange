---
title: "Antigen Tracking Figures"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc:            true
    toc_float:      true
    toc_depth:      4
    df_print:       "paged"
    code_folding:   "hide"
    self_contained: true
    highlight:      "kate"
params:
  template_dir:  "src"                                                                      # Directory containing template Rmarkdowns
  so_dir:        "~/Dropbox/Ryan/Projects/antigen-exchange/results/sobjs" # Directory for loading/saving Seurat objects
  ref_dir:       "ref"                                                                      # Directory to use for loading/saving clustifyr references
  sample_info:   "sample_info.xlsx"
  res_dir:                                                
    value:
      exp-0: "~/Projects/antigen-tracking/results"
      exp-1: "~/Projects/tamburini-antigen-tracking/results/2022-03-11"
      exp-2: "~/Projects/tamburini-antigen-tracking/results/2022-10-28"
editor_options: 
  chunk_output_type: console
---

---

<br>

```{r "setup"}
knitr::knit(here::here(params$template_dir, "setup.Rmd"), "")
```

## Figure 1

Antigen persists in discrete cell subsets within the lymph node

```{r "type frequency"}
fig1_dat <- all_meta %>%
  filter(
    mouse != "6wk-3wk",
    cell_type != "unassigned"
  ) %>%
  group_by(cell_sort) %>%
  mutate(
    tm        = fct_relevel(as.character(tm), tms),
    cell_type = fct_infreq(cell_type),
    cell_type = fct_relevel(cell_type, c("LEC", "Fibroblasts", "DC"))
  ) %>%
  ungroup() %>%
  arrange(tm, cell_type)

freq_dat <- fig1_dat %>%
  mutate(
    tm_group = str_c(tm, "_", cell_sort),
    tm_group = fct_inorder(tm_group)
  )

group_lab <- c(CD45pos = "CD45+", CD45neg = "CD45-")

x_labs <- get_nlab_fun(freq_dat, "tm_group", l = "\n", r = "")
x_labs <- x_labs() %>%
  map_chr(~ str_remove_all(.x, "_.+"))

typ_freq <- freq_dat %>%
  ggplot(aes(tm_group, fill = cell_type, color = cell_type)) +
  geom_bar(position = "fill", key_glyph = draw_key_point) +
  facet_wrap(~ cell_sort, nrow = 1, scales = "free_x", labeller = as_labeller(group_lab)) +
  scale_fill_manual(values = typ_clrs) +
  scale_color_manual(values = typ_clrs) +
  scale_x_discrete(labels = x_labs) +
  scale_y_continuous(expand = expansion(c(0.01, 0.05))) +
  guides(fill = guide_legend(ncol = 2, override.aes = list(shape = 19, size = 4))) +
  labs(x = "days post vaccination") +
  base_theme +
  theme(
    aspect.ratio = 1.5,
    legend.title = element_blank(),
    panel.border = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x  = element_text(size = txt_pt2, angle = 45, hjust = 1, vjust = 1),
    axis.text.y  = element_blank(),
    axis.ticks   = element_blank()
  )
```

```{r "type Ag heat", fig.width = 16, fig.height = 5}
# Create heatmap summarize Ag scores
heat_dat <- fig1_dat %>%
  group_by(tm, cell_type) %>%
  summarize(
    Ag_score = mean(Ag_score), .groups = "drop",
    n        = n()
  ) %>%
  group_by(cell_type) %>%
  mutate(cell_type = str_c(cell_type, "\nn = ", label_comma()(sum(n)))) %>%
  ungroup() %>%
  mutate(
    tm = fct_relevel(as.character(tm), rev(as.character(tms))),
    cell_type = fct_reorder(cell_type, Ag_score, mean, .desc = TRUE)
  )

typ_heat <- heat_dat %>%
  ggplot(aes(cell_type, tm, fill = Ag_score)) +
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "#D55E00"), na.value = "black") +
  guides(fill = guide_colorbar(
    title.position = "top", ticks = FALSE, title = "Ag-score",
    barwidth = unit(150, "pt"), barheight = unit(10, "pt")
  )) +
  labs(y = "days post vaccination") +
  base_theme +
  theme(
    plot.margin  = margin(0, 15, 0, 15),
    legend.position = "top",
    legend.justification = 0,
    legend.text  = element_text(size = txt_pt1),
    aspect.ratio = n_distinct(heat_dat$tm) / n_distinct(heat_dat$cell_type) * 0.9,
    # aspect.ratio = n_distinct(heat_dat$tm) / n_distinct(heat_dat$cell_type) * 1.5,
    axis.title.x = element_blank(),
    axis.text.x  = element_text(angle = 45, hjust = 1),
  )

# Create mock panel A
mock_a <- ggplot() +
  geom_blank() +
  base_theme +
  theme(aspect.ratio = 0.9)

mock_b <- ggplot() +
  geom_blank() +
  base_theme

# Create final panel
top <- plot_grid(
  mock_a, mock_b, typ_heat,
  labels = c("A", "B", "C"),
  label_size = ttl_pt2 * 1.5,
  align = "h",
  axis  = "tb",
  nrow  = 1,
  rel_widths = c(0.5, 0.5, 1)
)
```

```{r "LEC Ag UMAPs"}
# Data for UMAPs
u_args <- list(
  obj = list(LEC = lec_so, DC = dc_so),
  exp = c("exp-1", "exp-2")
)

u_dat <- u_args %>%
  pmap(~ {
    ..1@meta.data %>%
      as_tibble(rownames = ".cell_id") %>%
      filter(
        exp %in% c("exp-0", ..2),
        mouse != "6wk-3wk"
      ) %>%
      mutate(tm_lab = factor(as.character(tm), tms))    
  })

# Subtype UMAPs
lec_typ_u <- u_dat %>%
  imap(~ {
    typ_lvls <- .x %>%
      pull(subtype) %>%
      unique() %>%
      as.character()
    
    res <- .x %>%
      plot_scatter(
        "subtype", "hUMAP_1", "hUMAP_2",
        size         = 0.1,
        plot_colors  = c(lec_clrs, dc_clrs),
        plot_lvls    = rev(typ_lvls),
        label_params = list(size = ttl_pt1),
        panel_nrow   = 2
      ) +
      guides(color = guide_legend(ncol = 1, override.aes = list(size = 4))) +
      umap_theme +
      theme(
        aspect.ratio = 0.9,
        legend.position = "right",
        legend.title = element_blank()
      )
    
    res
  })

# Ag-score UMAPs
u_clrs <- list(
  LEC = c("lightblue", "white", "#D7301F"),
  DC  = c("lightblue", "white", "#6A51A3")
  # DC  = c("white", "#6A51A3")
)

lec_ag_u <- u_dat %>%
  imap(~ {
    .x %>%
      filter(tm_lab %in% as.character(tms)) %>%
      plot_scatter(
        "Ag_score", "hUMAP_1", "hUMAP_2",
        plot_colors  = u_clrs[[.y]],
        label_params = list(size = ttl_pt1),
        group_col    = "tm_lab",
        panel_nrow   = 1,
        outline      = TRUE,
        size         = 0.7,
        stroke       = 0.7
      ) +
      # facet_wrap(~ tm_lab, nrow = 1) +
      guides(fill = guide_colorbar(
        title.position = "right", ticks = FALSE, title = "Ag-score",
        barheight = unit(120, "pt"), barwidth = unit(10, "pt")
      )) +
      umap_theme +
      theme(
        aspect.ratio         = 0.9,
        panel.border         = element_rect(color = ln_col, linewidth = ln_pt, fill = NA),
        legend.position      = "right",
        legend.justification = 0,
        legend.title         = element_text(angle = 270, hjust = 0.5),
        strip.text.y         = element_blank()
      )
  })
```

```{r "LEC Ag scores", fig.width = 8, fig.height = 2}
# Data for boxplots
dat <- lec_so@meta.data %>%
  filter(
    mouse != "6wk-3wk",
    !subtype %in% c("unassigned"),
    exp %in% c("exp-0", "exp-1")
  ) %>%
  group_by(subtype) %>%
  filter(all(table(tm) >= 10)) %>%
  ungroup() %>%
  mutate(subtype = fct_reorder(subtype, Ag_score, mean, .desc = TRUE))

# # Data for lines
# ln_dat <- dat %>%
#   group_by(tm, mouse, subtype) %>%
#   summarize(Ag_score = median(Ag_score), .groups = "drop")

# Create boxplots
lec_ag_bxs <- dat %>%
  ggplot(aes(tm, Ag_score, fill = subtype)) +
  
  geom_smooth(
    data = dat,
    method = "loess",
    se = FALSE, color = "grey85", linewidth = 0.5, fill = "black", linetype = 2
  ) +
  geom_boxplot(aes(group = mouse), outlier.size = 0.2, width = 3, key_glyph = draw_key_point) +
  
  guides(
    fill = guide_legend(override.aes = list(size = 4, shape = 22), order = 1),
    linetype = guide_legend(override.aes = list(color = "black"), title = NULL)
  ) +
  facet_grid(~ subtype) +
  
  scale_fill_manual(values = lec_clrs) +
  labs(x = "days post vaccination", y = "Ag-score") +
  base_theme +
  theme(
    aspect.ratio    = 0.9,
    legend.position = "none",
    plot.margin     = margin(0, 15, 0, 15)
  )

# # Plot all cell types
# dat <- all_meta %>%
#   filter(
#     mouse != "6wk-3wk",
#     # cell_type == "LEC",
#     !subtype %in% c("unassigned"),
#     exp %in% c("exp-0", "exp-1")
#   ) %>%
#   mutate(subtype = fct_reorder(subtype, Ag_score, mean, .desc = TRUE))
```

```{r "DC Ag scores", fig.width = 8, fig.height = 2}
# Data for boxplots
dat <- dc_so@meta.data %>%
  filter(exp %in% c("exp-0", "exp-2")) %>%
  mutate(subtype = fct_reorder(subtype, Ag_score, mean, .desc = TRUE))

# # Data for lines
# ln_dat <- dat %>%
#   group_by(tm, subtype) %>%
#   summarize(Ag_score = median(Ag_score), .groups = "drop")

# Create boxplots
dc_ag_bxs <- dat %>%
  ggplot(aes(tm, Ag_score, fill = subtype)) +
  
  geom_smooth(
    data = dat,
    method = "loess",
    se = FALSE, color = "grey85", linewidth = 0.5, fill = "black", linetype = 2
  ) +
  geom_boxplot(
    aes(group = mouse),
    outlier.size = 0.2, width = 2.5, key_glyph = draw_key_point
  ) +
  guides(
    fill = guide_legend(override.aes = list(size = 4, shape = 22), order = 1),
    linetype = guide_legend(override.aes = list(color = "black"), title = NULL)
  ) +
  facet_grid(~ subtype) +
  scale_fill_manual(values = dc_clrs) +
  labs(x = "days post vaccination", y = "Ag-score") +
  base_theme +
  theme(
    aspect.ratio = 0.9,
    legend.position = "none",
    plot.margin = margin(0, 15, 0, 15)
  )
```

```{r "Ag heat"}
# Create heatmaps
heat_args <- list(
  ttl = c("LEC", "DC"),
  dat = list(
    LEC = lec_so@meta.data,
    DC = dc_so@meta.data
  ),
  clrs = c("#D7301F", "#6A51A3")
  # clrs = c("#D7301F", "#0072B2")
)
  
ag_heats <- heat_args %>%
  pmap(~ {
    args <- list(...)
    exps <- c(LEC = "exp-1", DC = "exp-2")  
    
    dat <- args$dat %>%
      filter(
        !is.na(tm),
        exp %in% c("exp-0", exps[[args$ttl]]),
        # cell_type == args$ttl,
        subtype != "unassigned"
      ) %>%
      group_by(subtype) %>%
      filter(all(table(tm) >= 10)) %>%
      group_by(mouse, tm, subtype) %>%
      summarize(Ag_score = mean(Ag_score), .groups = "drop") %>%
      mutate(
        subtype = fct_reorder(subtype, Ag_score, mean),
        tm      = fct_relevel(as.character(tm), as.character(tms)),
        ttl     = "Ag-score"
      )
    
    rat <- ifelse(
      identical(args$ttl, "DC"),
      1.25,
      n_distinct(dat$subtype) / n_distinct(dat$tm)
    )
    
    dat %>%
      ggplot(aes(tm, subtype, fill = Ag_score)) +
      geom_tile() +
      facet_wrap(~ ttl) +
      labs(x = "days post vaccination") +
      scale_fill_gradientn(colours = c("lightblue", "white", args$clrs)) +
      guides(fill = guide_colorbar(
        ticks = FALSE, title = "Ag-score",
        barheight = unit(105, "pt"), barwidth = unit(10, "pt")
      )) +
      base_theme +
      theme(
        legend.title = element_blank(),
        aspect.ratio = rat,
        axis.title.y = element_blank(),
        plot.margin  = margin(0, 15, 0, 15),
        plot.title   = element_text(hjust = 0.5, size = ttl_pt2)
      )
  })
```

```{r "Fig 1", fig.width = 15.5, fig.height = 15}
lec_fig <- (lec_typ_u$LEC + lec_ag_u$LEC) /
  (ag_heats[[1]] + lec_ag_bxs) /
  (lec_typ_u$DC + lec_ag_u$DC) /
  (ag_heats[[2]] + dc_ag_bxs) +
  plot_layout(heights = c(1, 0.7, 1, 0.7)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = ttl_pt2 * 1.5, face = "bold"))

plot_grid(
  top, lec_fig,
  ncol       = 1,
  label_size = ttl_pt2 * 1.5,
  rel_heights = c(1, 3)
)
```

---

<br>

<br>

## Figure 2

```{r "exchange UMAPs", fig.width = 16, fig.height = 4}
# Keys for naming labels
ag_labs <- c(
  Ag_3wk_score = "Ag-score\n21 day",
  Ag_6wk_score = "Ag-score\n42 day"
)

m_key <- c(
  d2        = "2 day",
  d14       = "14 day",
  `3wk`     = "21 day",
  `6wk`     = "42 day",
  `6wk-3wk` = "dual"
)

# Format plot data
# Using experiment 1 since, experiment is missing 3wk LECs
dat <- lec_so@meta.data %>%
  group_by(subtype) %>%
  filter(all(table(mouse) >= 10)) %>%
  ungroup() %>%
  mutate(mouse = fct_relevel(mouse, names(m_key))) %>%
  filter(exp == "exp-1") %>%
  arrange(mouse) %>%
  mutate(
    mouse = m_key[as.character(mouse)],
    mouse = fct_inorder(mouse)
  )

# Create UMAPs
ag_clmns <- c("Ag_3wk_score", "Ag_6wk_score")

plt_args <- list(
  ag_clmns = ag_clmns,
  clr      = tm_clrs[c("21", "42")]
)

mx_sig <- max(dat[plt_args$dat_clmns])

ex_u <- plt_args %>%
  pmap(~ {
    dat %>%
      plot_scatter(
        ..1,
        x           = "hUMAP_1",
        y           = "hUMAP_2",
        group_col   = "mouse",
        panel_nrow  = 1,
        outline     = TRUE,
        size        = 1,
        stroke      = 0.7,
        plot_colors = c("lightblue", "white", ..2),
        label_params = list(size = ttl_pt1)
      ) +
      # scale_fill_gradientn(colours = c("lightblue", "white", ..2), limits = c(0, mx_sig)) +
      guides(fill = guide_colorbar(
        ticks = FALSE,
        title = ag_labs[.x],
        barheight = unit(150, "pt"), barwidth = unit(10, "pt")
      )) +
      umap_theme +
      theme(
        legend.position = "right",
        panel.border    = element_rect(color = ln_col, linewidth = ln_pt)
      )
  })

# Create heatmaps
heat_dat <- dat %>%
  group_by(mouse, subtype) %>%
  summarize(across(all_of(ag_clmns), mean), .groups = "drop")

ex_heat <- plt_args %>%
  pmap(~ {
    heat_dat %>%
      mutate(subtype = fct_reorder(subtype, !!sym(..1), mean)) %>%
      ggplot(aes(mouse, subtype, fill = !!sym(..1))) +
      geom_tile() +
      labs(x = "vaccination group") +
      scale_fill_gradientn(colours = c("lightblue", "white", ..2)) +
      scale_x_discrete(labels = ~ str_replace(.x, " day", "d")) +
      guides(fill = guide_colorbar(
        ticks = FALSE,
        title = ag_labs[.x],
        barheight = unit(150, "pt"), barwidth = unit(10, "pt")
      )) +
      base_theme +
      theme(
        aspect.ratio = n_distinct(heat_dat$subtype) / n_distinct(heat_dat$mouse),
        axis.title.y = element_blank(),
        plot.margin = margin(0, 15, 0, 15)
      )
  })

# Create final panel
ex_panels <- map2(ex_heat, ex_u, ~ {
  plot_grid(
    .x, .y,
    nrow = 1,
    align = "h",
    axis  = "tb",
    rel_widths = c(0.37, 1)
  )
})
```

```{r "exchange 3wk boxes", fig.width = 10, fig.height = 2}
tm_clmn <- "tm_3"
ag_clmn <- "Ag_score_3"

lec_lvls <- c("cLEC", "fLEC", "Collecting")

# Effect of previous vaccination on uptake of new antigen
# Comparison using exp-2 isn't very useful since we captured very few LECs
# for the 3wk timepoint
dat <- lec_so@meta.data %>%
  filter(
    # cell_type == "LEC",
    !subtype %in% c("unassigned"),
    exp %in% c("exp-0", "exp-1")
  ) %>%
  group_by(subtype) %>%
  filter(all(table(mouse) >= 5)) %>%
  ungroup() %>%
  mutate(
    # subtype = fct_relevel(subtype, lec_lvls),
    subtype = fct_reorder(subtype, !!sym(ag_clmn), mean, .desc = TRUE),
    vaccination = fct_relevel(vaccination, vacs)
  )

# Data to draw line connecting timepoints
ln_dat <- dat %>%
  filter(mouse != "6wk-3wk")
  # # group_by(!!sym(tm_clmn), subtype) %>%
  # # summarize(!!sym(ag_clmn) := median(!!sym(ag_clmn)), .groups = "drop") %>%
  # # na.omit() %>%
  # group_by(subtype) %>%
  # group_modify(~ {
  #   if (nrow(.x) == 2) {
  #     scores <- pull(.x, ag_clmn)
  #     tms    <- pull(.x, tm_clmn)
  #     new_ag <- scores[tms == max(tms)]
  #     
  #     .x %>%
  #       add_row(
  #         !!sym(tm_clmn) := max(pull(.x, tm_clmn)) - 1,
  #         !!sym(ag_clmn) := new_ag
  #       )
  #   } else {
  #     .x
  #   }
  # }) %>%
  # ungroup()

# p-values for vaccination
p_dat <- dat %>%
  group_by(!!sym(tm_clmn), subtype) %>%
  filter(all(vacs %in% vaccination)) %>%
  summarize(
    pval = t.test(
      (!!sym(ag_clmn))[vaccination == vacs[1]],
      (!!sym(ag_clmn))[vaccination == vacs[2]],
      alternative = "less"
    )$p.value,
    y = max(!!sym(ag_clmn)),
    y = y + (y * 0.1),
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "bonferroni")) %>%
  rowwise() %>%
  mutate(
    plab = .format_pvalue(padj),
    plab = str_c("italic(p) == ", plab)
  ) %>%
  filter(padj < 0.05)

# Create boxplots
ex_3_bxs <- dat %>%
  ggplot(aes(!!sym(tm_clmn), !!sym(ag_clmn), fill = as.character(!!sym(tm_clmn)), alpha = vaccination)) +
  geom_smooth(
    data = ln_dat,
    mapping = aes(fill = NULL, alpha = NULL),
    method = "loess",
    se = FALSE, color = "grey85", linetype = 2, linewidth = 0.5, show.legend = FALSE,
    span = 0.8
  ) +
  geom_boxplot(
    outlier.size = 0.2, width = 5, key_glyph = draw_key_point,
    position = position_dodge2(preserve = "single")
  ) +
  geom_text(
    aes(y = y, label = plab, alpha = NULL),
    data = p_dat,
    parse = TRUE,
    show.legend = FALSE,
    # size = txt_pt1 / .pt
    size = 8 / .pt
  ) +
  facet_grid(~ subtype) +
  scale_alpha_manual(values = c(single = 0.35, dual = 1)) +
  scale_fill_manual(values = tm_clrs) +
  guides(fill = "none", alpha = guide_legend(override.aes = list(shape = 15, size = 4))) +
  labs(x = "days post vaccination", y = "Ag-score") +
  base_theme +
  theme(
    aspect.ratio = 0.6
  )
```

```{r "exchange 6wk boxes", fig.width = 10, fig.height = 2.15}

# old_so <- qread("~/Dropbox/Ryan/Projects/tamburini-antigen-tracking/results/2022-10-28/sobjs/so_lec_new.qs")

# Effect of vaccination on retention of previously acquired antigen 
tm_clmn <- "tm_6"
ag_clmn <- "Ag_score_6"

# Effect of previous vaccination on uptake of new antigen
# Comparison using exp-2 isn't very useful since we captured very few LECs
# for the 3wk timepoint
dat <- lec_so@meta.data %>%
  filter(
    # cell_type == "LEC",
    !subtype %in% c("unassigned"),
    exp %in% c("exp-0", "exp-1")
  ) %>%
  group_by(subtype) %>%
  filter(all(table(mouse) >= 5)) %>%
  ungroup() %>%
  mutate(
    # subtype = fct_relevel(subtype, lec_lvls),
    subtype = fct_reorder(subtype, !!sym(ag_clmn), mean, .desc = TRUE),
    vaccination = fct_relevel(vaccination, vacs)
  )

# # ADD OLD LEC ANNOTATIONS
# dat <- dat %>%
#   as_tibble(rownames = ".cell_id") %>%
#   mutate(raw_id = str_remove(.cell_id, "_.+$"))
# 
# dat <- old_so@meta.data %>%
#   as_tibble(rownames = ".cell_id") %>%
#   mutate(raw_id = str_remove(.cell_id, "_.+$")) %>%
#   dplyr::select(orig.ident, raw_id, subtype) %>%
#   right_join(dat, by = c("orig.ident", "raw_id"), suffix = c("", ".new"))

# Data to draw line connecting timepoints
ln_dat <- dat %>%
  filter(mouse != "6wk-3wk")
  # group_by(!!sym(tm_clmn), subtype) %>%
  # summarize(!!sym(ag_clmn) := median(!!sym(ag_clmn)), .groups = "drop") %>%
  # na.omit() %>%
  # group_by(subtype) %>%
  # group_modify(~ {
  #   if (nrow(.x) == 2) {
  #     scores <- pull(.x, ag_clmn)
  #     tms    <- pull(.x, tm_clmn)
  #     new_ag <- scores[tms == max(tms)]
  #     
  #     .x %>%
  #       add_row(
  #         !!sym(tm_clmn) := max(pull(.x, tm_clmn)) - 1,
  #         !!sym(ag_clmn) := new_ag
  #       )
  #   } else {
  #     .x
  #   }
  # }) %>%
  # ungroup()

# p-values for vaccination
p_dat <- dat %>%
  group_by(!!sym(tm_clmn), subtype) %>%
  filter(all(vacs %in% vaccination)) %>%
  summarize(
    pval = t.test(
      (!!sym(ag_clmn))[vaccination == vacs[1]],
      (!!sym(ag_clmn))[vaccination == vacs[2]],
      alternative = "less"
    )$p.value,
    y = max(!!sym(ag_clmn)),
    y = y + (y * 0.1),
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "bonferroni")) %>%
  rowwise() %>%
  mutate(
    plab = .format_pvalue(padj),
    plab = str_c("italic(p) == ", plab)
  ) %>%
  filter(padj < 0.05)

# Create boxplots
ex_6_bxs <- dat %>%
  ggplot(aes(!!sym(tm_clmn), !!sym(ag_clmn), fill = as.character(!!sym(tm_clmn)), alpha = vaccination)) +
  geom_smooth(
    data = ln_dat,
    mapping = aes(fill = NULL, alpha = NULL),
    method = "loess",
    se = FALSE, color = "grey85", linetype = 2, linewidth = 0.5, show.legend = FALSE,
    span = 0.8
  ) +
  geom_boxplot(
    outlier.size = 0.2, width = 5, key_glyph = draw_key_point,
    position = position_dodge2(preserve = "single")
  ) +
  geom_text(
    aes(y = y, label = plab, alpha = NULL),
    data = p_dat,
    parse = TRUE,
    show.legend = FALSE,
    size = 8 / .pt,
    # size = txt_pt1 / .pt,
    hjust = 0.7
  ) +
  facet_grid(~ subtype) +
  scale_alpha_manual(values = c(single = 0.35, dual = 1)) +
  scale_fill_manual(values = tm_clrs) +
  guides(fill = "none", alpha = guide_legend(override.aes = list(shape = 15, size = 4))) +
  labs(x = "days post vaccination", y = "Ag-score") +
  base_theme +
  theme(
    aspect.ratio = 0.6
  )
```

```{r "exchange correlation", fig.width = 10, fig.height = 4}
# Plot data
dat <- lec_so@meta.data %>%
  as_tibble(rownames = "cell_id") %>%
  filter(
    exp == "exp-1",
    mouse == "6wk-3wk",
    # cell_type == "LEC",
    subtype != "unassigned"
  ) %>%
  group_by(subtype) %>%
  filter(n() > 50) %>%
  ungroup() %>%
  mutate(subtype = fct_relevel(subtype, lec_lvls))

# Calculate correlation
lab_dat <- dat %>%
  group_by(subtype) %>%
  summarize(
    cor   = cor.test(Ag_3wk_score, Ag_6wk_score, method = "pearson")$estimate[[1]],
    p_val = cor.test(Ag_3wk_score, Ag_6wk_score, method = "pearson")$p.value,
    n     = n_distinct(cell_id),
    .groups = "drop"
  ) %>%
  mutate(p_adj = p.adjust(p_val, method = "bonferroni")) %>%
  rowwise() %>%
  mutate(
    p_lab = .format_pvalue(p_adj),
    r_lab = str_c("r = ", round(cor, digits = 2), "\nn = ", n)
    # r_lab = str_c("atop(italic(r) == ", round(cor, digits = 2), ", n == ", n, ")")
    # r_lab = str_c("italic(r) == ", round(cor, digits = 2), " ~~ n == ", n)
    # r_lab = str_c("italic(r) == ", round(cor, digits = 2))
    # r_lab = str_c("italic(r) == ", round(cor, digits = 2), " ~~ italic(p) == ", p_lab)
  )

# Create scatter plots
x_var <- "Ag_6wk_score"
y_var <- "Ag_3wk_score"

ag_labs <- c(
  Ag_3wk_score = "Ag-score (21 day)",
  Ag_6wk_score = "Ag-score (42 day)"
)

ex_scat <- dat %>%
  ggplot(aes(!!sym(x_var), !!sym(y_var), color = subtype)) +
  geom_abline(slope = 1, intercept = 0, size = 0.5, color = "grey90") +
  geom_point(size = 1.5) +
  geom_smooth(
    method    = "lm",
    linetype  = 2,
    linewidth = 0.5,
    color     = "black",
    se        = FALSE,
    formula   = "y ~ x"
  ) +
  geom_text(
    aes(x = -Inf, y = Inf, label = r_lab),
    data  = lab_dat,
    hjust = -0.1,
    vjust = 1.1,
    color = "black",
    size  = ttl_pt1 / .pt
  ) +
  facet_wrap(~ subtype, nrow = 1) +
  
  scale_color_manual(values = lec_clrs) +
  coord_cartesian(
    xlim = c(0, max(c(dat[[x_var]], dat[[y_var]]))),
    ylim = c(0, max(c(dat[[x_var]], dat[[y_var]])))
  ) +
  labs(
    x = ag_labs[x_var],
    y = ag_labs[y_var]
  ) +
  base_theme +
  theme(
    aspect.ratio = 1,
    legend.position = "none"
  )
```

```{r "Fig 2", fig.width = 15, fig.height = 16}
(ex_heat[[1]] + ex_u[[1]]) / ex_3_bxs /
  (ex_heat[[2]] + ex_u[[2]]) / ex_6_bxs /
  ex_scat +
  plot_layout(heights = c(1, 0.55, 1, 0.55, 0.8)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = ttl_pt2 * 1.5, face = "bold"))
```

---

<br>

<br>

## LEC markers

```{r, fig.width = 15, fig.height = 18}
# Plot marker genes
plt_vars <- c(
  "subtype",
  "Prox1", "Lyve1",
  "Marco", "Madcam1", "Ackr4", "Ptx3"
  # "Ptprc", "Cd3e", "Cd19", "Hba-a1",
  # "Pdpn", "Pecam1"
)

plt_vars %>%
  map(~ {
    plt <- lec_so %>%
      mutate_meta(
        mutate,
        tm_lab = ifelse(is.na(tm), vaccination, as.character(tm)),
        tm_lab = fct_relevel(tm_lab, c(as.character(tms), "dual"))
      ) %>%
      plot_scatter(
        .x,
        "hUMAP_1",
        "hUMAP_2",
        group_col = "tm_lab",
        size = 0.5,
        plot_colors = c("lightblue", "red"),
        top = Inf,
        panel_nrow = 1
      ) +
      umap_theme +
      theme(
        aspect.ratio = 0.9,
        panel.border = element_rect(linewidth = ln_pt, color = ln_col)
      )
    
    if (is.numeric(FetchData(lec_so, .x)[[.x]])) {
      plt <- plt +
        guides(color = guide_colorbar(
          ticks = FALSE, barwidth = unit(5, "pt"), barheight = unit(100, "pt")
        ))
    }
    
    plt
  }) %>%
  plot_grid(
    plotlist = .,
    align    = "v",
    axis     = "rl",
    ncol     = 1
  )
```

---

<br>

<br>

## Session info

```{r "session info"}
sessionInfo()
```

```{r "RF TEST 1", eval = FALSE}
# GOALS
# 1. train model for LEC subsets (~80% accuracy for cLECs)
# 2. train general model for all LECs (~60-90% for all subsets)

# Identify Ag markers for all LECs
degs_1 <- lec_so %>%
  wilcoxauc(group_by = "Ag_class") %>%
  filter(
    padj < 0.05, logFC > 0.25,
    !grepl("^(mt-|R[pls])", feature)
  ) %>%
  arrange(padj)

# Identify Ag markers for subtype
degs_2 <- unique(lec_so$subtype) %>%
  map_dfr(~ {
    res <- lec_so %>%
      subset(subtype == .x) %>%
      wilcoxauc(group_by = "Ag_class")

    if (nrow(res) == 0) return(NULL)

    res %>%
      filter(
        padj < 0.05, logFC > 0.25,
        !grepl("^(mt-|R[pls])", feature)
      ) %>%
      mutate(subtype = .x) %>%
      arrange(padj)
  })

# Identify markers for subtype and mouse
degs_3 <- lec_so@meta.data %>%
  distinct(subtype, mouse) %>%
  pmap_dfr(~ {
    res <- lec_so %>%
      subset(subtype == ..1 & mouse == ..2)
    
    if (n_distinct(res$Ag_class) < 2) return(NULL)
    
    res <- res %>%
      wilcoxauc(group_by = "Ag_class")

    if (nrow(res) == 0) return(NULL)

    res %>%
      filter(
        padj < 0.05, logFC > 0.25,
        !grepl("^(mt-|R[pls])", feature)
      ) %>%
      mutate(subtype = ..1, mouse = ..2) %>%
      arrange(padj)
  })

degs <- bind_rows(degs_1, degs_2, degs_3) %>%
  distinct(feature, group)

# Format RF data
# cat_feats <- c("tm", "subtype", "Ag_class")
# dat_col   <- "Ag_score"
cat_feats <- c("tm", "mouse", "subtype")
feats     <- unique(degs$feature)
dat_col   <- "Ag_class"

rf_dat <- lec_so %>%
  FetchData(c(dat_col, cat_feats, feats)) %>%
  mutate(!!sym(dat_col) := fct_relevel(!!sym(dat_col), "high", "low")) %>%
  rename_with(~ str_replace_all(.x, "-", "_")) %>%
  rename_with(~ str_replace_all(.x, "\\(|\\)", "_")) %>%
  rename_with(~ str_c("x", .x), matches("^[0-9]"))

set.seed(42)

rf_split <- rf_dat %>%
  initial_split(prop = 0.1)

rf_test <- testing(rf_split)

rf_train <- training(rf_split) %>%
  dplyr::select(-all_of(cat_feats))

# Tune model
tune_rf <- function(dat_df, dat_col, param_lst, return_best = TRUE) {
  
  rf_params <- expand.grid(param_lst)
  
  res <- pmap_dfr(rf_params, ~ {
    res <- ranger(
      as.formula(str_c(dat_col, " ~ .")),
      data       = dat_df,
      importance = "impurity",
      seed       = 42,
      ...
    )
    
    err <- sqrt(res$prediction.error)
    
    tibble(..., oob_rmse = err)
  })
  
  if (return_best) {
    res <- res %>%
      dplyr::filter(oob_rmse == min(oob_rmse)) %>%
      dplyr::select(-oob_rmse) %>%
      head(1) %>%
      as.list()
  }
  
  res
}

param_lst <- list(
  mtry            = seq(1, ncol(rf_train), 50),
  min.node.size   = c(1:3, 5, 10)
)

rf_params <- rf_train %>%
  tune_rf(
    dat_col   = "Ag_class",
    param_lst = param_lst
  )

# Fit RF
rf_mod <- pmap(rf_params, ~ {
  ranger(
    Ag_class ~ .,
    data       = rf_train,
    importance = "impurity",
    ...
  )
}) %>%
  pluck(1)

# Get predictions
prds <- rf_mod %>%
  predict(rf_test) %>%
  predictions()

rf_res <- rf_test %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(.cell_id, subtype, tm, mouse, Ag_class) %>%
  mutate(
    prediction = prds,
    correct    = Ag_class == prediction
  ) %>%
  group_by(subtype, mouse) %>%
  summarize(
    n       = n(),
    correct = sum(correct) / n,
    .groups = "drop"
  ) %>%
  arrange(desc(correct))

rf_res %>%
  mutate(lab = as.character(round(correct, 2))) %>%
  ggplot(aes(subtype, mouse, fill = correct)) +
  geom_tile() +
  geom_text(aes(label = lab)) +
  scale_fill_gradientn(colours = c("lightblue", "red")) +
  djvdj_theme()

# Get top regression variables
rf_marks <- tibble(
  gene   = names(rf_mod$variable.importance),
  impact = rf_mod$variable.importance
) %>%
  mutate(
    rank = row_number(desc(impact)),
    gene = ifelse(gene %in% cat_feats, gene, str_replace(gene, "_", "-"))
  ) %>%
  arrange(rank) %>%

  left_join(degs, by = c(gene = "feature"))

# # Create boxplots
# n_gns <- 50
# 
# plt_gns <- rf_marks %>%
#   filter(!gene %in% c("Ag-score", "Ag_class", "orig.ident", "tm")) %>%
#   pull(gene) %>%
#   head(n_gns) %>%
#   c("Ag_score", .)
# 
# plt_dat <- rf_so %>%
#   subset(subtype == typ) %>%
#   FetchData(c("tm", "Ag_class", plt_gns)) %>%
#   pivot_longer(all_of(plt_gns)) %>%
#   mutate(
#     tm       = fct_relevel(as.character(tm), tms),
#     Ag_class = fct_relevel(Ag_class, c("low", "high")),
#     name     = fct_relevel(name, plt_gns)
#   )
#   
# plt_dat %>%
#   ggplot(aes(tm, value, fill = name, color = name, alpha = Ag_class)) +
#   geom_boxplot() +
#   facet_wrap(~ name, scales = "free_y") +
#   scale_alpha_manual(values = c(low = 0.25, high = 0.75)) +
#   djvdj_theme()
# 
# # Create scatter plots
# plt_dat <- rf_so %>%
#   subset(subtype == typ) %>%
#   FetchData(c("tm", "Ag_class", plt_gns)) %>%
#   pivot_longer(all_of(plt_gns[-1])) %>%
#   mutate(
#     tm       = fct_relevel(as.character(tm), tms),
#     Ag_class = fct_relevel(Ag_class, c("low", "high")),
#     name     = fct_relevel(name, plt_gns)
#   )
# 
# plt_dat %>%
#   ggplot(aes(Ag_score, value, color = Ag_class)) +
#   geom_point(size = 0.1) +
#   facet_wrap(~ name, scales = "free") +
#   djvdj_theme() +
#   theme(aspect.ratio = 1)
```

```{r "RF TEST 2", eval = FALSE}
# GOALS
# 1. train model for LEC subsets for Ag groups (1-4)
# 2. identify cells in mock that are predicted to take up Ag

# Identify Ag markers for all LECs for each mouse
deg_so <- lec_so %>%
  SplitObject("mouse")

plan(multisession, workers = min(length(deg_so), 8))

degs_1 <- deg_so %>%
  future_imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = "Ag_group")

    if (nrow(res) == 0) return(NULL)

    res %>%
      filter(
        padj < 0.05, logFC > 0.25,
        !grepl("^(mt-|R[pls])", feature)
      ) %>%
      mutate(mouse = .y) %>%
      arrange(padj)
  })

# Identify Ag markers for subtype
deg_so <- lec_so %>%
  SplitObject("subtype")

plan(multisession, workers = min(length(deg_so), 8))

degs_2 <- deg_so %>%
  future_imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = "Ag_group")

    if (nrow(res) == 0) return(NULL)

    res %>%
      filter(
        padj < 0.05, logFC > 0.25,
        !grepl("^(mt-|R[pls])", feature)
      ) %>%
      mutate(subtype = .y) %>%
      arrange(padj)
  })

rm(deg_so)

# Identify markers for subtype and mouse
degs_3 <- lec_so@meta.data %>%
  distinct(subtype, mouse) %>%
  pmap_dfr(~ {
    res <- lec_so %>%
      subset(subtype == ..1 & mouse == ..2)
    
    if (n_distinct(res$Ag_class) < 2) return(NULL)
    
    res <- res %>%
      wilcoxauc(group_by = "Ag_group")

    if (nrow(res) == 0) return(NULL)

    res %>%
      filter(
        padj < 0.05, logFC > 0.25,
        !grepl("^(mt-|R[pls])", feature)
      ) %>%
      mutate(subtype = ..1, mouse = ..2) %>%
      arrange(padj)
  })

degs <- bind_rows(degs_1, degs_2, degs_3) %>%
  distinct(feature, group)

# Format RF data
dat_col   <- "Ag_group"
cat_feats <- c("tm", "mouse", "subtype")
feats     <- unique(degs$feature)

rf_dat <- lec_so %>%
  FetchData(c(dat_col, cat_feats, feats)) %>%
  rename_with(~ str_replace_all(.x, "-", "_")) %>%
  rename_with(~ str_replace_all(.x, "\\(|\\)", "_")) %>%
  rename_with(~ str_c("x", .x), matches("^[0-9]"))

set.seed(42)

rf_split <- rf_dat %>%
  initial_split(prop = 0.1)

rf_test <- testing(rf_split)

rf_train <- training(rf_split) %>%
  dplyr::select(-all_of(cat_feats))

# Tune model
tune_rf <- function(dat_df, dat_col, param_lst, return_best = TRUE) {
  
  rf_params <- expand.grid(param_lst)
  
  res <- pmap_dfr(rf_params, ~ {
    res <- ranger(
      as.formula(str_c(dat_col, " ~ .")),
      data       = dat_df,
      importance = "impurity",
      seed       = 42,
      ...
    )
    
    err <- sqrt(res$prediction.error)
    
    tibble(..., oob_rmse = err)
  })
  
  if (return_best) {
    res <- res %>%
      dplyr::filter(oob_rmse == min(oob_rmse)) %>%
      dplyr::select(-oob_rmse) %>%
      head(1) %>%
      as.list()
  }
  
  res
}

param_lst <- list(
  mtry            = seq(1, ncol(rf_train), 100),
  min.node.size   = c(1:3, 5, 10)
)

rf_params <- rf_train %>%
  tune_rf(
    dat_col   = "Ag_group",
    param_lst = param_lst
  )

# Fit model
rf_mod <- pmap(rf_params, ~ {
  ranger(
    Ag_class ~ .,
    data       = rf_train,
    importance = "impurity",
    ...
  )
}) %>%
  pluck(1)

# Get predictions
prds <- rf_mod %>%
  predict(rf_test) %>%
  predictions()

rf_res <- rf_test %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(.cell_id, subtype, tm, mouse, Ag_class) %>%
  mutate(
    prediction = prds,
    correct    = Ag_class == prediction
  ) %>%
  group_by(subtype, mouse) %>%
  summarize(
    n       = n(),
    correct = sum(correct) / n,
    .groups = "drop"
  ) %>%
  arrange(desc(correct))

rf_res %>%
  mutate(lab = as.character(round(correct, 2))) %>%
  ggplot(aes(subtype, mouse, fill = correct)) +
  geom_tile() +
  geom_text(aes(label = lab)) +
  scale_fill_gradientn(colours = c("lightblue", "red")) +
  djvdj_theme()

# Get top regression variables
rf_marks <- tibble(
  gene   = names(rf_mod$variable.importance),
  impact = rf_mod$variable.importance
) %>%
  mutate(
    rank = row_number(desc(impact)),
    gene = ifelse(gene %in% cat_feats, gene, str_replace(gene, "_", "-"))
  ) %>%
  arrange(rank) %>%

  left_join(degs, by = c(gene = "feature"))



# # Create boxplots
# n_gns <- 50
# 
# plt_gns <- rf_marks %>%
#   filter(!gene %in% c("Ag-score", "Ag_class", "orig.ident", "tm")) %>%
#   pull(gene) %>%
#   head(n_gns) %>%
#   c("Ag_score", .)
# 
# plt_dat <- rf_so %>%
#   subset(subtype == typ) %>%
#   FetchData(c("tm", "Ag_class", plt_gns)) %>%
#   pivot_longer(all_of(plt_gns)) %>%
#   mutate(
#     tm       = fct_relevel(as.character(tm), tms),
#     Ag_class = fct_relevel(Ag_class, c("low", "high")),
#     name     = fct_relevel(name, plt_gns)
#   )
#   
# plt_dat %>%
#   ggplot(aes(tm, value, fill = name, color = name, alpha = Ag_class)) +
#   geom_boxplot() +
#   facet_wrap(~ name, scales = "free_y") +
#   scale_alpha_manual(values = c(low = 0.25, high = 0.75)) +
#   djvdj_theme()
# 
# # Create scatter plots
# plt_dat <- rf_so %>%
#   subset(subtype == typ) %>%
#   FetchData(c("tm", "Ag_class", plt_gns)) %>%
#   pivot_longer(all_of(plt_gns[-1])) %>%
#   mutate(
#     tm       = fct_relevel(as.character(tm), tms),
#     Ag_class = fct_relevel(Ag_class, c("low", "high")),
#     name     = fct_relevel(name, plt_gns)
#   )
# 
# plt_dat %>%
#   ggplot(aes(Ag_score, value, color = Ag_class)) +
#   geom_point(size = 0.1) +
#   facet_wrap(~ name, scales = "free") +
#   djvdj_theme() +
#   theme(aspect.ratio = 1)
```

```{r "RF TEST 3", eval = FALSE}
# GOALS
# 1. train model for LEC subsets for Ag groups (1-4)
# 2. identify cells in mock that are predicted to take up Ag

# Identify DEGs ----
# Identify Ag markers for all LECs for each mouse
grp <- "Ag_class"
fc  <- 0

deg_so <- lec_so %>%
  SplitObject("mouse")

degs_1 <- deg_so %>%
  imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = "all", mouse = .y) %>%
      arrange(padj)
  })

# Identify Ag markers for subtype
deg_so <- lec_so %>%
  SplitObject("subtype")

degs_2 <- deg_so %>%
  imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = .y, mouse = "all") %>%
      arrange(padj)
  })

rm(deg_so)

# Identify markers for subtype and mouse
degs_3 <- lec_so@meta.data %>%
  distinct(subtype, mouse) %>%
  pmap_dfr(~ {
    res <- lec_so %>%
      subset(subtype == ..1 & mouse == ..2)
    
    if (n_distinct(res$Ag_class) < 2) return(NULL)
    
    res <- res %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = ..1, mouse = ..2) %>%
      arrange(padj)
  })

degs <- bind_rows(degs_1, degs_2, degs_3) %>%
  filter(
    padj < 0.05, logFC > fc,
    !grepl("^(mt-|R[pls])", feature)
  )

# Format data ----
# dat_col    <- "Ag_group"
dat_col    <- "Ag_class_2"
feats      <- unique(degs$feature)
other_vars <- NULL

feats <- degs %>%
  filter(subtype == "cLEC", mouse == "d14") %>%
  pull(feature) %>%
  unique()

other_info <- c("tm", "subtype", "mouse")

rf_dat <- lec_so %>%
  subset(subtype == "cLEC" & mouse == "d14") %>%

  FetchData(unique(c(dat_col, other_info, other_vars, feats))) %>%
  
  # mutate(across(all_of(feats), ~ as.numeric(scale(.x)))) %>%
  # mutate(!!sym(dat_col) := factor(!!sym(dat_col))) %>%
  # mutate(
  #   across(all_of(c(dat_col, other_vars)), ~ as.numeric(factor(.x)))
  # ) %>%
  
  rename_with(~ str_replace_all(.x, "-", "_")) %>%
  rename_with(~ str_replace_all(.x, "\\(|\\)", "_")) %>%
  rename_with(~ str_c("x", .x), matches("^[0-9]"))

# Adjust groups so they are balanced
sam_sz <- rf_dat %>%
  group_by(!!sym(dat_col), mouse) %>%
  summarize(n = n(), .groups = "drop") %>%
  pull(n)

# sam_sz <- max(100, min(sam_sz))
sam_sz <- 135

# Split into train/test data
# rf_split <- initial_split(rf_dat, prop = 0.5)
# rf_train <- training(rf_split)
# rf_test  <- testing(rf_split)

rf_train <- rf_dat %>%
  rownames_to_column(".cell_id") %>%
  group_by(!!sym(dat_col), mouse) %>%
  filter(n() >= sam_sz) %>%
  dplyr::sample_n(sam_sz) %>%
  ungroup() %>%
  dplyr::select(-all_of(other_info[!other_info %in% other_vars])) %>%
  column_to_rownames(".cell_id")

rf_test <- rf_dat[!rownames(rf_dat) %in% rownames(rf_train), ]

# Tune RF model ----
tune_rf <- function(dat_df, dat_col, param_lst, return_best = TRUE) {
  
  rf_params <- expand.grid(param_lst)
  
  res <- pmap_dfr(rf_params, ~ {
    res <- ranger(
      as.formula(str_c("factor(", dat_col, ") ~ .")),
      data       = dat_df,
      importance = "impurity",
      seed       = 42,
      ...
    )
    
    err <- sqrt(res$prediction.error)
    
    tibble(..., oob_rmse = err)
  })
  
  if (return_best) {
    res <- res %>%
      dplyr::filter(oob_rmse == min(oob_rmse)) %>%
      dplyr::select(-oob_rmse) %>%
      head(1) %>%
      as.list()
  }
  
  res
}

param_lst <- list(
  # mtry          = c(10, 50, 200, 300),
  mtry          = seq(10, 60, 10),
  min.node.size = c(1, 2, 5),
  num.trees     = 1000
)

rf_params <- rf_train %>%
  tune_rf(
    dat_col   = dat_col,
    param_lst = param_lst
  )

# rf_params <- list(
#   mtry = 10,
#   min.node.size = 1,
#   num.trees = 1000
#   # max.depth = 5
# )

# Fit RF model
rf_mod <- pmap(rf_params, ~ {
  ranger(
    as.formula(str_c("factor(", dat_col, ") ~ .")),
    data       = rf_train,
    importance = "impurity",
    ...
  )
}) %>%
  pluck(1)

# Identify top features and re-fit
top_feats <- importance(rf_mod) %>%
  sort(decreasing = TRUE)

top_feats <- top_feats[top_feats > 0]

rf_params$mtry <- min(length(top_feats), rf_params$mtry)

rf_mod_top <- pmap(rf_params, ~ {
  ranger(
    as.formula(str_c("factor(", dat_col, ") ~ .")),
    data       = rf_train[, c(dat_col, names(top_feats))],
    importance = "impurity",
    ...
  )
}) %>%
  pluck(1)

# prds <- rf_mod_top %>%
prds <- rf_mod %>%
  predict(rf_test) %>%
  predictions()

# Try logit regression ----
logit_mod <- rf_train %>%
  mutate(
    Ag_class = ifelse(Ag_class == "high", 1, 0),
    Ag_class = factor(Ag_class)
  ) %>%
  glm(
    data = .,
    # as.factor(Ag_class) ~ Cav1 + Marcks | as.numeric(as.factor(mouse)),
    # as.factor(Ag_class) ~ Cav1 + Marcks,
    Ag_class ~ .,
    control = glm.control(maxit = 200),
    family = binomial
  )

prob <- logit_mod %>%
  predict(newdata = rf_test, type = "response")

prds <- vector("character", length(prob))
prds[prob > 0.7] <- "high"
prds[prob <= 0.7] <- "low"

# Try glmer ----
# library(lme4)
# 
# logit_mod <- rf_train %>%
#   mutate(
#     Ag_class = ifelse(Ag_class == "high", 1, 0),
#     Ag_class = factor(Ag_class)
#   ) %>%
#   glmer(
#     data = .,
#     # as.factor(Ag_class) ~ Cav1 + Marcks | as.numeric(as.factor(mouse)),
#     # as.factor(Ag_class) ~ Cav1 + Marcks,
#     # Ag_class ~ (. | factor(mouse)),
#     # control = glm.control(maxit = 200),
#     Ag_class ~ (. | factor(exp)),
#     family = binomial
#   )
# 
# prob <- logit_mod %>%
#   predict(newdata = rf_test, type = "response")
# 
# prds <- vector("character", length(prob))
# prds[prob > 0.5] <- "high"
# prds[prob <= 0.5] <- "low"


# Get predictions ----
rf_res <- rf_test %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(.cell_id, subtype, all_of(c(dat_col, other_vars, other_info))) %>%
  mutate(
    prediction = prds,
    correct    = !!sym(dat_col) == prediction
  ) %>%
  # group_by(subtype, !!sym(other_vars)) %>%
  group_by(!!!syms(c(other_info, dat_col))) %>%
  summarize(
    n       = n(),
    correct = sum(correct) / n,
    .groups = "drop"
  ) %>%
  arrange(desc(correct))

# Plot results
rf_res %>%
  mutate(lab = as.character(round(correct, 2))) %>%
  ggplot(aes(subtype, mouse, fill = correct)) +
  geom_tile() +
  geom_text(aes(label = lab)) +
  facet_wrap(~ Ag_class_2) +
  scale_fill_gradientn(colours = c("lightblue", "red")) +
  djvdj_theme()

# Get top regression variables
rf_marks <- tibble(
  gene   = names(rf_mod$variable.importance),
  impact = rf_mod$variable.importance
) %>%
  mutate(
    rank = row_number(desc(impact)),
    gene = ifelse(gene %in% cat_feats, gene, str_replace(gene, "_", "-"))
  ) %>%
  arrange(rank) %>%

  left_join(degs, by = c(gene = "feature"))



# # Create boxplots
# n_gns <- 50
# 
# plt_gns <- rf_marks %>%
#   filter(!gene %in% c("Ag-score", "Ag_class", "orig.ident", "tm")) %>%
#   pull(gene) %>%
#   head(n_gns) %>%
#   c("Ag_score", .)
# 
# plt_dat <- rf_so %>%
#   subset(subtype == typ) %>%
#   FetchData(c("tm", "Ag_class", plt_gns)) %>%
#   pivot_longer(all_of(plt_gns)) %>%
#   mutate(
#     tm       = fct_relevel(as.character(tm), tms),
#     Ag_class = fct_relevel(Ag_class, c("low", "high")),
#     name     = fct_relevel(name, plt_gns)
#   )
#   
# plt_dat %>%
#   ggplot(aes(tm, value, fill = name, color = name, alpha = Ag_class)) +
#   geom_boxplot() +
#   facet_wrap(~ name, scales = "free_y") +
#   scale_alpha_manual(values = c(low = 0.25, high = 0.75)) +
#   djvdj_theme()
# 
# # Create scatter plots
# plt_dat <- rf_so %>%
#   subset(subtype == typ) %>%
#   FetchData(c("tm", "Ag_class", plt_gns)) %>%
#   pivot_longer(all_of(plt_gns[-1])) %>%
#   mutate(
#     tm       = fct_relevel(as.character(tm), tms),
#     Ag_class = fct_relevel(Ag_class, c("low", "high")),
#     name     = fct_relevel(name, plt_gns)
#   )
# 
# plt_dat %>%
#   ggplot(aes(Ag_score, value, color = Ag_class)) +
#   geom_point(size = 0.1) +
#   facet_wrap(~ name, scales = "free") +
#   djvdj_theme() +
#   theme(aspect.ratio = 1)
```

```{r "RF d14 TEST", eval = FALSE}
# GOALS
# 1. train model for LEC subsets for Ag groups (1-4)
# 2. identify cells in mock that are predicted to take up Ag

# Identify DEGs ----
# Identify Ag markers for all LECs for each mouse
grp <- "Ag_class_2"
fc  <- 0

deg_so <- lec_so %>%
  SplitObject("mouse")

degs_1 <- deg_so %>%
  imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = "all", mouse = .y) %>%
      arrange(padj)
  })

# Identify Ag markers for subtype
deg_so <- lec_so %>%
  SplitObject("subtype")

degs_2 <- deg_so %>%
  imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = .y, mouse = "all") %>%
      arrange(padj)
  })

rm(deg_so)

# Identify markers for subtype and mouse
degs_3 <- lec_so@meta.data %>%
  distinct(subtype, mouse) %>%
  pmap_dfr(~ {
    res <- lec_so %>%
      subset(subtype == ..1 & mouse == ..2)
    
    if (n_distinct(res[[grp]]) < 2) return(NULL)
    
    res <- res %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = ..1, mouse = ..2) %>%
      arrange(padj)
  })

degs <- bind_rows(degs_1, degs_2, degs_3) %>%
  filter(
    padj < 0.05, logFC > fc,
    !grepl("^(mt-|R[pls])", feature),
    feature != "Malat1"
  )

degs %>%
  write_tsv(here(params$so_dir, "ag-high_degs_Ag_class_2.tsv.gz"))

# Most common degs
top_degs <- degs %>%
  group_by(subtype, feature, group) %>%
  summarize(n = n_distinct(mouse), .groups = "drop") %>%
  arrange(desc(n)) %>%
  filter(n > 1) %>%
  filter(!subtype %in% c("all", "BEC", "unassigned")) %>%
  group_by(feature, group) %>%
  summarize(n_typ = n_distinct(subtype), .groups = "drop") %>%
  arrange(desc(n_typ)) %>%
  filter(n_typ > 1)

# Format data ----
dat_col    <- "Ag_class_2"
feats      <- unique(degs$feature)
other_vars <- NULL

# feats <- degs %>%
#   filter(subtype == "cLEC", mouse == "d14") %>%
#   pull(feature) %>%
#   unique()
feats <- unique(top_degs$feature)

other_info <- c("tm", "subtype", "mouse")

rf_dat <- rf_so %>%
  # subset(subtype != "BEC" & subtype == "cLEC") %>%
  subset(subtype == "cLEC" & mouse == "d14") %>%

  FetchData(unique(c(dat_col, other_info, other_vars, feats))) %>%
  
  rename_with(~ str_replace_all(.x, "-", "_")) %>%
  rename_with(~ str_replace_all(.x, "\\(|\\)", "_")) %>%
  rename_with(~ str_c("x", .x), matches("^[0-9]"))

# Adjust groups so they are balanced
# Split into train/test data
sam_sz <- 135

rf_train <- rf_dat %>%
  rownames_to_column(".cell_id") %>%
  group_by(!!sym(dat_col), subtype, mouse) %>%
  filter(n() >= sam_sz) %>%
  dplyr::sample_n(sam_sz) %>%
  ungroup() %>%
  dplyr::select(-all_of(other_info[!other_info %in% other_vars])) %>%
  column_to_rownames(".cell_id")

rf_test <- rf_dat[!rownames(rf_dat) %in% rownames(rf_train), ]

# Tune RF model ----
tune_rf <- function(dat_df, dat_col, param_lst, return_best = TRUE) {
  
  rf_params <- expand.grid(param_lst)
  
  res <- pmap_dfr(rf_params, ~ {
    res <- ranger(
      as.formula(str_c("factor(", dat_col, ") ~ .")),
      data       = dat_df,
      importance = "impurity",
      seed       = 42,
      ...
    )
    
    err <- sqrt(res$prediction.error)
    
    tibble(..., oob_rmse = err)
  })
  
  if (return_best) {
    res <- res %>%
      dplyr::filter(oob_rmse == min(oob_rmse)) %>%
      dplyr::select(-oob_rmse) %>%
      head(1) %>%
      as.list()
  }
  
  res
}

param_lst <- list(
  mtry          = seq(2, length(feats), 5),
  min.node.size = c(1, 2, 5),
  num.trees     = 1000
)

rf_params <- rf_train %>%
  tune_rf(
    dat_col   = dat_col,
    param_lst = param_lst
  )

# Fit RF model
rf_mod <- pmap(rf_params, ~ {
  ranger(
    as.formula(str_c("factor(", dat_col, ") ~ .")),
    data       = rf_train,
    importance = "impurity",
    ...
  )
}) %>%
  pluck(1)

# Identify top features and re-fit
top_feats <- importance(rf_mod) %>%
  sort(decreasing = TRUE)

top_feats <- top_feats[top_feats > 0]

rf_params$mtry <- min(length(top_feats), rf_params$mtry)

rf_mod_top <- pmap(rf_params, ~ {
  ranger(
    as.formula(str_c("factor(", dat_col, ") ~ .")),
    data       = rf_train[, c(dat_col, names(top_feats))],
    importance = "impurity",
    ...
  )
}) %>%
  pluck(1)

# prds <- rf_mod %>%
  # predict(rf_dat) %>%
prds <- rf_mod_top %>%
  predict(rf_test) %>%
  predictions()

# Get predictions ----
# rf_res <- rf_test %>%
rf_res <- rf_dat %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(.cell_id, subtype, all_of(c(dat_col, other_vars, other_info))) %>%
  mutate(
    prediction = prds,
    correct    = !!sym(dat_col) == prediction
  ) %>%
  group_by(!!!syms(c(other_info, dat_col))) %>%
  summarize(
    n       = n(),
    correct = sum(correct) / n,
    .groups = "drop"
  ) %>%
  arrange(desc(correct))

# Plot results
rf_res %>%
  mutate(lab = as.character(round(correct, 2))) %>%
  ggplot(aes(subtype, mouse, fill = correct)) +
  geom_tile() +
  geom_text(aes(label = lab)) +
  facet_wrap(~ Ag_class_2) +
  scale_fill_gradientn(colours = c("lightblue", "red")) +
  djvdj_theme()

# Get top regression variables
rf_marks <- tibble(
  gene   = names(rf_mod$variable.importance),
  impact = rf_mod$variable.importance
) %>%
  mutate(
    rank = row_number(desc(impact)),
    gene = ifelse(gene %in% cat_feats, gene, str_replace(gene, "_", "-"))
  ) %>%
  arrange(rank) %>%

  left_join(degs, by = c(gene = "feature"))

# Create boxplots
n_gns <- 50

plt_gns <- rf_marks %>%
  filter(!gene %in% c("Ag_score", dat_col, "orig.ident", "tm")) %>%
  pull(gene) %>%
  unique() %>%
  head(n_gns) %>%
  c("Ag_score", .) %>%
  str_remove("^x")

plt_dat <- lec_so %>%
  subset(subtype == typ) %>%
  FetchData(c("tm", dat_col, plt_gns)) %>%
  pivot_longer(all_of(plt_gns)) %>%
  mutate(
    tm         = fct_relevel(as.character(tm), tms),
    Ag_class_2 = fct_relevel(Ag_class_2, c("low", "high")),
    name       = fct_relevel(name, plt_gns)
  )

plt_dat %>%
  ggplot(aes(tm, value, fill = name, color = name, alpha = Ag_class_2)) +
  geom_boxplot() +
  facet_wrap(~ name, scales = "free_y") +
  scale_alpha_manual(values = c(low = 0.25, high = 0.75)) +
  djvdj_theme()

# # Create scatter plots
# plt_dat <- rf_so %>%
#   subset(subtype == typ) %>%
#   FetchData(c("tm", "Ag_class", plt_gns)) %>%
#   pivot_longer(all_of(plt_gns[-1])) %>%
#   mutate(
#     tm       = fct_relevel(as.character(tm), tms),
#     Ag_class = fct_relevel(Ag_class, c("low", "high")),
#     name     = fct_relevel(name, plt_gns)
#   )
# 
# plt_dat %>%
#   ggplot(aes(Ag_score, value, color = Ag_class)) +
#   geom_point(size = 0.1) +
#   facet_wrap(~ name, scales = "free") +
#   djvdj_theme() +
#   theme(aspect.ratio = 1)
```



```{r "RF DEGs", eval = FALSE}
# GOALS
# 1. train model for LEC subsets for Ag groups (1-4)
# 2. identify cells in mock that are predicted to take up Ag

# Identify Ag markers for all LECs for each mouse
grp <- "Ag_class_2"
fc  <- 0

deg_so <- lec_so %>%
  SplitObject("mouse")

degs_1 <- deg_so %>%
  imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = "all", mouse = .y) %>%
      arrange(padj)
  })

# Identify Ag markers for subtype
deg_so <- lec_so %>%
  SplitObject("subtype")

degs_2 <- deg_so %>%
  imap_dfr(~ {
    res <- .x %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = .y, mouse = "all") %>%
      arrange(padj)
  })

rm(deg_so)

# Identify markers for subtype and mouse
degs_3 <- lec_so@meta.data %>%
  distinct(subtype, mouse) %>%
  pmap_dfr(~ {
    res <- lec_so %>%
      subset(subtype == ..1 & mouse == ..2)
    
    if (n_distinct(res[[grp]]) < 2) return(NULL)
    
    res <- res %>%
      wilcoxauc(group_by = grp)

    if (nrow(res) == 0) return(NULL)

    res %>%
      mutate(subtype = ..1, mouse = ..2) %>%
      arrange(padj)
  })

degs <- bind_rows(degs_1, degs_2, degs_3) %>%
  filter(
    padj < 0.05, logFC > fc,
    !grepl("^(mt-|R[pls])", feature),
    feature != "Malat1"
  )

# degs %>%
#   write_tsv(here(params$so_dir, "ag-high_degs_Ag_class_2.tsv.gz"))

# # Most common degs
# top_degs <- degs %>%
#   group_by(subtype, feature, group) %>%
#   summarize(n = n_distinct(mouse), .groups = "drop") %>%
#   arrange(desc(n))
#   filter(n > 1)
```

```{r "RF FUNCTIONS", eval = FALSE}
# Function to predict
rf_predict <- function(mod, dat, data_clmn, return_stats = TRUE) {
  
  prds <- mod %>%
    predict(dat) %>%
    predictions()
  
  res <- dat %>%
    as_tibble(rownames = ".cell_id") %>%
    dplyr::select(.cell_id, all_of(data_clmn)) %>%
    mutate(
      pred = prds,
      correct = !!sym(data_clmn) == pred
    ) %>%
    group_by(!!sym(data_clmn)) %>%
    mutate(frac_correct = sum(correct) / n()) %>%
    ungroup()
  
  if (!return_stats) return(column_to_rownames(res, ".cell_id"))
  
  res <- res %>%
    distinct(!!sym(data_clmn), frac_correct) %>%
    pivot_wider(names_from = all_of(data_clmn), values_from = frac_correct)
  
  res
}

run_rf <- function(df_in, data_clmn, param_lst, sample_size = 135,
                   feat_p = 0.05, min_feats = 20, sample_info = NULL) {
  
  # Format train/test data
  rf_dat <- df_in %>%
    rename_with(~ str_replace_all(.x, "-", "_")) %>%
    rename_with(~ str_replace_all(.x, "\\(|\\)", "_")) %>%
    rename_with(~ str_c("x", .x), matches("^[0-9]"))
  
  # Adjust groups so they are balanced
  # Split into train/test data
  sam_sz <- min(sample_size, min(table(rf_dat[[data_clmn]])))
  min_sz <- 40
  
  if (sam_sz < min_sz) {
    cli::cli_abort("All groups must have at least {min_sz} cells")
    
  } else if (sam_sz < sample_size) {
    cli::cli_warn(
      "{sample_size} is too large for the number of cells,
       a sample size of {sam_sz} was used"
    )
  }
  
  rf_train <- rf_dat %>%
    rownames_to_column(".cell_id") %>%
    group_by(!!sym(data_clmn))
  
  set.seed(42)
  
  rf_train <- rf_train %>%
    dplyr::sample_n(sam_sz) %>%
    ungroup() %>%
    dplyr::select(-any_of(sample_info)) %>%
    column_to_rownames(".cell_id")
  
  rf_test <- rf_dat[!rownames(rf_dat) %in% rownames(rf_train), ]
  
  # Train models
  rf_params <- expand.grid(param_lst)
  
  res <- pmap_dfr(rf_params, ~ {
    args <- list(...)
    
    if (args$mtry > (ncol(rf_train) - 1)) return(NULL)
    
    args$formula    <- as.formula(str_c("factor(", data_clmn, ") ~ ."))
    args$data       <- rf_train
    args$importance <- "impurity_corrected"
    args$seed       <- 42
    
    set.seed(42)
    
    raw_mod <- lift_dl(ranger)(args)
    
    raw_err <- raw_mod$prediction.error

    # Feature selection
    key_feats <- raw_mod %>%
      importance_pvalues() %>%
      .[, "pvalue"] %>%
      sort()
    
    max_p <- key_feats %>%
      head(min_feats) %>%
      max()
    
    feat_p <- max(max_p, feat_p)
    
    key_feats <- key_feats[key_feats < feat_p] %>%
      names()
    
    n_feats <- length(key_feats)
    
    # Re-train model
    args$mtry       <- min(args$mtry, n_feats)
    args$data       <- rf_train[, c(data_clmn, key_feats)]
    args$importance <- "none"
    
    set.seed(42)
    
    mod <- lift_dl(ranger)(args)
    
    err <- mod$prediction.error
    
    # Test model    
    prds <- mod %>%
      rf_predict(
        dat = rf_test,
        data_clmn = data_clmn
      )
                                         # only used for continuous
    # err <- sqrt(res$prediction.error)  # response variables
    
    # Format output table
    tibble(
      raw_mod   = list(raw_mod),
      mod       = list(mod),
      feats     = list(key_feats),
      n_train   = nrow(rf_train),
      n_test    = nrow(rf_test),
      # train_bcs = list(rownames(rf_train)),
      # test_bcs  = list(rownames(rf_test)),
      ...,
      n_feats = length(key_feats),
      oob_raw = raw_err,
      oob     = err
    ) %>%
      bind_cols(prds)
  })
  
  res
}
```

```{r "RF MODELS", eval = FALSE}
# Train models
# use all cLEC features
dat_col <- "Ag_class_2"

feats <- degs %>%
  filter(subtype == "cLEC") %>%
  # filter(subtype == "cLEC", mouse == "d14") %>%
  pull(feature) %>%
  unique()

other_info <- c("subtype", "mouse")

rf_dat <- lec_so %>%
  subset(subtype == "cLEC" & mouse == "d14") %>%
  FetchData(unique(c(dat_col, other_info, feats)))

param_lst <- list(
  mtry          = seq(2, length(feats), 10),
  min.node.size = c(1:10),
  num.trees     = seq(50, 1000, 50)
)

rf_res <- rf_dat %>%
  run_rf(
    data_clmn   = dat_col,
    param_lst   = param_lst,
    sample_info = other_info,
    sample_size = 135
  ) %>%
  # arrange(desc(high), desc(low))
  arrange(desc(low), desc(high))

# Pull best model
best_mod <- rf_res %>%
  head(1) %>%
  pull(mod) %>%
  .[[1]]

best_feats <- rf_res %>%
  head(1) %>%
  pull(feats) %>%
  unlist()

# Predict for other timepoints
tm_dat <- lec_so %>%
  subset(subtype == "cLEC") %>%
  FetchData(unique(c(dat_col, other_info, feats))) %>%
  rename_with(~ str_replace_all(.x, "-", "_")) %>%
  rename_with(~ str_replace_all(.x, "\\(|\\)", "_")) %>%
  rename_with(~ str_c("x", .x), matches("^[0-9]")) %>%
  split(.$mouse)

preds <- tm_dat %>%
  imap_dfr(~ {
    best_mod %>%
      rf_predict(.x, data_clmn = dat_col, return_stats = FALSE) %>%
      mutate(mouse = .y)
  })

# Plot predicted classifications
pred_meta <- preds %>%
  dplyr::select(pred, correct)

lec_so <- lec_so %>%
  AddMetaData(pred_meta)

lec_so %>%
  plot_scatter(
    "pred", "hUMAP_1", "hUMAP_2",
    group_col = "mouse",
    size = 0.1,
    panel_nrow = 1
  ) +
  theme(aspect.ratio = 0.9)

# Fraction predicted in each mouse
plt_dat <- lec_so %>%
  subset(subtype == "cLEC") %>%
  AddModuleScore(features = best_feats, name = "Ag_module") %>%
  mutate_meta(
    mutate,
    pred_grp = case_when(
      Ag_class_2 == "high" ~ Ag_class_2,
      pred       == "high" ~ "high-predicted",
      TRUE                 ~ Ag_class_2
    ),
    mouse = fct_relevel(mouse, mice)
  )

plt_dat %>%
  plot_frequency("pred_grp", cluster_col = "mouse")

# Module scores for each prediction group
# expect that these genes will be highest expressed in high, high-predicted,
# lowest in low
# 3wk sample shows opposite
plt_dat@meta.data %>%
  # ggplot(aes(mouse, Ag_module1, fill = Ag_class_2)) +
  ggplot(aes(mouse, Ag_module1, fill = pred_grp)) +
  # geom_violin(scale = "width", draw_quantiles = c(0.25, 0.75, 0.5)) +
  geom_boxplot() +
  djvdj_theme()
  

```

```{r "COMPARE WITH MOCK DATA", eval = FALSE, fig.width = 18, fig.height = 15}

# Plot top features across data
plt_feats <- degs %>%
  group_by(subtype, feature, group) %>%
  summarize(n = n_distinct(mouse), .groups = "drop") %>%
  arrange(desc(n)) %>%
  filter(n > 1) %>%
  filter(group == "high") %>%
  split(.$subtype) %>%
  map(pull, feature)

# plt_feats <- top_degs %>%
#   split(.$group)

clmns <- str_c(names(plt_feats), seq_along(plt_feats))

plt_dat <- lec_so %>%
  Seurat::AddModuleScore(features = list(plt_feats$high$feature)) %>%
  # Seurat::AddModuleScore(features = plt_feats, name = names(plt_feats)) %>%
  FetchData(c("Ag_class_2", "Cluster1", "orig.ident", "mouse", "tm", "subtype"))

plt_dat %>%
  mutate(Ag_class_2 = fct_relevel(Ag_class_2, c("low", "high"))) %>%
  ggplot(aes(mouse, Cluster1, fill = mouse, alpha = Ag_class_2)) +
  geom_boxplot() +
  scale_alpha_manual(values = c(high = 0.75, low = 0.25)) +
  facet_wrap(~ subtype) +
  djvdj_theme()

# Load mock data
chikv_so <- qread("~/Dropbox/Ryan/Projects/morrison-lnsc/results/sobjs/so_merge.qs")

# Calculate module score
chikv_dat <- chikv_so %>%
  Seurat::AddModuleScore(features = plt_feats, name = names(plt_feats)) %>%
  FetchData(c("orig.ident", "lec_type", "tm", "cell_type", "rep", "cell_type_2", "treatment", clmns, "subtype"))

# Calculate mean signal
all_gns <- unique(unlist(plt_feats))

chikv_dat <- chikv_so %>%
  FetchData(c(
    "orig.ident", "lec_type", "tm", "cell_type",
    "rep", "cell_type_2", "treatment", "subtype",
    all_gns
  ))

# Plot example genes
chikv_so %>%
  FetchData(c("treatment", "tm", "lec_type", "rep", "Ctsd", "cell_type_2")) %>%
  filter(cell_type_2 == "LEC" | lec_type == "BEC") %>%
  mutate(
    treat_rep = str_c(treatment, "-", rep),
    treatment = fct_relevel(treatment, c("mock", "CHIKV"))
  ) %>%
  ggplot(aes(lec_type, Ctsd, fill = treatment, alpha = rep)) +
  geom_boxplot(outlier.size = 0.1) +
  scale_alpha_manual(values = c(0.2, 0.4, 0.6)) +
  facet_wrap(~ tm) +
  djvdj_theme() +
  theme(
    aspect.ratio = 0.4,
    axis.title.x = element_blank(),
    axis.text.x  = element_text(angle = 45, hjust = 1)
  )

# # Plot mean list expression
# plt_dat <- chikv_dat %>%
#   pivot_longer(any_of(all_gns)) %>%
#   filter(cell_type_2 == "LEC" | lec_type == "BEC")
# 
#   mutate(
#     treat_rep = str_c(treatment, "-", rep),
#     treatment = fct_relevel(treatment, c("mock", "CHIKV"))
#   ) %>%
#   ggplot(aes(lec_type, Ctsd, fill = treatment, alpha = rep)) +
#   geom_boxplot(outlier.size = 0.1) +
#   scale_alpha_manual(values = c(0.2, 0.4, 0.6)) +
#   facet_wrap(~ tm) +
#   djvdj_theme() +
#   theme(
#     aspect.ratio = 0.4,
#     axis.title.x = element_blank(),
#     axis.text.x  = element_text(angle = 45, hjust = 1)
#   )

# Plot module scores
plt <- clmns %>%
  map(~ {
    chikv_dat %>%
      filter(cell_type_2 == "LEC" | lec_type == "BEC") %>%
      mutate(
        treat_rep = str_c(treatment, "-", rep),
        treatment = fct_relevel(treatment, c("mock", "CHIKV"))
      ) %>%
      ggplot(aes(lec_type, !!sym(.x), fill = treatment, alpha = rep)) +
      geom_boxplot(outlier.size = 0.01, outlier.alpha = 1, size = 0.4) +
      scale_alpha_manual(values = c(0.2, 0.4, 0.6)) +
      facet_wrap(~ tm, nrow = 1) +
      guides(alpha = FALSE) +
      djvdj_theme() +
      theme(
        aspect.ratio = 0.4,
        axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 45, hjust = 1),
        legend.position = "top"
      )
  }) %>%
  plot_grid(plotlist = ., ncol = 2)

ggsave(
  here(params$so_dir, "ag_markers_chikv.png"),
  plot = plt,
  width = 18, height = 15
)
```



```{r "COMPARISON OF EMPTY DROPS", eval = FALSE}
# Paths to raw matrices to use for normalization factors
mat_dir <- names(params$res_dir)
mat_dir <- set_names(params[mat_dir], mat_dir)

# Calculate normalization factors
filt_counts <- qread(here("results/2022-10-28/sobjs/filt_norm_factors.qs"))
raw_counts  <- qread(here("results/2022-10-28/sobjs/norm_factors.qs"))

counts_df <- list(raw = raw_counts, filt = filt_counts) %>%
  imap_dfr(~ {
    reads <- .y
    
    .x %>%
      imap_dfr(~ {
        tibble(
          reads   = reads,
          run     = .y,
          library = names(.x),
          counts  = .x
        )
      })
  }) %>%
  pivot_wider(names_from = reads, values_from = counts) %>%
  mutate(frac_in_cells = filt / raw) %>%
  arrange(desc(frac_in_cells))

# Sample meta.data
lib_meta <- lec_so@meta.data %>%
  distinct(orig.ident, sample, tm, mouse, exp) %>%
  as_tibble()

counts_df %>%
  left_join(lib_meta, by = c(library = "orig.ident")) %>%
  filter(!is.na(sample)) %>%
  arrange(desc(frac_in_cells))
```

```{r "DSB TEST", eval = FALSE}
# Test the dsb package for correcting CITE-seq data based on empty droplets
# the results are not very convincing
# the signals do not decrease with time and the 3wk signals appear much higher
# than all the other timepoints

# data.frame with parameters
library(dsb)
library(furrr)

mat_dir <- names(params$res_dir)
mat_dir <- set_names(params[mat_dir], mat_dir)

mat_df <- mat_dir %>%
  imap_dfr(~ {
    rn <- .y
    
    .x %>%
      imap_dfr(~ {
        tibble(
          run    = rn,
          sample = .y,
          path   = here(params$res_dir[[rn]], .x, "outs"),
          rep    = str_extract(run, "^r[0-9]+(?=_)")
        )
      })
  })

# Normalize Ag matrices
plan(multisession, workers = 6)

norm_mats <- mat_df %>%
  future_pmap(~ {
    args <- list(...)
    filt_mat <- Read10X(here(args$path, "filtered_feature_bc_matrix"))$`Antibody Capture`
    raw_mat  <- Read10X(here(args$path, "raw_feature_bc_matrix"))$`Antibody Capture`
    raw_mat  <- raw_mat[, !colnames(raw_mat) %in% colnames(filt_mat)]
    
    DSBNormalizeProtein(
      cell_protein_matrix = filt_mat,
      empty_drop_matrix   = raw_mat,
      denoise.counts      = FALSE,
      pseudocount.use     = 1,
      use.isotype.control = FALSE,
      return.stats        = TRUE
    )
  })

names(norm_mats) <- mat_df$sample

# Create data.frame for corrected data
dsb_dat <- mat_df %>%
  pmap_dfr(~ {
    args <- list(...)
    
    dat <- t(norm_mats[[args$sample]]$dsb_normalized_matrix)
    
    if (!grepl("^CD45", args$sample)) {
      colnames(dat) <- params$ag_key[[args$rep]][colnames(dat)]
    }
    
    colnames(dat) <- colnames(dat) %>%
      str_c("dsb_", .)
    
    dat %>%
      as_tibble(rownames = "raw_cell_id") %>%
      mutate(run = args$fun, sample = args$sample)
  })

# Add corrected counts to object
lec_so <- qread(here(params$so_dir, "results/2022-10-28/sobjs/so_lec_new.qs"))

lec_so@meta.data <- lec_so@meta.data %>%
  mutate(raw_cell_id = str_remove(rownames(.), "_[_0-9]+$")) %>%
  as_tibble(rownames = ".cell_id") %>%
  left_join(dsb_dat, by = c("raw_cell_id", orig.ident = "sample")) %>%
  mutate(
    Ag_score = case_when(
      grepl("d[0-9]+$", mouse) ~ dsb_ovalbumin,
      grepl("^3wk$", mouse)    ~ dsb_3wk,
      grepl("^6wk$", mouse)    ~ dsb_6wk,
      
      Ag_3wk_score >= Ag_6wk_score ~ Ag_3wk_score,  # For 6wk-3wk use highest
      Ag_6wk_score >= Ag_3wk_score ~ Ag_6wk_score
    ),
    Ag_score_3 = ifelse(vaccination == "dual", Ag_3wk_score, Ag_score),
    Ag_score_6 = ifelse(vaccination == "dual", Ag_6wk_score, Ag_score),
    tm_3 = ifelse(vaccination == "dual", 21, tm),
    tm_6 = ifelse(vaccination == "dual", 42, tm)
  ) %>%
  column_to_rownames(".cell_id")

# Create plots
# timepoints
lec_so@meta.data %>%
  # filter(subtype == "fLEC") %>%
  # filter(tm != 21) %>%
  filter(vaccination == "single") %>%
  ggplot(aes(tm, Ag_score, group = tm, fill = subtype)) +
  geom_boxplot(width = 3) +
  facet_wrap(~ subtype, nrow = 1) +
  djvdj_theme()

# antigen-exchange
lec_so@meta.data %>%
  # filter(subtype == "fLEC") %>%
  mutate(vaccination = fct_relevel(vaccination, c("single", "dual"))) %>%
  ggplot(aes(tm_3, Ag_score_3, group = tm, fill = subtype, color = subtype, alpha = vaccination)) +
  geom_boxplot(width = 6, position = position_dodge2(preserve = "single")) +
  facet_wrap(~ subtype, nrow = 1) +
  scale_alpha_manual(values = c(0.25, 0.75)) +
  djvdj_theme()

lec_so@meta.data %>%
  # filter(tm_6 != 21) %>%
  # filter(subtype == "fLEC") %>%
  mutate(vaccination = fct_relevel(vaccination, c("single", "dual"))) %>%
  ggplot(aes(tm_6, Ag_score_6, group = tm, fill = subtype, color = subtype, alpha = vaccination)) +
  geom_boxplot(width = 6, position = position_dodge2(preserve = "single")) +
  facet_wrap(~ subtype, nrow = 1) +
  scale_alpha_manual(values = c(0.25, 0.75)) +
  djvdj_theme()
```

```{r "PLOT RAW COUNTS CORRELATION", eval = FALSE}
clmns <- c(
  "exp", "mouse", "vaccination", "orig.ident", "subtype",
  "adt_ABPS2", "adt_ABPS4",
  "Ag_3wk", "Ag_6wk"
)

dat <- lec_so %>%
  FetchData(clmns, slot = "counts") %>%
  filter(vaccination == "dual") %>%
  as_tibble(rownames = "cell_id")

xvar <- "adt_ABPS2"
yvar <- "adt_ABPS4"

# xvar <- "Ag_3wk"
# yvar <- "Ag_6wk"

dat %>%
  ggplot(aes(!!sym(xvar) + 1, !!sym(yvar) + 1, color = subtype)) +
  geom_point() +
  facet_grid(exp ~ subtype) +
  djvdj_theme() +
  theme(aspect.ratio = 1) +
  geom_abline(slope = 1, intercept = 0) +
  scale_x_log10() +
  scale_y_log10()
```