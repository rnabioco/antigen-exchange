---
title: "Xenium Analysis"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc:            true
    toc_float:      true
    toc_depth:      2
    df_print:       "paged"
    code_folding:   "hide"
    self_contained: true
params:
  xen_slide:    1                                                                             # Xenium slide to process
  xen_regex:    ["output-XETG00230__0022624__[A-Z]__", "output-XETG00230__0022841__[A-Z]__"]  # Regex to pull samples for Xenium slides
  xen_dir:      "~/Dropbox/Ryan/Projects/antigen-exchange/results/xenium/2024-03-22"          # Xenium objects
  xen_res_dir:  "results/xenium/20240322__194506__032224_Tamburini_Run_1"                     # Directory with Xenium data
  so_dir:       "~/Dropbox/Ryan/Projects/antigen-exchange/results/sobjs/2024-07-01"           # Seurat objects to use for reference
  template_dir: "src"                                                                         # Rmd templates
  ref_dir:      "ref"
  xen_samples: 
    value:
      A: ["6wk", 1, 2]      # Sample identity and 6wk and 3wk barcode identity (in this order)
      B: ["6wk", 2, 1]      # e.g. `1` indicates GeoMx-Barcode01
      C: ["6wk-3wk", 1, 2]
      D: ["6wk-3wk", 2, 1]
      E: ["3wk", 2, 1]
      F: ["3wk", 1, 2]
  xen_ag_targets:
    value:
      Ag_tag_1: "GeoMx-Barcode01-ERCC00142"
      Ag_tag_2: "GeoMx-Barcode02-ERCC00144"
  xen_custom_targets:
    - "Ag-tag-A-(ERCC2)"
    - "Ag-tag-B-(ERCC3)"
    - "Ag-tag-C-(ERCC4)"
    - "T2-Sensitive-Ag-tag-(ERCC9)"
    - "T2-Resistant-Ag-tag-(ERCC12)"
    - "DNA-only-T2-Control-Ag-tag-(ERCC16)"
    - "GeoMx-Barcode01-ERCC00142"
    - "GeoMx-Barcode02-ERCC00144"
    - "CHIKV-5-(0-7566)"
    - "CHIKV-sgRNA-(7566-12036)"
    - "CHIKV-negative-(0-12036)"
    - "LCMV-(Armstrong)-Segment"
    - "Listeria-monocytogenes-10403S-gyrase-B-CP002002-1"
    - "Vaccinia-(Western-Reserve)-J6R"
    - "mRNA-vaccine-(3-UTR)"
    - "mRNA-vaccine-(ovalbumin)"
    - "mRNA-vaccine-(FLAG-3x)"
    - "mRNA-vaccine-(eGFP)"
---

<br>

```{r "setup", include = FALSE}
# Default chunk options
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,
  dpi     = 250
)

# Packages
library(Seurat)
library(SeuratObject)
library(tidyverse)
library(djvdj)
library(here)
library(qs)
library(clustifyr)
library(clustifyrdata)
library(patchwork)
library(cowplot)
library(scales)
library(colorblindr)
library(ggtrace)
library(sf)
library(sp)
library(knitr)

# ggspruce dev install
library(ggspruce, lib.loc = "/home/rmsheridan/.cache/R/renv/library/ggspruce-c2135e66/R-4.3/x86_64-pc-linux-gnu")

source(here("src/funs.R"))

# Process Xenium slide
sffx <- str_c("_s", params$xen_slide, ".qs")

chunks <- knit_expand(
  here(params$template_dir, "setup-xenium.Rmd"),
  .x = params$xen_slide
)

knit(text = chunks, output = "")
```

```{r "load objects"}
# Load objects
xen   <- qread(here(params$xen_dir, str_c("xen", sffx)))
small <- qread(here(params$xen_dir, str_c("small", sffx)))
lec   <- qread(here(params$xen_dir, str_c("lec", sffx)))

# Top cell types to plot
dcs <- xen$cell_type %>%
  unique() %>%
  grep("DC", ., value = TRUE) %>%
  sort()

ag_dcs <- xen@meta.data %>%
  filter(cell_type %in% dcs) %>%
  group_by(cell_type) %>%
  filter(all(table(Ag_class) > 15)) %>%
  pull(cell_type) %>%
  unique()

top_types <- c("LEC", dcs)

# Cells to plot for sections
plt_cells <- colnames(small)

# FOVs to plot
fovs      <- sort(unique(xen$fov))
top_fov   <- "D"
top_fov_2 <- "B"
```

```{r "format data", eval = FALSE}
# Format plotting data
clmns <- c(
  ".cell_id", "fov", "cell_type",
  "Ag_class", "Ag_type", "lec_Ag_type",
  "lec_type", "lec_dc_type", "lec_dc_Ag_type",
  "lec_id", "lec_dist"
)

xen_dat <- xen@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(all_of(clmns), matches("^[xy]_"))

small_dat <- small@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(all_of(clmns), matches("^[xy]_")) %>%
  mutate(Ag_class = fct_relevel(Ag_class, c("Ag-low", "Ag-high"))) %>%
  arrange(Ag_class)
```

```{r "theme"}
# ggplot2 themes
txt_pt1  <- 10
txt_pt2  <- 12
ttl_pt1  <- 14
ttl_pt2  <- 16
ln_pt    <- 0.5
ln_col   <- "grey85"
cir_size <- 3.5
sqr_size <- 4

txt_theme_1 <- theme(
  strip.text   = element_text(size = ttl_pt2),
  legend.text  = element_text(size = ttl_pt1),
  axis.title   = element_text(size = ttl_pt2),
  axis.text    = element_text(size = txt_pt2, color = "black"),
  legend.title = element_text(size = ttl_pt2),
)

line_theme <- theme(
  axis.line.x  = element_line(linewidth = ln_pt, color = ln_col),
  axis.line.y  = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.x = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.y = element_line(linewidth = ln_pt, color = ln_col)
)

base_theme <- djvdj_theme() +
  theme(
    plot.title       = element_text(face = "plain", size = ttl_pt2),
    strip.background = element_blank(),
    strip.text       = element_text(face = "plain")
  ) +
  txt_theme_1

umap_theme <- base_theme +
  theme(
    panel.border = element_rect(color = NA, fill = NA),
    axis.title   = element_blank(),
    axis.line.x  = element_blank(),
    axis.line.y  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text    = element_blank()
  )

umap_theme_2 <- umap_theme %+replace%
  theme(panel.border = element_rect(colour = ln_col, linewidth = ln_pt, fill = NA))

fade_0 <- "#FAFAFA"
fade_1 <- "#F0F0F0"
fade_2 <- "#D9D9D9"

# Colors
# Okabe Ito color palettes
ito_cols <- c(
  palette_OkabeIto[c(1:3, 5)], "#D7301F",
  palette_OkabeIto[c(4, 6)],   "#6A51A3",
  palette_OkabeIto[7],         "#875C04",
  "#065D43", "#F7AF34", "#00446E"
)

ito_cols <- ito_cols[3:length(ito_cols)] %>%
  darken(0.2) %>%
  c(ito_cols, ., "#686868", "#000000")

clrs <- ito_cols

# Cell type colors
typs <- unique(xen$cell_type)

typ_clrs <- set_names(
  clrs[seq_along(typs)],
  typs
)

typ_clrs[c("other CD45+", "other CD45-", "other", "Ag-low")] <- "grey85"

# typ_clrs[c("LEC", "BEC", "cDC1")] <- c("#D7301F", "#0072B2", "#6A51A3")
typ_clrs[c("LEC", "BEC", "cDC1")] <- c("#56B4E9", "#D7301F", "#6A51A3")

top_typ_clrs <- typ_clrs
top_typ_clrs[!names(top_typ_clrs) %in% top_types] <- "grey85"

top_typ_clrs_2 <- top_typ_clrs
top_typ_clrs_2[!names(top_typ_clrs_2) %in% top_types] <- "grey99"
top_typ_clrs_2[names(top_typ_clrs_2) %in% dcs] <- "#D7301F"

# Subtype colors
lec_clrs <- lec@meta.data %>%
  pull(lec_type) %>%
  unique()

lec_clrs <- set_names(
  clrs[seq_along(lec_clrs)],
  lec_clrs
)

lec_clrs["cLEC"]      <- "#56B4E9"
lec_clrs["fLEC"]      <- "#D7301F"
lec_clrs["Ptx3_LEC"]  <- "#E69F00"
lec_clrs["tzLEC"]     <- "black"
lec_clrs["Marco_LEC"] <- "#6A51A3"

lec_clrs[c("Ag-low", "other")] <- "grey85"

lec_lvls <- c(
  "cLEC", "fLEC", "Marco_LEC",
  "tzLEC", "Collecting", "Ptx3_LEC", 
  "other"
)
```

## Summary

* Xenium data were analyzed for the 3 week/6 week Ag exchange experiment for
  slide `r params$slide_id`.
* Ag signals are sparse (most Ag+ cells have 1 count).
  This is at least partly due to the short length of the Ag tags, which only
  accommodate a single Xenium probe.
  We should consider re-designing and lengthening the Ag tags to allow binding
  of 2-3 probes.
* Due to the low number of Ag+ cells, Ag+ cells were identified as those with at
  least 1 count for either the 3 week or 6 week tag.
* LECs (specifically cLECs) are the top cell type enriched for Ag+ cells.
* When compared with Ag- DCs, Ag+ DCs tend to be in closer proximity to
  Ag+ LECs.
  This supports our previous GeoMx data and is in line with published work
  showing Ag is passed to DCs by LECs.
* Analysis of intracellular localization of Ag molecules for LECs interacting
  with a DC was inconclusive. This was due to the very few LEC-DC interactions,
  and the low number of Ag molecules.

<br>

<br>

---

## Quality control

Ag-tag barcodes used for each mouse are shown below.

```{r}
params$xen_samples %>%
  imap_dfr(~ {
    tibble(
      fov       = .y,
      mouse     = .x[[1]],
      `6wk tag` = params$xen_ag_targets[[.x[[2]]]],
      `3wk tag` = params$xen_ag_targets[[.x[[3]]]]
    ) %>%
      mutate(
        across(ends_with(" tag"), ~ {
          .x %>%
            str_remove("-ERCC[0-9]+$") %>%
            str_remove("^GeoMx-")
        })
      )
  })
```

<br>

The fraction of total counts assigned to each custom target is shown below for
each tissue section.
The GeoMx-Barcode02 probes produced very sparse signals regardless of sample
identity.
Values are labeled for targets assigned >0.01% of total counts.

```{r "fraction custom counts", fig.height = 6, fig.width = 12}
# Format plotting data
feats <- c(
  "mouse", "fov", "cell_type",
  "nCount_Xenium", "nCount_Xenium_custom"
)

DefaultAssay(xen) <- "Xenium_custom"

qc_dat <- xen %>%
  FetchData(c(feats, params$xen_custom_targets), slot = "counts") %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(params$xen_custom_targets)) %>%
  mutate(sample = str_c(mouse, "-", fov))

DefaultAssay(xen) <- "SCT"

# Format heatmap data
heat_dat <- qc_dat %>%
  group_by(fov, mouse, name) %>%
  mutate(
    tot_counts = sum(nCount_Xenium + nCount_Xenium_custom)
  ) %>%
  group_by(name, fov, mouse, sample, tot_counts) %>%
  summarize(
    value   = sum(value),
    .groups = "drop"
  ) %>%
  mutate(
    frac   = value / tot_counts,
    fov    = fct_relevel(fov, fovs),
    name   = fct_reorder(name, value),
    mouse  = fct_relevel(mouse, c("6wk", "3wk", "6wk-3wk"))
  )

# Tiles to outline
min_frac <- 0.0001

top_dat <- heat_dat %>%
  filter(frac >= min_frac)

# Tiles to label
lab_dat <- heat_dat %>%
  filter(frac >= min_frac) %>%
  mutate(
    lab = round(frac * 100, 2),
    lab = str_c(lab, "%")
  )

# Create heatmap
custom_counts_heat <- heat_dat %>%
  ggplot(aes(fov, name, fill = frac + min_frac)) +
  geom_tile() +
  geom_tile(
    data = top_dat,
    color = "black"
  ) +
  geom_text(
    aes(color = NULL, fill = NULL, label = lab),
    data = lab_dat
  ) +
  facet_grid(~ mouse, scales = "free") +
  scale_fill_gradientn(
    colours = c("white", "#D7301F"),
    labels  = label_percent(),
    trans   = "log10",
    name    = str_c("fraction of\ntotal counts\n(+", min_frac * 100, "%)")
  ) +
  base_theme +
  theme(
    aspect.ratio       = 5,
    strip.clip         = "off",
    strip.text.y.right = element_text(angle = 0, hjust = 0),
    axis.title.y       = element_blank()
  )

custom_counts_heat
```

<br>

Cells were identified as Ag+ if they have at least 1 Ag-tag count.
The fraction of Ag+ cells is shown below for each Ag-tag for
each tissue section.

```{r "fraction 3wk/6wk Ag+ cells", fig.height = 3.5, fig.width = 6, out.width = "50%"}
bar_dat <- xen@meta.data %>%
  group_by(fov, mouse) %>%
  summarize(
    `3wk tag` = (sum(Ag_3wk_counts > 0) / n()) * 100,
    `6wk tag` = (sum(Ag_6wk_counts > 0) / n()) * 100,
    .groups   = "drop"
  )

bar_dat %>%
  pivot_longer(ends_with("wk tag")) %>%
  mutate(mouse = fct_relevel(mouse, c("6wk", "3wk", "6wk-3wk"))) %>%
  
  ggplot(aes(fov, value, fill = name)) +
  geom_col(position = position_dodge2()) +
  facet_wrap(~ mouse, nrow = 1, scales = "free_x") +
  scale_fill_brewer() +
  scale_fill_spruce(difference = 30, range = c(25, 75)) +
  
  labs(y = "% Ag+ cells") +
  base_theme +
  theme(
    aspect.ratio = 1.5,
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )
```

<br>

<br>

## Cell types

Annotated cell types are shown for LN sections from slide `r params$slide_id`.
Cells were downsampled to allow for visualization of all cell types.

```{r "SLIDE 1: cell type sections", fig.width = 13, fig.height = 7}
# Legend labels
cell_n <- xen@meta.data %>%
  group_by(cell_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(cell_type, "\nn = ", label_comma()(n))
  ) %>%
  arrange(desc(n))

lgnd_labs <- set_names(cell_n$n_lab, cell_n$cell_type)

# Create section plots
Idents(small) <- small$cell_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 1.5,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 4))) +
      scale_fill_manual(values = typ_clrs, labels = lgnd_labs, drop = FALSE) +
      labs(tag = .x) +
      coord_fixed() +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = ttl_pt1),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

plts <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  )

# Create bargraphs
# be sure to NOT use downsampled data
brs <- xen@meta.data %>%
  plot_frequency(
    "cell_type",
    cluster_col = "fov",
    plot_colors = typ_clrs,
    plot_lvls   = names(lgnd_labs),
    alpha       = 1
  ) +
  base_theme +
  scale_y_continuous(expand = expansion(c(0, 0))) +
  theme(
    aspect.ratio    = 1.5,
    plot.margin     = margin(0, 0, 0, 0),
    panel.border    = element_blank(),
    legend.position = "none",
    axis.title      = element_blank(),
    axis.ticks      = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    axis.text.y     = element_blank()
  )

fig <- wrap_plots(
  plts, brs,
  nrow = 1,
  widths = c(1, 0.2)
) +
  plot_annotation(caption = "* cells downsampled for visualization") &
  theme(plot.caption = element_text(hjust = 0.02, vjust = 30, face = "italic"))

fig
```

### {.tabset .tabset-pills}

LEC and DC populations of interest are shown for LN sections.
Cells were downsampled to allow for visualization of all cell types.
High-resolution images showing all cells are included at the bottom,
LECs are highlighted in blue (center) and DCs are highlighted in purple, pink,
and orange (right).

```{r "SLIDE 3: LEC DC sections", fig.width = 13, fig.height = 6}
# Create section plots
Idents(small) <- small$cell_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 1.5,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 4))) +
      scale_fill_manual(values = top_typ_clrs, labels = lgnd_labs) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = ttl_pt1),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

plts <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  )

# Create bargraphs
br_dat <- xen@meta.data %>%
  group_by(fov) %>%
  mutate(total_cells = n()) %>%
  group_by(fov, total_cells, cell_type) %>%
  summarize(
    n    = n(),
    frac = (n / total_cells),
    .groups = "drop"
  ) %>%
  distinct() %>%
  filter(cell_type %in% top_types) %>%
  mutate(cell_type = fct_relevel(cell_type, rev(top_types)))

x_labs <- br_dat %>%
  group_by(fov) %>%
  summarize(n = sum(n), .groups = "drop") %>%
  mutate(
    n_lab = str_c(fov, "\nn = ", label_comma()(n))
  )

x_labs <- set_names(x_labs$n_lab, x_labs$fov)

brs <- br_dat %>%
  ggplot(aes(fov, frac, fill = cell_type)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = typ_clrs) +
  scale_x_discrete(labels = x_labs) +
  labs(y = "% of cells") +
  base_theme +
  scale_y_continuous(expand = expansion(c(0, 0)), labels = label_percent()) +
  theme(
    aspect.ratio    = 1.35,
    panel.border    = element_blank(),
    legend.position = "none",
    axis.line.y     = element_line(color = ln_col, linewidth = ln_pt),
    axis.title.x    = element_blank(),
    axis.ticks.x    = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1)
  )

# Create final figure
fig <- wrap_plots(
  plts, brs,
  nrow = 1,
  widths = c(1, 0.25)
) +
  plot_annotation(caption = "* cells downsampled for visualization") &
  theme(plot.caption = element_text(hjust = 0.02, vjust = 30, face = "italic"))

fig
```

```{r, fig.width = 45, fig.height = 10, results = "asis", out.height = "70%"}
fovs %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov   = .x,
        color = "cell_type",
        trace = list("NONE", "LEC", dcs),
        clrs  = typ_clrs
      ) %>%
      plot_grid(
        plotlist = .,
        nrow  = 1,
        align = "h",
        axis  = "tb"    
      )
    
    print(fig)
    cat("\n\n<br>\n\n<br>\n\n")
  })
```

###

The expression of key marker genes is shown below.

```{r "cell type markers", fig.width = 15, fig.height = 9}
gns <- c(
  # "Ptprc", "Pdpn", "Pecam1",
  # "Cd3d", "Cd19",
  # "Prox1", "Lyve1",
  "Itgax",           # DCs
  # "Xcr1",            # cDC1
  # "Sirpa",
  "Itgam",  # cDC2
  # "Siglech",         # Siglech DCs
  # "Ccr7",
  "H2-Aa",
  "Ly6c2",
  "Fcgr1"            # CD64
)

clst_clmn <- "SCT_snn_res.10"

clmns <- c(
  "cell_type", "fov", "pred_conf", clst_clmn,
  "UMAP_1", "UMAP_2", gns
)

dat <- xen %>%
  FetchData(clmns) %>%
  filter(fov == "D")
  
marker_plt <- gns %>%
  map(~ {
    dat %>%
      plot_violin(
        .x,
        cluster_col   = "cell_type",
        plot_colors   = typ_clrs,
        method        = "boxplot",
        outlier.size  = 0.5,
        outlier.alpha = 1,
        group_col = "mouse"
      )
  }) %>%
  plot_grid(
    plotlist = .,
    ncol     = 4,
    align    = "vh",
    axis     = "trbl"
  )

marker_plt
```

<br>

<br>

### Ag+ cells {.tabset .tabset-pills}

Ag+ cells are shown for LN sections.
High-resolution images showing all cells are included at the bottom

```{r "SLIDE 2: Ag+ cell types", fig.width = 13, fig.height = 7}
# Fraction of cell types that are Ag+
ag_dat <- xen@meta.data %>%
  group_by(fov, cell_type) %>%
  summarize(
    frac = sum(Ag_class == "Ag-high") / n(),
    .groups = "drop"
  ) %>%
  mutate(cell_type = fct_reorder(cell_type, frac, .desc = TRUE))

ag_brs <- ag_dat %>%
  ggplot(aes(cell_type, frac, fill = cell_type)) +
  geom_col() +
  facet_wrap(~ fov, ncol = 1, scales = "free_y", strip.position = "right") +
  scale_fill_manual(values = typ_clrs) +
  scale_y_continuous(labels = label_percent(), breaks = pretty_breaks(n = 2)) +
  labs(y = "% Ag+ cells") +
  base_theme +
  theme(
    aspect.ratio    = 0.3,
    legend.position = "none",
    strip.placement = "outside",
    strip.text      = element_text(size = ttl_pt2),
    axis.title.x    = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    axis.text.y     = element_text(size = txt_pt1)
  )

# Format labels to plot
small <- small %>%
  mutate_meta(
    mutate,
    Ag_type = fct_relevel(Ag_type, levels(ag_dat$cell_type)),
    Ag_type = fct_relevel(Ag_type, names(typ_clrs)[!grepl("^other", names(typ_clrs))]),
    Ag_type = fct_relevel(Ag_type, top_types)
  )

ag_labs <- xen@meta.data %>%
  group_by(Ag_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(Ag_type, "\nn = ", label_comma()(n))
  ) %>%
  arrange(Ag_type)

ag_labs <- set_names(ag_labs$n_lab, ag_labs$Ag_type)

# Plot Ag+ cells
Idents(small) <- small$Ag_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 2,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 5))) +
      scale_fill_manual(values = typ_clrs, labels = ag_labs, drop = FALSE) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = txt_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

fig <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.text     = element_text(size = ttl_pt2)
  )

fig <- plot_grid(
  fig, ag_brs,
  nrow = 1,
  rel_widths = c(1, 0.35)
)

fig
```

```{r, fig.width = 20, fig.height = 10, results = "asis", out.height = "70%"}
ag_types <- xen_dat$cell_type %>%
  unique() %>%
  grep("other|Ag-low", ., invert = TRUE, value = TRUE)

fovs %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov        = .x,
        color      = "Ag_type",
        clrs       = typ_clrs,
        trace      = list(ag_types),
        trace_clr  = NA,
        trace_size = 1.5
      )
    
    print(fig)
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

## LEC subsets

UMAP projections show annotated LEC subsets and marker gene expression. 

```{r "SLIDE 4: LEC UMAPs", fig.width = 13, fig.height = 6}
# LEC annotations UMAPs
lec_u <- lec %>%
  plot_scatter(
    "lec_type",
    size         = 1.2,
    plot_colors  = lec_clrs,
    label_params = list(size = ttl_pt1)
  ) +
  base_theme +
  theme(
    aspect.ratio    = 1,
    legend.position = "none",
    axis.title      = element_text(size = txt_pt2),
    axis.text       = element_blank(),
    axis.ticks      = element_blank()
  )

# LEC bargraphs
lec_brs <- lec@meta.data %>%
  ggplot(aes(fov, fill = lec_type)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = lec_clrs) +
  labs(x = "section", y = "fraction of cells") +
  coord_flip() +
  base_theme +
  theme(
    panel.border = element_blank(),
    legend.title = element_blank(),
    axis.ticks   = element_blank(),
    axis.title   = element_blank(),
    axis.text.x  = element_blank()
  )

lec_u <- plot_grid(
  lec_u, lec_brs,
  rel_heights = c(1, 0.3),
  ncol  = 1,
  align = "v",
  axis  = "rl"
)

# LEC markers
gns <- c(
  cLEC      = "Ackr4",
  fLEC      = "Madcam1",
  Marco_LEC = "Marco",
  Ptx3_LEC  = "Ptx3"
)

gn_u <- gns %>%
  imap(~ {
    lec %>%
      plot_scatter(
        .x,
        plot_colors = c("white", lec_clrs[.y]),
        n_label = "none",
        outline = TRUE
      ) +
      guides(color = guide_colorbar(ticks = FALSE)) +
      umap_theme_2 +
      theme(
        aspect.ratio = 1,
        legend.title = element_text(angle = 270, hjust = 0.5),
        legend.text  = element_text(size = txt_pt1),
        legend.key.height = unit(25, "pt"),
        legend.key.width = unit(5, "pt")
      )
  }) %>%
  plot_grid(
    plotlist = .,
    nrow = 2,
    align = "vh",
    axis  = "trbl"
  )

fig <- plot_grid(
  lec_u, gn_u,
  nrow = 1,
  rel_widths = c(0.8, 1)
)

fig
```

<br>

The expression of key LEC marker genes is shown below.

```{r "LEC type markers", fig.width = 10, fig.height = 4.5}
gns <- c(
  "Pdpn", "Pecam1",
  "Prox1",
  "Lyve1", "Mrc1",
  "Marco",
  "Madcam1", "Icam1",
  "Ackr4",
  "Ptx3"
)

marker_plt <- gns %>%
  map(~ {
    lec %>%
      plot_violin(
        .x,
        cluster_col   = "lec_type",
        plot_colors   = lec_clrs,
        method        = "boxplot",
        outlier.size  = 0.5,
        outlier.alpha = 1,
        n_label = "none"
      ) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
      )
  }) %>%
  plot_grid(
    plotlist = .,
    nrow     = 2,
    align    = "vh",
    axis     = "trbl"
  )

marker_plt
```

<br>

<br>

### {.tabset .tabset-pills}

Annotated LEC subsets are shown for LN sections.
High-resolution images showing all cells are included at the bottom

```{r "SLIDE 5: LEC type sections", fig.width = 13, fig.height = 6}
# Legend labels
lec_labs <- xen@meta.data %>%
  group_by(lec_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(lec_type, "\nn = ", label_comma()(n)),
    lec_type = fct_relevel(lec_type, lec_lvls)
  ) %>%
  arrange(lec_type)

lec_labs <- set_names(lec_labs$n_lab, lec_labs$lec_type)

# Create section plots
small <- small %>%
  mutate_meta(
    mutate, 
    lec_type = fct_relevel(lec_type, lec_lvls)
  )

Idents(small) <- small$lec_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 2,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 4))) +
      scale_fill_manual(values = lec_clrs, labels = lec_labs) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = ttl_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

fig <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  ) +
  plot_annotation(caption = "* cells downsampled for visualization") &
  theme(plot.caption = element_text(hjust = 0.02, face = "italic"))

fig
```

```{r, fig.width = 20, fig.height = 10, results = "asis", out.height = "70%"}
ag_types <- xen_dat$lec_type %>%
  unique() %>%
  grep("other|Ag-low", ., invert = TRUE, value = TRUE)

fovs %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov        = .x,
        color      = "lec_type",
        clrs       = lec_clrs,
        trace      = list(ag_types),
        trace_clr  = NA,
        trace_size = 2
      )
    
    print(fig)
    cat("\n\n<br>\n\n<br>\n\n")
  })
```

### Ag+ LECs {.tabset .tabset-pills}

Ag+ LECs are shown for LN sections.
High-resolution images showing all cells are included at the bottom

```{r "SLIDE 6: Ag+ LEC types", fig.width = 13, fig.height = 7}
# Fraction of cell types that are Ag+
ag_dat <- lec@meta.data %>%
  group_by(fov, lec_type) %>%
  summarize(
    frac = sum(Ag_class == "Ag-high") / n(),
    .groups = "drop"
  ) %>%
  mutate(lec_type = fct_reorder(lec_type, frac, .desc = TRUE))

ag_brs <- ag_dat %>%
  ggplot(aes(lec_type, frac, fill = lec_type)) +
  geom_col() +
  facet_wrap(~ fov, ncol = 1, scales = "free_y", strip.position = "right") +
  scale_fill_manual(values = lec_clrs) +
  scale_y_continuous(labels = label_percent(), breaks = pretty_breaks(n = 2)) +
  labs(y = "% Ag+ cells") +
  base_theme +
  theme(
    aspect.ratio    = 0.7,
    legend.position = "none",
    strip.placement = "outside",
    strip.text      = element_text(size = ttl_pt2),
    axis.title.x    = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    axis.text.y     = element_text(size = txt_pt1)
  )

# Format labels to plot
lec_ag_labs <- xen@meta.data %>%
  group_by(lec_Ag_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(lec_Ag_type, "\nn = ", label_comma()(n))
  ) %>%
  arrange(lec_Ag_type)

lec_ag_labs <- set_names(lec_ag_labs$n_lab, lec_ag_labs$lec_Ag_type)

# Plot Ag+ cells
Idents(small) <- small$lec_Ag_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 2,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 5))) +
      scale_fill_manual(values = lec_clrs, labels = lec_ag_labs, drop = FALSE) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = txt_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

plts <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.text     = element_text(size = ttl_pt2)
  )

fig <- plot_grid(
  plts, ag_brs,
  nrow = 1,
  rel_widths = c(1, 0.25)
)

fig
```

```{r, fig.width = 20, fig.height = 10, results = "asis", out.height = "70%"}
ag_types <- xen_dat$lec_Ag_type %>%
  unique() %>%
  grep("other|Ag-low", ., invert = TRUE, value = TRUE)

fovs %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov        = .x,
        color      = "lec_Ag_type",
        clrs       = lec_clrs,
        trace      = list(ag_types),
        trace_clr  = NA,
        trace_size = 2
      )
    
    print(fig)
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

## LEC-DC proximity

Ag+ LECs and DCs are shown for LN sections.

```{r "Ag+ LECs/DCs", fig.width = 13, fig.height = 6}
# Format legend labels
lec_dc_ag_labs <- small@meta.data %>%
  group_by(lec_dc_Ag_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = ifelse(
      lec_dc_Ag_type %in% top_types,
      str_c(lec_dc_Ag_type, "\nn = ", label_comma()(n)),
      as.character(lec_dc_Ag_type)
    )
  ) %>%
  arrange(lec_dc_Ag_type)

lec_dc_ag_labs <- set_names(
  lec_dc_ag_labs$n_lab,
  lec_dc_ag_labs$lec_dc_Ag_type
)

# Plot Ag+ cells
plts <- fovs %>%
  map(~ {
    p <- small_dat %>%
      filter(fov == .x) %>%
      arrange(desc(lec_dc_Ag_type)) %>%
      
      ggplot(aes(y_cell, x_cell, fill = lec_dc_Ag_type)) +
      geom_point_trace(size = 1.65, trace_position = "bottom") +
      guides(fill = guide_legend(
        title = "Ag+ LECs/DCs",
        title.position = "top",
        override.aes = list(size = 4)
      )) +
      scale_fill_manual(
        values = top_typ_clrs_2,
        labels = lec_dc_ag_labs,
        drop   = FALSE
      ) +
      coord_fixed() +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.text       = element_text(size = txt_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    p
  })

# Create final figure
fig <- plts %>%
  wrap_plots(
    nrow    = 2,
    guides  = "collect",
    heights = c(1, 1)
  ) &
  theme(
    legend.position = "right",
    legend.text     = element_text(size = ttl_pt2)
  )

fig
```

```{r "Ag+ LECs/DCs 1", fig.width = 8, fig.height = 10, out.width = "50%", results = "asis", eval = FALSE}
# Format LEC/DC data
plts <- fovs %>%
  set_names() %>%
  map(~ {
    dc_dat <- xen_dat %>%
      filter(fov == .x) %>%
      mutate(lec_dc_Ag_type = recode(lec_dc_Ag_type, `Ag-low` = "other")) %>%
      arrange(desc(lec_dc_Ag_type))
    
    # Format n label data
    lec_dc_ag_labs <- dc_dat %>%
      group_by(lec_dc_Ag_type) %>%
      summarize(n = n(), .groups = "drop") %>%
      mutate(n_lab = str_c(lec_dc_Ag_type, "\nn = ", label_comma()(n))) %>%
      arrange(lec_dc_Ag_type)
    
    lec_dc_ag_labs <- set_names(
      lec_dc_ag_labs$n_lab,
      lec_dc_ag_labs$lec_dc_Ag_type
    )
    
    # Create tissue section plot
    plt_1 <- dc_dat %>%
      ggplot(aes(y_cell, x_cell, fill = lec_dc_Ag_type)) +
      geom_point_trace(size = 1, trace_position = "bottom") +
      guides(fill = guide_legend(
        title = "Ag+ LECs/DCs",
        title.position = "top",
        override.aes = list(size = 4)
      )) +
      scale_fill_manual(values = top_typ_clrs_2, labels = lec_dc_ag_labs) +
      coord_fixed() +
      umap_theme_2
    
    # Add lines
    plt_2 <- dc_dat %>%
      ggplot(aes(y_cell, x_cell, color = lec_dc_Ag_type)) +
      
      geom_point_trace(
        size  = 1,
        color = "black",
        fill  = "grey99",
        trace_position = "bottom"
      ) +
      geom_segment(
        aes(x = y_cell, xend = y_lec, y = x_cell, yend = x_lec),
        data     = ~ filter(.x, lec_dc_Ag_type %in% c("LEC", dcs)),
        color    = "black",
        linetype = 1
      ) +
      geom_point(
        data = ~ filter(.x, lec_dc_Ag_type %in% top_types),
        size = 1
      ) +
      
      guides(color = guide_legend(
        title = "Ag+ LECs/DCs",
        title.position = "top",
        override.aes = list(size = 4)
      )) +
      scale_color_manual(values = top_typ_clrs_2, labels = lec_dc_ag_labs) +
      coord_fixed() +
      umap_theme_2
    
    # Create final figure
    plot_grid(
      plt_1, plt_2,
      ncol  = 1,
      align = "v",
      axis  = "rl"
    )
  })

plts %>%
  iwalk(~ {
    cat("\n\n####", .y, "\n\n")
    print(.x)
    cat("\n\n<br>\n\n<br>\n\n")
  })
```

```{r "SPATIAL CORRELATION", eval = FALSE}
# DO NOT SEE A SIGNIFICANT CORRELATION BASED ON THIS APPROACH

library(vegan)

dc_class <- "Ag-high"

# Plots
xen@meta.data %>%
  filter((cell_type == "LEC" & Ag_class == "Ag-high") | (grepl("^cDC2$", cell_type) & Ag_class == dc_class)) %>%
  group_by(cell_type) %>%
  slice_sample(n = 274) %>%
  ungroup() %>%
  
  ggplot(aes(y_cell, x_cell, color = cell_type)) +
  geom_point() +
  facet_wrap(~ cell_type) +
  coord_fixed() +
  base_theme
  
# Matrices for calculating p-values
lecs <- xen@meta.data %>%
  filter(cell_type == "LEC" & Ag_class == "Ag-high", fov == "D") %>%
  dplyr::select(x_cell, y_cell) %>%
  as.matrix()

dcs <- xen@meta.data %>%
  filter(grepl("^cDC2$", cell_type) & Ag_class == dc_class, fov == "D") %>%
  dplyr::select(x_cell, y_cell) %>%
  as.matrix()

# Downsample DCs so equal number of each cell type
# set.seed(42)

idx <- sample(seq_len(nrow(dcs)), nrow(lecs))

dcs <- dcs[idx, ]

# Procrustes test
protest(lecs, dcs, permutations = 999)

# Mantel test
mantel(dist(lecs), dist(dcs))

```

<br>

<br>

### {.tabset .tabset-pills}

Ag+ LECs and DCs are shown for each DC subset for each tissue section.
Lines (bottom) connect the nearest Ag+ LEC identified for each DC.

```{r "Ag+ LECs/DCs 2", fig.width = 13, fig.height = 11, results = "asis"}
# Plot Ag+ LECs and DCs
plts <- fovs %>%
  set_names() %>%
  map(~ {
    fov_name <- .x
    
    plts <- ag_dcs %>%
      map(~ {
        typ <- .x
        
        small_dat %>%
          filter(fov == fov_name) %>%
          filter(lec_dc_Ag_type %in% c("LEC", .x, "other", "Ag-low")) %>%
          arrange(desc(lec_dc_Ag_type)) %>%
          
          ggplot(aes(y_cell, x_cell, fill = lec_dc_Ag_type)) +
          geom_point_trace(size = 1.75, trace_position = "bottom") +
          guides(fill = guide_legend(
            title = "Ag+ LECs/DCs",
            title.position = "top",
            override.aes = list(size = 4)
          )) +
          scale_fill_manual(values = top_typ_clrs_2, drop = FALSE) +
          labs(title = .x) +
          coord_fixed() +
          umap_theme_2
      })
    
    plt_1 <- plts %>%
      wrap_plots(
        nrow = 1,
        guides = "collect"
      ) &
      theme(
        legend.position = "bottom",
        legend.text     = element_text(size = ttl_pt2),
        plot.title      = element_text(size = ttl_pt2 * 1.5, hjust = 0.5)
      )
    
    # Plot Ag+ LECs and DCs
    plts <- ag_dcs %>%
      map(~ {
        typ <- .x
        
        small_dat %>%
          filter(fov == fov_name) %>%
          filter(lec_dc_Ag_type %in% c("LEC", .x, "other", "Ag-low")) %>%
          arrange(desc(lec_dc_Ag_type)) %>%
          
          ggplot(aes(y_cell, x_cell, color = lec_dc_Ag_type)) +
          
          geom_point_trace(
            size  = 1.75,
            color = "black",
            fill  = "grey99",
            trace_position = "bottom"
          ) +
          geom_point(
            data = ~ filter(.x, lec_dc_Ag_type %in% top_types),
            size = 1.75
          ) +
          geom_segment(
            aes(x = y_cell, xend = y_lec, y = x_cell, yend = x_lec),
            data     = ~ filter(.x, lec_dc_Ag_type %in% c("LEC", typ)),
            color    = "black",
            linetype = 2
          ) +
          
          guides(color = guide_legend(
            title = "Ag+ LECs/DCs",
            title.position = "top",
            override.aes = list(size = 4)
          )) +
          scale_color_manual(values = top_typ_clrs_2, drop = FALSE) +
          labs(title = .x) +
          coord_fixed() +
          umap_theme_2
      })
    
    plt_2 <- plts %>%
      wrap_plots(
        nrow = 1,
        guides = "collect"
      ) &
      theme(
        legend.position = "bottom",
        legend.text     = element_text(size = ttl_pt2),
        plot.title      = element_text(size = ttl_pt2 * 1.5, hjust = 0.5)
      )
    
    # Create final figure
    plot_grid(
      plt_1, plt_2,
      ncol  = 1,
      align = "v",
      axis  = "rl"
    )
  })

plts %>%
  iwalk(~ {
    cat("\n\n####", .y, "\n\n")
    print(.x)
    cat("\n\n<br>\n\n<br>\n\n")
  })
```

###

The distance from the nearest Ag+ LEC is shown for Ag+ and Ag- cells for each
cell type.
Cell types with >5 Ag+ cells are shown.
Vertical lines indicate the median distance.
For ease of plotting, a pseudo count of `1` was added to distance measurements.

```{r "proximity histograms", fig.width = 18, fig.height = 13}
# Ag class labels
ag_classes <- c(
  `Ag-low`  = "Ag-",
  `Ag-high` = "Ag+"
)

# Format data for histograms
# only include cell types that have both Ag-low/high cells
hist_dat <- xen@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(.cell_id, fov, cell_type, lec_type, Ag_class, lec_id, lec_dist) %>%
  filter(cell_type != "LEC") %>%
  group_by(fov, cell_type) %>%
  filter(
    all(names(ag_classes) %in% Ag_class),
    all(table(Ag_class) > 5)
  ) %>%
  ungroup()
  
# Format data for median lines
ln_dat <- hist_dat %>%
  group_by(fov, cell_type, Ag_class) %>%
  summarize(
    lec_dist = median(lec_dist),
    n        = n(),
    .groups  = "drop"
  )

# Format data for n labels
n_dat <- ln_dat %>%
  group_by(fov, cell_type) %>%
  mutate(
    n_lab = str_c(ag_classes[Ag_class], " (", label_comma()(n), " cells)")
  ) %>%
  summarize(
    n_lab = str_c(n_lab, collapse = "\n"),
    .groups = "drop"
  )

# Format data for p-values
p_dat <- hist_dat %>%
  group_by(fov, cell_type) %>%
  summarize(
    p = wilcox.test(
      lec_dist[Ag_class == "Ag-high"],
      lec_dist[Ag_class == "Ag-low"],
      alternative = "less"
    )$p.value,
    .groups = "drop"
  ) %>%
  mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
  rowwise() %>%
  mutate(
    p_lab = .format_pvalue(p_adj),
    p_lab = str_c("italic(p) == ", p_lab)
  ) %>%
  ungroup()

# Plot distance from nearest Ag+ LEC
hist <- hist_dat %>%
  
  mutate(lec_dist = lec_dist + 1) %>%  # ADD 1
  
  ggplot(aes(lec_dist, fill = Ag_class, alpha = Ag_class)) +
  geom_vline(
    aes(xintercept = lec_dist, color = Ag_class, alpha = NULL),
    data      = ln_dat,
    linetype  = 2,
    linewidth = 0.75,
    show.legend = FALSE
  ) +
  geom_density(aes(color = Ag_class)) +
  
  geom_text(
    aes(x = 3, y = Inf, label = n_lab, fill = NULL, alpha = NULL),
    data = n_dat,
    hjust = 0,
    vjust = 1.2,
    size  = (txt_pt1 * 0.8) / .pt,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = Inf, y = Inf, label = p_lab, fill = NULL, alpha = NULL),
    data  = p_dat,
    parse = TRUE,
    hjust = 1.1,
    vjust = 1.2,
    size  = (txt_pt1 * 0.8) / .pt,
    show.legend = FALSE
  ) +
  
  facet_grid(cell_type ~ fov, scales = "free_y") +
  labs(x = "distance from nearest Ag+ LEC", y = "density") +
  scale_fill_manual(values = c(`Ag-low` = "grey85", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_color_manual(values = c(`Ag-low` = "black", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_alpha_manual(values = c(`Ag-low` = 0.5, `Ag-high` = 0.85), labels = ag_classes) +
  scale_x_log10() +
  base_theme +
  theme(
    aspect.ratio    = 0.5,
    legend.position = "bottom",
    legend.title    = element_blank()
  )

hist
```

<br>

<br>

The distance from the nearest Ag+ LEC is shown for Ag+ and Ag- cells for
cDC1 and cDC2 subsets for section `r top_fov`.
Vertical lines indicate the median distance.
For ease of plotting, a pseudo count of `1` was added to distance measurements.

```{r "DC proximity histograms 1"}
# DC labels
ag_classes <- c(
  `Ag-low`  = "Ag- DCs",
  `Ag-high` = "Ag+ DCs"
)

top_dcs <- dcs[dcs != "Siglec-H DC"]

# Plot distance from nearest Ag+ LEC
dc_hist <- hist_dat %>%
  
  mutate(lec_dist = lec_dist + 1) %>%  # ADD 1
  
  filter(cell_type %in% top_dcs, fov == top_fov) %>%
  ggplot(aes(lec_dist, fill = Ag_class, alpha = Ag_class)) +
  geom_density(aes(color = Ag_class)) +
  geom_vline(
    aes(xintercept = lec_dist, color = Ag_class, alpha = NULL),
    data      = filter(ln_dat, cell_type %in% top_dcs, fov == "D"),
    linetype  = 2,
    linewidth = 0.75,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = 3, y = Inf, label = p_lab, fill = NULL, alpha = NULL),
    data  = filter(p_dat, cell_type %in% top_dcs, fov == top_fov),
    parse = TRUE,
    hjust = 0,
    vjust = 1.2,
    size  = txt_pt2 / .pt,
    show.legend = FALSE
  ) +
  
  facet_grid(cell_type ~ ., scales = "free_y") +
  labs(x = "distance from Ag+ LEC", y = "density") +
  scale_fill_manual(values = c(`Ag-low` = "grey85", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_color_manual(values = c(`Ag-low` = "black", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_alpha_manual(values = c(`Ag-low` = 0.5, `Ag-high` = 0.85), labels = ag_classes) +
  scale_x_log10() +
  base_theme +
  theme(
    aspect.ratio    = 0.5,
    legend.position = "bottom",
    legend.title    = element_blank()
  )
```

```{r "DC proximity sections 1", fig.width = 16, fig.height = 7}
# Scatter plot with points colored by distance from Ag+ LEC
prox_plts <- ag_classes %>%
  imap(~ {
    cls <- .y
    
    n_dat <- small_dat %>%
      filter(fov == top_fov) %>%
      filter(cell_type %in% top_dcs & Ag_class == cls) %>%
      group_by(Ag_class) %>%
      summarize(n = n(), .groups = "drop") %>%
      mutate(n_lab = str_c(label_comma()(n), " cells"))
    
    plt <- small_dat %>%
      filter(fov == top_fov) %>%
      ggplot(aes(y_cell, x_cell)) +
      geom_point(
        data = ~ filter(.x, .cell_id %in% plt_cells),
        size = 1, color = "grey85"
      ) +
      geom_point(
        aes(color = lec_dist),
        data = ~ filter(.x, cell_type %in% top_dcs & Ag_class == cls)
      ) +
      geom_text(
        aes(-Inf, Inf, label = n_lab),
        data  = n_dat,
        vjust = 1.5,
        hjust = -0.2,
        size  = ttl_pt2 / .pt
      ) +
      guides(color = guide_colorbar(ticks = FALSE)) +
      scale_color_gradientn(
        colours = c("#D7301F", "black"),
        name = "distance from\nAg+ LEC",
        limits = c(0, 700)
      ) +
      coord_fixed() +
      labs(title = .x) +
      umap_theme_2 +
      theme(
        plot.title        = element_text(size = ttl_pt2 * 1.5, hjust = 0.5),
        legend.key.height = unit(12, "pt"),
        legend.key.width  = unit(40, "pt"),
        legend.text       = element_text(size = txt_pt2)
      )
    
    plt
  })

# Create final figure
prox_plts <- prox_plts %>%
  wrap_plots(
    nrow   = 1,
    guides = "collect",
    byrow  = FALSE
  ) &
  theme(legend.position = "bottom")

fig <- plot_grid(
  prox_plts, dc_hist,
  nrow  = 1,
  rel_widths = c(1, 0.35)
)

fig
```

<br>

<br>

The distance from the nearest Ag+ LEC is shown for Ag+ and Ag- cells for
each DC subset for section `r top_fov`.
Vertical lines indicate the median distance.
For ease of plotting, a pseudo count of `1` was added to distance measurements.

```{r "DC proximity histograms 2"}
# DC labels
ag_classes <- c(
  `Ag-low`  = "Ag- DCs",
  `Ag-high` = "Ag+ DCs"
)

# Plot distance from nearest Ag+ LEC
dc_hist <- hist_dat %>%
  
  mutate(lec_dist = lec_dist + 1) %>%  # ADD 1
  
  filter(cell_type %in% ag_dcs, fov == top_fov) %>%
  ggplot(aes(lec_dist, fill = Ag_class, alpha = Ag_class)) +
  geom_density(aes(color = Ag_class)) +
  geom_vline(
    aes(xintercept = lec_dist, color = Ag_class, alpha = NULL),
    data      = filter(ln_dat, cell_type %in% dcs, fov == "D"),
    linetype  = 2,
    linewidth = 0.75,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = 3, y = Inf, label = p_lab, fill = NULL, alpha = NULL),
    data  = filter(p_dat, cell_type %in% dcs, fov == top_fov),
    parse = TRUE,
    hjust = 0,
    vjust = 1.2,
    size  = txt_pt2 / .pt,
    show.legend = FALSE
  ) +
  
  facet_grid(cell_type ~ ., scales = "free_y") +
  labs(x = "distance from Ag+ LEC", y = "density") +
  scale_fill_manual(values = c(`Ag-low` = "grey85", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_color_manual(values = c(`Ag-low` = "black", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_alpha_manual(values = c(`Ag-low` = 0.5, `Ag-high` = 0.85), labels = ag_classes) +
  scale_x_log10() +
  base_theme +
  theme(
    aspect.ratio    = 0.5,
    legend.position = "bottom",
    legend.title    = element_blank()
  )
```

```{r "DC proximity sections 2", fig.width = 14, fig.height = 7}
# Scatter plot with points colored by distance from Ag+ LEC
prox_plts <- ag_dcs %>%
  map(~ {
    typ <- .x
    
    ag_classes %>%
      imap(~ {
        cls <- .y
        
        n_dat <- small_dat %>%
          filter(fov == top_fov) %>%
          filter(cell_type == typ & Ag_class == cls) %>%
          group_by(cell_type, Ag_class) %>%
          summarize(n = n(), .groups = "drop") %>%
          mutate(n_lab = str_c(.x, "\n", label_comma()(n), " cells"))
        
        plt <- small_dat %>%
          filter(fov == top_fov) %>%
          ggplot(aes(y_cell, x_cell)) +
          geom_point(
            data = ~ filter(.x, .cell_id %in% plt_cells),
            size = 1, color = "grey85"
          ) +
          geom_point(
            aes(color = lec_dist),
            data = ~ filter(.x, cell_type == typ & Ag_class == cls)
          ) +
          geom_text(
            aes(-Inf, Inf, label = n_lab),
            data  = n_dat,
            vjust = 1.2,
            hjust = -0.2,
            size  = txt_pt2 / .pt
          ) +
          guides(color = guide_colorbar(ticks = FALSE)) +
          scale_color_gradientn(
            colours = c("#D7301F", "black"),
            name = "distance from\nAg+ LEC",
            limits = c(0, 700)
          ) +
          coord_fixed() +
          umap_theme_2 +
          theme(
            plot.title        = element_text(size = ttl_pt2 * 1.5, hjust = 0.5),
            strip.clip        = "off",
            legend.key.height = unit(12, "pt"),
            legend.key.width  = unit(40, "pt"),
            legend.text       = element_text(size = txt_pt2)
          )
        
        if (cls == "Ag-low") {
          plt <- plt +
            labs(title = typ)
        }
        
        plt
      })
  }) %>%
  flatten()

# Create final figure
prox_plts <- prox_plts %>%
  wrap_plots(
    nrow   = 2,
    guides = "collect",
    byrow  = FALSE
  ) &
  theme(legend.position = "bottom")

fig <- plot_grid(
  prox_plts, dc_hist,
  nrow  = 1,
  rel_widths = c(1, 0.4)
)

fig
```

---

<br>

<br>

## LEC-DC Ag exchange

Patterns in intracellular Ag localization were assessed for Ag+ LECs interacting
with a DC.
The distance of Ag molecules from the cell boundary was compared for
DC interacting and non-interacting Ag+ LECs (left).
The distance from the site of the LEC-DC interaction was also measured for each
Ag molecule,
this was compared to the distance of Ag molecules from the cell boundary for
non-interacting LECs (right).

```{r "quantify Ag distance"}
# Pull LECs
# No indication of Ag spatial bias for LECs interacting with a DC
get_lec_interactions <- function(obj, fov_name, mol_feats = c("GeoMx_Barcode01_ERCC00142", "GeoMx_Barcode02_ERCC00144")) {
  
  dat <- obj@meta.data %>%
    filter(fov == fov_name)
  
  # Convert to sf object (sp package is deprecated)
  # first convert to sp::SpatialPolygonsDataFrame
  # mol <- obj@images$A@molecules$molecules$GeoMx_Barcode01_ERCC00142
  cells <- obj@images[[fov_name]]@boundaries$segmentation@polygons
  plys  <- SpatialPolygons(cells)
  
  plys <- SpatialPolygonsDataFrame(
    plys,
    data = data.frame(
      id        = seq_along(cells),
      cell_type = dat$cell_type,
      Ag_class  = dat$Ag_class,
      row.names = map_chr(cells, ~ .x@ID)
    )
  )
  
  plys <- st_as_sf(plys)
  
  # Ensure geometries are valid
  plys <- st_make_valid(plys)
  
  # Subset Ag-high LECs
  lec_plys <- plys %>%
    subset(cell_type == "LEC" & Ag_class == "Ag-high")
  
  dc_plys <- plys %>%
    subset(cell_type %in% c("cDC1", "cDC2"))
  
  dc_info <- dc_plys %>%
    as.data.frame() %>%
    as_tibble(rownames = "dc_cell") %>%
    dplyr::select(-c(geometry, id), dc_class = Ag_class, dc_type = cell_type)
  
  # Generate spatial index and find intersections
  int_mat <- st_intersects(dc_plys, lec_plys, sparse = TRUE)

  # Identify DCs that touch an Ag+ LEC
  int_matches <- which(lengths(int_mat) > 0, arr.ind = TRUE)
  
  int_matches <- tibble(
    dc_id  = int_matches,
    lec_id = int_mat[int_matches]
  ) %>%
    unnest(everything()) %>%
    mutate(
      dc_cell  = rownames(dc_plys)[dc_id],
      lec_cell = rownames(lec_plys)[lec_id]
    )
  
  dc_touches     <- dc_plys[unique(int_matches$dc_cell), ]
  lec_touches    <- lec_plys[unique(int_matches$lec_cell), ]
  lec_no_touches <- lec_plys[!rownames(lec_plys) %in% rownames(lec_touches), ]
  
  # Merge barcode SpatialPoints and convert to sf object
  ag_mols <- obj@images[[fov_name]]@molecules$molecules[mol_feats]
  
  ag_mols <- ag_mols %>%
    map(~ {
      .x %>%
        SpatialPointsDataFrame(
          data = data.frame(id = seq_along(.x))
        )
    }) %>%
    reduce(rbind) %>%
    st_as_sf()
  
  # Intersect Ag coords with Ag+ LECs
  ag_int_mat <- st_intersects(ag_mols, lec_plys)
  ag_matches <- which(lengths(ag_int_mat) > 0, arr.ind = TRUE)
  
  ag_int_df <- tibble(
    ag_id  = ag_matches,
    lec_id = ag_int_mat[ag_matches]
  ) %>%
    unnest(everything()) %>%
    mutate(lec_cell = rownames(lec_plys)[lec_id])
  
  # Add index for nearest DC
  ag_int_df <- ag_int_df %>%
    left_join(
      int_matches,
      by = c("lec_id", "lec_cell"),
      relationship = "many-to-many"
    ) %>%
    left_join(dc_info, by = "dc_cell")
  
  res <- list(
    df = ag_int_df,
    lec_plys = lec_plys,
    dc_plys  = dc_plys,
    mols     = ag_mols
  )
  
  res
}

quantify_ag_dist <- function(lec_int_df, lec_plys, dc_plys, ag_mols) {
  
  # Determine which polygon edge for LEC touches DC
  calc_intersection_dist <- function(ply1, ply2, mol) {
    intsct <- ply1 <- st_boundary(ply1)
    
    if (!is.null(ply2)) {
      intsct <- st_intersection(ply1, ply2)
    }
    
    res <- min(st_distance(mol, intsct))
    
    res
  }
  
  res <- lec_int_df %>%
    pmap_dfr(~ {
      args <- list(...)
      
      dc_ply <- NULL
      
      if (!is.na(args$dc_cell)) {
        dc_ply <- dc_plys[args$dc_cell, ]
      }
      
      dist <- calc_intersection_dist(
        ply1 = lec_plys[args$lec_cell, ],
        ply2 = NULL,
        mol  = ag_mols[args$ag_id, ]
      )
      
      dist_to_int <- calc_intersection_dist(
        ply1 = lec_plys[args$lec_cell, ],
        ply2 = dc_ply,
        mol  = ag_mols[args$ag_id, ]
      )
      
      tibble(!!!args, dist = dist, dist_to_int = dist_to_int)
    }) %>%
    mutate(DC_interaction = !is.na(dc_cell)) %>%
    group_by(ag_id, lec_cell, DC_interaction) %>%
    summarize(
      dist        = min(dist),
      dist_to_int = min(dist_to_int),
      .groups     = "drop"
    )
  
  res
}

plot_interactions <- function(..., mol, clrs, mol_clr = "black", ttl = NULL) {
  
  plys <- list(...) %>%
    purrr::discard(is.null)
  
  plt <- ggplot()
  
  plys %>%
    iwalk(~ {
      plt <<- plt +
        geom_sf(
          data = .x,
          color = clrs[.y],
          fill  = clrs[.y],
          alpha = 0.5,
          linewidth = 0.75
        )
    })
  
  plt <- plt +
    geom_sf(data = mol, color = mol_clr, size = 3) +
    labs(subtitle = ttl) +
    umap_theme_2
  
  plt
}

ag_dists <- fovs %>%
  map_dfr(~ {
    int_objs <- xen %>%
      get_lec_interactions(fov_name = .x)
    
    plts <- int_objs$df %>%
      filter(!is.na(dc_cell)) %>%
      split(.$lec_cell) %>%
      imap_dfr(~ {
        lecs <- int_objs$lec_plys[unique(.x$lec_cell), ]
        dcs  <- int_objs$dc_plys[unique(.x$dc_cell), ]
        ags  <- int_objs$mols[unique(.x$ag_id), ]
        
        plt <- plot_interactions(
          rbind(lecs), rbind(dcs),
          
          mol  = rbind(ags),
          clrs = typ_clrs[c("LEC", "cDC1")],
          ttl  = .y
        )
        
        tibble(lec_cell = .y, plt = list(plt))
      })
    
    dists <- int_objs$df %>%
      quantify_ag_dist(
        lec_plys = int_objs$lec_plys,
        dc_plys  = int_objs$dc_plys,
        ag_mols  = int_objs$mols
      ) %>%
      mutate(fov = .x)
    
    if (!is_empty(plts)) {
      dists <- dists %>%
        left_join(plts, by = "lec_cell")
    }
    
    dists
  })
```

```{r "plot Ag distance", out.width = "50%"}
# Create boxplots
bx_dat <- ag_dists %>%
  group_by(DC_interaction) %>%
  mutate(
    lab = str_c(label_comma()(n()))
  )

bx_params <- list(
  y = c("dist", "dist_to_int"),
  ttl = c(
    "distance to cell boundary",
    "distance to DC interaction"
  )
)

bxs <- bx_params %>%
  pmap(~ {
    args <- list(...)
    
    bx_dat %>%
      ggplot(aes(DC_interaction, !!sym(args$y), color = DC_interaction, fill = DC_interaction)) +
      geom_boxplot(notch = FALSE, alpha = 0.5, outlier.alpha = 1) +
      geom_text(
        aes(y = Inf, label = lab),
        data = ~ distinct(.x, DC_interaction, lab),
        vjust = 1.3,
        color = "black"
      ) +
      scale_color_manual(values = clrs) +
      scale_fill_manual(values = clrs) +
      scale_y_log10(expand = expansion(c(0.05, 0.15))) +
      labs(x = "LEC-DC interaction", y = args$ttl) +
      base_theme +
      theme(
        legend.position = "none",
        aspect.ratio = 2
      )
  })

# Create final figure
plot_grid(
  plotlist = bxs,
  nrow  = 1,
  align = "h",
  axis  = "tb"
)
```

<br>

LEC-DC interactions are shown for Ag+ LECs.
Each LEC is shown in blue, DCs in purple, and Ag molecules are shown as
black points for each Ag+ LEC.
Ag molecules are not shown for DCs.

```{r "plot LEC-DC interactions", fig.width = 10, fig.height = 12}
plt_dat <- ag_dists %>%
  filter(DC_interaction) %>%
  distinct(lec_cell, plt, fov)

plot_grid(
  plotlist = plt_dat$plt,
  nrow     = 5,
  ncol     = 4,
  align    = "vh",
  axis     = "tl"
)
```

```{r "ICAM EXPRESSION", eval = FALSE}
interacting_lecs <- xen@meta.data %>%
  filter(cell_type %in% dcs & lec_dist == 0) %>%
  pull(lec_id) %>%
  unique()

dat <- xen %>%
  mutate_meta(
    mutate,
    dc_interaction = .cell_id %in% interacting_lecs
  ) %>%
  subset(cell_type == "LEC" & Ag_class == "Ag-high")
  
dat %>%
  plot_violin("Icam1", "dc_interaction", method = "boxplot")
```

---

<br>

<br>

## Session info

```{r}
sessionInfo()
```



```{r "LEC-DC INTERACTIONS", eval = FALSE}
fov_id <- "D"

# Pull cell coordinates from object
lec_dc_obj <- xen %>%
  subset(cell_type %in% c("LEC", dcs))

cell_coords <- lec_dc_obj@images[[fov_id]]@boundaries$segmentation@polygons %>%
  imap(~ {
    meta <- xen_dat %>%
      filter(.cell_id == .y) %>%
      dplyr::select(.cell_id, cell_type, Ag_class)
    
    .x@Polygons[[1]]@coords %>%
      as_tibble() %>%
      mutate(.cell_id = .y, .before = x) %>%
      left_join(meta, by = ".cell_id")
  })

lecs <- xen_dat %>%
  filter(cell_type == "LEC" & Ag_class == "Ag-high") %>%
  pull(.cell_id)

# Compare LEC-DC pairs identified using centroid coordinates
lec_dc_pairs <- set_names(xen_dat$lec_id, xen_dat$.cell_id)

mem_dist <- cell_coords %>%
  imap_dfr(~ {
    x <- cell_coords[[.y]] %>%
      mutate(id = as.character(row_number()))
    
    y <- cell_coords[[lec_dc_pairs[[.y]]]] %>%
      mutate(id = as.character(row_number()))
    
    res <- expand_grid(other = x$id, lec = y$id) %>%
      left_join(x, by = c(other = "id")) %>%
      left_join(y, by = c(lec = "id"), suffix = c("", "_lec")) %>%
      mutate(
        mem_dist = sqrt(((x - x_lec)^2) + ((y - y_lec)^2))
      ) %>%
      group_by(.cell_id, lec_id = .cell_id_lec) %>%
      summarize(mem_dist = min(mem_dist), .groups = "drop")
    
    res
  })

# Summarize interacting cells
dist_dat <- xen_dat %>%
  filter(fov == "D", cell_type %in% c("LEC", dcs)) %>%
  left_join(mem_dist, by = c(".cell_id", "lec_id")) %>%
  mutate(LEC_interacting = mem_dist < 0.5)

dist_dat %>%
  group_by(fov, cell_type, Ag_class) %>%
  summarize(
    n         = n(),
    n_intr    = sum(LEC_interacting),
    frac_intr = n_intr / n,
    .groups   = "drop"
  )
```

```{r "PROXIMITY CELL PAIRS", fig.width = 14, fig.height = 7, eval = FALSE}
# Scatter plot with lines connecting closest Ag-high LEC
prox_dat %>%
  ggplot(aes(x_cell, y_cell)) +
  geom_point(size = 1, color = "grey85") +
  geom_point(
    aes(x_cell, y_cell, color = Ag_class),
    data = ~ filter(.x, cell_type == "Siglec-H DC")
  ) +
  geom_point(
    data = ~ filter(.x, cell_type == "LEC" & Ag_class == "Ag-high"),
    color = "black"
  ) +
  geom_segment(
    aes(x = x_cell, xend = x_lec, y = y_cell, yend = y_lec),
    data = ~ filter(.x, cell_type == "Siglec-H DC" & Ag_class == "Ag-high"),
    color = "black"
  ) +
  coord_fixed() +
  base_theme
```

```{r "Ag signal", eval = FALSE}
lec <- lec %>%
  mutate_meta(
    mutate,
    Ag_class_1 = Ag_tag_1 > 0,
    Ag_class_2 = Ag_tag_2 > 0
  )

lec@meta.data %>%
  # ggplot(aes(lec_type, fill = Ag_tag_1, group = as.character(Ag_tag_1))) +
  ggplot(aes(lec_type, fill = Ag_class)) +
  geom_bar(position = "fill") +
  facet_wrap(~ fov)

lec@meta.data %>%
  ggplot(aes(fov, fill = lec_type)) +
  geom_bar(position = "fill")

xen@meta.data %>%
  # ggplot(aes(lec_type, fill = Ag_tag_1, group = as.character(Ag_tag_1))) +
  ggplot(aes(cell_type, fill = Ag_class)) +
  geom_bar(position = "fill") +
  facet_wrap(~ fov)

xen@meta.data %>%
  filter(Ag_class == "Ag-high") %>%
  dplyr::select(fov, cell_type, Ag_class, starts_with("Ag_tag_")) %>%
  pivot_longer(starts_with("Ag_tag_")) %>%
  
  ggplot(aes(value + 1, fill = Ag_class)) + 
  geom_histogram() +
  facet_grid(name ~ cell_type) +
  scale_x_log10()


# lec %>%
#   mutate_meta(
#     mutate,
#     Ag_class = ifelse(Ag_tag_1 > 1, "Ag-high", "Ag-low"),
#   ) %>%
#   plot_violin(
#     "Cavin1",
#     cluster_col = "Ag_class",
#     group_col   = "lec_type",
#     method = "boxplot",
#     notch = TRUE
#   )
```

```{r, eval = FALSE}

# Plot cell types
xen %>%
  plot_scatter("SCT_snn_res.0.5", size = 0.0001, top = c("15", "8", "7", "12"))

xen %>%
  plot_scatter("Lyve1", size = 0.0001, plot_colors = c("lightblue", "white", "red"))

lec %>%
  plot_scatter("SCT_snn_res.3", size = 2, plot_colors = c("lightblue", "red"))

lec %>%
  plot_scatter("lec_type", size = 3, plot_colors = c("lightblue", "red"))

lec %>%
  plot_scatter("Mrc1", size = 3, plot_colors = c("lightblue", "red"))

xen %>%
  plot_scatter("cell_type", group_col = "fov", size = 0.0001)

xen %>%
  plot_scatter(
    # "xenium_custom_mRNA-vaccine-(3-UTR)",
    "xenium_custom_GeoMx-Barcode01-ERCC00142",
    # "xenium_custom_GeoMx-Barcode02-ERCC00144",
    size = 0.00001,
    plot_colors = c("lightblue", "red")
  )

Idents(xen) <- xen$cell_type

clrs <- unique(xen$cell_type)

clrs <- set_names(
  rep("white", length(clrs)),
  clrs
)

clrs["LEC"] <- "red"
clrs["BEC"] <- "lightblue"
clrs[c("cDC1", "cDC2")] <- "green4"

unique(xen$fov) %>%
  map(~ {
    xen %>%
      ImageDimPlot(
        fov = .x,
        size = 2,
        cols = clrs
      )
  }) %>%
  plot_grid(plotlist = .)

gns <- c(
  # "Madcam1",
  # "Marco", "Ackr4",
  # "Zbtb46", "Xcr1", "Itgax",
  "Cavin1", "Ctsd", "Psap", "Grn", "Tgfa",
  "GeoMx-Barcode01-ERCC00142",
  "GeoMx-Barcode02-ERCC00144"
)

xen %>%
  ImageFeaturePlot(
    fov = "A",
    features = gns,
    max.cutoff = "q1",
    size = 0.75,
    cols = c("white", "red")
  )

xen %>%
  ImageDimPlot(
    fov = "A",
    molecules = c("Ptprc", "Madcam1", "Marco", "Ackr4", "Ccr7"),
    nmols = 20000
  )

gns <- c(
  "Marco",
  "Madcam1", "Icam1", "Cd274",
  "Ackr4",
  "Ptx3", "Mrc1",
  "Fgl2"
)

gns %>%
  map(~ {
    lec %>%
      plot_violin(
        .x,
        cluster_col = "SCT_snn_res.3",
        group_col = "lec_type",
        method      = "boxplot",
        top = Inf
      )
  }) %>%
  plot_grid(plotlist = .)


# gns <- c(
#   "Ptprc", "Cd3d", "Cd19",
#   "Pecam1", "Pdpn",
#   "Prox1", "Lyve1",
#   "Ccr7", "Sirpa", "Xcr1",
#   "Itgax", "Itgam", "Siglech"
# )
# gns %>%
#   map(~ {
#     xen %>%
#       plot_violin(
#         .x,
#         cluster_col = clst_clmn,
#         group_col   = "cell_type",
#         method      = "boxplot",
#         top = Inf
#       )
#   }) %>%
#   plot_grid(plotlist = .)
# gns %>%
#   map(~ {
#     xen %>%
#       plot_violin(
#         .x,
#         cluster_col = "cell_type",
#         method      = "boxplot",
#         top = Inf
#       )
#   }) %>%
#   plot_grid(plotlist = .)
```

```{r "SLIDE 2: LEC type sections OLD", fig.width = 26, fig.height = 5, eval = FALSE}
new_clrs <- typ_clrs
new_clrs[!names(new_clrs) %in% c("LEC", "cDC2", "cDC1")] <- "grey85"

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov = .x,
        size = 1.5,
        cols = new_clrs,
        crop = TRUE,
        dark.background = FALSE
      ) +
      labs(tag = .x) +
      base_theme +
      theme_void() +
      theme(
        panel.border = element_rect(color = ln_col, fill = NA, linewidth = ln_pt),
        legend.title = element_blank(),
        plot.tag.position = c(0.05, 0.95),
        plot.tag = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    brs <- xen@meta.data %>%
      filter(fov == .x) %>%
      mutate(cell_type = fct_infreq(cell_type)) %>%
      ggplot(aes(y = fov, fill = cell_type)) +
      geom_bar(position = "fill") +
      scale_fill_manual(values = new_clrs) +
      base_theme +
      theme_void() +
      theme(
        legend.position = "none",
        axis.title      = element_blank(),
        axis.text       = element_blank()
      )
    
    list(p, brs)
  })

fig <- map(plts, pluck, 1) %>%
  wrap_plots(
    nrow = 1,
    guides = "collect"
  ) &
  theme(legend.direction = "horizontal")

fig
```
