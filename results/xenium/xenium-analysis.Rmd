---
title: "Xenium Analysis"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc:            true
    toc_float:      true
    toc_depth:      4
    df_print:       "paged"
    code_folding:   "hide"
    self_contained: true
params:
  res_dir:     "results/2024-03-22"
  xen_dir:     "20240322__194506__032224_Tamburini_Run_1"
  so_dir:      "~/Dropbox/Ryan/Projects/tamburini-antigen-tracking/results/2024-03-22/sobjs"
  ref_dir:     "ref"
  samples:
    value:
      A: "6wk"
      B: "6wk"
      C: "6wk-3wk"
      D: "6wk-3wk"
      E: "3wk"
      F: "3wk"
      G: "naive"
  custom_targets:
    - "Ag-tag-A-(ERCC2)"
    - "Ag-tag-B-(ERCC3)"
    - "Ag-tag-C-(ERCC4)"
    - "T2-Sensitive-Ag-tag-(ERCC9)"
    - "T2-Resistant-Ag-tag-(ERCC12)"
    - "DNA-only-T2-Control-Ag-tag-(ERCC16)"
    - "GeoMx-Barcode01-ERCC00142"
    - "GeoMx-Barcode02-ERCC00144"
    - "CHIKV-5-(0-7566)"
    - "CHIKV-sgRNA-(7566-12036)"
    - "CHIKV-negative-(0-12036)"
    - "LCMV-(Armstrong)-Segment"
    - "Listeria-monocytogenes-10403S-gyrase-B-CP002002-1"
    - "Vaccinia-(Western-Reserve)-J6R"
    - "mRNA-vaccine-(3-UTR)"
    - "mRNA-vaccine-(ovalbumin)"
    - "mRNA-vaccine-(FLAG-3x)"
    - "mRNA-vaccine-(eGFP)"
editor_options: 
  chunk_output_type: console
---

<br>

```{r "setup", include = FALSE}
# Default chunk options
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,
  dpi     = 250
)

# Packages
library(Seurat)
library(SeuratObject)
library(tidyverse)
library(djvdj)
library(here)
library(qs)
library(clustifyr)
library(clustifyrdata)
library(patchwork)
library(cowplot)
library(scales)
library(colorblindr)
library(ggtrace)

source(here("src/funs.R"))

create_object <- !file.exists(here(params$so_dir, "xen.qs"))
```

```{r "functions"}
.plot_full_fov <- function(df_in, fov_in, color, trace = list(), clrs,
                           size = 0.3, trace_size = 1, trace_clr = "black") {
  # Format input data
  plt_theme <- umap_theme +
    theme(
      legend.title = element_blank(),
      legend.text  = element_text(size = 28)
    )
  
  dat <- df_in %>%
    filter(fov == fov_in)
  
  n_dat <- dat %>%
    group_by(!!sym(color)) %>%
    summarize(n = n(), .groups = "drop") %>%
    mutate(
      n_lab = str_c(!!sym(color), "\nn = ", label_comma()(n))
    )
  
  # Plot highlighted cells
  res <- trace %>%
    map(~ {
      n_dat <- n_dat %>%
        arrange(desc(!!sym(color) %in% .x), desc(n))
      
      n_labs <- set_names(n_dat$n_lab, n_dat[[color]])
      
      dat %>%
        mutate(!!sym(color) := fct_relevel(!!sym(color), names(n_labs))) %>%
        arrange(!!sym(color)) %>%
        ggplot(aes(y_cell, x_cell, fill = !!sym(color))) +
        geom_point_trace(
          trace_position    = !!sym(color) %in% .x,
          background_params = list(size = size, color = NA),
          size  = trace_size,
          color = trace_clr
        ) +
        scale_fill_manual(values = clrs, labels = n_labs) +
        guides(fill = guide_legend(override.aes = list(size = 10, color = NA))) +
        coord_fixed() +
        plt_theme
    })
  
  if (length(trace) == 1) res <- res[[1]]
  
  res
}
```

```{r "references"}
# LEC reference
ref_lec <- ref_immgen[, grepl("^Endothelial cells", colnames(ref_immgen))]
ref_lec <- ref_lec[rownames(ref_lec) %in% rownames(ref_LEC_xiang), ]

colnames(ref_lec) <- colnames(ref_lec) %>%
  str_replace("Endothelial cells \\(BEC\\)", "BEC")

ref_LEC_xiang <- ref_LEC_xiang[rownames(ref_lec), ]

stopifnot(identical(rownames(ref_LEC_xiang), rownames(ref_lec)))

ref_lec <- cbind(ref_LEC_xiang, ref_lec)
ref_lec <- ref_lec[, !grepl("^Endothelial cells", colnames(ref_lec))]

# Fibroblast/stromal cell reference
ref_frc <- ref_immgen[, grepl("^Fibroblast", colnames(ref_immgen))]
ref_frc <- ref_frc[rownames(ref_frc) %in% rownames(ref_lymphnodestromal), ]

ref_lymphnodestromal <- ref_lymphnodestromal[rownames(ref_frc), ]

stopifnot(identical(rownames(ref_lymphnodestromal), rownames(ref_frc)))

ref_frc <- cbind(ref_lymphnodestromal, ref_frc)

# Combined Immgen/DC reference
rownames(ref_mousespleenDC) <- str_to_title(rownames(ref_mousespleenDC))

shared_gns    <- intersect(rownames(ref_immgen), rownames(ref_mousespleenDC))
ref_immgen_dc <- cbind(ref_immgen[shared_gns, ], ref_mousespleenDC[shared_gns, ])
```

```{r "create object", eval = create_object}
# Identify samples to load
xen_dirs <- dir(
  here(params$res_dir, params$xen_dir),
  pattern = "output-XETG00230__0022624__[A-Z]__",
  full.names = TRUE
)

names(xen_dirs) <- xen_dirs %>%
  str_extract("(?<=__)[A-Z](?=__)")

# Create Seurat object
# store custom targets as separate assay
xen <- xen_dirs %>%
  imap(~ {
    obj <- .x %>%
      LoadXenium(fov = .y) %>%
      subset(nCount_Xenium > 0)
    
    gns <- rownames(obj)
    gns <- gns[!gns %in% params$custom_targets]
    
    cstm <- obj %>%
      subset(features = params$custom_targets)
    
    obj <- obj %>%
      subset(features = gns)
    
    obj[["Xenium_custom"]] <- cstm@assays$Xenium
    
    obj
  })

xen <- merge(xen[[1]], xen[-1], add.cell.ids = names(xen))
```

```{r "process object", eval = create_object}
# Add FOV labels
xen <- xen %>%
  mutate_meta(
    mutate,
    fov = str_extract(.cell_id, "^[A-Z]+(?=_)")
  )
  
# Process data
xen <- xen %>%
  SCTransform(assay = "Xenium") %>%
  RunPCA(assay = "SCT", npcs = 50, features = rownames(xen)) %>%
  RunUMAP(
    assay       = "SCT",
    reduction   = "pca",
    dims        = 1:40,
    umap.method = "umap-learn"
  )

xen <- xen %>%
  FindNeighbors(
    assay     = "SCT",
    reduction = "pca",
    dims      = 1:40
  ) %>%
  FindClusters(resolution = c(0.5, 1, 2))

u_coords <- xen %>%
  FetchData(c("UMAP_1", "UMAP_2"))
  
xen <- xen %>%
  AddMetaData(u_coords)

# Identify Ag+ cells
ag_feats <- c("GeoMx-Barcode01-ERCC00142", "GeoMx-Barcode02-ERCC00144") %>%
  str_c("xenium_custom_", .)

xen <- xen %>%
  AddMetaData(
    FetchData(., ag_feats),
    col.name = c("Ag_tag_1", "Ag_tag_2")
  ) %>%
  mutate_meta(
    mutate,
    Ag_class = ifelse(
      Ag_tag_1 > 0 | Ag_tag_2 > 0,
      "Ag-high",
      "Ag-low"
    )
  )
```

```{r "cell types", eval = create_object}
clst_clmn <- "SCT_snn_res.2"

# Annotate B/T cells
xen <- xen %>%
  mutate_meta(mutate, cell_type = "unassigned") %>%
  classify_markers(
    Ptprc > 1.2,
    feats      = "Ptprc",
    type_label = "other CD45+",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type == "other CD45+" & Cd3d > 0.45,
    feats      = c("cell_type", "Cd3d"),
    type_label = "T cells",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type == "other CD45+" & Cd19 > 1.1,
    feats      = c("cell_type", "Cd19"),
    type_label = "B cells",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  )

# Annotate LECs
xen <- xen %>%
  classify_markers(
    Pdpn > 0.1 & Pecam1 > 0.5 & Prox1 > 0.2,
    feats      = c("cell_type", "Pdpn", "Pecam1", "Prox1"),
    type_label = "LEC",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    Pdpn < 0.1 & Pecam1 > 1,
    feats      = c("cell_type", "Pdpn", "Pecam1", "Prox1"),
    type_label = "BEC",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  )

# Annotate DCs
xen <- xen %>%
  classify_markers(
    cell_type == "other CD45+" & Itgax > 0.15,
    feats      = c("cell_type", "Itgax"),
    type_label = "DC",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  ) %>% 
  classify_markers(
    cell_type == "DC" & Sirpa > 0.15 & Itgam > 0.15,
    feats      = c("cell_type", "Sirpa", "Itgam"),
    type_label = "cDC2",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type == "DC" & Xcr1 > 0.15,
    feats      = c("cell_type", "Xcr1"),
    type_label = "cDC1",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type %in% c("DC", "other CD45+") & Siglech > 0.75,
    feats      = c("cell_type", "Siglech"),
    type_label = "Siglec-H DC",
    clst_col   = clst_clmn,
    type_col   = "cell_type"
  ) 

xen <- xen %>%
  mutate_meta(
    mutate,
    type_cluster = ifelse(cell_type == "unassigned", !!sym(clst_clmn), cell_type),
    Ag_type      = ifelse(Ag_class == "Ag-high", cell_type, "Ag-low")
  )
```

```{r "create lec object", eval = create_object}
# Process data
lec_clst_clmn <- "SCT_snn_res.3"

lec <- xen %>%
  subset(cell_type == "LEC")

lec <- lec %>%
  SCTransform(assay = "Xenium") %>%
  RunPCA(
    assay    = "SCT",
    npcs     = 30,
    features = rownames(.)
  ) %>%
  RunUMAP(
    assay       = "SCT",
    reduction   = "pca",
    dims        = 1:30,
    umap.method = "umap-learn"
  )

lec <- lec %>%
  FindNeighbors(
    assay     = "SCT",
    reduction = "pca",
    dims      = 1:30
  ) %>%
  FindClusters(resolution = c(0.5, 0.75, 1, 1.5, 2, 2.5, 3, 5))

u_coords <- lec %>%
  FetchData(c("UMAP_1", "UMAP_2"))

lec <- lec %>%
  AddMetaData(u_coords)
```

```{r "refine cell types", eval = create_object}
# Adjust LEC annotations based on marker genes
# clustifyr annotation exclude fLECs despite expression of fLEC markers
lec <- lec %>%
  classify_markers(
    Ptprc > 0.5,
    feats      = "Ptprc",
    type_label = "other CD45+",
    clst_col   = lec_clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type == "other CD45+" & Cd3d > 0.45,
    feats      = c("cell_type", "Cd3d"),
    type_label = "T cells",
    clst_col   = lec_clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type == "other CD45+" & Cd19 > 1.1,
    feats      = c("cell_type", "Cd19"),
    type_label = "B cells",
    clst_col   = lec_clst_clmn,
    type_col   = "cell_type"
  )

lec <- lec %>%
  classify_markers(
    cell_type == "other CD45+" & Itgax > 0.15,
    feats      = c("cell_type", "Itgax"),
    type_label = "DC",
    clst_col   = lec_clst_clmn,
    type_col   = "cell_type"
  ) %>% 
  classify_markers(
    cell_type == "DC" & Sirpa > 0.15 & Itgam > 0.15,
    feats      = c("cell_type", "Sirpa", "Itgam"),
    type_label = "cDC2",
    clst_col   = lec_clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type == "DC" & Xcr1 > 0.15,
    feats      = c("cell_type", "Xcr1"),
    type_label = "cDC1",
    clst_col   = lec_clst_clmn,
    type_col   = "cell_type"
  ) %>%
  classify_markers(
    cell_type %in% c("DC", "other CD45+") & Siglech > 0.75,
    feats      = c("cell_type", "Siglech"),
    type_label = "Siglec-H DC",
    clst_col   = lec_clst_clmn,
    type_col   = "cell_type"
  )

# Update cell type annotations
xen <- xen %>%
  AddMetaData(lec$cell_type, col.name = "new_type") %>%
  mutate_meta(~ {
    .x %>%
      mutate(
        cell_type    = ifelse(is.na(new_type), cell_type, new_type),
        type_cluster = ifelse(cell_type == "unassigned", !!sym(clst_clmn), cell_type),
        Ag_type      = ifelse(Ag_class == "Ag-high", cell_type, "Ag-low")
      ) %>%
      dplyr::select(-new_type)
  })
```

```{r "calculate distance from Ag+ LEC", eval = create_object}
# Calculate distance from closest Ag+ LEC
fovs <- sort(unique(xen$fov))

dist_meta <- fovs %>%
  map_dfr(~ {
    # Pull cell coordinates from object
    cell_coords <- xen@images[[.x]]@boundaries$centroids
    
    cell_coords <- cell_coords@coords %>%
      as_tibble() %>%
      mutate(.cell_id = cell_coords@cells)
    
    # Pull cell types
    cell_coords <- xen@meta.data %>%
      filter(fov == .x) %>%
      as_tibble(rownames = ".cell_id") %>%
      dplyr::select(.cell_id, cell_type, Ag_class) %>%
      left_join(cell_coords, by = ".cell_id")
    
    lecs <- cell_coords %>%
      filter(cell_type == "LEC" & Ag_class == "Ag-high")
    
    # Get all possible neighboring LECs for each cell
    cell_dist <- expand_grid(
      LEC   = lecs$.cell_id,
      other = cell_coords$.cell_id
    ) %>%
      inner_join(cell_coords, by = c(other = ".cell_id")) %>%
      inner_join(lecs, by = c(LEC = ".cell_id"), suffix = c("", "_lec")) %>%
      dplyr::select(-cell_type_lec, -Ag_class_lec)
    
    # Calculate distance and determine closest LEC
    cell_dist <- cell_dist %>%
      mutate(
        lec_dist = sqrt(((x - x_lec)^2) + ((y - y_lec)^2))
      ) %>%
      group_by(other) %>%
      slice_min(lec_dist, n = 1, with_ties = FALSE) %>%
      ungroup()
    
    res <- cell_dist %>%
      dplyr::select(
        other,
        lec_id = LEC, lec_dist,
        x_cell = x, y_cell = y,
        matches("^[xy]_")
      ) %>%
      column_to_rownames("other")
    
    res
  })

xen <- xen %>%
  AddMetaData(dist_meta)
```

```{r "lec types", eval = create_object}
# Recluster filtered LECs
lec <- lec %>%
  subset(cell_type == "LEC")

lec <- lec %>%
  SCTransform(assay = "Xenium") %>%
  RunPCA(
    assay    = "SCT",
    npcs     = 30,
    features = rownames(.)
  ) %>%
  RunUMAP(
    assay       = "SCT",
    reduction   = "pca",
    dims        = 1:30,
    umap.method = "umap-learn"
  )

lec <- lec %>%
  FindNeighbors(
    assay     = "SCT",
    reduction = "pca",
    dims      = 1:30
  ) %>%
  FindClusters(resolution = c(0.5, 0.75, 1, 1.5, 2, 2.5, 3, 5))

u_coords <- lec %>%
  FetchData(c("UMAP_1", "UMAP_2"))

lec <- lec %>%
  AddMetaData(u_coords)

# Annotate LEC types
ann <- clustify(
  input       = lec@assays$SCT@data,
  ref_mat     = ref_LEC_xiang,
  metadata    = lec@meta.data,
  cluster_col = lec_clst_clmn,
  vec_out     = TRUE,
)

names(ann) <- colnames(lec)

lec <- lec %>%
  AddMetaData(ann, col.name = "lec_type")

# Refine fLEC annotations
lec <- lec %>%
  classify_markers(
    Madcam1 > 0.25,
    feats      = "Madcam1",
    type_label = "fLEC",
    clst_col   = lec_clst_clmn,
    type_col   = "lec_type"
  )

# Add annotations to meta.data
lec <- lec %>%
  mutate_meta(
    mutate,
    Ag_type = ifelse(Ag_class == "Ag-high", lec_type, "Ag-low")
  )

xen <- xen %>%
  AddMetaData(lec$lec_type, col.name = "lec_type") %>%
  mutate_meta(
    mutate,
    lec_type = replace_na(lec_type, "other")
  )

# Save objects
lec %>%
  qsave(here(params$so_dir, "lec.qs"))
```

```{r "small object", eval = create_object}
# Format Ag labels
dcs <- xen$cell_type %>%
  unique() %>%
  grep("DC", ., value = TRUE) %>%
  sort()

top_types <- c("LEC", dcs)

xen <- xen %>%
  mutate_meta(
    mutate,
    lec_dc_type    = ifelse(cell_type %in% top_types, as.character(cell_type), "other"),
    lec_dc_type    = fct_relevel(lec_dc_type, top_types),
    lec_dc_Ag_type = ifelse(Ag_class == "Ag-high", as.character(lec_dc_type), "Ag-low"),
    lec_dc_Ag_type = fct_relevel(lec_dc_Ag_type, top_types)
  )

# Select subset of cells to plot
# too many points to plot, downsample when plotting sections
plt_cells <- sample(colnames(xen), 50000)

plt_cells <- xen@meta.data %>%
  filter(cell_type %in% top_types | Ag_class == "Ag-high") %>%
  rownames() %>%
  c(plt_cells) %>%
  unique()

plt_cells <- xen@meta.data[plt_cells, ] %>%
  mutate(cell_type = fct_relevel(cell_type, top_types)) %>%
  arrange(cell_type) %>%
  rownames()

small <- xen %>%
  subset(cells = plt_cells)

# Save objects
xen %>%
  qsave(here(params$so_dir, "xen.qs"))

small %>%
  qsave(here(params$so_dir, "small.qs"))
```

```{r "load objects"}
# Load objects
xen   <- qread(here(params$so_dir, "xen.qs"))
lec   <- qread(here(params$so_dir, "lec.qs"))
small <- qread(here(params$so_dir, "small.qs"))

# Top cell types
dcs <- xen$cell_type %>%
  unique() %>%
  grep("DC", ., value = TRUE) %>%
  sort()

top_types <- c("LEC", dcs)

# Cells to plot for sections
plt_cells <- colnames(small)

# FOVs to plot
fovs      <- sort(unique(xen$fov))
top_fov   <- "D"
top_fov_2 <- "B"
```

```{r "format data"}
# Format plotting data
clmns <- c(
  ".cell_id", "fov", "cell_type",
  "Ag_class", "Ag_type", "lec_Ag_type",
  "lec_type", "lec_dc_type", "lec_dc_Ag_type",
  "lec_id", "lec_dist"
)

xen_dat <- xen@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(all_of(clmns), matches("^[xy]_"))

small_dat <- small@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(all_of(clmns), matches("^[xy]_")) %>%
  mutate(Ag_class = fct_relevel(Ag_class, c("Ag-low", "Ag-high"))) %>%
  arrange(Ag_class)
```

```{r "theme"}
# ggplot2 themes
txt_pt1  <- 10
txt_pt2  <- 12
ttl_pt1  <- 14
ttl_pt2  <- 16
ln_pt    <- 0.5
ln_col   <- "grey85"
cir_size <- 3.5
sqr_size <- 4

txt_theme_1 <- theme(
  strip.text   = element_text(size = ttl_pt2),
  legend.text  = element_text(size = ttl_pt1),
  axis.title   = element_text(size = ttl_pt2),
  axis.text    = element_text(size = txt_pt2, color = "black"),
  legend.title = element_text(size = ttl_pt2),
)

line_theme <- theme(
  axis.line.x  = element_line(linewidth = ln_pt, color = ln_col),
  axis.line.y  = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.x = element_line(linewidth = ln_pt, color = ln_col),
  axis.ticks.y = element_line(linewidth = ln_pt, color = ln_col)
)

base_theme <- djvdj_theme() +
  theme(
    plot.title       = element_text(face = "plain", size = ttl_pt2),
    strip.background = element_blank(),
    strip.text       = element_text(face = "plain")
  ) +
  txt_theme_1

umap_theme <- base_theme +
  theme(
    panel.border = element_rect(color = NA, fill = NA),
    axis.title   = element_blank(),
    axis.line.x  = element_blank(),
    axis.line.y  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text    = element_blank()
  )

umap_theme_2 <- umap_theme %+replace%
  theme(panel.border = element_rect(colour = ln_col, linewidth = ln_pt, fill = NA))

fade_0 <- "#FAFAFA"
fade_1 <- "#F0F0F0"
fade_2 <- "#D9D9D9"

# Colors
# Okabe Ito color palettes
ito_cols <- c(
  palette_OkabeIto[c(1:3, 5)], "#D7301F",
  palette_OkabeIto[c(4, 6)],   "#6A51A3",
  palette_OkabeIto[7],         "#875C04",
  "#065D43", "#F7AF34", "#00446E"
)

ito_cols <- ito_cols[3:length(ito_cols)] %>%
  darken(0.2) %>%
  c(ito_cols, ., "#686868", "#000000")

clrs <- ito_cols

# Cell type colors
typs <- unique(xen$cell_type)

typ_clrs <- set_names(
  clrs[seq_along(typs)],
  typs
)

typ_clrs[c("other CD45+", "other CD45-", "other", "Ag-low")] <- "grey85"

# typ_clrs[c("LEC", "BEC", "cDC1")] <- c("#D7301F", "#0072B2", "#6A51A3")
typ_clrs[c("LEC", "BEC", "cDC1")] <- c("#56B4E9", "#D7301F", "#6A51A3")

top_typ_clrs <- typ_clrs
top_typ_clrs[!names(top_typ_clrs) %in% top_types] <- "grey85"

top_typ_clrs_2 <- top_typ_clrs
top_typ_clrs_2[!names(top_typ_clrs_2) %in% top_types] <- "grey99"
top_typ_clrs_2[names(top_typ_clrs_2) %in% dcs] <- "#D7301F"

# Subtype colors
lec_clrs <- lec@meta.data %>%
  pull(lec_type) %>%
  unique()

lec_clrs <- set_names(
  clrs[seq_along(lec_clrs)],
  lec_clrs
)

lec_clrs["cLEC"]      <- "#56B4E9"
lec_clrs["fLEC"]      <- "#D7301F"
lec_clrs["Ptx3_LEC"]  <- "#E69F00"
lec_clrs["tzLEC"]     <- "black"
lec_clrs["Marco_LEC"] <- "#6A51A3"

lec_clrs[c("Ag-low", "other")] <- "grey85"

lec_lvls <- c(
  "cLEC", "fLEC", "Marco_LEC",
  "tzLEC", "Collecting", "Ptx3_LEC", 
  "other"
)
```

## Summary

* Xenium data were analyzed for the 3 week/6 week Ag exchange experiment for
  slide 1 (the slide 2 technical replicates need to be analyzed).
* Ag signals are sparse (most Ag+ cells have 1 count).
  This is at least partly due to the short length of the Ag tags, which only
  accommodate a single Xenium probe.
  We should consider re-designing and lengthening the Ag tags to allow binding
  of 2-3 probes.
* Due to the low number of Ag+ cells, Ag+ cells were identified as those with at
  least 1 count for either the 3 week or 6 week tag.
* LECs (specifically cLECs) are the top cell type enriched for Ag+ cells.
* When compared with Ag- DCs, Ag+ DCs tend to be in closer proximity to
  Ag+ LECs.
  This supports our previous GeoMx data and is in line with published work
  showing Ag is passed to DCs by LECs.

<u>To do</u>

* Comparison of 3 week and 6 week Ag signals
* Further refinement of cell types (current annotations are rough)
* Analysis of slide 2

<br>

<br>

---

## Cell types {.tabset .tabset-pills}

Annotated cell types are shown for LN sections from slide 1.
Cells were downsampled to allow for visualization of all cell types.

```{r "SLIDE 1: cell type sections", fig.width = 13, fig.height = 7}
# Legend labels
cell_n <- xen@meta.data %>%
  group_by(cell_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(cell_type, "\nn = ", label_comma()(n))
  ) %>%
  arrange(desc(n))

lgnd_labs <- set_names(cell_n$n_lab, cell_n$cell_type)

# Create section plots
Idents(small) <- small$cell_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 1.5,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 4))) +
      scale_fill_manual(values = typ_clrs, labels = lgnd_labs) +
      labs(tag = .x) +
      coord_fixed() +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = ttl_pt1),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

plts <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  )

# Create bargraphs
# be sure to NOT use downsampled data
brs <- xen@meta.data %>%
  plot_frequency(
    "cell_type",
    cluster_col = "fov",
    plot_colors = typ_clrs,
    plot_lvls   = names(lgnd_labs),
    alpha       = 1
  ) +
  base_theme +
  scale_y_continuous(expand = expansion(c(0, 0))) +
  theme(
    aspect.ratio    = 1.5,
    plot.margin     = margin(0, 0, 0, 0),
    panel.border    = element_blank(),
    legend.position = "none",
    axis.title      = element_blank(),
    axis.ticks      = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    axis.text.y     = element_blank()
  )

fig <- wrap_plots(
  plts, brs,
  nrow = 1,
  widths = c(1, 0.2)
) +
  plot_annotation(caption = "* cells downsampled for visualization") &
  theme(plot.caption = element_text(hjust = 0.02, vjust = 30, face = "italic"))

fig
```

LEC and DC populations of interest are shown for LN sections.
Cells were downsampled to allow for visualization of all cell types.
High-resolution images showing all cells are included at the bottom.

```{r "SLIDE 3: LEC DC sections", fig.width = 13, fig.height = 6}
# Create section plots
Idents(small) <- small$cell_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 1.5,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 4))) +
      scale_fill_manual(values = top_typ_clrs, labels = lgnd_labs) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = ttl_pt1),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

plts <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  )

# Create bargraphs
br_dat <- xen@meta.data %>%
  group_by(fov) %>%
  mutate(total_cells = n()) %>%
  group_by(fov, total_cells, cell_type) %>%
  summarize(
    n    = n(),
    frac = (n / total_cells),
    .groups = "drop"
  ) %>%
  distinct() %>%
  filter(cell_type %in% top_types) %>%
  mutate(cell_type = fct_relevel(cell_type, rev(top_types)))

x_labs <- br_dat %>%
  group_by(fov) %>%
  summarize(n = sum(n), .groups = "drop") %>%
  mutate(
    n_lab = str_c(fov, "\nn = ", label_comma()(n))
  )

x_labs <- set_names(x_labs$n_lab, x_labs$fov)

brs <- br_dat %>%
  ggplot(aes(fov, frac, fill = cell_type)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = typ_clrs) +
  scale_x_discrete(labels = x_labs) +
  labs(y = "% of cells") +
  base_theme +
  scale_y_continuous(expand = expansion(c(0, 0)), labels = label_percent()) +
  theme(
    aspect.ratio    = 1.35,
    panel.border    = element_blank(),
    legend.position = "none",
    axis.line.y     = element_line(color = ln_col, linewidth = ln_pt),
    axis.title.x    = element_blank(),
    axis.ticks.x    = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1)
  )

# Create final figure
fig <- wrap_plots(
  plts, brs,
  nrow = 1,
  widths = c(1, 0.25)
) +
  plot_annotation(caption = "* cells downsampled for visualization") &
  theme(plot.caption = element_text(hjust = 0.02, vjust = 30, face = "italic"))

fig
```

```{r, fig.width = 45, fig.height = 10, results = "asis", out.height = "70%"}
fovs %>%
  walk(~ {
    cat("\n\n###", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov   = .x,
        color = "cell_type",
        trace = list("NONE", "LEC", dcs),
        clrs  = typ_clrs
      ) %>%
      plot_grid(
        plotlist = .,
        nrow  = 1,
        align = "h",
        axis  = "tb"    
      )
    
    print(fig)
    cat("\n\n<br>\n\n<br>\n\n")
  })
```

##

The expression of key marker genes is shown below.

```{r "cell type markers", fig.width = 15, fig.height = 7}
gns <- c(
  "Ptprc", "Pdpn", "Pecam1",
  "Cd3d", "Cd19",
  "Prox1", "Lyve1",
  "Itgax", "Xcr1", "Sirpa", "Itgam", "Siglech"
)

marker_plt <- gns %>%
  map(~ {
    xen %>%
      plot_violin(
        .x,
        cluster_col   = "cell_type",
        plot_colors   = typ_clrs,
        method        = "boxplot",
        outlier.size  = 0.5,
        outlier.alpha = 1
      )
  }) %>%
  plot_grid(
    plotlist = .,
    nrow     = 3,
    align    = "vh",
    axis     = "trbl"
  )

marker_plt
```

```{r "CCR7 EXPRESSION", eval = FALSE}
gns <- "Ccr7"

xen@active.assay <- "SCT"

dat <- xen %>%
  FetchData(
    c("cell_type", "Ag_class", "Ag_type", gns),
    slot = "data"
  ) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(gns))

dat %>%
  mutate(Ag_class = fct_relevel(Ag_class, c("Ag-low", "Ag-high"))) %>%
  ggplot(aes(cell_type, value, fill = Ag_class)) +
  geom_boxplot(alpha = 0.8) +
  scale_fill_manual(values = c("lightblue", "#D7301F")) +
  labs(y = "expression") +
  facet_wrap(~ name) +
  base_theme +
  theme(
    axis.title.x = element_blank(),
    axis.text.x  = element_text(angle = 45, hjust = 1)
  )
```

<br>

<br>

### Ag+ cells {.tabset .tabset-pills}

Ag+ cells are shown for LN sections.

```{r "SLIDE 2: Ag+ cell types", fig.width = 13, fig.height = 7}
# Fraction of cell types that are Ag+
ag_dat <- xen@meta.data %>%
  group_by(fov, cell_type) %>%
  summarize(
    frac = sum(Ag_class == "Ag-high") / n(),
    .groups = "drop"
  ) %>%
  mutate(cell_type = fct_reorder(cell_type, frac, .desc = TRUE))

ag_brs <- ag_dat %>%
  ggplot(aes(cell_type, frac, fill = cell_type)) +
  geom_col() +
  facet_wrap(~ fov, ncol = 1, scales = "free_y", strip.position = "right") +
  scale_fill_manual(values = typ_clrs) +
  scale_y_continuous(labels = label_percent(), breaks = pretty_breaks(n = 2)) +
  labs(y = "% Ag+ cells") +
  base_theme +
  theme(
    aspect.ratio    = 0.3,
    legend.position = "none",
    strip.placement = "outside",
    strip.text      = element_text(size = ttl_pt2),
    axis.title.x    = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    axis.text.y     = element_text(size = txt_pt1)
  )

# Format labels to plot
small <- small %>%
  mutate_meta(
    mutate,
    Ag_type = fct_relevel(Ag_type, levels(ag_dat$cell_type)),
    Ag_type = fct_relevel(Ag_type, names(typ_clrs)[!grepl("^other", names(typ_clrs))]),
    Ag_type = fct_relevel(Ag_type, top_types)
  )

ag_labs <- xen@meta.data %>%
  group_by(Ag_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(Ag_type, "\nn = ", label_comma()(n))
  ) %>%
  arrange(Ag_type)

ag_labs <- set_names(ag_labs$n_lab, ag_labs$Ag_type)

# Plot Ag+ cells
Idents(small) <- small$Ag_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 2,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 5))) +
      scale_fill_manual(values = typ_clrs, labels = ag_labs, drop = FALSE) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = txt_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

fig <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.text     = element_text(size = ttl_pt2)
  )

fig <- plot_grid(
  fig, ag_brs,
  nrow = 1,
  rel_widths = c(1, 0.35)
)

fig
```

```{r, fig.width = 20, fig.height = 10, results = "asis", out.height = "70%"}
ag_types <- xen_dat$cell_type %>%
  unique() %>%
  grep("other|Ag-low", ., invert = TRUE, value = TRUE)

fovs %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov        = .x,
        color      = "Ag_type",
        clrs       = typ_clrs,
        trace      = list(ag_types),
        trace_clr  = NA,
        trace_size = 1.5
      )
    
    print(fig)
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

## LEC subsets {.tabset .tabset-pills}

UMAP projections show annotated LEC subsets and marker gene expression. 

```{r "SLIDE 4: LEC UMAPs", fig.width = 13, fig.height = 6}
# LEC annotations UMAPs
lec_u <- lec %>%
  plot_scatter(
    "lec_type",
    size         = 1.2,
    plot_colors  = lec_clrs,
    label_params = list(size = ttl_pt1)
  ) +
  base_theme +
  theme(
    aspect.ratio    = 1,
    legend.position = "none",
    axis.title      = element_text(size = txt_pt2),
    axis.text       = element_blank(),
    axis.ticks      = element_blank()
  )

# LEC bargraphs
lec_brs <- lec@meta.data %>%
  ggplot(aes(fov, fill = lec_type)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = lec_clrs) +
  labs(x = "section", y = "fraction of cells") +
  coord_flip() +
  base_theme +
  theme(
    panel.border = element_blank(),
    legend.title = element_blank(),
    axis.ticks   = element_blank(),
    axis.title   = element_blank(),
    axis.text.x  = element_blank()
  )

lec_u <- plot_grid(
  lec_u, lec_brs,
  rel_heights = c(1, 0.3),
  ncol  = 1,
  align = "v",
  axis  = "rl"
)

# LEC markers
gns <- c(
  cLEC      = "Ackr4",
  fLEC      = "Madcam1",
  Marco_LEC = "Marco",
  Ptx3_LEC  = "Ptx3"
)

gn_u <- gns %>%
  imap(~ {
    lec %>%
      plot_scatter(
        .x,
        plot_colors = c("white", lec_clrs[.y]),
        n_label = "none",
        outline = TRUE
      ) +
      guides(color = guide_colorbar(ticks = FALSE)) +
      umap_theme_2 +
      theme(
        aspect.ratio = 1,
        legend.title = element_text(angle = 270, hjust = 0.5),
        legend.text  = element_text(size = txt_pt1),
        legend.key.height = unit(25, "pt"),
        legend.key.width = unit(5, "pt")
      )
  }) %>%
  plot_grid(
    plotlist = .,
    nrow = 2,
    align = "vh",
    axis  = "trbl"
  )

fig <- plot_grid(
  lec_u, gn_u,
  nrow = 1,
  rel_widths = c(0.8, 1)
)

fig
```

<br>

The expression of key LEC marker genes is shown below.

```{r "LEC type markers", fig.width = 10, fig.height = 4.5}
gns <- c(
  "Pdpn", "Pecam1",
  "Prox1",
  "Lyve1", "Mrc1",
  "Marco",
  "Madcam1", "Icam1",
  "Ackr4",
  "Ptx3"
)

marker_plt <- gns %>%
  map(~ {
    lec %>%
      plot_violin(
        .x,
        cluster_col   = "lec_type",
        plot_colors   = lec_clrs,
        method        = "boxplot",
        outlier.size  = 0.5,
        outlier.alpha = 1,
        n_label = "none"
      ) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
      )
  }) %>%
  plot_grid(
    plotlist = .,
    nrow     = 2,
    align    = "vh",
    axis     = "trbl"
  )

marker_plt
```

<br>

<br>

Annotated LEC subsets are shown for LN sections.

```{r "SLIDE 5: LEC type sections", fig.width = 13, fig.height = 6}
# Legend labels
lec_labs <- xen@meta.data %>%
  group_by(lec_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(lec_type, "\nn = ", label_comma()(n)),
    lec_type = fct_relevel(lec_type, lec_lvls)
  ) %>%
  arrange(lec_type)

lec_labs <- set_names(lec_labs$n_lab, lec_labs$lec_type)

# Create section plots
small <- small %>%
  mutate_meta(
    mutate, 
    lec_type = fct_relevel(lec_type, lec_lvls)
  )

Idents(small) <- small$lec_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 2,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 4))) +
      scale_fill_manual(values = lec_clrs, labels = lec_labs) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = ttl_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

fig <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  ) +
  plot_annotation(caption = "* cells downsampled for visualization") &
  theme(plot.caption = element_text(hjust = 0.02, face = "italic"))

fig
```

```{r, fig.width = 20, fig.height = 10, results = "asis", out.height = "70%"}
ag_types <- xen_dat$lec_type %>%
  unique() %>%
  grep("other|Ag-low", ., invert = TRUE, value = TRUE)

fovs %>%
  walk(~ {
    cat("\n\n###", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov        = .x,
        color      = "lec_type",
        clrs       = lec_clrs,
        trace      = list(ag_types),
        trace_clr  = NA,
        trace_size = 2
      )
    
    print(fig)
    cat("\n\n<br>\n\n<br>\n\n")
  })
```

##

### Ag+ LECs {.tabset .tabset-pills}

Ag+ LECs are shown for LN sections.

```{r "SLIDE 6: Ag+ LEC types", fig.width = 13, fig.height = 7}
# Fraction of cell types that are Ag+
ag_dat <- lec@meta.data %>%
  group_by(fov, lec_type) %>%
  summarize(
    frac = sum(Ag_class == "Ag-high") / n(),
    .groups = "drop"
  ) %>%
  mutate(lec_type = fct_reorder(lec_type, frac, .desc = TRUE))

ag_brs <- ag_dat %>%
  ggplot(aes(lec_type, frac, fill = lec_type)) +
  geom_col() +
  facet_wrap(~ fov, ncol = 1, scales = "free_y", strip.position = "right") +
  scale_fill_manual(values = lec_clrs) +
  scale_y_continuous(labels = label_percent(), breaks = pretty_breaks(n = 2)) +
  labs(y = "% Ag+ cells") +
  base_theme +
  theme(
    aspect.ratio    = 0.7,
    legend.position = "none",
    strip.placement = "outside",
    strip.text      = element_text(size = ttl_pt2),
    axis.title.x    = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    axis.text.y     = element_text(size = txt_pt1)
  )

# Format labels to plot
lec_ag_labs <- xen@meta.data %>%
  group_by(lec_Ag_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = str_c(lec_Ag_type, "\nn = ", label_comma()(n))
  ) %>%
  arrange(lec_Ag_type)

lec_ag_labs <- set_names(lec_ag_labs$n_lab, lec_ag_labs$lec_Ag_type)

# Plot Ag+ cells
Idents(small) <- small$lec_Ag_type

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov  = .x,
        size = 2,
        crop = TRUE,
        dark.background = FALSE
      ) +
      guides(fill = guide_legend(override.aes = list(shape = 22, size = 5))) +
      scale_fill_manual(values = lec_clrs, labels = lec_ag_labs, drop = FALSE) +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.title      = element_blank(),
        legend.text       = element_text(size = txt_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    p
  })

plts <- plts %>%
  wrap_plots(
    nrow = 2,
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.text     = element_text(size = ttl_pt2)
  )

fig <- plot_grid(
  plts, ag_brs,
  nrow = 1,
  rel_widths = c(1, 0.25)
)

fig
```

```{r, fig.width = 20, fig.height = 10, results = "asis", out.height = "70%"}
ag_types <- xen_dat$lec_Ag_type %>%
  unique() %>%
  grep("other|Ag-low", ., invert = TRUE, value = TRUE)

fovs %>%
  walk(~ {
    cat("\n\n####", .x, "\n\n")
    
    fig <- xen_dat %>%
      .plot_full_fov(
        fov        = .x,
        color      = "lec_Ag_type",
        clrs       = lec_clrs,
        trace      = list(ag_types),
        trace_clr  = NA,
        trace_size = 2
      )
    
    print(fig)
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

## LEC-DC Ag exchange

Ag+ LECs and DCs are shown for LN sections.

```{r "Ag+ LECs/DCs", fig.width = 13, fig.height = 6}
# Format legend labels
lec_dc_ag_labs <- small@meta.data %>%
  group_by(lec_dc_Ag_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(
    n_lab = ifelse(
      lec_dc_Ag_type %in% top_types,
      str_c(lec_dc_Ag_type, "\nn = ", label_comma()(n)),
      as.character(lec_dc_Ag_type)
    )
  ) %>%
  arrange(lec_dc_Ag_type)

lec_dc_ag_labs <- set_names(
  lec_dc_ag_labs$n_lab,
  lec_dc_ag_labs$lec_dc_Ag_type
)

# Plot Ag+ cells
plts <- fovs %>%
  map(~ {
    p <- small_dat %>%
      filter(fov == .x) %>%
      arrange(desc(lec_dc_Ag_type)) %>%
      
      ggplot(aes(y_cell, x_cell, fill = lec_dc_Ag_type)) +
      geom_point_trace(size = 1.65, trace_position = "bottom") +
      guides(fill = guide_legend(
        title = "Ag+ LECs/DCs",
        title.position = "top",
        override.aes = list(size = 4)
      )) +
      scale_fill_manual(
        values = top_typ_clrs_2,
        labels = lec_dc_ag_labs,
        drop   = FALSE
      ) +
      coord_fixed() +
      labs(tag = .x) +
      umap_theme +
      theme(
        legend.key.height = unit(35, "pt"),
        legend.text       = element_text(size = txt_pt2),
        plot.tag.position = c(0.05, 0.95),
        plot.tag          = element_text(size = ttl_pt2, face = "bold")
      )
    
    p
  })

# Create final figure
fig <- plts %>%
  wrap_plots(
    nrow    = 2,
    guides  = "collect",
    heights = c(1, 1)
  ) &
  theme(
    legend.position = "right",
    legend.text     = element_text(size = ttl_pt2)
  )

fig
```

<br>

<br>

Ag+ LECs and DCs are shown for all DCs for tissue section `r top_fov`.
Lines (bottom) connect the nearest Ag+ LEC identified for each DC.

```{r "FOV D Ag+ LECs/DCs 1", fig.width = 8, fig.height = 5}
# Format LEC/DC data
dc_dat <- xen_dat %>%
  filter(fov == top_fov) %>%
  mutate(lec_dc_Ag_type = recode(lec_dc_Ag_type, `Ag-low` = "other")) %>%
  arrange(desc(lec_dc_Ag_type))

# Format n label data
lec_dc_ag_labs <- dc_dat %>%
  group_by(lec_dc_Ag_type) %>%
  summarize(n = n(), .groups = "drop") %>%
  mutate(n_lab = str_c(lec_dc_Ag_type, "\nn = ", label_comma()(n))) %>%
  arrange(lec_dc_Ag_type)

lec_dc_ag_labs <- set_names(
  lec_dc_ag_labs$n_lab,
  lec_dc_ag_labs$lec_dc_Ag_type
)

# Create tissue section plot
dc_dat %>%
  ggplot(aes(y_cell, x_cell, fill = lec_dc_Ag_type)) +
  geom_point_trace(size = 1, trace_position = "bottom") +
  guides(fill = guide_legend(
    title = "Ag+ LECs/DCs",
    title.position = "top",
    override.aes = list(size = 4)
  )) +
  scale_fill_manual(values = top_typ_clrs_2, labels = lec_dc_ag_labs) +
  coord_fixed() +
  umap_theme_2
```

```{r "FOV D Ag+ LEC/DC pairs 1", fig.width = 8, fig.height = 5}
dc_dat %>%
  ggplot(aes(y_cell, x_cell, color = lec_dc_Ag_type)) +
  
  geom_point_trace(
    size  = 1,
    color = "black",
    fill  = "grey99",
    trace_position = "bottom"
  ) +
  geom_segment(
    aes(x = y_cell, xend = y_lec, y = x_cell, yend = x_lec),
    data     = ~ filter(.x, lec_dc_Ag_type %in% c("LEC", dcs)),
    color    = "black",
    linetype = 1
  ) +
  geom_point(
    data = ~ filter(.x, lec_dc_Ag_type %in% top_types),
    size = 1
  ) +
  
  guides(color = guide_legend(
    title = "Ag+ LECs/DCs",
    title.position = "top",
    override.aes = list(size = 4)
  )) +
  scale_color_manual(values = top_typ_clrs_2, labels = lec_dc_ag_labs) +
  coord_fixed() +
  umap_theme_2
```

<br>

<br>

Ag+ LECs and DCs are shown for each DC subset for tissue section `r top_fov`.
Lines (bottom) connect the nearest Ag+ LEC identified for each DC.

```{r "FOV D Ag+ LECs/DCs 2", fig.width = 13, fig.height = 5.5}
# Plot Ag+ LECs and DCs
plts <- dcs %>%
  map(~ {
    typ <- .x
    
    small_dat %>%
      filter(fov == top_fov) %>%
      filter(lec_dc_Ag_type %in% c("LEC", .x, "other", "Ag-low")) %>%
      arrange(desc(lec_dc_Ag_type)) %>%
      
      ggplot(aes(y_cell, x_cell, fill = lec_dc_Ag_type)) +
      geom_point_trace(size = 1.75, trace_position = "bottom") +
      guides(fill = guide_legend(
        title = "Ag+ LECs/DCs",
        title.position = "top",
        override.aes = list(size = 4)
      )) +
      scale_fill_manual(values = top_typ_clrs_2, drop = FALSE) +
      labs(title = .x) +
      coord_fixed() +
      umap_theme_2
  })

fig <- plts %>%
  wrap_plots(
    nrow = 1,
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.text     = element_text(size = ttl_pt2),
    plot.title      = element_text(size = ttl_pt2 * 1.5, hjust = 0.5)
  )

fig
```

```{r "FOV D Ag+ LEC/DC pairs 2", fig.width = 13, fig.height = 5.5}
# Plot Ag+ LECs and DCs
plts <- dcs %>%
  map(~ {
    typ <- .x
    
    small_dat %>%
      filter(fov == top_fov) %>%
      filter(lec_dc_Ag_type %in% c("LEC", .x, "other", "Ag-low")) %>%
      arrange(desc(lec_dc_Ag_type)) %>%
      
      ggplot(aes(y_cell, x_cell, color = lec_dc_Ag_type)) +
      
      geom_point_trace(
        size  = 1.75,
        color = "black",
        fill  = "grey99",
        trace_position = "bottom"
      ) +
      geom_point(
        data = ~ filter(.x, lec_dc_Ag_type %in% top_types),
        size = 1.75
      ) +
      geom_segment(
        aes(x = y_cell, xend = y_lec, y = x_cell, yend = x_lec),
        data     = ~ filter(.x, lec_dc_Ag_type %in% c("LEC", typ)),
        color    = "black",
        linetype = 2
      ) +
      
      guides(color = guide_legend(
        title = "Ag+ LECs/DCs",
        title.position = "top",
        override.aes = list(size = 4)
      )) +
      scale_color_manual(values = top_typ_clrs_2, drop = FALSE) +
      labs(title = .x) +
      coord_fixed() +
      umap_theme_2
  })

fig <- plts %>%
  wrap_plots(
    nrow = 1,
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.text     = element_text(size = ttl_pt2),
    plot.title      = element_text(size = ttl_pt2 * 1.5, hjust = 0.5)
  )

fig
```

<br>

<br>

The distance from the nearest Ag+ LEC is shown for Ag+ and Ag- cells for each
cell type. Vertical lines indicate the median distance.

```{r "proximity histograms", fig.width = 18, fig.height = 13}
# Ag class labels
ag_classes <- c(
  `Ag-low`  = "Ag-",
  `Ag-high` = "Ag+"
)

# Format data for histograms
hist_dat <- xen@meta.data %>%
  as_tibble(rownames = ".cell_id") %>%
  dplyr::select(.cell_id, fov, cell_type, lec_type, Ag_class, lec_id, lec_dist) %>%
  filter(cell_type != "LEC")

# Format data for median lines
ln_dat <- hist_dat %>%
  group_by(fov, cell_type, Ag_class) %>%
  summarize(
    lec_dist = median(lec_dist),
    n        = n(),
    .groups  = "drop"
  )

# Format data for n labels
n_dat <- ln_dat %>%
  group_by(fov, cell_type) %>%
  mutate(
    n_lab = str_c(ag_classes[Ag_class], " (", label_comma()(n), " cells)")
  ) %>%
  summarize(
    n_lab = str_c(n_lab, collapse = "\n"),
    .groups = "drop"
  )

# Format data for p-values
p_dat <- hist_dat %>%
  group_by(fov, cell_type) %>%
  summarize(
    p = wilcox.test(
      lec_dist[Ag_class == "Ag-high"],
      lec_dist[Ag_class == "Ag-low"],
      alternative = "less"
    )$p.value,
    .groups = "drop"
  ) %>%
  mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
  rowwise() %>%
  mutate(
    p_lab = .format_pvalue(p_adj),
    p_lab = str_c("italic(p) == ", p_lab)
  ) %>%
  ungroup()

# Plot distance from nearest Ag+ LEC
hist <- hist_dat %>%
  ggplot(aes(lec_dist, fill = Ag_class, alpha = Ag_class)) +
  geom_vline(
    aes(xintercept = lec_dist, color = Ag_class, alpha = NULL),
    data      = ln_dat,
    linetype  = 2,
    linewidth = 0.75,
    show.legend = FALSE
  ) +
  geom_density(aes(color = Ag_class)) +
  
  geom_text(
    aes(x = 3, y = Inf, label = n_lab, fill = NULL, alpha = NULL),
    data = n_dat,
    hjust = 0,
    vjust = 1.2,
    size  = (txt_pt1 * 0.8) / .pt,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = Inf, y = Inf, label = p_lab, fill = NULL, alpha = NULL),
    data  = p_dat,
    parse = TRUE,
    hjust = 1.1,
    vjust = 1.2,
    size  = (txt_pt1 * 0.8) / .pt,
    show.legend = FALSE
  ) +
  
  facet_grid(cell_type ~ fov, scales = "free_y") +
  labs(x = "distance from nearest Ag+ LEC", y = "density") +
  scale_fill_manual(values = c(`Ag-low` = "grey85", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_color_manual(values = c(`Ag-low` = "black", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_alpha_manual(values = c(`Ag-low` = 0.5, `Ag-high` = 0.85), labels = ag_classes) +
  scale_x_log10() +
  base_theme +
  theme(
    aspect.ratio    = 0.5,
    legend.position = "bottom",
    legend.title    = element_blank()
  )

hist
```

<br>

<br>

The distance from the nearest Ag+ LEC is shown for Ag+ and Ag- cells for
cDC1 and cDC2 subsets. Vertical lines indicate the median distance.

```{r "DC proximity histograms 1"}
# DC labels
ag_classes <- c(
  `Ag-low`  = "Ag- DCs",
  `Ag-high` = "Ag+ DCs"
)

top_dcs <- dcs[dcs != "Siglec-H DC"]

# Plot distance from nearest Ag+ LEC
dc_hist <- hist_dat %>%
  filter(cell_type %in% top_dcs, fov == top_fov) %>%
  ggplot(aes(lec_dist, fill = Ag_class, alpha = Ag_class)) +
  geom_density(aes(color = Ag_class)) +
  geom_vline(
    aes(xintercept = lec_dist, color = Ag_class, alpha = NULL),
    data      = filter(ln_dat, cell_type %in% top_dcs, fov == "D"),
    linetype  = 2,
    linewidth = 0.75,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = 3, y = Inf, label = p_lab, fill = NULL, alpha = NULL),
    data  = filter(p_dat, cell_type %in% top_dcs, fov == top_fov),
    parse = TRUE,
    hjust = 0,
    vjust = 1.2,
    size  = txt_pt2 / .pt,
    show.legend = FALSE
  ) +
  
  facet_grid(cell_type ~ ., scales = "free_y") +
  labs(x = "distance from Ag+ LEC", y = "density") +
  scale_fill_manual(values = c(`Ag-low` = "grey85", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_color_manual(values = c(`Ag-low` = "black", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_alpha_manual(values = c(`Ag-low` = 0.5, `Ag-high` = 0.85), labels = ag_classes) +
  scale_x_log10() +
  base_theme +
  theme(
    aspect.ratio    = 0.5,
    legend.position = "bottom",
    legend.title    = element_blank()
  )
```

```{r "DC proximity sections 1", fig.width = 16, fig.height = 7}
# Scatter plot with points colored by distance from Ag+ LEC
prox_plts <- ag_classes %>%
  imap(~ {
    cls <- .y
    
    n_dat <- small_dat %>%
      filter(fov == top_fov) %>%
      filter(cell_type %in% top_dcs & Ag_class == cls) %>%
      group_by(Ag_class) %>%
      summarize(n = n(), .groups = "drop") %>%
      mutate(n_lab = str_c(label_comma()(n), " cells"))
    
    plt <- small_dat %>%
      filter(fov == top_fov) %>%
      ggplot(aes(y_cell, x_cell)) +
      geom_point(
        data = ~ filter(.x, .cell_id %in% plt_cells),
        size = 1, color = "grey85"
      ) +
      geom_point(
        aes(color = lec_dist),
        data = ~ filter(.x, cell_type %in% top_dcs & Ag_class == cls)
      ) +
      geom_text(
        aes(-Inf, Inf, label = n_lab),
        data  = n_dat,
        vjust = 1.5,
        hjust = -0.2,
        size  = ttl_pt2 / .pt
      ) +
      guides(color = guide_colorbar(ticks = FALSE)) +
      scale_color_gradientn(
        colours = c("#D7301F", "black"),
        name = "distance from\nAg+ LEC",
        limits = c(0, 700)
      ) +
      coord_fixed() +
      labs(title = .x) +
      umap_theme_2 +
      theme(
        plot.title        = element_text(size = ttl_pt2 * 1.5, hjust = 0.5),
        legend.key.height = unit(12, "pt"),
        legend.key.width  = unit(40, "pt"),
        legend.text       = element_text(size = txt_pt2)
      )
    
    plt
  })

# Create final figure
prox_plts <- prox_plts %>%
  wrap_plots(
    nrow   = 1,
    guides = "collect",
    byrow  = FALSE
  ) &
  theme(legend.position = "bottom")

fig <- plot_grid(
  prox_plts, dc_hist,
  nrow  = 1,
  rel_widths = c(1, 0.35)
)

fig
```

<br>

<br>

The distance from the nearest Ag+ LEC is shown for Ag+ and Ag- cells for
each DC subset. Vertical lines indicate the median distance.

```{r "DC proximity histograms 2"}
# DC labels
ag_classes <- c(
  `Ag-low`  = "Ag- DCs",
  `Ag-high` = "Ag+ DCs"
)

# Plot distance from nearest Ag+ LEC
dc_hist <- hist_dat %>%
  filter(cell_type %in% dcs, fov == top_fov) %>%
  ggplot(aes(lec_dist, fill = Ag_class, alpha = Ag_class)) +
  geom_density(aes(color = Ag_class)) +
  geom_vline(
    aes(xintercept = lec_dist, color = Ag_class, alpha = NULL),
    data      = filter(ln_dat, cell_type %in% dcs, fov == "D"),
    linetype  = 2,
    linewidth = 0.75,
    show.legend = FALSE
  ) +
  
  geom_text(
    aes(x = 3, y = Inf, label = p_lab, fill = NULL, alpha = NULL),
    data  = filter(p_dat, cell_type %in% dcs, fov == top_fov),
    parse = TRUE,
    hjust = 0,
    vjust = 1.2,
    size  = txt_pt2 / .pt,
    show.legend = FALSE
  ) +
  
  facet_grid(cell_type ~ ., scales = "free_y") +
  labs(x = "distance from Ag+ LEC", y = "density") +
  scale_fill_manual(values = c(`Ag-low` = "grey85", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_color_manual(values = c(`Ag-low` = "black", `Ag-high` = "#D7301F"), labels = ag_classes) +
  scale_alpha_manual(values = c(`Ag-low` = 0.5, `Ag-high` = 0.85), labels = ag_classes) +
  scale_x_log10() +
  base_theme +
  theme(
    aspect.ratio    = 0.5,
    legend.position = "bottom",
    legend.title    = element_blank()
  )
```

```{r "DC proximity sections 2", fig.width = 14, fig.height = 7}
# Scatter plot with points colored by distance from Ag+ LEC
prox_plts <- dcs %>%
  map(~ {
    typ <- .x
    
    ag_classes %>%
      imap(~ {
        cls <- .y
        
        n_dat <- small_dat %>%
          filter(fov == top_fov) %>%
          filter(cell_type == typ & Ag_class == cls) %>%
          group_by(cell_type, Ag_class) %>%
          summarize(n = n(), .groups = "drop") %>%
          mutate(n_lab = str_c(.x, "\n", label_comma()(n), " cells"))
        
        plt <- small_dat %>%
          filter(fov == top_fov) %>%
          ggplot(aes(y_cell, x_cell)) +
          geom_point(
            data = ~ filter(.x, .cell_id %in% plt_cells),
            size = 1, color = "grey85"
          ) +
          geom_point(
            aes(color = lec_dist),
            data = ~ filter(.x, cell_type == typ & Ag_class == cls)
          ) +
          geom_text(
            aes(-Inf, Inf, label = n_lab),
            data  = n_dat,
            vjust = 1.2,
            hjust = -0.2,
            size  = txt_pt2 / .pt
          ) +
          guides(color = guide_colorbar(ticks = FALSE)) +
          scale_color_gradientn(
            colours = c("#D7301F", "black"),
            name = "distance from\nAg+ LEC",
            limits = c(0, 700)
          ) +
          coord_fixed() +
          umap_theme_2 +
          theme(
            plot.title        = element_text(size = ttl_pt2 * 1.5, hjust = 0.5),
            legend.key.height = unit(12, "pt"),
            legend.key.width  = unit(40, "pt"),
            legend.text       = element_text(size = txt_pt2)
          )
        
        if (cls == "Ag-low") {
          plt <- plt +
            labs(title = typ)
        }
        
        plt
      })
  }) %>%
  flatten()

# Create final figure
prox_plts <- prox_plts %>%
  wrap_plots(
    nrow   = 2,
    guides = "collect",
    byrow  = FALSE
  ) &
  theme(legend.position = "bottom")

fig <- plot_grid(
  prox_plts, dc_hist,
  nrow  = 1,
  rel_widths = c(1, 0.43)
)

fig
```



```{r "PROXIMITY CELL PAIRS", fig.width = 14, fig.height = 7, eval = FALSE}
# Scatter plot with lines connecting closest Ag-high LEC
prox_dat %>%
  ggplot(aes(x_cell, y_cell)) +
  geom_point(size = 1, color = "grey85") +
  geom_point(
    aes(x_cell, y_cell, color = Ag_class),
    data = ~ filter(.x, cell_type == "Siglec-H DC")
  ) +
  geom_point(
    data = ~ filter(.x, cell_type == "LEC" & Ag_class == "Ag-high"),
    color = "black"
  ) +
  geom_segment(
    aes(x = x_cell, xend = x_lec, y = y_cell, yend = y_lec),
    data = ~ filter(.x, cell_type == "Siglec-H DC" & Ag_class == "Ag-high"),
    color = "black"
  ) +
  coord_fixed() +
  base_theme
```

```{r "Ag signal", eval = FALSE}
lec <- lec %>%
  mutate_meta(
    mutate,
    Ag_class_1 = Ag_tag_1 > 0,
    Ag_class_2 = Ag_tag_2 > 0
  )

lec@meta.data %>%
  # ggplot(aes(lec_type, fill = Ag_tag_1, group = as.character(Ag_tag_1))) +
  ggplot(aes(lec_type, fill = Ag_class)) +
  geom_bar(position = "fill") +
  facet_wrap(~ fov)

lec@meta.data %>%
  ggplot(aes(fov, fill = lec_type)) +
  geom_bar(position = "fill")

xen@meta.data %>%
  # ggplot(aes(lec_type, fill = Ag_tag_1, group = as.character(Ag_tag_1))) +
  ggplot(aes(cell_type, fill = Ag_class)) +
  geom_bar(position = "fill") +
  facet_wrap(~ fov)

xen@meta.data %>%
  filter(Ag_class == "Ag-high") %>%
  dplyr::select(fov, cell_type, Ag_class, starts_with("Ag_tag_")) %>%
  pivot_longer(starts_with("Ag_tag_")) %>%
  
  ggplot(aes(value + 1, fill = Ag_class)) + 
  geom_histogram() +
  facet_grid(name ~ cell_type) +
  scale_x_log10()


# lec %>%
#   mutate_meta(
#     mutate,
#     Ag_class = ifelse(Ag_tag_1 > 1, "Ag-high", "Ag-low"),
#   ) %>%
#   plot_violin(
#     "Cavin1",
#     cluster_col = "Ag_class",
#     group_col   = "lec_type",
#     method = "boxplot",
#     notch = TRUE
#   )
```

```{r, eval = FALSE}

# Plot cell types
xen %>%
  plot_scatter("SCT_snn_res.0.5", size = 0.0001, top = c("15", "8", "7", "12"))

xen %>%
  plot_scatter("Lyve1", size = 0.0001, plot_colors = c("lightblue", "white", "red"))

lec %>%
  plot_scatter("SCT_snn_res.3", size = 2, plot_colors = c("lightblue", "red"))

lec %>%
  plot_scatter("lec_type", size = 3, plot_colors = c("lightblue", "red"))

lec %>%
  plot_scatter("Mrc1", size = 3, plot_colors = c("lightblue", "red"))

xen %>%
  plot_scatter("cell_type", group_col = "fov", size = 0.0001)

xen %>%
  plot_scatter(
    # "xenium_custom_mRNA-vaccine-(3-UTR)",
    "xenium_custom_GeoMx-Barcode01-ERCC00142",
    # "xenium_custom_GeoMx-Barcode02-ERCC00144",
    size = 0.00001,
    plot_colors = c("lightblue", "red")
  )

Idents(xen) <- xen$cell_type

clrs <- unique(xen$cell_type)

clrs <- set_names(
  rep("white", length(clrs)),
  clrs
)

clrs["LEC"] <- "red"
clrs["BEC"] <- "lightblue"
clrs[c("cDC1", "cDC2")] <- "green4"

unique(xen$fov) %>%
  map(~ {
    xen %>%
      ImageDimPlot(
        fov = .x,
        size = 2,
        cols = clrs
      )
  }) %>%
  plot_grid(plotlist = .)

gns <- c(
  # "Madcam1",
  # "Marco", "Ackr4",
  # "Zbtb46", "Xcr1", "Itgax",
  "Cavin1", "Ctsd", "Psap", "Grn", "Tgfa",
  "GeoMx-Barcode01-ERCC00142",
  "GeoMx-Barcode02-ERCC00144"
)

xen %>%
  ImageFeaturePlot(
    fov = "A",
    features = gns,
    max.cutoff = "q1",
    size = 0.75,
    cols = c("white", "red")
  )

xen %>%
  ImageDimPlot(
    fov = "A",
    molecules = c("Ptprc", "Madcam1", "Marco", "Ackr4", "Ccr7"),
    nmols = 20000
  )

gns <- c(
  "Marco",
  "Madcam1", "Icam1", "Cd274",
  "Ackr4",
  "Ptx3", "Mrc1",
  "Fgl2"
)

gns %>%
  map(~ {
    lec %>%
      plot_violin(
        .x,
        cluster_col = "SCT_snn_res.3",
        group_col = "lec_type",
        method      = "boxplot",
        top = Inf
      )
  }) %>%
  plot_grid(plotlist = .)


# gns <- c(
#   "Ptprc", "Cd3d", "Cd19",
#   "Pecam1", "Pdpn",
#   "Prox1", "Lyve1",
#   "Ccr7", "Sirpa", "Xcr1",
#   "Itgax", "Itgam", "Siglech"
# )
# gns %>%
#   map(~ {
#     xen %>%
#       plot_violin(
#         .x,
#         cluster_col = clst_clmn,
#         group_col   = "cell_type",
#         method      = "boxplot",
#         top = Inf
#       )
#   }) %>%
#   plot_grid(plotlist = .)
# gns %>%
#   map(~ {
#     xen %>%
#       plot_violin(
#         .x,
#         cluster_col = "cell_type",
#         method      = "boxplot",
#         top = Inf
#       )
#   }) %>%
#   plot_grid(plotlist = .)
```

```{r "SLIDE 2: LEC type sections OLD", fig.width = 26, fig.height = 5, eval = FALSE}
new_clrs <- typ_clrs
new_clrs[!names(new_clrs) %in% c("LEC", "cDC2", "cDC1")] <- "grey85"

plts <- fovs %>%
  map(~ {
    p <- small %>%
      ImageDimPlot(
        fov = .x,
        size = 1.5,
        cols = new_clrs,
        crop = TRUE,
        dark.background = FALSE
      ) +
      labs(tag = .x) +
      base_theme +
      theme_void() +
      theme(
        panel.border = element_rect(color = ln_col, fill = NA, linewidth = ln_pt),
        legend.title = element_blank(),
        plot.tag.position = c(0.05, 0.95),
        plot.tag = element_text(size = ttl_pt2, face = "bold")
      )
    
    plot_data <- p$data
    plot_data <- plot_data[order(plot_data$ident, decreasing = TRUE), ]
    p$data    <- plot_data
    
    brs <- xen@meta.data %>%
      filter(fov == .x) %>%
      mutate(cell_type = fct_infreq(cell_type)) %>%
      ggplot(aes(y = fov, fill = cell_type)) +
      geom_bar(position = "fill") +
      scale_fill_manual(values = new_clrs) +
      base_theme +
      theme_void() +
      theme(
        legend.position = "none",
        axis.title      = element_blank(),
        axis.text       = element_blank()
      )
    
    list(p, brs)
  })

fig <- map(plts, pluck, 1) %>%
  wrap_plots(
    nrow = 1,
    guides = "collect"
  ) &
  theme(legend.direction = "horizontal")

fig
```
